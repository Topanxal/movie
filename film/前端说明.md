

### 1. é¡¹ç›®ç»“æ„æ¦‚è§ˆ
é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹é¡¹ç›®çš„æ•´ä½“ç»“æ„ï¼š

```
|-- .gitignore
|-- index.html
|-- package.json
|-- README.md
|-- build
|-- config
|-- src
|   |-- App.vue
|   |-- main.js
|   |-- api
|   |   |-- ajax.js
|   |   |-- index.js
|   |-- common
|   |   |-- css
|   |   |   |-- style.css
|   |   |   |-- fonts
|   |   |-- util
|   |       |-- util.js
|   |-- components
|   |   |-- CinemaDetail
|   |   |-- DatePicker
|   |   |-- Login
|   |   |-- MovieDetail
|   |   |   |-- MovieDetail.vue
|   |   |   |-- children
|   |   |   |   |-- CommentPanel.vue
|   |   |-- MovieItem
|   |   |-- Pay
|   |   |-- SelectCinema
|   |   |-- SelectSeat
|   |   |-- SubmitOrder
|   |   |-- TabBar
|   |-- pages
|   |   |-- Cinema
|   |   |   |-- Cinema.vue
|   |   |   |-- children
|   |   |       |-- SearchCinema.vue
|   |   |-- Home
|   |   |   |-- Home.vue
|   |   |   |-- children
|   |   |   |   |-- SearchAll.vue
|   |   |-- Movie
|   |   |   |-- Movie.vue
|   |   |   |-- children
|   |   |   |   |-- SearchMovie.vue
|   |   |-- My
|   |       |-- My.vue
|   |       |-- children
|   |       |   |-- ModifyUserName.vue
|   |       |   |-- ModifyUserSign.vue
|   |       |   |-- MyInfo.vue
|   |       |   |-- MyMovie.vue
|   |       |   |-- MyOrder.vue
|   |-- router
|   |   |-- index.js
|   |-- store
|-- static
    |-- css
        |-- adapter.css
        |-- reset.css
```

### 2. é¡¹ç›®å…¥å£æ–‡ä»¶
#### 2.1 `index.html`
è¿™æ˜¯é¡¹ç›®çš„æ ¹HTMLæ–‡ä»¶ï¼Œæ‰€æœ‰çš„Vueç»„ä»¶æœ€ç»ˆéƒ½ä¼šè¢«æ¸²æŸ“åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚å®ƒé€šå¸¸åŒ…å«ä¸€ä¸ª`<div id="app"></div>`ï¼ŒVueå®ä¾‹ä¼šæŒ‚è½½åˆ°è¿™ä¸ªDOMå…ƒç´ ä¸Šã€‚

#### 2.2 `main.js`
è¿™æ˜¯Vueåº”ç”¨çš„å…¥å£æ–‡ä»¶ã€‚å®ƒè´Ÿè´£åˆå§‹åŒ–Vueå®ä¾‹ï¼Œå¹¶å¼•å…¥å…¨å±€çš„æ’ä»¶ã€è·¯ç”±ã€çŠ¶æ€ç®¡ç†ç­‰ã€‚

```javascript
import Vue from 'vue'
import App from './App.vue'
import router from './router'
import store from './store'

new Vue({
  el: '#app',
  router,
  store,
  render: h => h(App)
})
```

- `router`ï¼šè´Ÿè´£è·¯ç”±ç®¡ç†ï¼Œæ§åˆ¶é¡µé¢çš„è·³è½¬ã€‚
- `store`ï¼šè´Ÿè´£å…¨å±€çŠ¶æ€ç®¡ç†ï¼Œä½¿ç”¨Vuexæ¥ç®¡ç†åº”ç”¨çš„çŠ¶æ€ã€‚

#### 2.3 `App.vue`
è¿™æ˜¯æ•´ä¸ªåº”ç”¨çš„æ ¹ç»„ä»¶ï¼Œæ‰€æœ‰çš„é¡µé¢å’Œç»„ä»¶éƒ½ä¼šåœ¨è¿™ä¸ªç»„ä»¶ä¸­è¢«æ¸²æŸ“ã€‚å®ƒé€šå¸¸åŒ…å«ä¸€ä¸ª`<router-view>`ï¼Œç”¨äºæ˜¾ç¤ºå½“å‰è·¯ç”±å¯¹åº”çš„ç»„ä»¶ã€‚

```vue
<template>
  <div id="app">
    <router-view></router-view>
  </div>
</template>

<script>
export default {
  name: 'App'
}
</script>
```

### 3. è·¯ç”±é…ç½®
#### 3.1 `src/router/index.js`
è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº†åº”ç”¨çš„è·¯ç”±é…ç½®ã€‚æ¯ä¸ªè·¯ç”±å¯¹åº”ä¸€ä¸ªé¡µé¢ç»„ä»¶ï¼Œç”¨æˆ·è®¿é—®ä¸åŒçš„URLæ—¶ï¼ŒVue Routerä¼šæ ¹æ®é…ç½®æ¸²æŸ“å¯¹åº”çš„ç»„ä»¶ã€‚

```javascript
import Vue from 'vue'
import Router from 'vue-router'
import Home from '../pages/Home/Home.vue'
import Movie from '../pages/Movie/Movie.vue'
import Cinema from '../pages/Cinema/Cinema.vue'
import My from '../pages/My/My.vue'

Vue.use(Router)

export default new Router({
  routes: [
    {
      path: '/',
      name: 'Home',
      component: Home
    },
    {
      path: '/movie',
      name: 'Movie',
      component: Movie
    },
    {
      path: '/cinema',
      name: 'Cinema',
      component: Cinema
    },
    {
      path: '/my',
      name: 'My',
      component: My
    }
  ]
})
```

### 4. é¡µé¢ç»„ä»¶
é¡µé¢ç»„ä»¶ä½äº`src/pages`ç›®å½•ä¸‹ï¼Œæ¯ä¸ªé¡µé¢é€šå¸¸å¯¹åº”ä¸€ä¸ªè·¯ç”±ã€‚é¡µé¢ç»„ä»¶å¯ä»¥åŒ…å«å­ç»„ä»¶ï¼Œç”¨äºæ„å»ºå¤æ‚çš„é¡µé¢ç»“æ„ã€‚

#### 4.1 `Home.vue`
è¿™æ˜¯åº”ç”¨çš„ä¸»é¡µï¼Œé€šå¸¸åŒ…å«ä¸€äº›æ¨èç”µå½±ã€çƒ­é—¨å½±é™¢ç­‰ä¿¡æ¯ã€‚

```vue
<template>
  <div class="home">
    <h1>æ¬¢è¿æ¥åˆ°ç”µå½±è®¢ç¥¨ç³»ç»Ÿ</h1>
    <MovieItem v-for="movie in movies" :key="movie.id" :movie="movie" />
  </div>
</template>

<script>
import MovieItem from '@/components/MovieItem/MovieItem.vue'

export default {
  name: 'Home',
  components: {
    MovieItem
  },
  data() {
    return {
      movies: []
    }
  },
  created() {
    // è·å–ç”µå½±æ•°æ®
    this.fetchMovies()
  },
  methods: {
    fetchMovies() {
      // è°ƒç”¨APIè·å–ç”µå½±æ•°æ®
    }
  }
}
</script>
```

#### 4.2 `Movie.vue`
è¿™æ˜¯ç”µå½±é¡µé¢ï¼Œé€šå¸¸å±•ç¤ºç”µå½±åˆ—è¡¨ã€ç”µå½±è¯¦æƒ…ç­‰ä¿¡æ¯ã€‚

```vue
<template>
  <div class="movie">
    <h1>ç”µå½±åˆ—è¡¨</h1>
    <MovieItem v-for="movie in movies" :key="movie.id" :movie="movie" />
  </div>
</template>

<script>
import MovieItem from '@/components/MovieItem/MovieItem.vue'

export default {
  name: 'Movie',
  components: {
    MovieItem
  },
  data() {
    return {
      movies: []
    }
  },
  created() {
    // è·å–ç”µå½±æ•°æ®
    this.fetchMovies()
  },
  methods: {
    fetchMovies() {
      // è°ƒç”¨APIè·å–ç”µå½±æ•°æ®
    }
  }
}
</script>
```

### 5. ç»„ä»¶
ç»„ä»¶ä½äº`src/components`ç›®å½•ä¸‹ï¼Œæ¯ä¸ªç»„ä»¶éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„Vueæ–‡ä»¶ï¼Œå¯ä»¥è¢«å¤šä¸ªé¡µé¢å¤ç”¨ã€‚

#### 5.1 `MovieItem.vue`
è¿™æ˜¯ä¸€ä¸ªå±•ç¤ºå•ä¸ªç”µå½±ä¿¡æ¯çš„ç»„ä»¶ï¼Œé€šå¸¸ç”¨äºç”µå½±åˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹ã€‚

```vue
<template>
  <div class="movie-item">
    <img :src="movie.poster" alt="movie poster">
    <h3>{{ movie.title }}</h3>
    <p>{{ movie.description }}</p>
  </div>
</template>

<script>
export default {
  name: 'MovieItem',
  props: {
    movie: {
      type: Object,
      required: true
    }
  }
}
</script>
```

#### 5.2 `TabBar.vue`
è¿™æ˜¯ä¸€ä¸ªåº•éƒ¨å¯¼èˆªæ ç»„ä»¶ï¼Œé€šå¸¸ç”¨äºåˆ‡æ¢ä¸åŒçš„é¡µé¢ã€‚

```vue
<template>
  <div class="tab-bar">
    <router-link to="/">é¦–é¡µ</router-link>
    <router-link to="/movie">ç”µå½±</router-link>
    <router-link to="/cinema">å½±é™¢</router-link>
    <router-link to="/my">æˆ‘çš„</router-link>
  </div>
</template>

<script>
export default {
  name: 'TabBar'
}
</script>
```

### 6. API è¯·æ±‚
#### 6.1 `src/api/ajax.js`
è¿™ä¸ªæ–‡ä»¶é€šå¸¸å°è£…äº†`axios`ï¼Œç”¨äºå‘é€HTTPè¯·æ±‚ã€‚

```javascript
import axios from 'axios'

const instance = axios.create({
  baseURL: 'https://api.example.com',
  timeout: 10000
})

export default instance
```

#### 6.2 `src/api/index.js`
è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº†å…·ä½“çš„APIè¯·æ±‚æ–¹æ³•ã€‚

```javascript
import ajax from './ajax'

export const getMovies = () => ajax.get('/movies')
export const getMovieDetail = (id) => ajax.get(`/movies/${id}`)
```

### 7. çŠ¶æ€ç®¡ç†
#### 7.1 `src/store/index.js`
è¿™ä¸ªæ–‡ä»¶ä½¿ç”¨Vuexæ¥ç®¡ç†å…¨å±€çŠ¶æ€ã€‚Vuexçš„æ ¸å¿ƒæ¦‚å¿µåŒ…æ‹¬`state`ã€`mutations`ã€`actions`å’Œ`getters`ã€‚

```javascript
import Vue from 'vue'
import Vuex from 'vuex'

Vue.use(Vuex)

export default new Vuex.Store({
  state: {
    user: null,
    movies: []
  },
  mutations: {
    setUser(state, user) {
      state.user = user
    },
    setMovies(state, movies) {
      state.movies = movies
    }
  },
  actions: {
    fetchMovies({ commit }) {
      // è°ƒç”¨APIè·å–ç”µå½±æ•°æ®
      const movies = []
      commit('setMovies', movies)
    }
  },
  getters: {
    getUser(state) {
      return state.user
    },
    getMovies(state) {
      return state.movies
    }
  }
})
```

### 8. å…¬å…±èµ„æº
#### 8.1 `src/common/css/style.css`
è¿™ä¸ªæ–‡ä»¶é€šå¸¸åŒ…å«ä¸€äº›å…¨å±€çš„CSSæ ·å¼ï¼Œæ¯”å¦‚å­—ä½“å›¾æ ‡ã€é¢œè‰²ã€å¸ƒå±€ç­‰ã€‚

```css
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
}
```

#### 8.2 `src/common/util/util.js`
è¿™ä¸ªæ–‡ä»¶åŒ…å«ä¸€äº›å…¬å…±çš„å·¥å…·æ–¹æ³•ï¼Œæ¯”å¦‚æ—¥æœŸæ ¼å¼åŒ–ã€å­—ç¬¦ä¸²å¤„ç†ç­‰ã€‚

```javascript
export function formatDate(date) {
  return new Date(date).toLocaleDateString()
}
```

### 9. é™æ€èµ„æº
#### 9.1 `static/css/reset.css`
è¿™ä¸ªæ–‡ä»¶é€šå¸¸ç”¨äºé‡ç½®æµè§ˆå™¨çš„é»˜è®¤æ ·å¼ï¼Œç¡®ä¿ä¸åŒæµè§ˆå™¨ä¸‹çš„ä¸€è‡´æ€§ã€‚

```css
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
```

#### 9.2 `static/css/adapter.css`
è¿™ä¸ªæ–‡ä»¶é€šå¸¸ç”¨äºå¤„ç†ä¸åŒå±å¹•å°ºå¯¸çš„è‡ªé€‚åº”æ ·å¼ã€‚

```css
@media screen and (max-width: 768px) {
  body {
    font-size: 14px;
  }
}
```

### 10. é¡¹ç›®æ„å»ºä¸é…ç½®
#### 10.1 `build` å’Œ `config` ç›®å½•
è¿™ä¸¤ä¸ªç›®å½•åŒ…å«äº†Webpackçš„é…ç½®æ–‡ä»¶å’ŒVue CLIçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºé¡¹ç›®çš„å¼€å‘å’Œæ‰“åŒ…ã€‚é€šå¸¸ä½ ä¸éœ€è¦ä¿®æ”¹è¿™äº›æ–‡ä»¶ï¼Œé™¤éä½ æœ‰ç‰¹æ®Šçš„æ„å»ºéœ€æ±‚ã€‚

### 11. ä¿®æ”¹é¡¹ç›®
ç°åœ¨ä½ å·²ç»å¯¹é¡¹ç›®çš„ç»“æ„æœ‰äº†åŸºæœ¬çš„äº†è§£ï¼Œæ¥ä¸‹æ¥ä½ å¯ä»¥æ ¹æ®éœ€æ±‚å¯¹é¡¹ç›®è¿›è¡Œä¿®æ”¹ã€‚æ¯”å¦‚ï¼š

- **æ·»åŠ æ–°é¡µé¢**ï¼šåœ¨`src/pages`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„Vueæ–‡ä»¶ï¼Œå¹¶åœ¨`src/router/index.js`ä¸­æ·»åŠ å¯¹åº”çš„è·¯ç”±é…ç½®ã€‚
- **ä¿®æ”¹æ ·å¼**ï¼šåœ¨`src/common/css/style.css`æˆ–`static/css/adapter.css`ä¸­ä¿®æ”¹å…¨å±€æ ·å¼ï¼Œæˆ–è€…åœ¨ç»„ä»¶å†…éƒ¨ä½¿ç”¨`<style>`æ ‡ç­¾æ·»åŠ å±€éƒ¨æ ·å¼ã€‚
- **æ·»åŠ æ–°åŠŸèƒ½**ï¼šåœ¨`src/components`ç›®å½•ä¸‹åˆ›å»ºæ–°çš„ç»„ä»¶ï¼Œå¹¶åœ¨é¡µé¢ä¸­å¼•å…¥å’Œä½¿ç”¨è¿™äº›ç»„ä»¶ã€‚

### 12. è¿è¡Œé¡¹ç›®
åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š

```bash
npm install
npm run dev
```

è¿™å°†å¯åŠ¨ä¸€ä¸ªæœ¬åœ°å¼€å‘æœåŠ¡å™¨ï¼Œä½ å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—®`http://localhost:8080`æ¥æŸ¥çœ‹é¡¹ç›®ã€‚

### 13. æ‰“åŒ…é¡¹ç›®
å½“ä½ å®Œæˆå¼€å‘åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†é¡¹ç›®æ‰“åŒ…ï¼š

```bash
npm run build
```

æ‰“åŒ…åçš„æ–‡ä»¶ä¼šç”Ÿæˆåœ¨`dist`ç›®å½•ä¸‹ï¼Œä½ å¯ä»¥å°†è¿™äº›æ–‡ä»¶éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šã€‚

### æ€»ç»“
é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ åº”è¯¥å·²ç»å¯¹è¿™ä¸ªåŸºäºVueçš„ç”µå½±è®¢ç¥¨ç³»ç»Ÿé¡¹ç›®æœ‰äº†å…¨é¢çš„äº†è§£ã€‚æ¥ä¸‹æ¥ï¼Œä½ å¯ä»¥æ ¹æ®éœ€æ±‚å¯¹é¡¹ç›®è¿›è¡Œä¿®æ”¹å’Œæ‰©å±•ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–éœ€è¦è¿›ä¸€æ­¥çš„å¸®åŠ©ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ï¼







# ä¿®æ”¹æ–¹æ¡ˆ

åœ¨ä½ çš„ Vue é¡¹ç›®ç»“æ„ä¸­ï¼Œ`components` å’Œ `pages` ç›®å½•çš„ä¸»è¦åŒºåˆ«åœ¨äº **ç”¨é€”** å’Œ **ç²’åº¦**ï¼Œå®ƒä»¬çš„é€»è¾‘å…³ç³»å¦‚ä¸‹ï¼š

------

## **1. `components` ç›®å½•ï¼ˆç»„ä»¶ï¼‰**

- **ä½œç”¨**ï¼šå­˜æ”¾ **å¯å¤ç”¨çš„å°å‹ UI ç»„ä»¶**ï¼Œè¿™äº›ç»„ä»¶ä¸€èˆ¬æ˜¯ **æ— çŠ¶æ€ï¼ˆstatelessï¼‰** æˆ– **å°‘çŠ¶æ€ï¼ˆstatefulï¼‰** çš„ï¼Œåªå…³æ³¨ UI å’Œäº¤äº’ï¼Œä¸è´Ÿè´£é¡µé¢é€»è¾‘ã€‚
- ç‰¹ç‚¹ï¼š
  - ç»„ä»¶æ˜¯ **å¯å¤ç”¨çš„**ï¼Œå¤šä¸ªé¡µé¢å¯èƒ½éƒ½ä¼šç”¨åˆ°ç›¸åŒçš„ç»„ä»¶ã€‚
  - ç»„ä»¶é€šå¸¸æ˜¯ **åŠŸèƒ½æ¨¡å—**ï¼Œä¾‹å¦‚æŒ‰é’®ã€å¯¼èˆªæ ã€å¡ç‰‡ã€å¼¹çª—ç­‰ã€‚
  - ç»„ä»¶æœ¬èº« **ä¸ä¼šæˆä¸ºä¸€ä¸ªå•ç‹¬çš„è·¯ç”±**ï¼Œè€Œæ˜¯è¢« `pages` é‡Œçš„é¡µé¢å¼•ç”¨ã€‚
  - ç»„ä»¶ä¸€èˆ¬é€šè¿‡ **props æ¥æ”¶æ•°æ®**ï¼Œæˆ–è€…åœ¨å†…éƒ¨ç®¡ç†å°èŒƒå›´çš„çŠ¶æ€ã€‚

### **ç»„ä»¶åˆ†ç±»**

| ç»„ä»¶å         | ä½œç”¨                                         |
| -------------- | -------------------------------------------- |
| `TabBar`       | åº•éƒ¨å¯¼èˆªæ                                    |
| `MovieItem`    | å•ä¸ªç”µå½±æ¡ç›®                                 |
| `MovieDetail`  | ç”µå½±è¯¦æƒ…ç»„ä»¶ï¼ˆåŒ…å« `CommentPanel` å½±è¯„ç»„ä»¶ï¼‰ |
| `CinemaDetail` | å½±é™¢è¯¦æƒ…ç»„ä»¶                                 |
| `SelectCinema` | å½±é™¢é€‰æ‹©ç»„ä»¶                                 |
| `SelectSeat`   | é€‰åº§ç»„ä»¶                                     |
| `SubmitOrder`  | è®¢å•æäº¤ç»„ä»¶                                 |
| `Pay`          | æ”¯ä»˜ç»„ä»¶                                     |
| `DatePicker`   | æ—¥æœŸé€‰æ‹©å™¨                                   |
| `Login`        | ç™»å½•ç»„ä»¶                                     |

âœ… **ç¤ºä¾‹**

```vue
<!-- MovieItem.vue -->
<template>
  <div class="movie-item">
    <img :src="movie.poster" alt="movie poster" />
    <h3>{{ movie.title }}</h3>
    <p>{{ movie.genre }}</p>
  </div>
</template>

<script>
export default {
  props: {
    movie: Object, // æ¥æ”¶ç”µå½±æ•°æ®
  }
}
</script>
```

> è¿™ä¸ªç»„ä»¶**åªå…³æ³¨ç”µå½±çš„å±•ç¤º**ï¼Œå¯ä»¥è¢« `Movie.vue` æˆ– `Home.vue` å¤ç”¨ã€‚

------

## **2. `pages` ç›®å½•ï¼ˆé¡µé¢ï¼‰**

- **ä½œç”¨**ï¼šå­˜æ”¾ **é¡µé¢çº§ç»„ä»¶**ï¼Œè¿™äº›ç»„ä»¶é€šå¸¸**å¯¹åº”ä¸€ä¸ªè·¯ç”±**ï¼Œä¾‹å¦‚ `/home`ã€`/movie`ã€`/cinema`ã€‚
- ç‰¹ç‚¹ ï¼š
  - `pages` ä¸‹çš„ç»„ä»¶æ˜¯ **è·¯ç”±ç»„ä»¶**ï¼Œæ„å‘³ç€å®ƒä»¬åœ¨ `router/index.js` é‡Œè¢«å®šä¹‰ä¸ºä¸€ä¸ªé¡µé¢è·¯å¾„ã€‚
  - é¡µé¢ç»„ä»¶é€šå¸¸ä¼š **å¼•ç”¨å¤šä¸ª `components` é‡Œçš„ç»„ä»¶**ï¼Œç»„åˆæˆå®Œæ•´çš„é¡µé¢ç»“æ„ã€‚
  - é¡µé¢ç»„ä»¶é€šå¸¸æ˜¯ **æœ‰çŠ¶æ€çš„ï¼ˆstatefulï¼‰**ï¼Œå®ƒä»¬å¯èƒ½ä» `Vuex` æˆ– **API** è·å–æ•°æ®ï¼Œå¹¶ä¸”ç®¡ç†è‡ªèº«çš„ UI é€»è¾‘ã€‚

### **é¡µé¢åˆ†ç±»**

| é¡µé¢å               | ä½œç”¨           |
| -------------------- | -------------- |
| `Home.vue`           | ä¸»é¡µ           |
| `Movie.vue`          | ç”µå½±é¡µ         |
| `Cinema.vue`         | å½±é™¢é¡µ         |
| `My.vue`             | ä¸ªäººä¸­å¿ƒé¡µ     |
| `SearchAll.vue`      | å…¨å±€æœç´¢é¡µ     |
| `SearchMovie.vue`    | ç”µå½±æœç´¢é¡µ     |
| `SearchCinema.vue`   | å½±é™¢æœç´¢é¡µ     |
| `MyInfo.vue`         | ä¸ªäººä¿¡æ¯é¡µ     |
| `MyMovie.vue`        | æ”¶è—ç”µå½±é¡µ     |
| `MyOrder.vue`        | è®¢å•ç®¡ç†é¡µ     |
| `ModifyUserName.vue` | ä¿®æ”¹ç”¨æˆ·åé¡µ   |
| `ModifyUserSign.vue` | ä¿®æ”¹ç”¨æˆ·ç­¾åé¡µ |

âœ… **ç¤ºä¾‹**

```vue
<!-- Home.vue -->
<template>
  <div class="home">
    <TabBar /> <!-- å¤ç”¨ç»„ä»¶ -->
    <MovieItem v-for="movie in movies" :key="movie.id" :movie="movie" />
  </div>
</template>

<script>
import TabBar from '@/components/TabBar/TabBar';
import MovieItem from '@/components/MovieItem/MovieItem';

export default {
  components: { TabBar, MovieItem },
  data() {
    return {
      movies: [] // é¡µé¢çŠ¶æ€
    };
  },
  created() {
    // è¿™é‡Œå¯ä»¥è°ƒç”¨ API è·å–ç”µå½±æ•°æ®
  }
};
</script>
```

> è¿™ä¸ª `Home.vue` é¡µé¢ä½¿ç”¨äº† `TabBar` å’Œ `MovieItem` ç»„ä»¶ï¼Œå¹¶ä¸”ä¼šç®¡ç† `movies` çš„æ•°æ®çŠ¶æ€ã€‚

------

## **3. `components` å’Œ `pages` çš„é€»è¾‘å…³ç³»**

- `pages` è´Ÿè´£é¡µé¢é€»è¾‘ï¼Œå®ƒä»¬**å¯ä»¥å¼•ç”¨å¤šä¸ª `components` ç»„ä»¶**ã€‚
- `components` ä»…ä»…æ˜¯**UI ç»„ä»¶**ï¼Œä¸€èˆ¬ä¸ä¼šè‡ªå·±ç®¡ç†å…¨å±€æ•°æ®ï¼Œè€Œæ˜¯**ç”± `pages` ä¼ å…¥æ•°æ®**ã€‚
- `pages` **é€šå¸¸å’Œ `router/index.js` ç›¸å…³è”**ï¼Œè€Œ `components` **ä¸ä¼šå‡ºç°åœ¨ `router/index.js` é‡Œ**ï¼Œå› ä¸ºå®ƒä»¬åªæ˜¯é¡µé¢çš„å­ç»„ä»¶ã€‚

### **å…³ç³»ç¤ºæ„å›¾**

```
Home.vue (é¡µé¢)
 â”œâ”€â”€ TabBar.vue (ç»„ä»¶)
 â”œâ”€â”€ MovieItem.vue (ç»„ä»¶)
 â”œâ”€â”€ å…¶ä»–å°ç»„ä»¶...
```

------

## **4. ä»€ä¹ˆæ—¶å€™åº”è¯¥æ”¾åˆ° `components` è€Œä¸æ˜¯ `pages`ï¼Ÿ**

âœ… **åº”è¯¥æ”¾åˆ° `components` çš„æƒ…å†µ**

1. **å¤šä¸ªé¡µé¢éƒ½ä¼šç”¨åˆ°çš„ UI ç»„ä»¶**ï¼ˆä¾‹å¦‚ `TabBar`ï¼‰ã€‚
2. **å°è£…å¥½çš„å¯å¤ç”¨ç»„ä»¶**ï¼ˆä¾‹å¦‚ `MovieItem`ã€`DatePicker`ï¼‰ã€‚
3. **é¡µé¢çš„æŸä¸€éƒ¨åˆ†åŠŸèƒ½**ï¼ˆä¾‹å¦‚ `CommentPanel` å±äº `MovieDetail.vue`ï¼‰ã€‚

âœ… **åº”è¯¥æ”¾åˆ° `pages` çš„æƒ…å†µ**

1. **è¯¥ç»„ä»¶å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„è·¯ç”±**ï¼ˆä¾‹å¦‚ `/movie` å¯¹åº” `Movie.vue`ï¼‰ã€‚
2. **é¡µé¢çº§åˆ«çš„é€»è¾‘å’Œæ•°æ®**ï¼ˆä¾‹å¦‚ `Home.vue` éœ€è¦ä» API è·å–æ•°æ®ï¼‰ã€‚
3. **åŒ…å«å¤šä¸ª `components` ç»„ä»¶çš„å®Œæ•´é¡µé¢**ï¼ˆä¾‹å¦‚ `Cinema.vue` å¯èƒ½åŒ…å« `CinemaDetail`ï¼‰ã€‚

------

## **æ€»ç»“**

| å¯¹æ¯”é¡¹         | `components` ç›®å½•             | `pages` ç›®å½•                  |
| -------------- | ----------------------------- | ----------------------------- |
| **ä½œç”¨**       | å­˜æ”¾å¯å¤ç”¨ç»„ä»¶                | å­˜æ”¾è·¯ç”±é¡µé¢                  |
| **æ˜¯å¦æœ‰è·¯ç”±** | âŒ ä¸æ˜¯è·¯ç”±ç»„ä»¶                | âœ… æ˜¯è·¯ç”±ç»„ä»¶                  |
| **æ˜¯å¦å¯å¤ç”¨** | âœ… å¯åœ¨å¤šä¸ªé¡µé¢ä½¿ç”¨            | âŒ ä»…åœ¨å¯¹åº”çš„è·¯ç”±ä½¿ç”¨          |
| **æ•°æ®ç®¡ç†**   | âŒ ä¾èµ– `props` ä¼ å€¼           | âœ… å¯ä»¥ç®¡ç†é¡µé¢çŠ¶æ€å’Œ API è¯·æ±‚ |
| **ç¤ºä¾‹**       | `MovieItem.vue`ï¼Œ`TabBar.vue` | `Movie.vue`ï¼Œ`Home.vue`       |

------

## **5. æ‰©å±•ï¼šå¦‚æœæƒ³æ·»åŠ å…¨å±€æœç´¢çš„è¯­ä¹‰æœç´¢åŠŸèƒ½ï¼Œè¯¥æ”¾åœ¨å“ªï¼Ÿ**

- **æœç´¢æ¡†ç»„ä»¶** â†’ `components/SearchBar.vue`
- **æœç´¢ç»“æœç»„ä»¶** â†’ `components/SearchResult.vue`
- **æœç´¢é¡µé¢** â†’ `pages/Home/children/SearchAll.vue`
- **æœç´¢é€»è¾‘ï¼ˆBERT è¯­ä¹‰æœç´¢ï¼‰** â†’ `api/search.js`ï¼ˆå¦‚æœæ˜¯å‰ç«¯æœç´¢ï¼‰ï¼Œæˆ–è€…åç«¯ **API**

ä½ å¯ä»¥åœ¨ `SearchAll.vue` é‡Œè°ƒç”¨ `tensorflow.js` è¿›è¡Œæœç´¢ï¼Œç„¶åç”¨ `SearchResult.vue` ç»„ä»¶å±•ç¤ºç»“æœï¼š

```vue
<!-- SearchAll.vue -->
<template>
  <div>
    <SearchBar @search="handleSearch" />
    <SearchResult :movies="searchResults" />
  </div>
</template>

<script>
import SearchBar from '@/components/SearchBar.vue';
import SearchResult from '@/components/SearchResult.vue';

export default {
  components: { SearchBar, SearchResult },
  data() {
    return {
      searchResults: []
    };
  },
  methods: {
    handleSearch(query) {
      // è¿™é‡Œè°ƒç”¨ tensorflow.js è¿›è¡Œè¯­ä¹‰æœç´¢
    }
  }
};
</script>
```

> è¿™æ · `SearchAll.vue` ä½œä¸ºé¡µé¢ï¼Œè´Ÿè´£è°ƒç”¨æœç´¢é€»è¾‘ï¼Œè€Œ `SearchBar.vue` å’Œ `SearchResult.vue` ä½œä¸ºç»„ä»¶ï¼Œè´Ÿè´£ UI å±•ç¤ºã€‚

------

## **æœ€ç»ˆç»“è®º**

- **`components` æ˜¯å¯å¤ç”¨çš„ UI ç»„ä»¶ï¼Œ`pages` æ˜¯å®Œæ•´çš„é¡µé¢ç»„ä»¶**ã€‚
- **`components` è´Ÿè´£å±•ç¤ºï¼Œ`pages` è´Ÿè´£ç®¡ç†æ•°æ®å’Œé€»è¾‘**ã€‚
- **è¯­ä¹‰æœç´¢åŠŸèƒ½çš„ UI æ”¾åœ¨ `components`ï¼Œæœç´¢é€»è¾‘æ”¾åœ¨ `pages` æˆ– `api`ã€‚**

è¿™æ ·å¯ä»¥è®©ä½ çš„é¡¹ç›®ç»“æ„æ›´åŠ æ¸…æ™°ï¼Œæ–¹ä¾¿ç»´æŠ¤å’Œæ‰©å±•ï¼ğŸš€





# åç«¯index.jsæºä»£ç 

```javascript
const express = require('express')
const router = express.Router()
const conn = require('../db/db')
const svgCaptcha = require('svg-captcha')
const util = require('../util/util')
const multer = require('multer')

// ç”¨æˆ·API
let user = {}
/* GET home page. */
router.get('/', function (req, res, next) {
  res.render('index', { title: 'Express' })
})
//è·å–æ‰‹æœºéªŒè¯ç 
router.get('/api/getPhoneCode', function (req, res) {
  let phone = req.query.phone
  let phoneCode = util.randomCode(4)
  if (!phoneCode) {
    res.json({ error_code: 1, message: 'è·å–éªŒè¯ç å¤±è´¥' })
  } else {
    user[phone] = phoneCode
    res.json({ success_code: 200, data: phoneCode })
  }
})
//è·å–å›¾å½¢éªŒè¯ç 
router.get('/api/captcha', function (req, res) {
  let captcha = svgCaptcha.create({
    size: 4, // size of random string
    ignoreChars: '0o1i', // filter out some characters like 0o1i
    noise: 3, // number of noise lines
    color: true, //, characters will have distinct colors instead of grey, true if background option is set
    background: '#fff', // background color of the svg image
  })
  //ä¿å­˜å›¾å½¢éªŒè¯ç æ–‡æœ¬
  req.session.captcha = captcha.text.toLowerCase()
  //è¿”å›éªŒè¯ç æ•°æ®
  res.type('svg')
  res.status(200).send(captcha.data)
})
//æ‰‹æœºç™»å½•
router.post('/api/phoneLogin', function (req, res) {
  let phone = req.body.phone
  let phoneCode = req.body.phoneCode
  //åˆ¤æ–­æ‰‹æœºéªŒè¯ç æ˜¯å¦æ­£ç¡®
  if (user[phone] === phoneCode) {
    let sqlStr = 'SELECT * from t_user WHERE phone = ? LIMIT 1 ;'
    conn.query(sqlStr, [phone], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'è¯·æ±‚æ•°æ®å¤±è´¥' })
      } else {
        result = JSON.parse(JSON.stringify(result))
        //ç”¨æˆ·å­˜åœ¨
        if (result[0]) {
          req.session.userId = result[0].user_id
          res.cookie('user_id', result[0].user_id)
          res.json({ success_code: 200 })
        } else {
          //ç”¨æˆ·ä¸å­˜åœ¨
          let sqlStr =
            'INSERT INTO t_user(user_name,phone,avatar,password) VALUES(?,?,?,?)'
          let avatarSrc = '/images/avatar/monkey.png'
          conn.query(
            sqlStr,
            [phone, phone, avatarSrc, 123456],
            (error, result, field) => {
              if (error) {
                console.log(error)
                res.json({ error_code: 1, message: 'åˆ›å»ºç”¨æˆ·å¤±è´¥' })
              } else {
                res.cookie('user_id', result.insertId)
                res.json({ success_code: 200 })
              }
            },
          )
        }
      }
    })
  } else {
    res.json({ error_code: 1, message: 'éªŒè¯ç ä¸æ­£ç¡®' })
  }
})
//å¯†ç ç™»å½•
router.post('/api/pwdLogin', function (req, res) {
  let name = req.body.userName
  let pwd = req.body.password
  let captcha = req.body.captcha
  //åˆ¤æ–­éªŒè¯ç æ˜¯å¦æ­£ç¡®
  if (captcha.toLowerCase() !== req.session.captcha) {
    res.json({ error_code: 1, message: 'éªŒè¯ç ä¸æ­£ç¡®' })
  } else {
    delete req.session.captcha
    let sqlStr = 'SELECT * from t_user WHERE user_name =? LIMIT 1 ;'
    conn.query(sqlStr, [name], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'æŸ¥è¯¢ç”¨æˆ·å¤±è´¥' })
      } else {
        result = JSON.parse(JSON.stringify(result))
        if (result[0]) {
          if (result[0].password === pwd) {
            //ä¿å­˜ç”¨æˆ·id
            req.session.userId = result[0].user_id
            res.cookie('user_id', result[0].user_id)
            res.json({ success_code: 200 })
          } else {
            res.json({ error_code: 1, message: 'å¯†ç é”™è¯¯' })
          }
        } else {
          res.json({ error: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
        }
      }
    })
  }
})
//è·å–ç”¨æˆ·ä¿¡æ¯
router.get('/api/getUserInfo', function (req, res) {
  let userId = req.query.userId
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥' })
      } else {
        result = JSON.parse(JSON.stringify(result))
        if (result[0]) {
          res.json({ success_code: 200, data: result[0] })
        } else {
          res.json({ error_code: 1, message: 'ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨' })
        }
      }
    })
  }
})
//æ›´æ–°ç”¨æˆ·å¤´åƒ
router.post('/api/updateUserAvatar', function (req, res) {
  let { userId, avatar } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      } else {
        //æ›´æ–°æ•°æ®åº“
        let sqlStr = 'UPDATE t_user SET avatar = ? WHERE user_id = ?;'
        conn.query(sqlStr, [avatar, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·å¤´åƒå¤±è´¥' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//æ›´æ–°ç”¨æˆ·å
router.post('/api/updateUserName', function (req, res) {
  let { userId, userName } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      } else {
        sqlStr =
          'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1 ;'
        conn.query(sqlStr, [userName, userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: 'ç”¨æˆ·åå·²å­˜åœ¨ï¼' })
            } else {
              //æ›´æ–°æ•°æ®åº“
              let sqlStr = 'UPDATE t_user SET user_name = ? WHERE user_id = ?;'
              conn.query(sqlStr, [userName, userId], (error, result, field) => {
                if (error) {
                  res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·åå¤±è´¥' })
                } else {
                  res.json({ success_code: 200 })
                }
              })
            }
          }
        })
      }
    })
  }
})
//æ›´æ–°ç”¨æˆ·æ€§åˆ«
router.post('/api/updateUserSex', function (req, res) {
  let { userId, sex } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      } else {
        //æ›´æ–°æ•°æ®åº“
        let sqlStr = 'UPDATE t_user SET sex = ? WHERE user_id = ?;'
        conn.query(sqlStr, [sex, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·æ€§åˆ«å¤±è´¥' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//æ›´æ–°ç”¨æˆ·ç”Ÿæ—¥
router.post('/api/updateUserBirthday', function (req, res) {
  let { userId, birthday } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      } else {
        //æ›´æ–°æ•°æ®åº“
        let sqlStr = 'UPDATE t_user SET birthday = ? WHERE user_id = ?;'
        conn.query(sqlStr, [birthday, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·ç”Ÿæ—¥å¤±è´¥' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//æ›´æ–°ç”¨æˆ·ç­¾å
router.post('/api/updateUserSign', function (req, res) {
  let { userId, sign } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      } else {
        //æ›´æ–°æ•°æ®åº“
        let sqlStr = 'UPDATE t_user SET sign = ? WHERE user_id = ?;'
        conn.query(sqlStr, [sign, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·ç­¾åå¤±è´¥' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//æ›´æ–°ç”¨æˆ·ä¿¡æ¯
router.post('/api/updateUserInfo', function (req, res) {
  let { userId, userName, avatar, password, sex, sign, birthday } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      } else {
        sqlStr =
          'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1 ;'
        conn.query(sqlStr, [userName, userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: 'ç”¨æˆ·åå·²å­˜åœ¨ï¼' })
            } else {
              //æ›´æ–°æ•°æ®åº“
              let sqlStr =
                'UPDATE t_user SET user_name = ?,avatar = ?,password = ?,sex = ? ,birthday = ?,sign = ?WHERE user_id = ?;'
              conn.query(
                sqlStr,
                [userName, avatar, password, sex, birthday, sign, userId],
                (error, result, field) => {
                  if (error) {
                    res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥' })
                  } else {
                    res.json({ success_code: 200 })
                  }
                },
              )
            }
          }
        })
      }
    })
  }
})
//åŠ è½½ç”µå½±åˆ—è¡¨
router.get('/api/getMovieList', function (req, res) {
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'è·å–ç”µå½±åˆ—è¡¨å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        // result = result.filter((value)=>{
        //   return new Date(value.show_date+','+value.show_time)-new Date()>0;
        // });
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['movie_id'] === result[j]['movie_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
        res.json({ success_code: 200, data: result })
      } else {
        res.json({ error_code: 1, message: 'ç”µå½±åˆ—è¡¨ä¸ºç©º' })
      }
    }
  })
})
//åŠ è½½ç”µå½±è¯¦ç»†ä¿¡æ¯
router.get('/api/getMovieDetail', function (req, res) {
  let movieId = req.query.movieId
  let sqlStr = 'SELECT * FROM t_movie WHERE movie_id = ? LIMIT 1;'
  conn.query(sqlStr, [movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: 'è·å–ç”µå½±ä¿¡æ¯å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result })
      } else {
        res.json({ error_code: 1, message: 'è¯¥ç”µå½±ä¸å­˜åœ¨' })
      }
    }
  })
})
//æ˜¯å¦æƒ³çœ‹ç”µå½±
router.post('/api/isWishMovie', function (req, res) {
  let { userId, movieId } = req.body
  let sqlStr =
    'SELECT * FROM t_wishmovie WHERE user_id = ? AND movie_id = ? LIMIT 1;'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200 })
      } else {
        res.json({ error_code: 1, message: 'ä¸æƒ³çœ‹' })
      }
    }
  })
})
//æƒ³çœ‹ç”µå½±
router.post('/api/wishMovie', function (req, res) {
  let { userId, movieId } = req.body
  let sqlStr = 'INSERT INTO t_wishmovie(user_id,movie_id) VALUES(?,?)'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
    } else {
      let sqlStr = 'SELECT wish_num from t_movie WHERE movie_id = ? LIMIT 1;'
      conn.query(sqlStr, [movieId], (error, result, field) => {
        if (error) {
          res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
        } else {
          result = JSON.parse(JSON.stringify(result))
          if (result[0]) {
            //æ›´æ–°æ•°æ®åº“
            let sqlStr = 'UPDATE t_movie SET wish_num = ? WHERE movie_id = ?;'
            conn.query(
              sqlStr,
              [result[0].wish_num + 1, movieId],
              (error, result, field) => {
                if (error) {
                  res.json({ error_code: 1, message: 'æ›´æ–°ä¿¡æ¯å¤±è´¥' })
                } else {
                  res.json({ success_code: 200 })
                }
              },
            )
          }
        }
      })
    }
  })
})
//å–æ¶ˆæƒ³çœ‹ç”µå½±
router.post('/api/cancelWishMovie', function (req, res) {
  let { userId, movieId } = req.body
  let sqlStr = 'DELETE FROM t_wishmovie WHERE user_id = ? AND movie_id =? ;'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
    } else {
      let sqlStr = 'SELECT wish_num from t_movie WHERE movie_id = ? LIMIT 1;'
      conn.query(sqlStr, [movieId], (error, result, field) => {
        if (error) {
          res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
        } else {
          result = JSON.parse(JSON.stringify(result))
          if (result[0]) {
            //æ›´æ–°æ•°æ®åº“
            let sqlStr = 'UPDATE t_movie SET wish_num = ? WHERE movie_id = ?;'
            conn.query(
              sqlStr,
              [result[0].wish_num - 1, movieId],
              (error, result, field) => {
                if (error) {
                  res.json({ error_code: 1, message: 'æ›´æ–°ä¿¡æ¯å¤±è´¥' })
                } else {
                  res.json({ success_code: 200 })
                }
              },
            )
          }
        }
      })
    }
  })
})
//è·å–å½“å‰ç”¨æˆ·è¯„è®º
router.get('/api/getUserComment', function (req, res) {
  let { userId, movieId } = req.query
  let sqlStr =
    'SELECT * FROM t_comment WHERE user_id = ? AND movie_id= ? LIMIT 1;'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: 'ç”¨æˆ·æœªè¯„è®º' })
      }
    }
  })
})
//è·å–æ‰€æœ‰ç”¨æˆ·é€šè¿‡å®¡æ ¸çš„è¯„è®º
router.get('/api/getAllUserPassComment', function (req, res) {
  let { movieId } = req.query
  let sqlStr =
    'SELECT * FROM t_user user INNER JOIN t_comment comment ON user.user_id = comment.user_id WHERE comment.movie_id = ? AND comment.is_pass = ? ;'
  conn.query(sqlStr, [movieId, 1], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result) {
        res.json({ success_code: 200, data: result })
      } else {
        res.json({ error_code: 1, message: 'æœªè¯„è®º' })
      }
    }
  })
})
//æ›´æ–°ç”¨æˆ·è¯„è®º
router.post('/api/updateUserComment', function (req, res) {
  let { userId, movieId, score, commentContent, commentDate } = req.body
  let sqlStr =
    'SELECT comment_id from t_comment WHERE user_id = ? AND movie_id = ? LIMIT 1'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        //è¯„è®ºå­˜åœ¨
        //æ›´æ–°
        let sqlStr =
          'UPDATE t_comment SET user_score = ?, comment_content = ?, comment_date = ?,support_num = ?,is_pass = ?,support_user = ? WHERE comment_id = ? ;'
        conn.query(
          sqlStr,
          [
            score,
            commentContent,
            commentDate,
            0,
            0,
            undefined,
            result[0].comment_id,
          ],
          (error, result, field) => {
            if (error) {
              res.json({ error_code: 1, message: 'æ›´æ–°è¯„è®ºå¤±è´¥' })
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      } else {
        //è¯„è®ºä¸å­˜åœ¨
        let sqlStr =
          'INSERT INTO t_comment(user_id,movie_id,user_score,comment_content,comment_date,support_num,is_pass) VALUES(?,?,?,?,?,?,?)'
        conn.query(
          sqlStr,
          [userId, movieId, score, commentContent, commentDate, 0, 0],
          (error, result, field) => {
            if (error) {
              console.log(error)
              res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      }
    }
  })
})
//è·å–å½“å‰è¯„è®º
router.get('/api/getCommentByID', function (req, res) {
  let { commentId } = req.query
  let sqlStr = 'SELECT * FROM t_comment WHERE comment_id = ? LIMIT 1;'
  conn.query(sqlStr, [commentId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: 'ç”¨æˆ·æœªè¯„è®º' })
      }
    }
  })
})
//æ›´æ–°å½“å‰è¯„è®ºçš„ç”¨æˆ·ç‚¹èµ
router.post('/api/updateUserSupport', function (req, res) {
  let { commentId, supportNum, supportUser } = req.body
  let sqlStr =
    'UPDATE t_comment SET support_num = ? , support_user = ? WHERE comment_id = ?;'
  conn.query(
    sqlStr,
    [supportNum, supportUser, commentId],
    (error, result, field) => {
      if (error) {
        console.log(error)
        res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
      } else {
        res.json({ success_code: 200 })
      }
    },
  )
})
//åŠ è½½å½±é™¢åˆ—è¡¨
router.get('/api/getCinemaList', function (req, res) {
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_cinema ON t_schedule.cinema_id = t_cinema.cinema_id INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: 'è·å–å½±é™¢åˆ—è¡¨å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        // result = result.filter((value)=>{
        //   return new Date(value.show_date+','+value.show_time)-new Date()>0;
        // });
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['cinema_id'] === result[j]['cinema_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
      }
      res.json({ success_code: 200, data: result })
    }
  })
})
//åŠ è½½å½“å‰å½±é™¢è¯¦ç»†ä¿¡æ¯
router.get('/api/getCurrentCinemaDetail', function (req, res) {
  let cinemaId = req.query.cinemaId
  let sqlStr = 'SELECT * FROM t_cinema WHERE cinema_id = ? LIMIT 1;'
  conn.query(sqlStr, [cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'è·å–å½“å‰å½±é™¢ä¿¡æ¯å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: 'å½±é™¢ä¸å­˜åœ¨' })
      }
    }
  })
})
//åŠ è½½å½“å‰å½±é™¢æ’ç‰‡
router.get('/api/getCurrentCinemaMovieSchedule', function (req, res) {
  let cinemaId = req.query.cinemaId
  console.log(cinemaId)
  let sqlStr = 'SELECT * FROM t_schedule WHERE cinema_id = ?;'
  conn.query(sqlStr, [cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'è·å–å½“å‰å½±é™¢æ’ç‰‡ä¿¡æ¯å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result) {
        let tempMovieArr = []
        result.forEach((value) => {
          if (
            new Date() - new Date(value.show_date + ',' + value.show_time) <=
            0
          ) {
            tempMovieArr.push(value.movie_id)
          }
        })
        tempMovieArr = Array.from(new Set(tempMovieArr))
        let movieArray = []
        let movieScheduleArray = []
        tempMovieArr.forEach((value) => {
          sqlStr = 'SELECT * FROM t_movie WHERE movie_id = ? LIMIT 1;'
          conn.query(sqlStr, [value], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result[0]) {
                movieArray.push(result[0])
              }
            }
          })
          sqlStr =
            'SELECT * FROM t_schedule schedule INNER JOIN t_movie movie ON schedule.movie_id = movie.movie_id WHERE schedule.movie_id = ? AND schedule.cinema_id = ?;'
          conn.query(sqlStr, [value, cinemaId], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result) {
                movieScheduleArray.push(result)
              }
            }
          })
        })
        setTimeout(() => {
          res.json({
            success_code: 200,
            data: {
              hasMovieInfo: movieArray,
              movieScheduleInfo: movieScheduleArray,
            },
          })
        }, 500)
      } else {
        res.json({ error_code: 1, message: 'å½“å‰å½±é™¢æ’ç‰‡ä¿¡æ¯ä¸ºç©º' })
      }
    }
  })
})
//åŠ è½½å½“å‰å½±é™¢è¯¦ç»†ä¿¡æ¯
router.get('/api/getScheduleById', function (req, res) {
  let scheduleId = req.query.scheduleId
  let sqlStr = 'SELECT * FROM t_schedule WHERE schedule_id = ? LIMIT 1;'
  conn.query(sqlStr, [scheduleId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'è·å–å½“å‰æ’ç‰‡ä¿¡æ¯å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: 'æ’ç‰‡ä¿¡æ¯ä¸å­˜åœ¨' })
      }
    }
  })
})
//åŠ è½½å½“å‰å½±é™¢è¯¦ç»†ä¿¡æ¯
router.post('/api/updateScheduleSeat', function (req, res) {
  let { scheduleId, seatInfo } = req.body
  let sqlStr =
    'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ? LIMIT 1;'
  conn.query(sqlStr, [seatInfo, scheduleId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'æ›´æ–°æ’ç‰‡åº§ä½ä¿¡æ¯å¤±è´¥' })
    } else {
      res.json({ success_code: 200, data: result[0] })
    }
  })
})
//åŠ è½½å½“å‰ç”µå½±æ’ç‰‡
router.get('/api/getCurrentMovieSchedule', function (req, res) {
  let movieId = req.query.movieId
  let sqlStr = 'SELECT * FROM t_schedule WHERE movie_id = ?;'
  conn.query(sqlStr, [movieId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'è·å–å½“å‰å½±é™¢æ’ç‰‡ä¿¡æ¯å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result) {
        let tempDateArr = []
        result.forEach((value) => {
          if (
            new Date() - new Date(value.show_date + ',' + value.show_time) <=
            0
          ) {
            tempDateArr.push(value.show_date)
          }
        })
        tempDateArr = Array.from(new Set(tempDateArr))
        tempDateArr.sort((a, b) => {
          return new Date(a) - new Date(b)
        })
        let cinemaArray = []
        let cinemaScheduleArray = []
        tempDateArr.forEach((value) => {
          sqlStr = 'SELECT * FROM t_schedule WHERE show_date = ?'
          conn.query(sqlStr, [value], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result) {
                cinemaArray.push(result)
              }
            }
          })
          sqlStr =
            'SELECT * FROM t_schedule schedule INNER JOIN t_cinema cinema ON schedule.cinema_id = cinema.cinema_id WHERE schedule.movie_id = ? AND schedule.show_date = ?;'
          conn.query(sqlStr, [movieId, value], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result) {
                cinemaScheduleArray.push(result)
              }
            }
          })
        })
        setTimeout(() => {
          res.json({
            success_code: 200,
            data: {
              hasCinemaInfo: cinemaArray,
              cinemaScheduleInfo: cinemaScheduleArray,
            },
          })
        }, 500)
      } else {
        res.json({ error_code: 1, message: 'å½“å‰ç”µå½±æ’ç‰‡ä¿¡æ¯ä¸ºç©º' })
      }
    }
  })
})
//æ ¹æ®åå­—åŒ¹é…ç”µå½±
router.get('/api/matchMovieByName', function (req, res) {
  console.log('å¼€å§‹è¿›è¡Œç²¾å‡†æœç´¢ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼')
  let movieName = req.query.movieName
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id WHERE name LIKE ?;'
  conn.query(sqlStr, ['%' + movieName + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        // result = result.filter((value)=>{
        //   return new Date(value.show_date+','+value.show_time)-new Date()>0;
        // });
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['movie_id'] === result[j]['movie_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
      }
      res.json({ success_code: 200, data: result })
    }
  })
})

const { BertTokenizer } = require('bert-tokenizer')
const _ = require('lodash') // ç”¨äºå¤„ç†æ•°ç»„å’Œå¯¹è±¡çš„å·¥å…·åº“

// åŠ è½½è¯æ±‡è¡¨
const vocabUrl = 'node_modules/bert-tokenizer/assets/vocab.json'
const bertTokenizer = new BertTokenizer(vocabUrl, true)

// è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
function cosineSimilarity(vecA, vecB) {
  const dotProduct = _.sum(_.zipWith(vecA, vecB, (a, b) => a * b))
  const normA = Math.sqrt(_.sum(_.map(vecA, (a) => a * a)))
  const normB = Math.sqrt(_.sum(_.map(vecB, (b) => b * b)))
  if (normA === 0 || normB === 0) {
    return 0
  }
  return dotProduct / (normA * normB)
}

// è¯­ä¹‰æœç´¢ç”µå½±
// router.get('/api/semanticSearchMovie', async function (req, res) {
//   try {
//     const searchQuery = req.query.searchQuery // ç”¨æˆ·æœç´¢è¯

//     // å¯¹æœç´¢è¯è¿›è¡Œåˆ†è¯
//     const searchTokens = bertTokenizer.tokenize(searchQuery)

//     // æ„å»ºæœç´¢è¯çš„è¯é¢‘å‘é‡
//     const searchVector = []
//     const searchTokenCount = _.countBy(searchTokens)
//     for (let i = 0; i < bertTokenizer.vocab.length; i++) {
//       searchVector[i] = searchTokenCount[bertTokenizer.vocab[i]] || 0
//     }

//     // è·å–æ‰€æœ‰ç”µå½±çš„æè¿°ä¿¡æ¯
//     let sqlStr = 'SELECT movie_id, name, intro FROM t_movie;'
//     conn.query(sqlStr, async (error, movies) => {
//       if (error) {
//         console.error(error)
//         return res.json({ error_code: 1, message: 'æŸ¥è¯¢å¤±è´¥' })
//       }

//       const results = []
//       for (const movie of movies) {
//         const movieIntro = movie.intro
//         // å¯¹ç”µå½±æè¿°è¿›è¡Œåˆ†è¯
//         const movieTokens = bertTokenizer.tokenize(movieIntro)

//         // æ„å»ºç”µå½±æè¿°çš„è¯é¢‘å‘é‡
//         const movieVector = []
//         const movieTokenCount = _.countBy(movieTokens)
//         for (let i = 0; i < bertTokenizer.vocab.length; i++) {
//           movieVector[i] = movieTokenCount[bertTokenizer.vocab[i]] || 0
//         }

//         // è®¡ç®—æœç´¢è¯å’Œç”µå½±æè¿°çš„ä½™å¼¦ç›¸ä¼¼åº¦
//         const similarityScore = cosineSimilarity(searchVector, movieVector)

//         results.push({
//           movie_id: movie.movie_id,
//           name: movie.name,
//           intro: movie.intro,
//           score: similarityScore,
//         })
//       }

//       // æŒ‰ç›¸ä¼¼åº¦æ’åº
//       results.sort((a, b) => b.score - a.score)

//       // è¿‡æ»¤å‡ºç›¸ä¼¼åº¦å¤§äº 0 çš„ç»“æœ
//       const filteredResults = results.filter((result) => result.score > 0)

//       res.json({
//         success_code: 200,
//         data: filteredResults,
//       })
//     })
//   } catch (error) {
//     console.error('è¯­ä¹‰æœç´¢é”™è¯¯:', error)
//     res.json({
//       error_code: 1,
//       message: 'æœç´¢å¤„ç†å¤±è´¥',
//     })
//   }
// })
// è¯­ä¹‰æœç´¢ç”µå½±
router.get('/api/semanticSearchMovie', async function (req, res) {
  console.log('å¼€å§‹è¿›è¡Œè¯­ä¹‰æœç´¢ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼')
  try {
    const searchQuery = req.query.searchQuery // ç”¨æˆ·æœç´¢è¯
    console.log('ç”¨æˆ·æœç´¢è¯:', searchQuery)

    // å¯¹æœç´¢è¯è¿›è¡Œå‘é‡åŒ–
    const searchVector =
      bertTokenizer.convertSingleExample(searchQuery).inputIds
    console.log('æœç´¢è¯å‘é‡:', searchVector)

    // è·å–æ‰€æœ‰ç”µå½±çš„æè¿°ä¿¡æ¯
    const sqlStr =
      'SELECT movie_id, name, intro, movieName_vector, movieIntro_vector, movieLabel_vector FROM t_movie;'
    console.log('æ‰§è¡Œ SQL æŸ¥è¯¢:', sqlStr)

    const movies = await new Promise((resolve, reject) => {
      conn.query(sqlStr, (error, results) => {
        if (error) {
          reject(error)
        } else {
          resolve(results)
        }
      })
    })
    // console.log('è·å–ç”µå½±æ•°æ®æˆåŠŸï¼Œå…±', movies.length, 'æ¡è®°å½•')

    const results = []
    for (const movie of movies) {
      console.log('å¤„ç†ç”µå½±:', movie.name)

      // å¯¹ç”µå½±çš„ä¸‰ä¸ªå‘é‡ï¼ˆmovieName_vector, movieIntro_vector, movieLabel_vectorï¼‰åˆ†åˆ«è®¡ç®—ç›¸ä¼¼åº¦
      const movieNameVector = JSON.parse(movie.movieName_vector || '[]')
      const movieIntroVector = JSON.parse(movie.movieIntro_vector || '[]')
      const movieLabelVector = JSON.parse(movie.movieLabel_vector || '[]')

      // console.log('ç”µå½±åç§°å‘é‡:', movieNameVector)
      // console.log('ç”µå½±ç®€ä»‹å‘é‡:', movieIntroVector)
      // console.log('ç”µå½±æ ‡ç­¾å‘é‡:', movieLabelVector)

      // è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
      const nameSimilarity = cosineSimilarity(searchVector, movieNameVector)
      const introSimilarity = cosineSimilarity(searchVector, movieIntroVector)
      const labelSimilarity = cosineSimilarity(searchVector, movieLabelVector)

      // console.log('åç§°ç›¸ä¼¼åº¦:', nameSimilarity)
      // console.log('ç®€ä»‹ç›¸ä¼¼åº¦:', introSimilarity)
      // console.log('æ ‡ç­¾ç›¸ä¼¼åº¦:', labelSimilarity)

      // ç»¼åˆç›¸ä¼¼åº¦ï¼ˆå–æœ€å¤§å€¼æˆ–å¹³å‡å€¼ï¼‰
      // const similarityScore = Math.max(
      //   nameSimilarity,
      //   introSimilarity,
      //   labelSimilarity,
      // )
      const similarityScore =
        0.0 * nameSimilarity + 0.3 * introSimilarity + 0.0 * labelSimilarity
      // console.log('ç»¼åˆç›¸ä¼¼åº¦:', similarityScore)

      results.push({
        movie_id: movie.movie_id,
        name: movie.name,
        intro: movie.intro,
        score: similarityScore,
      })
    }

    // æŒ‰ç›¸ä¼¼åº¦æ’åº
    results.sort((a, b) => b.score - a.score)
    console.log('æ’åºåçš„ç»“æœ:', results)

    // è·å– top10 ç»“æœ
    const top10Results = results.slice(0, 10)
    // console.log('Top10 ç»“æœ:', top10Results)

    // å»é‡ï¼ˆæ ¹æ® movie_idï¼‰
    const uniqueResults = _.uniqBy(top10Results, 'movie_id')
    // console.log('å»é‡åçš„ç»“æœ:', uniqueResults)

    // è·å– top10 ç”µå½± ID
    const movieIds = uniqueResults.map((movie) => movie.movie_id)
    console.log('Top10 ç”µå½± ID:', movieIds)

    // æ ¹æ®ç”µå½± ID æŸ¥è¯¢å®Œæ•´è¡Œæ•°æ®
    const finalSqlStr = `
  SELECT * FROM t_schedule
  INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id
  WHERE t_schedule.movie_id IN (?);
`
    // console.log('æ‰§è¡Œæœ€ç»ˆ SQL æŸ¥è¯¢:', finalSqlStr)

    const finalResults = await new Promise((resolve, reject) => {
      conn.query(finalSqlStr, [movieIds], (error, results) => {
        if (error) {
          reject(error)
        } else {
          resolve(results)
        }
      })
    })
    console.log('è·å–å®Œæ•´è¡Œæ•°æ®æˆåŠŸï¼Œå…±', finalResults.length, 'æ¡è®°å½•')

    const finalSortedResults = _.sortBy(finalResults, (movie) =>
      movieIds.indexOf(movie.movie_id),
    )
    res.json({ success_code: 200, data: finalSortedResults })
  } catch (error) {
    console.error('è¯­ä¹‰æœç´¢é”™è¯¯:', error)
    res.json({ error_code: 1, message: 'æœç´¢å¤„ç†å¤±è´¥' })
  }
})

router.get('/api/matchCinemaByName', function (req, res) {
  let cinemaName = req.query.cinemaName
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_cinema ON t_schedule.cinema_id = t_cinema.cinema_id INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id WHERE cinema_name LIKE ?;'
  conn.query(sqlStr, ['%' + cinemaName + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        // result = result.filter((value)=>{
        //   return new Date(value.show_date+','+value.show_time)-new Date()>0;
        // });
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['cinema_id'] === result[j]['cinema_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
      }
      res.json({ success_code: 200, data: result })
    }
  })
})
//ç”¨æˆ·ä¸‹å•
router.post('/api/order', function (req, res) {
  let {
    userId,
    scheduleId,
    orderPhone,
    orderDate,
    ticketNum,
    totalPrice,
    orderSeatInfo,
    payType,
  } = req.body
  let phoneCode = util.randomCode(6)
  let sqlStr =
    'INSERT INTO t_order(user_id,schedule_id,order_phone,order_date,ticket_num,ticket_total_price,order_seat_info,pay_type,phone_code) VALUES(?,?,?,?,?,?,?,?,?); '
  conn.query(
    sqlStr,
    [
      userId,
      scheduleId,
      orderPhone,
      orderDate,
      ticketNum,
      totalPrice,
      orderSeatInfo,
      payType,
      phoneCode,
    ],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200, data: { phone_code: phoneCode } })
      }
    },
  )
})
//è·å–ä¸ªäººè®¢å•ä¿¡æ¯
router.get('/api/getOrderByUserId', function (req, res) {
  let userId = req.query.userId
  let sqlStr =
    'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE user_id = ?;'
  conn.query(sqlStr, [userId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//è·å–ä¸ªäººæƒ³çœ‹ç”µå½±
router.get('/api/getWishMovieByUserId', function (req, res) {
  let userId = req.query.userId
  let sqlStr =
    'SELECT * FROM t_wishmovie INNER JOIN t_movie ON t_wishmovie.movie_id = t_movie.movie_id WHERE user_id = ?;'
  conn.query(sqlStr, [userId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//è·å–ä¸ªäººçœ‹è¿‡çš„ç”µå½±
router.get('/api/getIsWatchedMovieByUserId', function (req, res) {
  let userId = req.query.userId
  let sqlStr =
    'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id WHERE user_id = ? AND is_pass = 1;'
  conn.query(sqlStr, [userId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})

//ç®¡ç†å‘˜API
//è·å–å½“å‰é¡µç”¨æˆ·

//å¯†ç ç™»å½•
router.post('/api/admin/login', function (req, res) {
  let name = req.body.name
  let password = req.body.password
  let sqlStr = 'SELECT * FROM t_admin WHERE name = ? LIMIT 1 ;'
  conn.query(sqlStr, [name, password], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: 'æŸ¥è¯¢ç”¨æˆ·å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        if (result[0].password === password) {
          //ä¿å­˜ç”¨æˆ·id
          req.session.adminId = result[0].admin_id
          res.cookie('admin_id', result[0].admin_id)
          res.json({ success_code: 200 })
        } else {
          res.json({ error_code: 1, message: 'å¯†ç é”™è¯¯' })
        }
      } else {
        res.json({ error: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      }
    }
  })
})
//è·å–ç”¨æˆ·ä¿¡æ¯
router.get('/api/admin/getAdminInfo', function (req, res) {
  let adminId = req.query.adminId
  let sqlStr = 'SELECT * FROM t_admin WHERE admin_id = ? LIMIT 1 ;'
  conn.query(sqlStr, [adminId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: 'æŸ¥è¯¢ç”¨æˆ·å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      }
    }
  })
})
router.get('/api/admin/getCurrentPageUser', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr = 'SELECT * FROM t_user WHERE user_name LIKE ? ORDER BY user_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_user WHERE user_name LIKE ? ORDER BY user_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})

var datatime = './public/images/avatar/'
//å°†å›¾ç‰‡æ”¾åˆ°æœåŠ¡å™¨
var storage = multer.diskStorage({
  // å¦‚æœä½ æä¾›çš„ destination æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½ éœ€è¦è´Ÿè´£åˆ›å»ºæ–‡ä»¶å¤¹
  destination: datatime,
  // //ç»™ä¸Šä¼ æ–‡ä»¶é‡å‘½åï¼Œè·å–æ·»åŠ åç¼€å
  filename: function (req, file, cb) {
    cb(null, new Date().getTime() + '.jpg')
  },
})
var upload = multer({
  storage: storage,
})
// let upload = multer({dest:'./public/images/avatar'}).any();
router.post('/api/admin/upLoadImg', upload.any(), function (req, res) {
  res.json({ success_code: 200, data: req.files })
  console.log(req.files)
})

//æ›´æ–°ç”¨æˆ·ä¿¡æ¯
router.post('/api/admin/updateUserInfo', function (req, res) {
  let { userId, userName, avatar, password, sex, phone, sign, birthday } =
    req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      } else {
        let sqlStr =
          'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1;'
        conn.query(sqlStr, [userName, userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: 'ç”¨æˆ·åå·²å­˜åœ¨ï¼' })
            } else {
              sqlStr =
                'SELECT * FROM t_user WHERE phone = ? AND user_id <> ? LIMIT 1;'
              conn.query(sqlStr, [phone, userId], (error, result, field) => {
                if (error) {
                  console.log(error)
                } else {
                  result = JSON.parse(JSON.stringify(result))
                  if (result[0]) {
                    res.json({ error_code: 1, message: 'æ‰‹æœºå·ç å·²æ³¨å†Œï¼' })
                  } else {
                    //æ›´æ–°æ•°æ®åº“
                    let sqlStr =
                      'UPDATE t_user SET user_name = ?,avatar = ?,password = ?,sex = ? ,phone = ?,birthday = ?,sign = ? WHERE user_id = ?;'
                    conn.query(
                      sqlStr,
                      [
                        userName,
                        avatar,
                        password,
                        sex,
                        phone,
                        birthday,
                        sign,
                        userId,
                      ],
                      (error, result, field) => {
                        if (error) {
                          res.json({
                            error_code: 1,
                            message: 'æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥',
                          })
                          console.log(error)
                        } else {
                          res.json({ success_code: 200 })
                        }
                      },
                    )
                  }
                }
              })
            }
          }
        })
      }
    })
  }
})
//åˆ é™¤ç”¨æˆ·ä¿¡æ¯
router.post('/api/admin/deleteUserInfo', function (req, res) {
  let { userId } = req.body
  if (userId) {
    let sqlStr =
      'SELECT t_schedule.schedule_id, t_schedule.seat_info,order_seat_info FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id WHERE user_id = ?'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        console.log(result)
        if (result) {
          result.forEach((value) => {
            let tempArr = []
            value.seat_info = JSON.parse(value.seat_info)
            value.order_seat_info = JSON.parse(value.order_seat_info)
            value.seat_info.forEach((v) => {
              if (value.order_seat_info.indexOf(v) === -1) {
                tempArr.push(v)
              }
            })
            tempArr = JSON.stringify(tempArr)
            sqlStr =
              'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ?;'
            conn.query(
              sqlStr,
              [tempArr, value.schedule_id],
              (error, result, field) => {
                if (error) {
                  console.log(error)
                }
              },
            )
          })
        }
        sqlStr = 'DELETE FROM t_user WHERE user_id =?'
        conn.query(sqlStr, [userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//æ·»åŠ ç”¨æˆ·ä¿¡æ¯
router.post('/api/admin/addUserInfo', function (req, res) {
  let { userName, avatar, phone, password, sex, sign, birthday } = req.body
  if (!avatar) {
    avatar = '/images/avatar/monkey.png'
  }
  let sqlStr = 'SELECT * FROM t_user WHERE user_name = ? LIMIT 1;'
  conn.query(sqlStr, [userName], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·åå·²å­˜åœ¨ï¼' })
      } else {
        sqlStr = 'SELECT * FROM t_user WHERE phone = ? LIMIT 1'
        conn.query(sqlStr, [phone], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: 'æ‰‹æœºå·ç å·²æ³¨å†Œï¼' })
            } else {
              sqlStr =
                'INSERT INTO t_user(user_name,avatar,phone,password,sex,sign,birthday) VALUES(?,?,?,?,?,?,?);'
              conn.query(
                sqlStr,
                [userName, avatar, phone, password, sex, sign, birthday],
                (error, result, field) => {
                  if (error) {
                    console.log(error)
                  } else {
                    res.json({ success_code: 200 })
                  }
                },
              )
            }
          }
        })
      }
    }
  })
})
//è·å–å½“å‰é¡µç”µå½±
router.get('/api/admin/getCurrentPageMovie', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr = 'SELECT * FROM t_movie WHERE name LIKE ? ORDER BY movie_id'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_movie WHERE name LIKE ? ORDER BY movie_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})

// å¼‚æ­¥å‡½æ•°ï¼šæ›´æ–°ç”µå½±çš„å‘é‡
async function updateMovieVectors(movieId, movieName, intro, type) {
  try {
    console.log(`å¼€å§‹æ›´æ–°ç”µå½± ID ${movieId} çš„å‘é‡...`)

    // ç”Ÿæˆå‘é‡
    console.log('ç”Ÿæˆ movieName_vector...')
    const movieNameVector = generateTextVector(movieName)
    console.log('ç”Ÿæˆ movieIntro_vector...')
    const movieIntroVector = generateTextVector(intro)
    console.log('ç”Ÿæˆ movieLabel_vector...')
    const movieLabelVector = generateTextVector(type)

    // æ›´æ–°æ•°æ®åº“
    console.log('å°†å‘é‡æ›´æ–°åˆ°æ•°æ®åº“...')
    const updateSqlStr =
      'UPDATE t_movie SET movieName_vector = ?, movieIntro_vector = ?, movieLabel_vector = ? WHERE movie_id = ?;'
    await new Promise((resolve, reject) => {
      conn.query(
        updateSqlStr,
        [
          JSON.stringify(movieNameVector),
          JSON.stringify(movieIntroVector),
          JSON.stringify(movieLabelVector),
          movieId,
        ],
        (error, result) => {
          if (error) {
            reject(error)
          } else {
            resolve(result)
          }
        },
      )
    })

    console.log(`ç”µå½± ID ${movieId} çš„å‘é‡æ›´æ–°æˆåŠŸ`)
  } catch (error) {
    console.error(`ç”µå½± ID ${movieId} çš„å‘é‡æ›´æ–°å¤±è´¥:`, error)
    throw error // æŠ›å‡ºé”™è¯¯ä»¥ä¾¿è°ƒç”¨æ–¹å¤„ç†
  }
}

//æ›´æ–°ç”µå½±ä¿¡æ¯
// æ›´æ–°ç”µå½±ä¿¡æ¯
router.post('/api/admin/updateMovieInfo', async function (req, res) {
  const {
    movieId,
    movieName,
    poster,
    director,
    actor,
    long,
    type,
    language,
    publicDate,
    intro,
  } = req.body

  try {
    console.log(`å¼€å§‹æ›´æ–°ç”µå½± ID ${movieId} çš„ä¿¡æ¯...`)

    // æ£€æŸ¥ç”µå½±åæ˜¯å¦å·²å­˜åœ¨
    console.log('æ£€æŸ¥ç”µå½±åæ˜¯å¦å·²å­˜åœ¨...')
    const checkSqlStr =
      'SELECT * FROM t_movie WHERE name = ? AND movie_id <> ? LIMIT 1;'
    const checkResult = await new Promise((resolve, reject) => {
      conn.query(checkSqlStr, [movieName, movieId], (error, result) => {
        if (error) {
          reject(error)
        } else {
          resolve(JSON.parse(JSON.stringify(result)))
        }
      })
    })

    if (checkResult.length > 0) {
      console.log('ç”µå½±åå·²å­˜åœ¨ï¼Œæ›´æ–°å¤±è´¥')
      return res.json({ error_code: 1, message: 'ç”µå½±åå·²å­˜åœ¨ï¼' })
    }

    // æ›´æ–°ç”µå½±åŸºæœ¬ä¿¡æ¯
    console.log('æ›´æ–°ç”µå½±åŸºæœ¬ä¿¡æ¯...')
    const updateSqlStr =
      'UPDATE t_movie SET name = ?, poster = ?, director = ?, actor = ?, movie_long = ?, type = ?, language = ?, public_date = ?, intro = ? WHERE movie_id = ?;'
    await new Promise((resolve, reject) => {
      conn.query(
        updateSqlStr,
        [
          movieName,
          poster,
          director,
          actor,
          long,
          type,
          language,
          publicDate,
          intro,
          movieId,
        ],
        (error, result) => {
          if (error) {
            reject(error)
          } else {
            resolve(result)
          }
        },
      )
    })

    // å¼‚æ­¥æ›´æ–°ç”µå½±å‘é‡
    console.log('å¼€å§‹å¼‚æ­¥æ›´æ–°ç”µå½±å‘é‡...')
    updateMovieVectors(movieId, movieName, intro, type)
      .then(() => {
        console.log(`ç”µå½± ID ${movieId} çš„å‘é‡æ›´æ–°å®Œæˆ`)
      })
      .catch((error) => {
        console.error(`ç”µå½± ID ${movieId} çš„å‘é‡æ›´æ–°å¤±è´¥:`, error)
      })

    console.log('ç”µå½±ä¿¡æ¯æ›´æ–°æˆåŠŸ')
    res.json({ success_code: 200, message: 'ç”µå½±ä¿¡æ¯æ›´æ–°æˆåŠŸ' })
  } catch (error) {
    console.error('æ›´æ–°ç”µå½±ä¿¡æ¯é”™è¯¯:', error)
    res.status(500).json({ error_code: 500, message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯' })
  }
})
// //æ·»åŠ ç”µå½±ä¿¡æ¯
// æ·»åŠ ç”µå½±ä¿¡æ¯
router.post('/api/admin/addMovieInfo', async function (req, res) {
  const {
    movieName,
    poster,
    director,
    actor,
    long,
    type,
    language,
    publicDate,
    intro,
  } = req.body

  try {
    console.log('å¼€å§‹æ–°å¢ç”µå½±...')

    // æ£€æŸ¥ç”µå½±åæ˜¯å¦å·²å­˜åœ¨
    console.log('æ£€æŸ¥ç”µå½±åæ˜¯å¦å·²å­˜åœ¨...')
    const checkSqlStr = 'SELECT * FROM t_movie WHERE name = ? LIMIT 1;'
    const checkResult = await new Promise((resolve, reject) => {
      conn.query(checkSqlStr, [movieName], (error, result) => {
        if (error) {
          reject(error)
        } else {
          resolve(JSON.parse(JSON.stringify(result)))
        }
      })
    })

    if (checkResult.length > 0) {
      console.log('ç”µå½±åå·²å­˜åœ¨ï¼Œæ–°å¢å¤±è´¥')
      return res.json({ error_code: 1, message: 'ç”µå½±åå·²å­˜åœ¨ï¼' })
    }

    // æ’å…¥ç”µå½±åŸºæœ¬ä¿¡æ¯
    console.log('æ’å…¥ç”µå½±åŸºæœ¬ä¿¡æ¯...')
    const insertSqlStr =
      'INSERT INTO t_movie(name, poster, director, actor, movie_long, type, language, public_date, intro) VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?);'
    const insertResult = await new Promise((resolve, reject) => {
      conn.query(
        insertSqlStr,
        [
          movieName,
          poster,
          director,
          actor,
          long,
          type,
          language,
          publicDate,
          intro,
        ],
        (error, result) => {
          if (error) {
            reject(error)
          } else {
            resolve(result)
          }
        },
      )
    })

    const movieId = insertResult.insertId // è·å–æ–°æ’å…¥çš„ç”µå½± ID
    console.log(`æ–°å¢ç”µå½±æˆåŠŸï¼Œç”µå½± ID: ${movieId}`)

    // å¼‚æ­¥æ›´æ–°ç”µå½±å‘é‡
    console.log('å¼€å§‹å¼‚æ­¥æ›´æ–°ç”µå½±å‘é‡...')
    updateMovieVectors(movieId, movieName, intro, type)
      .then(() => {
        console.log(`æ–°å¢ç”µå½± ID ${movieId} çš„å‘é‡æ›´æ–°å®Œæˆ`)
      })
      .catch((error) => {
        console.error(`æ–°å¢ç”µå½± ID ${movieId} çš„å‘é‡æ›´æ–°å¤±è´¥:`, error)
      })

    res.json({ success_code: 200, message: 'ç”µå½±æ–°å¢æˆåŠŸ', movieId })
  } catch (error) {
    console.error('æ–°å¢ç”µå½±é”™è¯¯:', error)
    res.status(500).json({ error_code: 500, message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯' })
  }
})
// ç”Ÿæˆæ–‡æœ¬çš„è¯é¢‘å‘é‡
function generateTextVector(text) {
  if (!text || typeof text !== 'string') {
    throw new Error('Invalid text input')
  }

  // ä½¿ç”¨ BERT åˆ†è¯å™¨å¤„ç†æ–‡æœ¬
  console.log('å¼€å§‹ä½¿ç”¨ BERT åˆ†è¯å™¨å¤„ç†æ–‡æœ¬')
  const tokenizedResult = bertTokenizer.convertSingleExample(text)

  // æ£€æŸ¥åˆ†è¯ç»“æœ
  if (!tokenizedResult || !tokenizedResult.inputIds) {
    throw new Error('Failed to tokenize text')
  }

  // ä½¿ç”¨ inputIds ä½œä¸ºå‘é‡
  const vector = tokenizedResult.inputIds

  // è¿”å›å‘é‡
  return vector
}

// å¼‚æ­¥å‡½æ•°ï¼šæ›´æ–°ç”µå½±çš„å‘é‡
async function updateMovieVectors(movieId, movieName, intro, type) {
  try {
    // ç”Ÿæˆå‘é‡
    const movieNameVector = generateTextVector(movieName)
    const movieIntroVector = generateTextVector(intro)
    const movieLabelVector = generateTextVector(type)

    // æ›´æ–°æ•°æ®åº“
    const updateSqlStr =
      'UPDATE t_movie SET movieName_vector = ?, movieIntro_vector = ?, movieLabel_vector = ? WHERE movie_id = ?;'
    await new Promise((resolve, reject) => {
      conn.query(
        updateSqlStr,
        [
          JSON.stringify(movieNameVector),
          JSON.stringify(movieIntroVector),
          JSON.stringify(movieLabelVector),
          movieId,
        ],
        (error, result) => {
          if (error) {
            reject(error)
          } else {
            resolve(result)
          }
        },
      )
    })

    console.log(`ç”µå½± ID ${movieId} çš„å‘é‡æ›´æ–°æˆåŠŸ`)
  } catch (error) {
    console.error(`ç”µå½± ID ${movieId} çš„å‘é‡æ›´æ–°å¤±è´¥:`, error)
    throw error // æŠ›å‡ºé”™è¯¯ä»¥ä¾¿è°ƒç”¨æ–¹å¤„ç†
  }
}

datatime = './public/images/movie/'
//å°†å›¾ç‰‡æ”¾åˆ°æœåŠ¡å™¨
storage = multer.diskStorage({
  // å¦‚æœä½ æä¾›çš„ destination æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½ éœ€è¦è´Ÿè´£åˆ›å»ºæ–‡ä»¶å¤¹
  destination: datatime,
  // //ç»™ä¸Šä¼ æ–‡ä»¶é‡å‘½åï¼Œè·å–æ·»åŠ åç¼€å
  filename: function (req, file, cb) {
    cb(null, new Date().getTime() + '.jpg')
  },
})
upload = multer({
  storage: storage,
})
router.post('/api/admin/upLoadMovieImg', upload.any(), function (req, res) {
  res.json({ success_code: 200, data: req.files })
  console.log(req.files)
})
//åˆ é™¤ç”µå½±ä¿¡æ¯
router.post('/api/admin/deleteMovieInfo', function (req, res) {
  let { movieId } = req.body
  let sqlStr = 'DELETE FROM t_movie WHERE movie_id =?'
  conn.query(sqlStr, [movieId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      res.json({ success_code: 200 })
    }
  })
})
//è·å–å½“å‰é¡µå½±é™¢
router.get('/api/admin/getCurrentPageCinema', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_cinema WHERE cinema_name LIKE ? ORDER BY cinema_id ;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_cinema WHERE cinema_name LIKE ? ORDER BY cinema_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//æ›´æ–°å½±é™¢ä¿¡æ¯
router.post('/api/admin/updateCinemaInfo', function (req, res) {
  let { cinemaId, cinemaName, cinemaPhone, address } = req.body
  if (cinemaId) {
    let sqlStr = 'SELECT * from t_cinema WHERE cinema_id = ? LIMIT 1;'
    conn.query(sqlStr, [cinemaId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        sqlStr =
          'SELECT * FROM t_cinema WHERE cinema_name = ? AND cinema_id <> ? LIMIT 1 ;'
        conn.query(sqlStr, [cinemaName, cinemaId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: 'å½±é™¢åå·²å­˜åœ¨ï¼' })
            } else {
              //æ›´æ–°æ•°æ®åº“
              let sqlStr =
                'UPDATE t_cinema SET cinema_name = ?,cinema_phone = ?,specified_address = ? WHERE cinema_id = ?;'
              conn.query(
                sqlStr,
                [cinemaName, cinemaPhone, address, cinemaId],
                (error, result, field) => {
                  if (error) {
                    res.json({ error_code: 1, message: 'æ›´æ–°å½±é™¢ä¿¡æ¯å¤±è´¥' })
                    console.log(error)
                  } else {
                    res.json({ success_code: 200 })
                  }
                },
              )
            }
          }
        })
      }
    })
  }
})
//åˆ é™¤å½±é™¢ä¿¡æ¯
router.post('/api/admin/deleteCinemaInfo', function (req, res) {
  let { cinemaId } = req.body
  if (cinemaId) {
    let sqlStr = 'DELETE FROM t_cinema WHERE cinema_id =?'
    conn.query(sqlStr, [cinemaId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200 })
      }
    })
  }
})
//æ·»åŠ å½±é™¢ä¿¡æ¯
router.post('/api/admin/addCinemaInfo', function (req, res) {
  let { cinemaName, cinemaPhone, address } = req.body
  sqlStr = 'SELECT * FROM t_cinema WHERE cinema_name = ? LIMIT 1 ;'
  conn.query(sqlStr, [cinemaName], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: 'å½±é™¢åå·²å­˜åœ¨ï¼' })
      } else {
        let sqlStr =
          'INSERT INTO t_cinema(cinema_name,cinema_phone,specified_address) VALUES(?,?,?);'
        conn.query(
          sqlStr,
          [cinemaName, cinemaPhone, address],
          (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      }
    }
  })
})
//è·å–å½“å‰é¡µè¯„è®º
router.get('/api/admin/getCurrentPageComment', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id INNER JOIN t_user ON t_user.user_id=t_comment.user_id WHERE t_movie.name LIKE ? ORDER BY comment_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id INNER JOIN t_user ON t_user.user_id=t_comment.user_id WHERE t_movie.name LIKE ? ORDER BY comment_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//é€šè¿‡å½“å‰è¯„è®º
router.post('/api/admin/passCurrentComment', function (req, res) {
  let commentId = req.body.commentId
  let movieId = req.body.movieId
  if (commentId) {
    let sqlStr = 'UPDATE t_comment SET is_pass = 1 WHERE comment_id = ?;'
    conn.query(sqlStr, [commentId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        sqlStr =
          'SELECT user_score FROM t_comment WHERE movie_id = ? AND is_pass = ?;'
        conn.query(sqlStr, [movieId, 1], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            let avgScore = 0
            if (result.length) {
              result.forEach((val) => {
                avgScore += Number(val.user_score)
              })
              avgScore = (avgScore / Number(result.length)).toFixed(1)
            }
            sqlStr = 'UPDATE t_movie SET score = ? WHERE movie_id = ?;'
            conn.query(sqlStr, [avgScore, movieId], (error, result, field) => {
              if (error) {
                console.log(error)
              } else {
                res.json({ success_code: 200 })
              }
            })
          }
        })
      }
    })
  }
})
//åˆ é™¤å½“å‰è¯„è®º
router.post('/api/admin/deleteCurrentComment', function (req, res) {
  let commentId = req.body.commentId
  let movieId = req.body.movieId
  if (commentId) {
    let sqlStr = 'DELETE FROM t_comment WHERE comment_id = ?;'
    conn.query(sqlStr, [commentId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        sqlStr =
          'SELECT user_score FROM t_comment WHERE movie_id = ? AND is_pass = ?;'
        conn.query(sqlStr, [movieId, 1], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            let avgScore = 0
            if (result.length) {
              result.forEach((val) => {
                avgScore += Number(val.user_score)
              })
              avgScore = (avgScore / Number(result.length)).toFixed(1)
            }
            sqlStr = 'UPDATE t_movie SET score = ? WHERE movie_id = ?;'
            conn.query(sqlStr, [avgScore, movieId], (error, result, field) => {
              if (error) {
                console.log(error)
              } else {
                res.json({ success_code: 200 })
              }
            })
          }
        })
      }
    })
  }
})
//è·å–å½“å‰é¡µè®¢å•
router.get('/api/admin/getCurrentPageOrder', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id INNER JOIN t_user ON t_order.user_id = t_user.user_id WHERE t_movie.name LIKE ? ORDER BY order_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id INNER JOIN t_user ON t_order.user_id = t_user.user_id WHERE t_movie.name LIKE ? ORDER BY order_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//åˆ é™¤è®¢å•
router.post('/api/admin/deleteOrder', function (req, res) {
  let { orderId, scheduleId, orderSeatInfo } = req.body
  if (orderId) {
    let sqlStr = 'SELECT seat_info FROM t_schedule WHERE schedule_id = ?'
    conn.query(sqlStr, [scheduleId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = result[0].seat_info
        result = JSON.parse(result)
        orderSeatInfo = JSON.parse(orderSeatInfo)
        console.log(typeof result)
        console.log(typeof orderSeatInfo)
        let tempArr = []
        result.forEach((value) => {
          if (orderSeatInfo.indexOf(value) === -1) {
            tempArr.push(value)
          }
        })
        console.log(tempArr)
        result = JSON.stringify(tempArr)
        sqlStr = 'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ?;'
        conn.query(sqlStr, [result, scheduleId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            sqlStr = 'DELETE FROM t_order WHERE order_id =?'
            conn.query(sqlStr, [orderId], (error, result, field) => {
              if (error) {
                console.log(error)
              } else {
                res.json({ success_code: 200 })
              }
            })
          }
        })
      }
    })
  }
})
//è·å–å½“å‰é¡µå½±å…
router.get('/api/admin/getCurrentPageHall', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_hall INNER JOIN t_cinema ON t_cinema.cinema_id = t_hall.cinema_id WHERE t_cinema.cinema_name LIKE ? ORDER BY hall_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_hall INNER JOIN t_cinema ON t_cinema.cinema_id = t_hall.cinema_id WHERE t_cinema.cinema_name LIKE ? ORDER BY hall_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//åˆ é™¤å½±å…
router.post('/api/admin/deleteHall', function (req, res) {
  let { cinemaId, hallName } = req.body
  if (cinemaId) {
    let sqlStr =
      'SELECT schedule_id FROM t_schedule WHERE cinema_id = ? AND hall_name = ?;'
    conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        console.log(result)
        if (result.length) {
          result.forEach((value) => {
            sqlStr = 'DELETE FROM t_schedule WHERE schedule_id = ?;'
            conn.query(sqlStr, [value.schedule_id], (error, result, field) => {
              if (error) {
                console.log(error)
              }
            })
          })
        }
        sqlStr = 'DELETE FROM t_hall WHERE cinema_id = ? AND name = ?'
        conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//æ›´æ–°å½±å…ä¿¡æ¯
router.post('/api/admin/updateHallInfo', function (req, res) {
  let { hallId, cinemaId, hallOldName, hallNewName } = req.body
  if (cinemaId) {
    let sqlStr =
      'SELECT * FROM t_hall WHERE name = ? AND cinema_id = ? AND hall_id <> ? LIMIT 1;'
    conn.query(
      sqlStr,
      [hallNewName, cinemaId, hallId],
      (error, result, field) => {
        if (error) {
          console.log(error)
        } else {
          result = JSON.parse(JSON.stringify(result))
          if (result[0]) {
            res.json({ error_code: 1, message: 'è¯¥å½±é™¢çš„å½±å…å·²å­˜åœ¨ï¼' })
          } else {
            sqlStr =
              'UPDATE t_schedule SET hall_name = ? WHERE cinema_id = ? AND hall_name = ?'
            conn.query(
              sqlStr,
              [hallNewName, cinemaId, hallOldName],
              (error, result, field) => {
                if (error) {
                  console.log(error)
                } else {
                  //æ›´æ–°æ•°æ®åº“
                  let sqlStr =
                    'UPDATE t_hall SET name = ? WHERE cinema_id = ? AND name = ?;'
                  conn.query(
                    sqlStr,
                    [hallNewName, cinemaId, hallOldName],
                    (error, result, field) => {
                      if (error) {
                        res.json({
                          error_code: 1,
                          message: 'æ›´æ–°å½±å½±å…ä¿¡æ¯å¤±è´¥',
                        })
                        console.log(error)
                      } else {
                        res.json({ success_code: 200 })
                      }
                    },
                  )
                }
              },
            )
          }
        }
      },
    )
  }
})
//è·å–æ‰€æœ‰å½±é™¢
router.get('/api/admin/getAllCinema', function (req, res) {
  let sqlStr = 'SELECT cinema_id,cinema_name FROM t_cinema;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//æ·»åŠ å½±å…ä¿¡æ¯
router.post('/api/admin/addHallInfo', function (req, res) {
  let { cinemaId, hallName } = req.body
  let sqlStr = 'SELECT * FROM t_hall WHERE name = ? AND cinema_id = ? LIMIT 1;'
  conn.query(sqlStr, [hallName, cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: 'è¯¥å½±é™¢çš„å½±å…å·²å­˜åœ¨ï¼' })
      } else {
        let sqlStr = 'INSERT INTO t_hall(cinema_id,name) VALUES(?,?);'
        conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    }
  })
})
//è·å–å½“å‰é¡µç”µå½±
router.get('/api/admin/getCurrentPageMovieSchedule', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE t_movie.name LIKE ? ORDER BY schedule_id '
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE t_movie.name LIKE ? ORDER BY schedule_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//è·å–æ‰€æœ‰ç”µå½±
router.get('/api/admin/getAllMovie', function (req, res) {
  let sqlStr = 'SELECT * FROM t_movie;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//è·å–å½±é™¢çš„å½±å…
router.get('/api/admin/getHallByCinemaId', function (req, res) {
  let cinemaId = req.query.cinemaId
  console.log(cinemaId)
  let sqlStr = 'SELECT hall_id,name FROM t_hall WHERE cinema_id = ?;'
  conn.query(sqlStr, [cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      console.log(result)
      res.json({ success_code: 200, data: result })
    }
  })
})
//è·å–æ’ç‰‡çš„æŸå¤©çš„æ—¶é—´æ®µå®‰æ’
router.get('/api/admin/getHasScheduleDateTime', function (req, res) {
  let { cinemaId, hallName, showDate } = req.query
  let sqlStr =
    'SELECT show_time FROM t_schedule WHERE cinema_id = ? AND hall_name = ? AND show_date = ?;'
  conn.query(sqlStr, [cinemaId, hallName, showDate], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//æ·»åŠ å½±é™¢ä¿¡æ¯
router.post('/api/admin/addScheduleInfo', function (req, res) {
  let { movieId, cinemaId, hallName, showDate, showTime, price } = req.body
  let sqlStr =
    'INSERT INTO t_schedule(movie_id,cinema_id,hall_name,show_date,show_time,price) VALUES(?,?,?,?,?,?);'
  conn.query(
    sqlStr,
    [movieId, cinemaId, hallName, showDate, showTime, price],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200 })
      }
    },
  )
})
//åˆ é™¤å½±å…
router.post('/api/admin/deleteMovieSchedule', function (req, res) {
  let { scheduleId } = req.body
  if (scheduleId) {
    let sqlStr = 'DELETE FROM t_schedule WHERE schedule_id = ?'
    conn.query(sqlStr, [scheduleId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200 })
      }
    })
  }
})
module.exports = router

```



# ç”¨æˆ·ç«¯å‰ç«¯ä»£ç 

```vue
<template>
  <div class="search-all">
    <div class="header">
      <div class="search">
        <span
          class="icon-dropdown-arrow"
          :class="{ 'arrow-open': isDropdownOpen }"
          @click="toggleDropdown"
          >&#9660;</span
        >
        <span class="icon-search"></span>
        <!-- ç»‘å®š placeholder åˆ°è®¡ç®—å±æ€§ -->
        <input type="text" :placeholder="getPlaceholder" v-model.trim="name" />
      </div>
      <div class="dropdown-menu" v-if="isDropdownOpen">
        <div class="dropdown-item">
          <input
            type="checkbox"
            id="search-movie"
            v-model="searchOptions.movie"
          />
          <label for="search-movie">æœç”µå½±</label>
        </div>
        <div class="dropdown-item">
          <input
            type="checkbox"
            id="search-cinema"
            v-model="searchOptions.cinema"
          />
          <label for="search-cinema">æœå½±é™¢</label>
        </div>
        <div class="dropdown-item">
          <input
            type="checkbox"
            id="fuzzy-search"
            v-model="searchOptions.fuzzy"
          />
          <label for="fuzzy-search">æ¨¡ç³Šæœç´¢</label>
        </div>
      </div>
      <span class="cancel-btn" @click="$router.go(-1)">å–æ¶ˆ</span>
    </div>
    <div class="content">
      <!-- åŸæœ‰å†…å®¹ -->
      <div class="movie-container" v-if="movieInfo.length">
        <div class="title">å½±ç‰‡</div>
        <movie-item :movie-list="movieInfo" :search-name="name"></movie-item>
      </div>
      <div class="cinema-container" v-if="cinemaInfo.length">
        <div class="title">å½±é™¢</div>
        <div
          class="item"
          v-for="(item, index) in cinemaInfo"
          :key="index"
          @click="
            $router.push({
              path: '/cinema_detail',
              query: { cinema_id: item.cinema_id }
            })
          "
        >
          <div class="left">
            <div
              class="name ellipsis"
              v-html="ruleName(item.cinema_name)"
            ></div>
            <div class="address ellipsis">{{ item.specified_address }}</div>
            <div class="label-block">
              <span>å°åƒ</span><span>4Då…</span><span>æœæ¯”å…¨æ™¯å£°å…</span
              ><span>å·¨å¹•å…</span>
            </div>
          </div>
        </div>
      </div>
      <div class="tips" v-if="name && !movieInfo.length && !cinemaInfo.length">
        <span class="icon icon-empty-content"></span>
        <span class="text">æš‚æ—¶æœ¨æœ‰å†…å®¹å‘€</span>
      </div>
    </div>
  </div>
</template>

<script>
import {
  matchCinemaByName,
  matchMovieByName,
  semanticSearchMovie,
} from "../../../api/index";
import MovieItem from "../../../components/MovieItem/MovieItem";

export default {
  name: "SearchAll",
  components: {
    MovieItem,
  },
  data() {
    return {
      name: "",
      movieInfo: [],
      cinemaInfo: [],
      server: "http://localhost:3000",
      timer: "",
      isDropdownOpen: false, // æ§åˆ¶ä¸‹æ‹‰èœå•æ˜¯å¦æ˜¾ç¤º
      searchOptions: {
        movie: true, // æœç”µå½±åˆå§‹å‹¾é€‰
        cinema: true, // æœå½±é™¢åˆå§‹å‹¾é€‰
        fuzzy: false, // æ¨¡ç³Šæœç´¢åˆå§‹ä¸å‹¾é€‰
      },
    };
  },
  methods: {
    toggleDropdown() {
      this.isDropdownOpen = !this.isDropdownOpen;
      if (this.isDropdownOpen) {
        clearTimeout(this.timer); // ä¸‹æ‹‰èœå•å±•å¼€æ—¶åœæ­¢æœç´¢
      }
    },
    closeDropdown() {
      this.isDropdownOpen = false;
    },
    handleClickOutside(event) {
      const dropdown = this.$el.querySelector(".dropdown-menu");
      const arrow = this.$el.querySelector(".icon-dropdown-arrow");
      if (
        dropdown &&
        !dropdown.contains(event.target) &&
        !arrow.contains(event.target)
      ) {
        this.closeDropdown();
      }
    },
    // åˆå¹¶ç²¾å‡†æœç´¢å’Œæ¨¡ç³Šæœç´¢çš„ç»“æœ
    async filterData() {
      if (this.isDropdownOpen) return; // ä¸‹æ‹‰èœå•å±•å¼€æ—¶ä¸è¿›è¡Œæœç´¢
      const keyword = this.name;
      this.movieInfo = [];
      this.cinemaInfo = [];

      // ç²¾å‡†æœç´¢
      if (this.searchOptions.movie) {
        let exactMovieResults = await matchMovieByName(keyword);
        if (exactMovieResults.success_code === 200) {
          this.movieInfo = exactMovieResults.data;
        }
      }

      // æ¨¡ç³Šæœç´¢
      if (this.searchOptions.fuzzy && this.searchOptions.movie) {
        let fuzzyMovieResults = await semanticSearchMovie(keyword);
        if (fuzzyMovieResults.success_code === 200) {
          // åˆå¹¶ç»“æœï¼Œå»é‡ï¼Œä¼˜å…ˆä¿ç•™ç²¾å‡†æœç´¢çš„ç»“æœ
          const exactMovieIds = new Set(this.movieInfo.map((movie) => movie.movie_id));
          fuzzyMovieResults.data.forEach((movie) => {
            if (!exactMovieIds.has(movie.movie_id)) {
              this.movieInfo.push(movie);
            }
          });
        }
      }

      // æœå½±é™¢é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
      if (this.searchOptions.cinema) {
        let json = await matchCinemaByName(keyword);
        if (json.success_code === 200) {
          this.cinemaInfo = json.data;
        }
      }
    },
  },
  watch: {
    async name(newVal, oldVal) {
      clearTimeout(this.timer);
      if (newVal) {
        this.timer = setTimeout(async () => {
          await this.filterData();
        }, 500);
      }
    },
    searchOptions: {
      deep: true,
      handler() {
        this.filterData();
      },
    },
  },
  computed: {
    ruleName() {
      return (nameString) => {
        let replaceReg = new RegExp(this.name, "g");
        let replaceString = `<span style="color: #dd2727">${this.name}</span>`;
        return nameString.replace(replaceReg, replaceString);
      };
    },
    // æ–°å¢è®¡ç®—å±æ€§ getPlaceholder
    getPlaceholder() {
      let searchType = this.searchOptions.fuzzy ? "ã€æ¨¡ç³Šã€‘" : "ã€ç²¾ç¡®ã€‘";
      let searchTarget = "1";
      if (this.searchOptions.movie && this.searchOptions.cinema) {
        searchTarget = "å½±ç‰‡ã€å½±é™¢";
      } else if (this.searchOptions.movie) {
        searchTarget = "å½±ç‰‡";
      } else if (this.searchOptions.cinema) {
        searchTarget = "å½±é™¢";
      }
      return `${searchType}æœ${searchTarget}`;
    },
  },
  mounted() {
    document.addEventListener("click", this.handleClickOutside);
  },
  beforeDestroy() {
    document.removeEventListener("click", this.handleClickOutside);
  },
};
</script>

<style scoped lang="stylus" ref="stylesheet/stylus">
.search-all
  width 100%
  background-color #f5f5f5
  .header
    width 100%
    height 1rem
    display flex
    justify-content center
    align-items center
    background-color #fff
    box-shadow 0 0 .002rem #888
    .search
      flex 4
      display flex
      align-items center
      border-radius .5rem
      margin-left .25rem
      padding .125rem .25rem
      background-color #f5f5f5
      .icon-dropdown-arrow
        font-size .375rem
        margin-right .1rem
        color blue // åˆå§‹è“è‰²
        cursor pointer
      .arrow-open
        color black // ä¸‹æ‹‰åé»‘è‰²
      .icon-search
        font-size .375rem
      input
        width 100%
        border none
        outline none
        background-color #f5f5f5
        caret-color #dd2727
        text-indent .125rem
        font-size .3rem !important
    .dropdown-menu
      position absolute
      top 1rem
      left .25rem
      background-color white
      border 1px solid #ccc
      border-radius .1rem
      padding .1rem
      box-shadow 0 2px 4px rgba(0, 0, 0, 0.1)
      .dropdown-item
        display flex
        align-items center
        margin-bottom .05rem
        input[type="checkbox"]
          width: .3rem  // å¢å¤§å‹¾é€‰æ¡†å¤§å°
          height: .3rem
        label
          font-size: .25rem  // å‡å°å­—ä½“å¤§å°
          margin-left: .15rem  // å¢åŠ æ–‡å­—ä¸å‹¾é€‰æ¡†çš„é—´è·
    .cancel-btn
      flex 1
      font-size .3rem
      color #dd2727
      text-align center
  .content
    width 100%
    background #fff
    .movie-container
      width 100%
      font-size .3125rem
      padding .3rem
      box-sizing border-box
      border-top .04rem solid #f1f1f1
      .title
        font-size .3rem
        padding-bottom .25rem
        border-bottom .03rem solid #f1f1f1
      .item
        display flex
        justify-content space-around
        align-items center
        padding .25rem
        border-bottom .03rem solid #f1f1f1
        img
          display inline-block
          width 20%
          border-radius .1rem
        .info
          width 68%
          display flex
          flex-flow column
          padding .25rem
          font-size .25rem
          color #9d9d9d
          .name
            font-weight bolder
            padding-bottom .2rem
            color #333
          .type
            padding-bottom .2rem
          .people
            padding-bottom .2rem
            .number
              color #ffb400
          .score
            padding-bottom .2rem
            .number
              color #ffb400
        .buy
          width 12%
          padding .16rem .12rem
          text-align center
          background-color #dd2727
          border-radius 24%
          font-size .25rem
          color #fff
        .presell
          background-color #2d98f3
          width 12%
          padding .16rem .12rem
          text-align center
          border-radius 20%
          font-size .25rem
          color #fff
    .cinema-container
      width 100%
      font-size .3125rem
      padding .3rem
      box-sizing border-box
      border-top .04rem solid #f1f1f1
      .title
        font-size .3rem
        padding-bottom .25rem
        border-bottom .03rem solid #f1f1f1
      .item
        display flex
        justify-content center
        align-items center
        box-sizing border-box
        padding .25rem
        width 100%
        border-bottom .03rem solid #f1f1f1
        margin-bottom .25rem
        .left
          width 100%
          .name
            font-size .345rem
            line-height .36rem
            margin-bottom .25rem
            font-weight 700
          .address
            font-size .28rem
            line-height .3rem
            color #666
            margin-bottom .25rem
          .label-block
            display flex
            span
              padding .06rem
              font-size .2rem
              border .01rem solid #f90
              margin-right .1rem
              border-radius .04rem
              color #f90
        .right
          width 20%
          text-align center
          .price-block
            color #dd2727
            .price
              font-size .38rem
    .tips
      display flex
      justify-content center
      align-items center
      flex-flow column
      font-size .28rem
      padding-top 4rem
      border-top .04rem solid #f1f1f1
      .icon
        font-size 1.6rem
        margin-bottom .25rem
      .text
        color #ccc
</style>
```





```javascript
//æ ¹æ®åå­—åŒ¹é…ç”µå½±---ç²¾å‡†æœç´¢
router.get('/api/matchMovieByName', function (req, res) {
  console.log('å¼€å§‹ç²¾å‡†æœç´¢ï¼ï¼ï¼ï¼')
  let movieName = req.query.movieName
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id WHERE name LIKE ?;'
  conn.query(sqlStr, ['%' + movieName + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        result = result.filter((value) => {
          return (
            new Date(value.show_date + ',' + value.show_time) - new Date() > 0
          )
        })
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['movie_id'] === result[j]['movie_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
      }
      res.json({ success_code: 200, data: result })
    }
  })
})

const _ = require('lodash')
// const { createRequire } = require('module')
// const requireES6 = createRequire(import.meta.url)

// å¯¼å…¥ jieba ç›¸å…³æ¨¡å—
const { Jieba } = require('@node-rs/jieba')
const { dict } = require('@node-rs/jieba/dict')

// åˆå§‹åŒ– jieba å®ä¾‹
const jieba = Jieba.withDict(dict)

// BM25 ç±»
class BM25 {
  constructor(docs, k1 = 1.2, b = 0.75) {
    this.docs = docs
    this.k1 = k1
    this.b = b
    this.avgDocLen = this.calculateAvgDocLen()
    this.idf = this.calculateIDF()
  }

  calculateAvgDocLen() {
    let totalLen = 0
    for (const doc of this.docs) {
      totalLen += doc.length
    }
    return totalLen / this.docs.length
  }

  calculateIDF() {
    const docCount = this.docs.length
    const idf = {}
    const termDocCount = {}

    for (const doc of this.docs) {
      const uniqueTerms = _.uniq(doc)
      for (const term of uniqueTerms) {
        termDocCount[term] = (termDocCount[term] || 0) + 1
      }
    }

    for (const term in termDocCount) {
      const freq = termDocCount[term]
      idf[term] = Math.log((docCount - freq + 0.5) / (freq + 0.5) + 1)
    }

    return idf
  }

  score(query, doc) {
    const docLen = doc.length
    const termFreq = _.countBy(doc)
    let score = 0

    for (const term of query) {
      if (this.idf[term]) {
        const freq = termFreq[term] || 0
        const numerator = this.idf[term] * freq * (this.k1 + 1)
        const denominator =
          freq + this.k1 * (1 - this.b + this.b * (docLen / this.avgDocLen))
        score += numerator / denominator
      }
    }

    return score
  }
}

router.get('/api/semanticSearchMovie', function (req, res) {
  console.log('å¼€å§‹è¿›è¡Œè¯­ä¹‰æœç´¢ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼')

  let searchQuery = req.query.searchQuery
  console.log('ç”¨æˆ·æœç´¢è¯:', searchQuery)

  if (!searchQuery) {
    return res.json({ error_code: 1, message: 'æœç´¢è¯ä¸èƒ½ä¸ºç©º' })
  }

  let sqlStr = 'SELECT movie_id, name, intro FROM t_movie;'

  conn.query(sqlStr, (error, result) => {
    if (error) {
      console.error('æ•°æ®åº“æŸ¥è¯¢é”™è¯¯:', error)
      return res.json({ error_code: 1, message: 'æ•°æ®åº“æŸ¥è¯¢å¤±è´¥' })
    }

    result = JSON.parse(JSON.stringify(result)) // è§„èŒƒåŒ–æ•°æ®æ ¼å¼
    console.log('æ•°æ®åº“æŸ¥è¯¢è¿”å›:', result.length, 'æ¡è®°å½•')

    if (result.length === 0) {
      return res.json({ success_code: 200, data: [] })
    }

    // **âœ… è¿›è¡Œåˆ†è¯å¤„ç†**
    const searchTokens = jieba.cut(searchQuery)
    const docs = result.map((movie) => jieba.cut(movie.intro))

    // **âœ… è®¡ç®— BM25 ç›¸å…³æ€§**
    const bm25 = new BM25(docs)
    const results = result.map((movie, i) => ({
      movie_id: movie.movie_id,
      name: movie.name,
      intro: movie.intro,
      score: bm25.score(searchTokens, docs[i]),
    }))

    // **âœ… æ’åº & å»é‡**
    const topResults = _.uniqBy(
      results.sort((a, b) => b.score - a.score).slice(0, 10),
      'movie_id',
    )

    const movieIds = topResults.map((m) => m.movie_id)
    console.log('Top 10 ç”µå½± ID:', movieIds)

    if (movieIds.length === 0) {
      return res.json({ success_code: 200, data: [] })
    }

    // **âœ… æŸ¥è¯¢å®Œæ•´ç”µå½±ä¿¡æ¯**
    let finalSqlStr = `
      SELECT t_schedule.*, t_movie.*
      FROM t_schedule
      INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id
      WHERE t_schedule.movie_id IN (${movieIds.map(() => '?').join(',')})
    `

    conn.query(finalSqlStr, movieIds, (err, finalResults) => {
      if (err) {
        console.error('è·å–å®Œæ•´ç”µå½±ä¿¡æ¯é”™è¯¯:', err)
        return res.json({ error_code: 1, message: 'è·å–ç”µå½±è¯¦æƒ…å¤±è´¥' })
      }

      console.log('å®Œæ•´ç”µå½±æ•°æ®:', finalResults.length, 'æ¡è®°å½•')
      res.json({ success_code: 200, data: finalResults })
    })
  })
})
```





bm25 ä½†æ˜¯æ²¡æœ‰ç²¾å‡†äº†ï¼Ÿï¼Ÿ

```js
const express = require('express')
const router = express.Router()
const conn = require('../db/db')
const svgCaptcha = require('svg-captcha')
const util = require('../util/util')
const multer = require('multer')

// ç”¨æˆ·API
let user = {}
/* GET home page. */
router.get('/', function (req, res, next) {
  res.render('index', { title: 'Express' })
})
//è·å–æ‰‹æœºéªŒè¯ç 
router.get('/api/getPhoneCode', function (req, res) {
  let phone = req.query.phone
  let phoneCode = util.randomCode(4)
  if (!phoneCode) {
    res.json({ error_code: 1, message: 'è·å–éªŒè¯ç å¤±è´¥' })
  } else {
    user[phone] = phoneCode
    res.json({ success_code: 200, data: phoneCode })
  }
})
//è·å–å›¾å½¢éªŒè¯ç 
router.get('/api/captcha', function (req, res) {
  let captcha = svgCaptcha.create({
    size: 4, // size of random string
    ignoreChars: '0o1i', // filter out some characters like 0o1i
    noise: 3, // number of noise lines
    color: true, //, characters will have distinct colors instead of grey, true if background option is set
    background: '#fff', // background color of the svg image
  })
  //ä¿å­˜å›¾å½¢éªŒè¯ç æ–‡æœ¬
  req.session.captcha = captcha.text.toLowerCase()
  //è¿”å›éªŒè¯ç æ•°æ®
  res.type('svg')
  res.status(200).send(captcha.data)
})
//æ‰‹æœºç™»å½•
router.post('/api/phoneLogin', function (req, res) {
  let phone = req.body.phone
  let phoneCode = req.body.phoneCode
  //åˆ¤æ–­æ‰‹æœºéªŒè¯ç æ˜¯å¦æ­£ç¡®
  if (user[phone] === phoneCode) {
    let sqlStr = 'SELECT * from t_user WHERE phone = ? LIMIT 1 ;'
    conn.query(sqlStr, [phone], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'è¯·æ±‚æ•°æ®å¤±è´¥' })
      } else {
        result = JSON.parse(JSON.stringify(result))
        //ç”¨æˆ·å­˜åœ¨
        if (result[0]) {
          req.session.userId = result[0].user_id
          res.cookie('user_id', result[0].user_id)
          res.json({ success_code: 200 })
        } else {
          //ç”¨æˆ·ä¸å­˜åœ¨
          let sqlStr =
            'INSERT INTO t_user(user_name,phone,avatar,password) VALUES(?,?,?,?)'
          let avatarSrc = '/images/avatar/monkey.png'
          conn.query(
            sqlStr,
            [phone, phone, avatarSrc, 123456],
            (error, result, field) => {
              if (error) {
                console.log(error)
                res.json({ error_code: 1, message: 'åˆ›å»ºç”¨æˆ·å¤±è´¥' })
              } else {
                res.cookie('user_id', result.insertId)
                res.json({ success_code: 200 })
              }
            },
          )
        }
      }
    })
  } else {
    res.json({ error_code: 1, message: 'éªŒè¯ç ä¸æ­£ç¡®' })
  }
})
//å¯†ç ç™»å½•
router.post('/api/pwdLogin', function (req, res) {
  let name = req.body.userName
  let pwd = req.body.password
  let captcha = req.body.captcha
  //åˆ¤æ–­éªŒè¯ç æ˜¯å¦æ­£ç¡®
  if (captcha.toLowerCase() !== req.session.captcha) {
    res.json({ error_code: 1, message: 'éªŒè¯ç ä¸æ­£ç¡®' })
  } else {
    delete req.session.captcha
    let sqlStr = 'SELECT * from t_user WHERE user_name =? LIMIT 1 ;'
    conn.query(sqlStr, [name], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'æŸ¥è¯¢ç”¨æˆ·å¤±è´¥' })
      } else {
        result = JSON.parse(JSON.stringify(result))
        if (result[0]) {
          if (result[0].password === pwd) {
            //ä¿å­˜ç”¨æˆ·id
            req.session.userId = result[0].user_id
            res.cookie('user_id', result[0].user_id)
            res.json({ success_code: 200 })
          } else {
            res.json({ error_code: 1, message: 'å¯†ç é”™è¯¯' })
          }
        } else {
          res.json({ error: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
        }
      }
    })
  }
})
//è·å–ç”¨æˆ·ä¿¡æ¯
router.get('/api/getUserInfo', function (req, res) {
  let userId = req.query.userId
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥' })
      } else {
        result = JSON.parse(JSON.stringify(result))
        if (result[0]) {
          res.json({ success_code: 200, data: result[0] })
        } else {
          res.json({ error_code: 1, message: 'ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨' })
        }
      }
    })
  }
})
//æ›´æ–°ç”¨æˆ·å¤´åƒ
router.post('/api/updateUserAvatar', function (req, res) {
  let { userId, avatar } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      } else {
        //æ›´æ–°æ•°æ®åº“
        let sqlStr = 'UPDATE t_user SET avatar = ? WHERE user_id = ?;'
        conn.query(sqlStr, [avatar, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·å¤´åƒå¤±è´¥' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//æ›´æ–°ç”¨æˆ·å
router.post('/api/updateUserName', function (req, res) {
  let { userId, userName } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      } else {
        sqlStr =
          'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1 ;'
        conn.query(sqlStr, [userName, userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: 'ç”¨æˆ·åå·²å­˜åœ¨ï¼' })
            } else {
              //æ›´æ–°æ•°æ®åº“
              let sqlStr = 'UPDATE t_user SET user_name = ? WHERE user_id = ?;'
              conn.query(sqlStr, [userName, userId], (error, result, field) => {
                if (error) {
                  res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·åå¤±è´¥' })
                } else {
                  res.json({ success_code: 200 })
                }
              })
            }
          }
        })
      }
    })
  }
})
//æ›´æ–°ç”¨æˆ·æ€§åˆ«
router.post('/api/updateUserSex', function (req, res) {
  let { userId, sex } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      } else {
        //æ›´æ–°æ•°æ®åº“
        let sqlStr = 'UPDATE t_user SET sex = ? WHERE user_id = ?;'
        conn.query(sqlStr, [sex, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·æ€§åˆ«å¤±è´¥' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//æ›´æ–°ç”¨æˆ·ç”Ÿæ—¥
router.post('/api/updateUserBirthday', function (req, res) {
  let { userId, birthday } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      } else {
        //æ›´æ–°æ•°æ®åº“
        let sqlStr = 'UPDATE t_user SET birthday = ? WHERE user_id = ?;'
        conn.query(sqlStr, [birthday, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·ç”Ÿæ—¥å¤±è´¥' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//æ›´æ–°ç”¨æˆ·ç­¾å
router.post('/api/updateUserSign', function (req, res) {
  let { userId, sign } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      } else {
        //æ›´æ–°æ•°æ®åº“
        let sqlStr = 'UPDATE t_user SET sign = ? WHERE user_id = ?;'
        conn.query(sqlStr, [sign, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·ç­¾åå¤±è´¥' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//æ›´æ–°ç”¨æˆ·ä¿¡æ¯
router.post('/api/updateUserInfo', function (req, res) {
  let { userId, userName, avatar, password, sex, sign, birthday } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      } else {
        sqlStr =
          'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1 ;'
        conn.query(sqlStr, [userName, userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: 'ç”¨æˆ·åå·²å­˜åœ¨ï¼' })
            } else {
              //æ›´æ–°æ•°æ®åº“
              let sqlStr =
                'UPDATE t_user SET user_name = ?,avatar = ?,password = ?,sex = ? ,birthday = ?,sign = ?WHERE user_id = ?;'
              conn.query(
                sqlStr,
                [userName, avatar, password, sex, birthday, sign, userId],
                (error, result, field) => {
                  if (error) {
                    res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥' })
                  } else {
                    res.json({ success_code: 200 })
                  }
                },
              )
            }
          }
        })
      }
    })
  }
})
//åŠ è½½ç”µå½±åˆ—è¡¨
router.get('/api/getMovieList', function (req, res) {
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'è·å–ç”µå½±åˆ—è¡¨å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        result = result.filter((value) => {
          return (
            new Date(value.show_date + ',' + value.show_time) - new Date() > 0
          )
        })
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['movie_id'] === result[j]['movie_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
        res.json({ success_code: 200, data: result })
      } else {
        res.json({ error_code: 1, message: 'ç”µå½±åˆ—è¡¨ä¸ºç©º' })
      }
    }
  })
})
//åŠ è½½ç”µå½±è¯¦ç»†ä¿¡æ¯
router.get('/api/getMovieDetail', function (req, res) {
  let movieId = req.query.movieId
  let sqlStr = 'SELECT * FROM t_movie WHERE movie_id = ? LIMIT 1;'
  conn.query(sqlStr, [movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: 'è·å–ç”µå½±ä¿¡æ¯å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result })
      } else {
        res.json({ error_code: 1, message: 'è¯¥ç”µå½±ä¸å­˜åœ¨' })
      }
    }
  })
})
//æ˜¯å¦æƒ³çœ‹ç”µå½±
router.post('/api/isWishMovie', function (req, res) {
  let { userId, movieId } = req.body
  let sqlStr =
    'SELECT * FROM t_wishmovie WHERE user_id = ? AND movie_id = ? LIMIT 1;'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200 })
      } else {
        res.json({ error_code: 1, message: 'ä¸æƒ³çœ‹' })
      }
    }
  })
})
//æƒ³çœ‹ç”µå½±
router.post('/api/wishMovie', function (req, res) {
  let { userId, movieId } = req.body
  let sqlStr = 'INSERT INTO t_wishmovie(user_id,movie_id) VALUES(?,?)'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
    } else {
      let sqlStr = 'SELECT wish_num from t_movie WHERE movie_id = ? LIMIT 1;'
      conn.query(sqlStr, [movieId], (error, result, field) => {
        if (error) {
          res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
        } else {
          result = JSON.parse(JSON.stringify(result))
          if (result[0]) {
            //æ›´æ–°æ•°æ®åº“
            let sqlStr = 'UPDATE t_movie SET wish_num = ? WHERE movie_id = ?;'
            conn.query(
              sqlStr,
              [result[0].wish_num + 1, movieId],
              (error, result, field) => {
                if (error) {
                  res.json({ error_code: 1, message: 'æ›´æ–°ä¿¡æ¯å¤±è´¥' })
                } else {
                  res.json({ success_code: 200 })
                }
              },
            )
          }
        }
      })
    }
  })
})
//å–æ¶ˆæƒ³çœ‹ç”µå½±
router.post('/api/cancelWishMovie', function (req, res) {
  let { userId, movieId } = req.body
  let sqlStr = 'DELETE FROM t_wishmovie WHERE user_id = ? AND movie_id =? ;'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
    } else {
      let sqlStr = 'SELECT wish_num from t_movie WHERE movie_id = ? LIMIT 1;'
      conn.query(sqlStr, [movieId], (error, result, field) => {
        if (error) {
          res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
        } else {
          result = JSON.parse(JSON.stringify(result))
          if (result[0]) {
            //æ›´æ–°æ•°æ®åº“
            let sqlStr = 'UPDATE t_movie SET wish_num = ? WHERE movie_id = ?;'
            conn.query(
              sqlStr,
              [result[0].wish_num - 1, movieId],
              (error, result, field) => {
                if (error) {
                  res.json({ error_code: 1, message: 'æ›´æ–°ä¿¡æ¯å¤±è´¥' })
                } else {
                  res.json({ success_code: 200 })
                }
              },
            )
          }
        }
      })
    }
  })
})
//è·å–å½“å‰ç”¨æˆ·è¯„è®º
router.get('/api/getUserComment', function (req, res) {
  let { userId, movieId } = req.query
  let sqlStr =
    'SELECT * FROM t_comment WHERE user_id = ? AND movie_id= ? LIMIT 1;'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: 'ç”¨æˆ·æœªè¯„è®º' })
      }
    }
  })
})
//è·å–æ‰€æœ‰ç”¨æˆ·é€šè¿‡å®¡æ ¸çš„è¯„è®º
router.get('/api/getAllUserPassComment', function (req, res) {
  let { movieId } = req.query
  let sqlStr =
    'SELECT * FROM t_user user INNER JOIN t_comment comment ON user.user_id = comment.user_id WHERE comment.movie_id = ? AND comment.is_pass = ? ;'
  conn.query(sqlStr, [movieId, 1], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result) {
        res.json({ success_code: 200, data: result })
      } else {
        res.json({ error_code: 1, message: 'æœªè¯„è®º' })
      }
    }
  })
})
//æ›´æ–°ç”¨æˆ·è¯„è®º
router.post('/api/updateUserComment', function (req, res) {
  let { userId, movieId, score, commentContent, commentDate } = req.body
  let sqlStr =
    'SELECT comment_id from t_comment WHERE user_id = ? AND movie_id = ? LIMIT 1'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        //è¯„è®ºå­˜åœ¨
        //æ›´æ–°
        let sqlStr =
          'UPDATE t_comment SET user_score = ?, comment_content = ?, comment_date = ?,support_num = ?,is_pass = ?,support_user = ? WHERE comment_id = ? ;'
        conn.query(
          sqlStr,
          [
            score,
            commentContent,
            commentDate,
            0,
            0,
            undefined,
            result[0].comment_id,
          ],
          (error, result, field) => {
            if (error) {
              res.json({ error_code: 1, message: 'æ›´æ–°è¯„è®ºå¤±è´¥' })
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      } else {
        //è¯„è®ºä¸å­˜åœ¨
        let sqlStr =
          'INSERT INTO t_comment(user_id,movie_id,user_score,comment_content,comment_date,support_num,is_pass) VALUES(?,?,?,?,?,?,?)'
        conn.query(
          sqlStr,
          [userId, movieId, score, commentContent, commentDate, 0, 0],
          (error, result, field) => {
            if (error) {
              console.log(error)
              res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      }
    }
  })
})
//è·å–å½“å‰è¯„è®º
router.get('/api/getCommentByID', function (req, res) {
  let { commentId } = req.query
  let sqlStr = 'SELECT * FROM t_comment WHERE comment_id = ? LIMIT 1;'
  conn.query(sqlStr, [commentId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: 'ç”¨æˆ·æœªè¯„è®º' })
      }
    }
  })
})
//æ›´æ–°å½“å‰è¯„è®ºçš„ç”¨æˆ·ç‚¹èµ
router.post('/api/updateUserSupport', function (req, res) {
  let { commentId, supportNum, supportUser } = req.body
  let sqlStr =
    'UPDATE t_comment SET support_num = ? , support_user = ? WHERE comment_id = ?;'
  conn.query(
    sqlStr,
    [supportNum, supportUser, commentId],
    (error, result, field) => {
      if (error) {
        console.log(error)
        res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })
      } else {
        res.json({ success_code: 200 })
      }
    },
  )
})
//åŠ è½½å½±é™¢åˆ—è¡¨
router.get('/api/getCinemaList', function (req, res) {
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_cinema ON t_schedule.cinema_id = t_cinema.cinema_id INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: 'è·å–å½±é™¢åˆ—è¡¨å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        result = result.filter((value) => {
          return (
            new Date(value.show_date + ',' + value.show_time) - new Date() > 0
          )
        })
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['cinema_id'] === result[j]['cinema_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
      }
      res.json({ success_code: 200, data: result })
    }
  })
})
//åŠ è½½å½“å‰å½±é™¢è¯¦ç»†ä¿¡æ¯
router.get('/api/getCurrentCinemaDetail', function (req, res) {
  let cinemaId = req.query.cinemaId
  let sqlStr = 'SELECT * FROM t_cinema WHERE cinema_id = ? LIMIT 1;'
  conn.query(sqlStr, [cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'è·å–å½“å‰å½±é™¢ä¿¡æ¯å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: 'å½±é™¢ä¸å­˜åœ¨' })
      }
    }
  })
})
//åŠ è½½å½“å‰å½±é™¢æ’ç‰‡
router.get('/api/getCurrentCinemaMovieSchedule', function (req, res) {
  let cinemaId = req.query.cinemaId
  console.log(cinemaId)
  let sqlStr = 'SELECT * FROM t_schedule WHERE cinema_id = ?;'
  conn.query(sqlStr, [cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'è·å–å½“å‰å½±é™¢æ’ç‰‡ä¿¡æ¯å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result) {
        let tempMovieArr = []
        result.forEach((value) => {
          if (
            new Date() - new Date(value.show_date + ',' + value.show_time) <=
            0
          ) {
            tempMovieArr.push(value.movie_id)
          }
        })
        tempMovieArr = Array.from(new Set(tempMovieArr))
        let movieArray = []
        let movieScheduleArray = []
        tempMovieArr.forEach((value) => {
          sqlStr = 'SELECT * FROM t_movie WHERE movie_id = ? LIMIT 1;'
          conn.query(sqlStr, [value], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result[0]) {
                movieArray.push(result[0])
              }
            }
          })
          sqlStr =
            'SELECT * FROM t_schedule schedule INNER JOIN t_movie movie ON schedule.movie_id = movie.movie_id WHERE schedule.movie_id = ? AND schedule.cinema_id = ?;'
          conn.query(sqlStr, [value, cinemaId], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result) {
                movieScheduleArray.push(result)
              }
            }
          })
        })
        setTimeout(() => {
          res.json({
            success_code: 200,
            data: {
              hasMovieInfo: movieArray,
              movieScheduleInfo: movieScheduleArray,
            },
          })
        }, 500)
      } else {
        res.json({ error_code: 1, message: 'å½“å‰å½±é™¢æ’ç‰‡ä¿¡æ¯ä¸ºç©º' })
      }
    }
  })
})
//åŠ è½½å½“å‰å½±é™¢è¯¦ç»†ä¿¡æ¯
router.get('/api/getScheduleById', function (req, res) {
  let scheduleId = req.query.scheduleId
  let sqlStr = 'SELECT * FROM t_schedule WHERE schedule_id = ? LIMIT 1;'
  conn.query(sqlStr, [scheduleId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'è·å–å½“å‰æ’ç‰‡ä¿¡æ¯å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: 'æ’ç‰‡ä¿¡æ¯ä¸å­˜åœ¨' })
      }
    }
  })
})
//åŠ è½½å½“å‰å½±é™¢è¯¦ç»†ä¿¡æ¯
router.post('/api/updateScheduleSeat', function (req, res) {
  let { scheduleId, seatInfo } = req.body
  let sqlStr =
    'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ? LIMIT 1;'
  conn.query(sqlStr, [seatInfo, scheduleId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'æ›´æ–°æ’ç‰‡åº§ä½ä¿¡æ¯å¤±è´¥' })
    } else {
      res.json({ success_code: 200, data: result[0] })
    }
  })
})
//åŠ è½½å½“å‰ç”µå½±æ’ç‰‡
router.get('/api/getCurrentMovieSchedule', function (req, res) {
  let movieId = req.query.movieId
  let sqlStr = 'SELECT * FROM t_schedule WHERE movie_id = ?;'
  conn.query(sqlStr, [movieId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: 'è·å–å½“å‰å½±é™¢æ’ç‰‡ä¿¡æ¯å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result) {
        let tempDateArr = []
        result.forEach((value) => {
          if (
            new Date() - new Date(value.show_date + ',' + value.show_time) <=
            0
          ) {
            tempDateArr.push(value.show_date)
          }
        })
        tempDateArr = Array.from(new Set(tempDateArr))
        tempDateArr.sort((a, b) => {
          return new Date(a) - new Date(b)
        })
        let cinemaArray = []
        let cinemaScheduleArray = []
        tempDateArr.forEach((value) => {
          sqlStr = 'SELECT * FROM t_schedule WHERE show_date = ?'
          conn.query(sqlStr, [value], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result) {
                cinemaArray.push(result)
              }
            }
          })
          sqlStr =
            'SELECT * FROM t_schedule schedule INNER JOIN t_cinema cinema ON schedule.cinema_id = cinema.cinema_id WHERE schedule.movie_id = ? AND schedule.show_date = ?;'
          conn.query(sqlStr, [movieId, value], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result) {
                cinemaScheduleArray.push(result)
              }
            }
          })
        })
        setTimeout(() => {
          res.json({
            success_code: 200,
            data: {
              hasCinemaInfo: cinemaArray,
              cinemaScheduleInfo: cinemaScheduleArray,
            },
          })
        }, 500)
      } else {
        res.json({ error_code: 1, message: 'å½“å‰ç”µå½±æ’ç‰‡ä¿¡æ¯ä¸ºç©º' })
      }
    }
  })
})

//æ ¹æ®åå­—åŒ¹é…ç”µå½±---ç²¾å‡†æœç´¢
router.get('/api/matchMovieByName', function (req, res) {
  console.log('å¼€å§‹ç²¾å‡†æœç´¢ï¼ï¼ï¼ï¼')
  let movieName = req.query.movieName
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id WHERE name LIKE ?;'
  conn.query(sqlStr, ['%' + movieName + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        result = result.filter((value) => {
          return (
            new Date(value.show_date + ',' + value.show_time) - new Date() > 0
          )
        })
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['movie_id'] === result[j]['movie_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
      }
      res.json({ success_code: 200, data: result })
    }
  })
})

const _ = require('lodash')
// const { createRequire } = require('module')
// const requireES6 = createRequire(import.meta.url)

// å¯¼å…¥ jieba ç›¸å…³æ¨¡å—
const { Jieba } = require('@node-rs/jieba')
const { dict } = require('@node-rs/jieba/dict')

// åˆå§‹åŒ– jieba å®ä¾‹
const jieba = Jieba.withDict(dict)

// BM25 ç±»
class BM25 {
  constructor(docs, k1 = 1.2, b = 0.75) {
    this.docs = docs
    this.k1 = k1
    this.b = b
    this.avgDocLen = this.calculateAvgDocLen()
    this.idf = this.calculateIDF()
  }

  calculateAvgDocLen() {
    let totalLen = 0
    for (const doc of this.docs) {
      totalLen += doc.length
    }
    return totalLen / this.docs.length
  }

  calculateIDF() {
    const docCount = this.docs.length
    const idf = {}
    const termDocCount = {}

    for (const doc of this.docs) {
      const uniqueTerms = _.uniq(doc)
      for (const term of uniqueTerms) {
        termDocCount[term] = (termDocCount[term] || 0) + 1
      }
    }

    for (const term in termDocCount) {
      const freq = termDocCount[term]
      idf[term] = Math.log((docCount - freq + 0.5) / (freq + 0.5) + 1)
    }

    return idf
  }

  score(query, doc) {
    const docLen = doc.length
    const termFreq = _.countBy(doc)
    let score = 0

    for (const term of query) {
      if (this.idf[term]) {
        const freq = termFreq[term] || 0
        const numerator = this.idf[term] * freq * (this.k1 + 1)
        const denominator =
          freq + this.k1 * (1 - this.b + this.b * (docLen / this.avgDocLen))
        score += numerator / denominator
      }
    }

    return score
  }
}

router.get('/api/semanticSearchMovie', function (req, res) {
  console.log('å¼€å§‹è¿›è¡Œè¯­ä¹‰æœç´¢ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼')

  let searchQuery = req.query.searchQuery
  console.log('ç”¨æˆ·æœç´¢è¯:', searchQuery)

  if (!searchQuery) {
    return res.json({ error_code: 1, message: 'æœç´¢è¯ä¸èƒ½ä¸ºç©º' })
  }

  let sqlStr = 'SELECT movie_id, name, intro FROM t_movie;'

  conn.query(sqlStr, (error, result) => {
    if (error) {
      console.error('æ•°æ®åº“æŸ¥è¯¢é”™è¯¯:', error)
      return res.json({ error_code: 1, message: 'æ•°æ®åº“æŸ¥è¯¢å¤±è´¥' })
    }

    result = JSON.parse(JSON.stringify(result)) // è§„èŒƒåŒ–æ•°æ®æ ¼å¼
    console.log('æ•°æ®åº“æŸ¥è¯¢è¿”å›:', result.length, 'æ¡è®°å½•')

    if (result.length === 0) {
      return res.json({ success_code: 200, data: [] })
    }

    // **âœ… è¿›è¡Œåˆ†è¯å¤„ç†**
    const searchTokens = jieba.cut(searchQuery)
    const docs = result.map((movie) => jieba.cut(movie.intro))

    // **âœ… è®¡ç®— BM25 ç›¸å…³æ€§**
    const bm25 = new BM25(docs)
    const results = result.map((movie, i) => ({
      movie_id: movie.movie_id,
      name: movie.name,
      intro: movie.intro,
      score: bm25.score(searchTokens, docs[i]),
    }))

    // **âœ… æ’åº & å»é‡**
    const topResults = _.uniqBy(
      results.sort((a, b) => b.score - a.score).slice(0, 10),
      'movie_id',
    )

    const movieIds = topResults.map((m) => m.movie_id)
    console.log('Top 10 ç”µå½± ID:', movieIds)

    if (movieIds.length === 0) {
      return res.json({ success_code: 200, data: [] })
    }

    // **âœ… æŸ¥è¯¢å®Œæ•´ç”µå½±ä¿¡æ¯**
    let finalSqlStr = `
      SELECT t_schedule.*, t_movie.*
      FROM t_schedule
      INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id
      WHERE t_schedule.movie_id IN (${movieIds.map(() => '?').join(',')})
    `

    conn.query(finalSqlStr, movieIds, (err, finalResults) => {
      if (err) {
        console.error('è·å–å®Œæ•´ç”µå½±ä¿¡æ¯é”™è¯¯:', err)
        return res.json({ error_code: 1, message: 'è·å–ç”µå½±è¯¦æƒ…å¤±è´¥' })
      }

      console.log('å®Œæ•´ç”µå½±æ•°æ®:', finalResults.length, 'æ¡è®°å½•')
      res.json({ success_code: 200, data: finalResults })
    })
  })
})

//æ ¹æ®åå­—åŒ¹é…å½±é™¢
router.get('/api/matchCinemaByName', function (req, res) {
  let cinemaName = req.query.cinemaName
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_cinema ON t_schedule.cinema_id = t_cinema.cinema_id INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id WHERE cinema_name LIKE ?;'
  conn.query(sqlStr, ['%' + cinemaName + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        result = result.filter((value) => {
          return (
            new Date(value.show_date + ',' + value.show_time) - new Date() > 0
          )
        })
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['cinema_id'] === result[j]['cinema_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
      }
      res.json({ success_code: 200, data: result })
    }
  })
})
//ç”¨æˆ·ä¸‹å•
router.post('/api/order', function (req, res) {
  let {
    userId,
    scheduleId,
    orderPhone,
    orderDate,
    ticketNum,
    totalPrice,
    orderSeatInfo,
    payType,
  } = req.body
  let phoneCode = util.randomCode(6)
  let sqlStr =
    'INSERT INTO t_order(user_id,schedule_id,order_phone,order_date,ticket_num,ticket_total_price,order_seat_info,pay_type,phone_code) VALUES(?,?,?,?,?,?,?,?,?); '
  conn.query(
    sqlStr,
    [
      userId,
      scheduleId,
      orderPhone,
      orderDate,
      ticketNum,
      totalPrice,
      orderSeatInfo,
      payType,
      phoneCode,
    ],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200, data: { phone_code: phoneCode } })
      }
    },
  )
})
//è·å–ä¸ªäººè®¢å•ä¿¡æ¯
router.get('/api/getOrderByUserId', function (req, res) {
  let userId = req.query.userId
  let sqlStr =
    'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE user_id = ?;'
  conn.query(sqlStr, [userId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//è·å–ä¸ªäººæƒ³çœ‹ç”µå½±
router.get('/api/getWishMovieByUserId', function (req, res) {
  let userId = req.query.userId
  let sqlStr =
    'SELECT * FROM t_wishmovie INNER JOIN t_movie ON t_wishmovie.movie_id = t_movie.movie_id WHERE user_id = ?;'
  conn.query(sqlStr, [userId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//è·å–ä¸ªäººçœ‹è¿‡çš„ç”µå½±
router.get('/api/getIsWatchedMovieByUserId', function (req, res) {
  let userId = req.query.userId
  let sqlStr =
    'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id WHERE user_id = ? AND is_pass = 1;'
  conn.query(sqlStr, [userId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})

//ç®¡ç†å‘˜API
//è·å–å½“å‰é¡µç”¨æˆ·

//å¯†ç ç™»å½•
router.post('/api/admin/login', function (req, res) {
  let name = req.body.name
  let password = req.body.password
  let sqlStr = 'SELECT * FROM t_admin WHERE name = ? LIMIT 1 ;'
  conn.query(sqlStr, [name, password], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: 'æŸ¥è¯¢ç”¨æˆ·å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        if (result[0].password === password) {
          //ä¿å­˜ç”¨æˆ·id
          req.session.adminId = result[0].admin_id
          res.cookie('admin_id', result[0].admin_id)
          res.json({ success_code: 200 })
        } else {
          res.json({ error_code: 1, message: 'å¯†ç é”™è¯¯' })
        }
      } else {
        res.json({ error: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      }
    }
  })
})
//è·å–ç”¨æˆ·ä¿¡æ¯
router.get('/api/admin/getAdminInfo', function (req, res) {
  let adminId = req.query.adminId
  let sqlStr = 'SELECT * FROM t_admin WHERE admin_id = ? LIMIT 1 ;'
  conn.query(sqlStr, [adminId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: 'æŸ¥è¯¢ç”¨æˆ·å¤±è´¥' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      }
    }
  })
})
router.get('/api/admin/getCurrentPageUser', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr = 'SELECT * FROM t_user WHERE user_name LIKE ? ORDER BY user_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_user WHERE user_name LIKE ? ORDER BY user_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})

var datatime = './public/images/avatar/'
//å°†å›¾ç‰‡æ”¾åˆ°æœåŠ¡å™¨
var storage = multer.diskStorage({
  // å¦‚æœä½ æä¾›çš„ destination æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½ éœ€è¦è´Ÿè´£åˆ›å»ºæ–‡ä»¶å¤¹
  destination: datatime,
  // //ç»™ä¸Šä¼ æ–‡ä»¶é‡å‘½åï¼Œè·å–æ·»åŠ åç¼€å
  filename: function (req, file, cb) {
    cb(null, new Date().getTime() + '.jpg')
  },
})
var upload = multer({
  storage: storage,
})
// let upload = multer({dest:'./public/images/avatar'}).any();
router.post('/api/admin/upLoadImg', upload.any(), function (req, res) {
  res.json({ success_code: 200, data: req.files })
  console.log(req.files)
})

//æ›´æ–°ç”¨æˆ·ä¿¡æ¯
router.post('/api/admin/updateUserInfo', function (req, res) {
  let { userId, userName, avatar, password, sex, phone, sign, birthday } =
    req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })
      } else {
        let sqlStr =
          'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1;'
        conn.query(sqlStr, [userName, userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: 'ç”¨æˆ·åå·²å­˜åœ¨ï¼' })
            } else {
              sqlStr =
                'SELECT * FROM t_user WHERE phone = ? AND user_id <> ? LIMIT 1;'
              conn.query(sqlStr, [phone, userId], (error, result, field) => {
                if (error) {
                  console.log(error)
                } else {
                  result = JSON.parse(JSON.stringify(result))
                  if (result[0]) {
                    res.json({ error_code: 1, message: 'æ‰‹æœºå·ç å·²æ³¨å†Œï¼' })
                  } else {
                    //æ›´æ–°æ•°æ®åº“
                    let sqlStr =
                      'UPDATE t_user SET user_name = ?,avatar = ?,password = ?,sex = ? ,phone = ?,birthday = ?,sign = ? WHERE user_id = ?;'
                    conn.query(
                      sqlStr,
                      [
                        userName,
                        avatar,
                        password,
                        sex,
                        phone,
                        birthday,
                        sign,
                        userId,
                      ],
                      (error, result, field) => {
                        if (error) {
                          res.json({
                            error_code: 1,
                            message: 'æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥',
                          })
                          console.log(error)
                        } else {
                          res.json({ success_code: 200 })
                        }
                      },
                    )
                  }
                }
              })
            }
          }
        })
      }
    })
  }
})
//åˆ é™¤ç”¨æˆ·ä¿¡æ¯
router.post('/api/admin/deleteUserInfo', function (req, res) {
  let { userId } = req.body
  if (userId) {
    let sqlStr =
      'SELECT t_schedule.schedule_id, t_schedule.seat_info,order_seat_info FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id WHERE user_id = ?'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        console.log(result)
        if (result) {
          result.forEach((value) => {
            let tempArr = []
            value.seat_info = JSON.parse(value.seat_info)
            value.order_seat_info = JSON.parse(value.order_seat_info)
            value.seat_info.forEach((v) => {
              if (value.order_seat_info.indexOf(v) === -1) {
                tempArr.push(v)
              }
            })
            tempArr = JSON.stringify(tempArr)
            sqlStr =
              'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ?;'
            conn.query(
              sqlStr,
              [tempArr, value.schedule_id],
              (error, result, field) => {
                if (error) {
                  console.log(error)
                }
              },
            )
          })
        }
        sqlStr = 'DELETE FROM t_user WHERE user_id =?'
        conn.query(sqlStr, [userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//æ·»åŠ ç”¨æˆ·ä¿¡æ¯
router.post('/api/admin/addUserInfo', function (req, res) {
  let { userName, avatar, phone, password, sex, sign, birthday } = req.body
  if (!avatar) {
    avatar = '/images/avatar/monkey.png'
  }
  let sqlStr = 'SELECT * FROM t_user WHERE user_name = ? LIMIT 1;'
  conn.query(sqlStr, [userName], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: 'ç”¨æˆ·åå·²å­˜åœ¨ï¼' })
      } else {
        sqlStr = 'SELECT * FROM t_user WHERE phone = ? LIMIT 1'
        conn.query(sqlStr, [phone], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: 'æ‰‹æœºå·ç å·²æ³¨å†Œï¼' })
            } else {
              sqlStr =
                'INSERT INTO t_user(user_name,avatar,phone,password,sex,sign,birthday) VALUES(?,?,?,?,?,?,?);'
              conn.query(
                sqlStr,
                [userName, avatar, phone, password, sex, sign, birthday],
                (error, result, field) => {
                  if (error) {
                    console.log(error)
                  } else {
                    res.json({ success_code: 200 })
                  }
                },
              )
            }
          }
        })
      }
    }
  })
})
//è·å–å½“å‰é¡µç”µå½±
router.get('/api/admin/getCurrentPageMovie', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr = 'SELECT * FROM t_movie WHERE name LIKE ? ORDER BY movie_id'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_movie WHERE name LIKE ? ORDER BY movie_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//æ›´æ–°ç”µå½±ä¿¡æ¯
router.post('/api/admin/updateMovieInfo', function (req, res) {
  let {
    movieId,
    movieName,
    poster,
    director,
    actor,
    long,
    type,
    language,
    publicDate,
    intro,
  } = req.body
  let sqlStr = 'SELECT * FROM t_movie WHERE name = ? AND movie_id <> ? LIMIT 1;'
  conn.query(sqlStr, [movieName, movieId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: 'ç”µå½±åå·²å­˜åœ¨ï¼' })
      } else {
        //æ›´æ–°æ•°æ®åº“
        let sqlStr =
          'UPDATE t_movie SET name = ?,poster = ?,director = ?,actor = ? ,movie_long = ?,type = ?,language = ?,public_date = ?,intro = ? WHERE movie_id = ?;'
        conn.query(
          sqlStr,
          [
            movieName,
            poster,
            director,
            actor,
            long,
            type,
            language,
            publicDate,
            intro,
            movieId,
          ],
          (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      }
    }
  })
})
//æ·»åŠ ç”µå½±ä¿¡æ¯
router.post('/api/admin/addMovieInfo', function (req, res) {
  let {
    movieName,
    poster,
    director,
    actor,
    long,
    type,
    language,
    publicDate,
    intro,
  } = req.body
  let sqlStr = 'SELECT * FROM t_movie WHERE name = ? LIMIT 1;'
  conn.query(sqlStr, [movieName], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: 'ç”µå½±åå·²å­˜åœ¨ï¼' })
      } else {
        let sqlStr =
          'INSERT INTO t_movie(name,poster,director,actor,movie_long,type,language,public_date,intro) VALUES(?,?,?,?,?,?,?,?,?);'
        conn.query(
          sqlStr,
          [
            movieName,
            poster,
            director,
            actor,
            long,
            type,
            language,
            publicDate,
            intro,
          ],
          (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      }
    }
  })
})

datatime = './public/images/movie/'
//å°†å›¾ç‰‡æ”¾åˆ°æœåŠ¡å™¨
storage = multer.diskStorage({
  // å¦‚æœä½ æä¾›çš„ destination æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½ éœ€è¦è´Ÿè´£åˆ›å»ºæ–‡ä»¶å¤¹
  destination: datatime,
  // //ç»™ä¸Šä¼ æ–‡ä»¶é‡å‘½åï¼Œè·å–æ·»åŠ åç¼€å
  filename: function (req, file, cb) {
    cb(null, new Date().getTime() + '.jpg')
  },
})
upload = multer({
  storage: storage,
})
router.post('/api/admin/upLoadMovieImg', upload.any(), function (req, res) {
  res.json({ success_code: 200, data: req.files })
  console.log(req.files)
})
//åˆ é™¤ç”µå½±ä¿¡æ¯
router.post('/api/admin/deleteMovieInfo', function (req, res) {
  let { movieId } = req.body
  let sqlStr = 'DELETE FROM t_movie WHERE movie_id =?'
  conn.query(sqlStr, [movieId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      res.json({ success_code: 200 })
    }
  })
})
//è·å–å½“å‰é¡µå½±é™¢
router.get('/api/admin/getCurrentPageCinema', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_cinema WHERE cinema_name LIKE ? ORDER BY cinema_id ;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_cinema WHERE cinema_name LIKE ? ORDER BY cinema_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//æ›´æ–°å½±é™¢ä¿¡æ¯
router.post('/api/admin/updateCinemaInfo', function (req, res) {
  let { cinemaId, cinemaName, cinemaPhone, address } = req.body
  if (cinemaId) {
    let sqlStr = 'SELECT * from t_cinema WHERE cinema_id = ? LIMIT 1;'
    conn.query(sqlStr, [cinemaId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        sqlStr =
          'SELECT * FROM t_cinema WHERE cinema_name = ? AND cinema_id <> ? LIMIT 1 ;'
        conn.query(sqlStr, [cinemaName, cinemaId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: 'å½±é™¢åå·²å­˜åœ¨ï¼' })
            } else {
              //æ›´æ–°æ•°æ®åº“
              let sqlStr =
                'UPDATE t_cinema SET cinema_name = ?,cinema_phone = ?,specified_address = ? WHERE cinema_id = ?;'
              conn.query(
                sqlStr,
                [cinemaName, cinemaPhone, address, cinemaId],
                (error, result, field) => {
                  if (error) {
                    res.json({ error_code: 1, message: 'æ›´æ–°å½±é™¢ä¿¡æ¯å¤±è´¥' })
                    console.log(error)
                  } else {
                    res.json({ success_code: 200 })
                  }
                },
              )
            }
          }
        })
      }
    })
  }
})
//åˆ é™¤å½±é™¢ä¿¡æ¯
router.post('/api/admin/deleteCinemaInfo', function (req, res) {
  let { cinemaId } = req.body
  if (cinemaId) {
    let sqlStr = 'DELETE FROM t_cinema WHERE cinema_id =?'
    conn.query(sqlStr, [cinemaId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200 })
      }
    })
  }
})
//æ·»åŠ å½±é™¢ä¿¡æ¯
router.post('/api/admin/addCinemaInfo', function (req, res) {
  let { cinemaName, cinemaPhone, address } = req.body
  sqlStr = 'SELECT * FROM t_cinema WHERE cinema_name = ? LIMIT 1 ;'
  conn.query(sqlStr, [cinemaName], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: 'å½±é™¢åå·²å­˜åœ¨ï¼' })
      } else {
        let sqlStr =
          'INSERT INTO t_cinema(cinema_name,cinema_phone,specified_address) VALUES(?,?,?);'
        conn.query(
          sqlStr,
          [cinemaName, cinemaPhone, address],
          (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      }
    }
  })
})
//è·å–å½“å‰é¡µè¯„è®º
router.get('/api/admin/getCurrentPageComment', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id INNER JOIN t_user ON t_user.user_id=t_comment.user_id WHERE t_movie.name LIKE ? ORDER BY comment_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id INNER JOIN t_user ON t_user.user_id=t_comment.user_id WHERE t_movie.name LIKE ? ORDER BY comment_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//é€šè¿‡å½“å‰è¯„è®º
router.post('/api/admin/passCurrentComment', function (req, res) {
  let commentId = req.body.commentId
  let movieId = req.body.movieId
  if (commentId) {
    let sqlStr = 'UPDATE t_comment SET is_pass = 1 WHERE comment_id = ?;'
    conn.query(sqlStr, [commentId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        sqlStr =
          'SELECT user_score FROM t_comment WHERE movie_id = ? AND is_pass = ?;'
        conn.query(sqlStr, [movieId, 1], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            let avgScore = 0
            if (result.length) {
              result.forEach((val) => {
                avgScore += Number(val.user_score)
              })
              avgScore = (avgScore / Number(result.length)).toFixed(1)
            }
            sqlStr = 'UPDATE t_movie SET score = ? WHERE movie_id = ?;'
            conn.query(sqlStr, [avgScore, movieId], (error, result, field) => {
              if (error) {
                console.log(error)
              } else {
                res.json({ success_code: 200 })
              }
            })
          }
        })
      }
    })
  }
})
//åˆ é™¤å½“å‰è¯„è®º
router.post('/api/admin/deleteCurrentComment', function (req, res) {
  let commentId = req.body.commentId
  let movieId = req.body.movieId
  if (commentId) {
    let sqlStr = 'DELETE FROM t_comment WHERE comment_id = ?;'
    conn.query(sqlStr, [commentId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        sqlStr =
          'SELECT user_score FROM t_comment WHERE movie_id = ? AND is_pass = ?;'
        conn.query(sqlStr, [movieId, 1], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            let avgScore = 0
            if (result.length) {
              result.forEach((val) => {
                avgScore += Number(val.user_score)
              })
              avgScore = (avgScore / Number(result.length)).toFixed(1)
            }
            sqlStr = 'UPDATE t_movie SET score = ? WHERE movie_id = ?;'
            conn.query(sqlStr, [avgScore, movieId], (error, result, field) => {
              if (error) {
                console.log(error)
              } else {
                res.json({ success_code: 200 })
              }
            })
          }
        })
      }
    })
  }
})
//è·å–å½“å‰é¡µè®¢å•
router.get('/api/admin/getCurrentPageOrder', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id INNER JOIN t_user ON t_order.user_id = t_user.user_id WHERE t_movie.name LIKE ? ORDER BY order_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id INNER JOIN t_user ON t_order.user_id = t_user.user_id WHERE t_movie.name LIKE ? ORDER BY order_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//åˆ é™¤è®¢å•
router.post('/api/admin/deleteOrder', function (req, res) {
  let { orderId, scheduleId, orderSeatInfo } = req.body
  if (orderId) {
    let sqlStr = 'SELECT seat_info FROM t_schedule WHERE schedule_id = ?'
    conn.query(sqlStr, [scheduleId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = result[0].seat_info
        result = JSON.parse(result)
        orderSeatInfo = JSON.parse(orderSeatInfo)
        console.log(typeof result)
        console.log(typeof orderSeatInfo)
        let tempArr = []
        result.forEach((value) => {
          if (orderSeatInfo.indexOf(value) === -1) {
            tempArr.push(value)
          }
        })
        console.log(tempArr)
        result = JSON.stringify(tempArr)
        sqlStr = 'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ?;'
        conn.query(sqlStr, [result, scheduleId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            sqlStr = 'DELETE FROM t_order WHERE order_id =?'
            conn.query(sqlStr, [orderId], (error, result, field) => {
              if (error) {
                console.log(error)
              } else {
                res.json({ success_code: 200 })
              }
            })
          }
        })
      }
    })
  }
})
//è·å–å½“å‰é¡µå½±å…
router.get('/api/admin/getCurrentPageHall', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_hall INNER JOIN t_cinema ON t_cinema.cinema_id = t_hall.cinema_id WHERE t_cinema.cinema_name LIKE ? ORDER BY hall_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_hall INNER JOIN t_cinema ON t_cinema.cinema_id = t_hall.cinema_id WHERE t_cinema.cinema_name LIKE ? ORDER BY hall_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//åˆ é™¤å½±å…
router.post('/api/admin/deleteHall', function (req, res) {
  let { cinemaId, hallName } = req.body
  if (cinemaId) {
    let sqlStr =
      'SELECT schedule_id FROM t_schedule WHERE cinema_id = ? AND hall_name = ?;'
    conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        console.log(result)
        if (result.length) {
          result.forEach((value) => {
            sqlStr = 'DELETE FROM t_schedule WHERE schedule_id = ?;'
            conn.query(sqlStr, [value.schedule_id], (error, result, field) => {
              if (error) {
                console.log(error)
              }
            })
          })
        }
        sqlStr = 'DELETE FROM t_hall WHERE cinema_id = ? AND name = ?'
        conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//æ›´æ–°å½±å…ä¿¡æ¯
router.post('/api/admin/updateHallInfo', function (req, res) {
  let { hallId, cinemaId, hallOldName, hallNewName } = req.body
  if (cinemaId) {
    let sqlStr =
      'SELECT * FROM t_hall WHERE name = ? AND cinema_id = ? AND hall_id <> ? LIMIT 1;'
    conn.query(
      sqlStr,
      [hallNewName, cinemaId, hallId],
      (error, result, field) => {
        if (error) {
          console.log(error)
        } else {
          result = JSON.parse(JSON.stringify(result))
          if (result[0]) {
            res.json({ error_code: 1, message: 'è¯¥å½±é™¢çš„å½±å…å·²å­˜åœ¨ï¼' })
          } else {
            sqlStr =
              'UPDATE t_schedule SET hall_name = ? WHERE cinema_id = ? AND hall_name = ?'
            conn.query(
              sqlStr,
              [hallNewName, cinemaId, hallOldName],
              (error, result, field) => {
                if (error) {
                  console.log(error)
                } else {
                  //æ›´æ–°æ•°æ®åº“
                  let sqlStr =
                    'UPDATE t_hall SET name = ? WHERE cinema_id = ? AND name = ?;'
                  conn.query(
                    sqlStr,
                    [hallNewName, cinemaId, hallOldName],
                    (error, result, field) => {
                      if (error) {
                        res.json({
                          error_code: 1,
                          message: 'æ›´æ–°å½±å½±å…ä¿¡æ¯å¤±è´¥',
                        })
                        console.log(error)
                      } else {
                        res.json({ success_code: 200 })
                      }
                    },
                  )
                }
              },
            )
          }
        }
      },
    )
  }
})
//è·å–æ‰€æœ‰å½±é™¢
router.get('/api/admin/getAllCinema', function (req, res) {
  let sqlStr = 'SELECT cinema_id,cinema_name FROM t_cinema;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//æ·»åŠ å½±å…ä¿¡æ¯
router.post('/api/admin/addHallInfo', function (req, res) {
  let { cinemaId, hallName } = req.body
  let sqlStr = 'SELECT * FROM t_hall WHERE name = ? AND cinema_id = ? LIMIT 1;'
  conn.query(sqlStr, [hallName, cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: 'è¯¥å½±é™¢çš„å½±å…å·²å­˜åœ¨ï¼' })
      } else {
        let sqlStr = 'INSERT INTO t_hall(cinema_id,name) VALUES(?,?);'
        conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    }
  })
})
//è·å–å½“å‰é¡µç”µå½±
router.get('/api/admin/getCurrentPageMovieSchedule', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE t_movie.name LIKE ? ORDER BY schedule_id '
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE t_movie.name LIKE ? ORDER BY schedule_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//è·å–æ‰€æœ‰ç”µå½±
router.get('/api/admin/getAllMovie', function (req, res) {
  let sqlStr = 'SELECT * FROM t_movie;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//è·å–å½±é™¢çš„å½±å…
router.get('/api/admin/getHallByCinemaId', function (req, res) {
  let cinemaId = req.query.cinemaId
  console.log(cinemaId)
  let sqlStr = 'SELECT hall_id,name FROM t_hall WHERE cinema_id = ?;'
  conn.query(sqlStr, [cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      console.log(result)
      res.json({ success_code: 200, data: result })
    }
  })
})
//è·å–æ’ç‰‡çš„æŸå¤©çš„æ—¶é—´æ®µå®‰æ’
router.get('/api/admin/getHasScheduleDateTime', function (req, res) {
  let { cinemaId, hallName, showDate } = req.query
  let sqlStr =
    'SELECT show_time FROM t_schedule WHERE cinema_id = ? AND hall_name = ? AND show_date = ?;'
  conn.query(sqlStr, [cinemaId, hallName, showDate], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//æ·»åŠ å½±é™¢ä¿¡æ¯
router.post('/api/admin/addScheduleInfo', function (req, res) {
  let { movieId, cinemaId, hallName, showDate, showTime, price } = req.body
  let sqlStr =
    'INSERT INTO t_schedule(movie_id,cinema_id,hall_name,show_date,show_time,price) VALUES(?,?,?,?,?,?);'
  conn.query(
    sqlStr,
    [movieId, cinemaId, hallName, showDate, showTime, price],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200 })
      }
    },
  )
})
//åˆ é™¤å½±å…
router.post('/api/admin/deleteMovieSchedule', function (req, res) {
  let { scheduleId } = req.body
  if (scheduleId) {
    let sqlStr = 'DELETE FROM t_schedule WHERE schedule_id = ?'
    conn.query(sqlStr, [scheduleId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200 })
      }
    })
  }
})
module.exports = router

```

const express = require('express')

const router = express.Router()

const conn = require('../db/db')

const svgCaptcha = require('svg-captcha')

const util = require('../util/util')

const multer = require('multer')

// ç”¨æˆ·API

let user = {}

/* GET home page. */

router.get('/', function (req, res, next) {

 res.render('index', { title: 'Express' })

})

//è·å–æ‰‹æœºéªŒè¯ç 

router.get('/api/getPhoneCode', function (req, res) {

 let phone = req.query.phone

 let phoneCode = util.randomCode(4)

 if (!phoneCode) {

  res.json({ error_code: 1, message: 'è·å–éªŒè¯ç å¤±è´¥' })

 } else {

  user[phone] = phoneCode

  res.json({ success_code: 200, data: phoneCode })

 }

})

//è·å–å›¾å½¢éªŒè¯ç 

router.get('/api/captcha', function (req, res) {

 let captcha = svgCaptcha.create({

  size: 4, // size of random string

  ignoreChars: '0o1i', // filter out some characters like 0o1i

  noise: 3, // number of noise lines

  color: true, //, characters will have distinct colors instead of grey, true if background option is set

  background: '#fff', // background color of the svg image

 })

 //ä¿å­˜å›¾å½¢éªŒè¯ç æ–‡æœ¬

 req.session.captcha = captcha.text.toLowerCase()

 //è¿”å›éªŒè¯ç æ•°æ®

 res.type('svg')

 res.status(200).send(captcha.data)

})

//æ‰‹æœºç™»å½•

router.post('/api/phoneLogin', function (req, res) {

 let phone = req.body.phone

 let phoneCode = req.body.phoneCode

 //åˆ¤æ–­æ‰‹æœºéªŒè¯ç æ˜¯å¦æ­£ç¡®

 if (user[phone] === phoneCode) {

  let sqlStr = 'SELECT * from t_user WHERE phone = ? LIMIT 1 ;'

  conn.query(sqlStr, [phone], (error, result, field) => {

   if (error) {

â€‹    res.json({ error_code: 1, message: 'è¯·æ±‚æ•°æ®å¤±è´¥' })

   } else {

â€‹    result = JSON.parse(JSON.stringify(result))

â€‹    //ç”¨æˆ·å­˜åœ¨

â€‹    if (result[0]) {

â€‹     req.session.userId = result[0].user_id

â€‹     res.cookie('user_id', result[0].user_id)

â€‹     res.json({ success_code: 200 })

â€‹    } else {

â€‹     //ç”¨æˆ·ä¸å­˜åœ¨

â€‹     let sqlStr =

â€‹      'INSERT INTO t_user(user_name,phone,avatar,password) VALUES(?,?,?,?)'

â€‹     let avatarSrc = '/images/avatar/monkey.png'

â€‹     conn.query(

â€‹      sqlStr,

â€‹      [phone, phone, avatarSrc, 123456],

â€‹      (error, result, field) => {

â€‹       if (error) {

â€‹        console.log(error)

â€‹        res.json({ error_code: 1, message: 'åˆ›å»ºç”¨æˆ·å¤±è´¥' })

â€‹       } else {

â€‹        res.cookie('user_id', result.insertId)

â€‹        res.json({ success_code: 200 })

â€‹       }

â€‹      },

â€‹     )

â€‹    }

   }

  })

 } else {

  res.json({ error_code: 1, message: 'éªŒè¯ç ä¸æ­£ç¡®' })

 }

})

//å¯†ç ç™»å½•

router.post('/api/pwdLogin', function (req, res) {

 let name = req.body.userName

 let pwd = req.body.password

 let captcha = req.body.captcha

 //åˆ¤æ–­éªŒè¯ç æ˜¯å¦æ­£ç¡®

 if (captcha.toLowerCase() !== req.session.captcha) {

  res.json({ error_code: 1, message: 'éªŒè¯ç ä¸æ­£ç¡®' })

 } else {

  delete req.session.captcha

  let sqlStr = 'SELECT * from t_user WHERE user_name =? LIMIT 1 ;'

  conn.query(sqlStr, [name], (error, result, field) => {

   if (error) {

â€‹    res.json({ error_code: 1, message: 'æŸ¥è¯¢ç”¨æˆ·å¤±è´¥' })

   } else {

â€‹    result = JSON.parse(JSON.stringify(result))

â€‹    if (result[0]) {

â€‹     if (result[0].password === pwd) {

â€‹      //ä¿å­˜ç”¨æˆ·id

â€‹      req.session.userId = result[0].user_id

â€‹      res.cookie('user_id', result[0].user_id)

â€‹      res.json({ success_code: 200 })

â€‹     } else {

â€‹      res.json({ error_code: 1, message: 'å¯†ç é”™è¯¯' })

â€‹     }

â€‹    } else {

â€‹     res.json({ error: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })

â€‹    }

   }

  })

 }

})

//è·å–ç”¨æˆ·ä¿¡æ¯

router.get('/api/getUserInfo', function (req, res) {

 let userId = req.query.userId

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

â€‹    res.json({ error_code: 1, message: 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥' })

   } else {

â€‹    result = JSON.parse(JSON.stringify(result))

â€‹    if (result[0]) {

â€‹     res.json({ success_code: 200, data: result[0] })

â€‹    } else {

â€‹     res.json({ error_code: 1, message: 'ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨' })

â€‹    }

   }

  })

 }

})

//æ›´æ–°ç”¨æˆ·å¤´åƒ

router.post('/api/updateUserAvatar', function (req, res) {

 let { userId, avatar } = req.body

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

â€‹    res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })

   } else {

â€‹    //æ›´æ–°æ•°æ®åº“

â€‹    let sqlStr = 'UPDATE t_user SET avatar = ? WHERE user_id = ?;'

â€‹    conn.query(sqlStr, [avatar, userId], (error, result, field) => {

â€‹     if (error) {

â€‹      res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·å¤´åƒå¤±è´¥' })

â€‹     } else {

â€‹      res.json({ success_code: 200 })

â€‹     }

â€‹    })

   }

  })

 }

})

//æ›´æ–°ç”¨æˆ·å

router.post('/api/updateUserName', function (req, res) {

 let { userId, userName } = req.body

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

â€‹    res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })

   } else {

â€‹    sqlStr =

â€‹     'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1 ;'

â€‹    conn.query(sqlStr, [userName, userId], (error, result, field) => {

â€‹     if (error) {

â€‹      console.log(error)

â€‹     } else {

â€‹      result = JSON.parse(JSON.stringify(result))

â€‹      if (result[0]) {

â€‹       res.json({ error_code: 1, message: 'ç”¨æˆ·åå·²å­˜åœ¨ï¼' })

â€‹      } else {

â€‹       //æ›´æ–°æ•°æ®åº“

â€‹       let sqlStr = 'UPDATE t_user SET user_name = ? WHERE user_id = ?;'

â€‹       conn.query(sqlStr, [userName, userId], (error, result, field) => {

â€‹        if (error) {

â€‹         res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·åå¤±è´¥' })

â€‹        } else {

â€‹         res.json({ success_code: 200 })

â€‹        }

â€‹       })

â€‹      }

â€‹     }

â€‹    })

   }

  })

 }

})

//æ›´æ–°ç”¨æˆ·æ€§åˆ«

router.post('/api/updateUserSex', function (req, res) {

 let { userId, sex } = req.body

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

â€‹    res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })

   } else {

â€‹    //æ›´æ–°æ•°æ®åº“

â€‹    let sqlStr = 'UPDATE t_user SET sex = ? WHERE user_id = ?;'

â€‹    conn.query(sqlStr, [sex, userId], (error, result, field) => {

â€‹     if (error) {

â€‹      res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·æ€§åˆ«å¤±è´¥' })

â€‹     } else {

â€‹      res.json({ success_code: 200 })

â€‹     }

â€‹    })

   }

  })

 }

})

//æ›´æ–°ç”¨æˆ·ç”Ÿæ—¥

router.post('/api/updateUserBirthday', function (req, res) {

 let { userId, birthday } = req.body

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

â€‹    res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })

   } else {

â€‹    //æ›´æ–°æ•°æ®åº“

â€‹    let sqlStr = 'UPDATE t_user SET birthday = ? WHERE user_id = ?;'

â€‹    conn.query(sqlStr, [birthday, userId], (error, result, field) => {

â€‹     if (error) {

â€‹      res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·ç”Ÿæ—¥å¤±è´¥' })

â€‹     } else {

â€‹      res.json({ success_code: 200 })

â€‹     }

â€‹    })

   }

  })

 }

})

//æ›´æ–°ç”¨æˆ·ç­¾å

router.post('/api/updateUserSign', function (req, res) {

 let { userId, sign } = req.body

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

â€‹    res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })

   } else {

â€‹    //æ›´æ–°æ•°æ®åº“

â€‹    let sqlStr = 'UPDATE t_user SET sign = ? WHERE user_id = ?;'

â€‹    conn.query(sqlStr, [sign, userId], (error, result, field) => {

â€‹     if (error) {

â€‹      res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·ç­¾åå¤±è´¥' })

â€‹     } else {

â€‹      res.json({ success_code: 200 })

â€‹     }

â€‹    })

   }

  })

 }

})

//æ›´æ–°ç”¨æˆ·ä¿¡æ¯

router.post('/api/updateUserInfo', function (req, res) {

 let { userId, userName, avatar, password, sex, sign, birthday } = req.body

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

â€‹    res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })

   } else {

â€‹    sqlStr =

â€‹     'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1 ;'

â€‹    conn.query(sqlStr, [userName, userId], (error, result, field) => {

â€‹     if (error) {

â€‹      console.log(error)

â€‹     } else {

â€‹      result = JSON.parse(JSON.stringify(result))

â€‹      if (result[0]) {

â€‹       res.json({ error_code: 1, message: 'ç”¨æˆ·åå·²å­˜åœ¨ï¼' })

â€‹      } else {

â€‹       //æ›´æ–°æ•°æ®åº“

â€‹       let sqlStr =

â€‹        'UPDATE t_user SET user_name = ?,avatar = ?,password = ?,sex = ? ,birthday = ?,sign = ?WHERE user_id = ?;'

â€‹       conn.query(

â€‹        sqlStr,

â€‹        [userName, avatar, password, sex, birthday, sign, userId],

â€‹        (error, result, field) => {

â€‹         if (error) {

â€‹          res.json({ error_code: 1, message: 'æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥' })

â€‹         } else {

â€‹          res.json({ success_code: 200 })

â€‹         }

â€‹        },

â€‹       )

â€‹      }

â€‹     }

â€‹    })

   }

  })

 }

})

//åŠ è½½ç”µå½±åˆ—è¡¨

router.get('/api/getMovieList', function (req, res) {

 let sqlStr =

  'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id;'

 conn.query(sqlStr, (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: 'è·å–ç”µå½±åˆ—è¡¨å¤±è´¥' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result.length) {

â€‹    result = result.filter((value) => {

â€‹     return (

â€‹      new Date(value.show_date + ',' + value.show_time) - new Date() > 0

â€‹     )

â€‹    })

â€‹    for (let i = 0; i < result.length; i++) {

â€‹     for (let j = i + 1; j < result.length; j++) {

â€‹      if (result[i]['movie_id'] === result[j]['movie_id']) {

â€‹       result.splice(j, 1)

â€‹       j = j - 1

â€‹      }

â€‹     }

â€‹    }

â€‹    res.json({ success_code: 200, data: result })

   } else {

â€‹    res.json({ error_code: 1, message: 'ç”µå½±åˆ—è¡¨ä¸ºç©º' })

   }

  }

 })

})

//åŠ è½½ç”µå½±è¯¦ç»†ä¿¡æ¯

router.get('/api/getMovieDetail', function (req, res) {

 let movieId = req.query.movieId

 let sqlStr = 'SELECT * FROM t_movie WHERE movie_id = ? LIMIT 1;'

 conn.query(sqlStr, [movieId], (error, result, field) => {

  if (error) {

   res.json({ error_code: 1, message: 'è·å–ç”µå½±ä¿¡æ¯å¤±è´¥' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

â€‹    res.json({ success_code: 200, data: result })

   } else {

â€‹    res.json({ error_code: 1, message: 'è¯¥ç”µå½±ä¸å­˜åœ¨' })

   }

  }

 })

})

//æ˜¯å¦æƒ³çœ‹ç”µå½±

router.post('/api/isWishMovie', function (req, res) {

 let { userId, movieId } = req.body

 let sqlStr =

  'SELECT * FROM t_wishmovie WHERE user_id = ? AND movie_id = ? LIMIT 1;'

 conn.query(sqlStr, [userId, movieId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

â€‹    res.json({ success_code: 200 })

   } else {

â€‹    res.json({ error_code: 1, message: 'ä¸æƒ³çœ‹' })

   }

  }

 })

})

//æƒ³çœ‹ç”µå½±

router.post('/api/wishMovie', function (req, res) {

 let { userId, movieId } = req.body

 let sqlStr = 'INSERT INTO t_wishmovie(user_id,movie_id) VALUES(?,?)'

 conn.query(sqlStr, [userId, movieId], (error, result, field) => {

  if (error) {

   res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })

  } else {

   let sqlStr = 'SELECT wish_num from t_movie WHERE movie_id = ? LIMIT 1;'

   conn.query(sqlStr, [movieId], (error, result, field) => {

â€‹    if (error) {

â€‹     res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })

â€‹    } else {

â€‹     result = JSON.parse(JSON.stringify(result))

â€‹     if (result[0]) {

â€‹      //æ›´æ–°æ•°æ®åº“

â€‹      let sqlStr = 'UPDATE t_movie SET wish_num = ? WHERE movie_id = ?;'

â€‹      conn.query(

â€‹       sqlStr,

â€‹       [result[0].wish_num + 1, movieId],

â€‹       (error, result, field) => {

â€‹        if (error) {

â€‹         res.json({ error_code: 1, message: 'æ›´æ–°ä¿¡æ¯å¤±è´¥' })

â€‹        } else {

â€‹         res.json({ success_code: 200 })

â€‹        }

â€‹       },

â€‹      )

â€‹     }

â€‹    }

   })

  }

 })

})

//å–æ¶ˆæƒ³çœ‹ç”µå½±

router.post('/api/cancelWishMovie', function (req, res) {

 let { userId, movieId } = req.body

 let sqlStr = 'DELETE FROM t_wishmovie WHERE user_id = ? AND movie_id =? ;'

 conn.query(sqlStr, [userId, movieId], (error, result, field) => {

  if (error) {

   res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })

  } else {

   let sqlStr = 'SELECT wish_num from t_movie WHERE movie_id = ? LIMIT 1;'

   conn.query(sqlStr, [movieId], (error, result, field) => {

â€‹    if (error) {

â€‹     res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })

â€‹    } else {

â€‹     result = JSON.parse(JSON.stringify(result))

â€‹     if (result[0]) {

â€‹      //æ›´æ–°æ•°æ®åº“

â€‹      let sqlStr = 'UPDATE t_movie SET wish_num = ? WHERE movie_id = ?;'

â€‹      conn.query(

â€‹       sqlStr,

â€‹       [result[0].wish_num - 1, movieId],

â€‹       (error, result, field) => {

â€‹        if (error) {

â€‹         res.json({ error_code: 1, message: 'æ›´æ–°ä¿¡æ¯å¤±è´¥' })

â€‹        } else {

â€‹         res.json({ success_code: 200 })

â€‹        }

â€‹       },

â€‹      )

â€‹     }

â€‹    }

   })

  }

 })

})

//è·å–å½“å‰ç”¨æˆ·è¯„è®º

router.get('/api/getUserComment', function (req, res) {

 let { userId, movieId } = req.query

 let sqlStr =

  'SELECT * FROM t_comment WHERE user_id = ? AND movie_id= ? LIMIT 1;'

 conn.query(sqlStr, [userId, movieId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

â€‹    res.json({ success_code: 200, data: result[0] })

   } else {

â€‹    res.json({ error_code: 1, message: 'ç”¨æˆ·æœªè¯„è®º' })

   }

  }

 })

})

//è·å–æ‰€æœ‰ç”¨æˆ·é€šè¿‡å®¡æ ¸çš„è¯„è®º

router.get('/api/getAllUserPassComment', function (req, res) {

 let { movieId } = req.query

 let sqlStr =

  'SELECT * FROM t_user user INNER JOIN t_comment comment ON user.user_id = comment.user_id WHERE comment.movie_id = ? AND comment.is_pass = ? ;'

 conn.query(sqlStr, [movieId, 1], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result) {

â€‹    res.json({ success_code: 200, data: result })

   } else {

â€‹    res.json({ error_code: 1, message: 'æœªè¯„è®º' })

   }

  }

 })

})

//æ›´æ–°ç”¨æˆ·è¯„è®º

router.post('/api/updateUserComment', function (req, res) {

 let { userId, movieId, score, commentContent, commentDate } = req.body

 let sqlStr =

  'SELECT comment_id from t_comment WHERE user_id = ? AND movie_id = ? LIMIT 1'

 conn.query(sqlStr, [userId, movieId], (error, result, field) => {

  if (error) {

   res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

â€‹    //è¯„è®ºå­˜åœ¨

â€‹    //æ›´æ–°

â€‹    let sqlStr =

â€‹     'UPDATE t_comment SET user_score = ?, comment_content = ?, comment_date = ?,support_num = ?,is_pass = ?,support_user = ? WHERE comment_id = ? ;'

â€‹    conn.query(

â€‹     sqlStr,

â€‹     [

â€‹      score,

â€‹      commentContent,

â€‹      commentDate,

â€‹      0,

â€‹      0,

â€‹      undefined,

â€‹      result[0].comment_id,

â€‹     ],

â€‹     (error, result, field) => {

â€‹      if (error) {

â€‹       res.json({ error_code: 1, message: 'æ›´æ–°è¯„è®ºå¤±è´¥' })

â€‹      } else {

â€‹       res.json({ success_code: 200 })

â€‹      }

â€‹     },

â€‹    )

   } else {

â€‹    //è¯„è®ºä¸å­˜åœ¨

â€‹    let sqlStr =

â€‹     'INSERT INTO t_comment(user_id,movie_id,user_score,comment_content,comment_date,support_num,is_pass) VALUES(?,?,?,?,?,?,?)'

â€‹    conn.query(

â€‹     sqlStr,

â€‹     [userId, movieId, score, commentContent, commentDate, 0, 0],

â€‹     (error, result, field) => {

â€‹      if (error) {

â€‹       console.log(error)

â€‹       res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })

â€‹      } else {

â€‹       res.json({ success_code: 200 })

â€‹      }

â€‹     },

â€‹    )

   }

  }

 })

})

//è·å–å½“å‰è¯„è®º

router.get('/api/getCommentByID', function (req, res) {

 let { commentId } = req.query

 let sqlStr = 'SELECT * FROM t_comment WHERE comment_id = ? LIMIT 1;'

 conn.query(sqlStr, [commentId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

â€‹    res.json({ success_code: 200, data: result[0] })

   } else {

â€‹    res.json({ error_code: 1, message: 'ç”¨æˆ·æœªè¯„è®º' })

   }

  }

 })

})

//æ›´æ–°å½“å‰è¯„è®ºçš„ç”¨æˆ·ç‚¹èµ

router.post('/api/updateUserSupport', function (req, res) {

 let { commentId, supportNum, supportUser } = req.body

 let sqlStr =

  'UPDATE t_comment SET support_num = ? , support_user = ? WHERE comment_id = ?;'

 conn.query(

  sqlStr,

  [supportNum, supportUser, commentId],

  (error, result, field) => {

   if (error) {

â€‹    console.log(error)

â€‹    res.json({ error_code: 1, message: 'æ“ä½œå¤±è´¥' })

   } else {

â€‹    res.json({ success_code: 200 })

   }

  },

 )

})

//åŠ è½½å½±é™¢åˆ—è¡¨

router.get('/api/getCinemaList', function (req, res) {

 let sqlStr =

  'SELECT * FROM t_schedule INNER JOIN t_cinema ON t_schedule.cinema_id = t_cinema.cinema_id INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id;'

 conn.query(sqlStr, (error, result, field) => {

  if (error) {

   res.json({ error_code: 1, message: 'è·å–å½±é™¢åˆ—è¡¨å¤±è´¥' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result.length) {

â€‹    result = result.filter((value) => {

â€‹     return (

â€‹      new Date(value.show_date + ',' + value.show_time) - new Date() > 0

â€‹     )

â€‹    })

â€‹    for (let i = 0; i < result.length; i++) {

â€‹     for (let j = i + 1; j < result.length; j++) {

â€‹      if (result[i]['cinema_id'] === result[j]['cinema_id']) {

â€‹       result.splice(j, 1)

â€‹       j = j - 1

â€‹      }

â€‹     }

â€‹    }

   }

   res.json({ success_code: 200, data: result })

  }

 })

})

//åŠ è½½å½“å‰å½±é™¢è¯¦ç»†ä¿¡æ¯

router.get('/api/getCurrentCinemaDetail', function (req, res) {

 let cinemaId = req.query.cinemaId

 let sqlStr = 'SELECT * FROM t_cinema WHERE cinema_id = ? LIMIT 1;'

 conn.query(sqlStr, [cinemaId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: 'è·å–å½“å‰å½±é™¢ä¿¡æ¯å¤±è´¥' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

â€‹    res.json({ success_code: 200, data: result[0] })

   } else {

â€‹    res.json({ error_code: 1, message: 'å½±é™¢ä¸å­˜åœ¨' })

   }

  }

 })

})

//åŠ è½½å½“å‰å½±é™¢æ’ç‰‡

router.get('/api/getCurrentCinemaMovieSchedule', function (req, res) {

 let cinemaId = req.query.cinemaId

 console.log(cinemaId)

 let sqlStr = 'SELECT * FROM t_schedule WHERE cinema_id = ?;'

 conn.query(sqlStr, [cinemaId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: 'è·å–å½“å‰å½±é™¢æ’ç‰‡ä¿¡æ¯å¤±è´¥' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result) {

â€‹    let tempMovieArr = []

â€‹    result.forEach((value) => {

â€‹     if (

â€‹      new Date() - new Date(value.show_date + ',' + value.show_time) <=

â€‹      0

â€‹     ) {

â€‹      tempMovieArr.push(value.movie_id)

â€‹     }

â€‹    })

â€‹    tempMovieArr = Array.from(new Set(tempMovieArr))

â€‹    let movieArray = []

â€‹    let movieScheduleArray = []

â€‹    tempMovieArr.forEach((value) => {

â€‹     sqlStr = 'SELECT * FROM t_movie WHERE movie_id = ? LIMIT 1;'

â€‹     conn.query(sqlStr, [value], (error, result, field) => {

â€‹      if (error) {

â€‹       console.log(error)

â€‹      } else {

â€‹       result = JSON.parse(JSON.stringify(result))

â€‹       if (result[0]) {

â€‹        movieArray.push(result[0])

â€‹       }

â€‹      }

â€‹     })

â€‹     sqlStr =

â€‹      'SELECT * FROM t_schedule schedule INNER JOIN t_movie movie ON schedule.movie_id = movie.movie_id WHERE schedule.movie_id = ? AND schedule.cinema_id = ?;'

â€‹     conn.query(sqlStr, [value, cinemaId], (error, result, field) => {

â€‹      if (error) {

â€‹       console.log(error)

â€‹      } else {

â€‹       result = JSON.parse(JSON.stringify(result))

â€‹       if (result) {

â€‹        movieScheduleArray.push(result)

â€‹       }

â€‹      }

â€‹     })

â€‹    })

â€‹    setTimeout(() => {

â€‹     res.json({

â€‹      success_code: 200,

â€‹      data: {

â€‹       hasMovieInfo: movieArray,

â€‹       movieScheduleInfo: movieScheduleArray,

â€‹      },

â€‹     })

â€‹    }, 500)

   } else {

â€‹    res.json({ error_code: 1, message: 'å½“å‰å½±é™¢æ’ç‰‡ä¿¡æ¯ä¸ºç©º' })

   }

  }

 })

})

//åŠ è½½å½“å‰å½±é™¢è¯¦ç»†ä¿¡æ¯

router.get('/api/getScheduleById', function (req, res) {

 let scheduleId = req.query.scheduleId

 let sqlStr = 'SELECT * FROM t_schedule WHERE schedule_id = ? LIMIT 1;'

 conn.query(sqlStr, [scheduleId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: 'è·å–å½“å‰æ’ç‰‡ä¿¡æ¯å¤±è´¥' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

â€‹    res.json({ success_code: 200, data: result[0] })

   } else {

â€‹    res.json({ error_code: 1, message: 'æ’ç‰‡ä¿¡æ¯ä¸å­˜åœ¨' })

   }

  }

 })

})

//åŠ è½½å½“å‰å½±é™¢è¯¦ç»†ä¿¡æ¯

router.post('/api/updateScheduleSeat', function (req, res) {

 let { scheduleId, seatInfo } = req.body

 let sqlStr =

  'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ? LIMIT 1;'

 conn.query(sqlStr, [seatInfo, scheduleId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: 'æ›´æ–°æ’ç‰‡åº§ä½ä¿¡æ¯å¤±è´¥' })

  } else {

   res.json({ success_code: 200, data: result[0] })

  }

 })

})

//åŠ è½½å½“å‰ç”µå½±æ’ç‰‡

router.get('/api/getCurrentMovieSchedule', function (req, res) {

 let movieId = req.query.movieId

 let sqlStr = 'SELECT * FROM t_schedule WHERE movie_id = ?;'

 conn.query(sqlStr, [movieId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: 'è·å–å½“å‰å½±é™¢æ’ç‰‡ä¿¡æ¯å¤±è´¥' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result) {

â€‹    let tempDateArr = []

â€‹    result.forEach((value) => {

â€‹     if (

â€‹      new Date() - new Date(value.show_date + ',' + value.show_time) <=

â€‹      0

â€‹     ) {

â€‹      tempDateArr.push(value.show_date)

â€‹     }

â€‹    })

â€‹    tempDateArr = Array.from(new Set(tempDateArr))

â€‹    tempDateArr.sort((a, b) => {

â€‹     return new Date(a) - new Date(b)

â€‹    })

â€‹    let cinemaArray = []

â€‹    let cinemaScheduleArray = []

â€‹    tempDateArr.forEach((value) => {

â€‹     sqlStr = 'SELECT * FROM t_schedule WHERE show_date = ?'

â€‹     conn.query(sqlStr, [value], (error, result, field) => {

â€‹      if (error) {

â€‹       console.log(error)

â€‹      } else {

â€‹       result = JSON.parse(JSON.stringify(result))

â€‹       if (result) {

â€‹        cinemaArray.push(result)

â€‹       }

â€‹      }

â€‹     })

â€‹     sqlStr =

â€‹      'SELECT * FROM t_schedule schedule INNER JOIN t_cinema cinema ON schedule.cinema_id = cinema.cinema_id WHERE schedule.movie_id = ? AND schedule.show_date = ?;'

â€‹     conn.query(sqlStr, [movieId, value], (error, result, field) => {

â€‹      if (error) {

â€‹       console.log(error)

â€‹      } else {

â€‹       result = JSON.parse(JSON.stringify(result))

â€‹       if (result) {

â€‹        cinemaScheduleArray.push(result)

â€‹       }

â€‹      }

â€‹     })

â€‹    })

â€‹    setTimeout(() => {

â€‹     res.json({

â€‹      success_code: 200,

â€‹      data: {

â€‹       hasCinemaInfo: cinemaArray,

â€‹       cinemaScheduleInfo: cinemaScheduleArray,

â€‹      },

â€‹     })

â€‹    }, 500)

   } else {

â€‹    res.json({ error_code: 1, message: 'å½“å‰ç”µå½±æ’ç‰‡ä¿¡æ¯ä¸ºç©º' })

   }

  }

 })

})

//æ ¹æ®åå­—åŒ¹é…ç”µå½±---ç²¾å‡†æœç´¢

router.get('/api/matchMovieByName', function (req, res) {

 console.log('å¼€å§‹ç²¾å‡†æœç´¢ï¼ï¼ï¼ï¼')

 let movieName = req.query.movieName

 let sqlStr =

  'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id WHERE name LIKE ?;'

 conn.query(sqlStr, ['%' + movieName + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result.length) {

â€‹    result = result.filter((value) => {

â€‹     return (

â€‹      new Date(value.show_date + ',' + value.show_time) - new Date() > 0

â€‹     )

â€‹    })

â€‹    for (let i = 0; i < result.length; i++) {

â€‹     for (let j = i + 1; j < result.length; j++) {

â€‹      if (result[i]['movie_id'] === result[j]['movie_id']) {

â€‹       result.splice(j, 1)

â€‹       j = j - 1

â€‹      }

â€‹     }

â€‹    }

   }

   res.json({ success_code: 200, data: result })

  }

 })

})

const _ = require('lodash')

// const { createRequire } = require('module')

// const requireES6 = createRequire(import.meta.url)

// å¯¼å…¥ jieba ç›¸å…³æ¨¡å—

const { Jieba } = require('@node-rs/jieba')

const { dict } = require('@node-rs/jieba/dict')

// åˆå§‹åŒ– jieba å®ä¾‹

const jieba = Jieba.withDict(dict)

// BM25 ç±»

class BM25 {

 constructor(docs, k1 = 1.2, b = 0.75) {

  this.docs = docs

  this.k1 = k1

  this.b = b

  this.avgDocLen = this.calculateAvgDocLen()

  this.idf = this.calculateIDF()

 }

 calculateAvgDocLen() {

  let totalLen = 0

  for (const doc of this.docs) {

   totalLen += doc.length

  }

  return totalLen / this.docs.length

 }

 calculateIDF() {

  const docCount = this.docs.length

  const idf = {}

  const termDocCount = {}

  for (const doc of this.docs) {

   const uniqueTerms = _.uniq(doc)

   for (const term of uniqueTerms) {

â€‹    termDocCount[term] = (termDocCount[term] || 0) + 1

   }

  }

  for (const term in termDocCount) {

   const freq = termDocCount[term]

   idf[term] = Math.log((docCount - freq + 0.5) / (freq + 0.5) + 1)

  }

  return idf

 }

 score(query, doc) {

  const docLen = doc.length

  const termFreq = _.countBy(doc)

  let score = 0

  for (const term of query) {

   if (this.idf[term]) {

â€‹    const freq = termFreq[term] || 0

â€‹    const numerator = this.idf[term] * freq * (this.k1 + 1)

â€‹    const denominator =

â€‹     freq + this.k1 * (1 - this.b + this.b * (docLen / this.avgDocLen))

â€‹    score += numerator / denominator

   }

  }

  return score

 }

}

router.get('/api/semanticSearchMovie', function (req, res) {

 console.log('å¼€å§‹è¿›è¡Œè¯­ä¹‰æœç´¢ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼')

 let searchQuery = req.query.searchQuery

 console.log('ç”¨æˆ·æœç´¢è¯:', searchQuery)

 if (!searchQuery) {

  return res.json({ error_code: 1, message: 'æœç´¢è¯ä¸èƒ½ä¸ºç©º' })

 }

 let sqlStr = 'SELECT movie_id, name, intro FROM t_movie;'

 conn.query(sqlStr, (error, result) => {

  if (error) {

   console.error('æ•°æ®åº“æŸ¥è¯¢é”™è¯¯:', error)

   return res.json({ error_code: 1, message: 'æ•°æ®åº“æŸ¥è¯¢å¤±è´¥' })

  }

  result = JSON.parse(JSON.stringify(result)) // è§„èŒƒåŒ–æ•°æ®æ ¼å¼

  console.log('æ•°æ®åº“æŸ¥è¯¢è¿”å›:', result.length, 'æ¡è®°å½•')

  if (result.length === 0) {

   return res.json({ success_code: 200, data: [] })

  }

  // **âœ… è¿›è¡Œåˆ†è¯å¤„ç†**

  const searchTokens = jieba.cut(searchQuery)

  const docs = result.map((movie) => jieba.cut(movie.intro))

  // **âœ… è®¡ç®— BM25 ç›¸å…³æ€§**

  const bm25 = new BM25(docs)

  const results = result.map((movie, i) => ({

   movie_id: movie.movie_id,

   name: movie.name,

   intro: movie.intro,

   score: bm25.score(searchTokens, docs[i]),

  }))

  // **âœ… æ’åº & å»é‡**

  const topResults = _.uniqBy(

   results.sort((a, b) => b.score - a.score).slice(0, 10),

   'movie_id',

  )

  const movieIds = topResults.map((m) => m.movie_id)

  console.log('Top 10 ç”µå½± ID:', movieIds)

  if (movieIds.length === 0) {

   return res.json({ success_code: 200, data: [] })

  }

  // **âœ… æŸ¥è¯¢å®Œæ•´ç”µå½±ä¿¡æ¯**

  let finalSqlStr = `

   SELECT t_schedule.*, t_movie.*

   FROM t_schedule

   INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id

   WHERE t_schedule.movie_id IN (${movieIds.map(() => '?').join(',')})

  `

  conn.query(finalSqlStr, movieIds, (err, finalResults) => {

   if (err) {

â€‹    console.error('è·å–å®Œæ•´ç”µå½±ä¿¡æ¯é”™è¯¯:', err)

â€‹    return res.json({ error_code: 1, message: 'è·å–ç”µå½±è¯¦æƒ…å¤±è´¥' })

   }

   console.log('å®Œæ•´ç”µå½±æ•°æ®:', finalResults.length, 'æ¡è®°å½•')

   res.json({ success_code: 200, data: finalResults })

  })

 })

})

//æ ¹æ®åå­—åŒ¹é…å½±é™¢

router.get('/api/matchCinemaByName', function (req, res) {

 let cinemaName = req.query.cinemaName

 let sqlStr =

  'SELECT * FROM t_schedule INNER JOIN t_cinema ON t_schedule.cinema_id = t_cinema.cinema_id INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id WHERE cinema_name LIKE ?;'

 conn.query(sqlStr, ['%' + cinemaName + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result.length) {

â€‹    result = result.filter((value) => {

â€‹     return (

â€‹      new Date(value.show_date + ',' + value.show_time) - new Date() > 0

â€‹     )

â€‹    })

â€‹    for (let i = 0; i < result.length; i++) {

â€‹     for (let j = i + 1; j < result.length; j++) {

â€‹      if (result[i]['cinema_id'] === result[j]['cinema_id']) {

â€‹       result.splice(j, 1)

â€‹       j = j - 1

â€‹      }

â€‹     }

â€‹    }

   }

   res.json({ success_code: 200, data: result })

  }

 })

})

//ç”¨æˆ·ä¸‹å•

router.post('/api/order', function (req, res) {

 let {

  userId,

  scheduleId,

  orderPhone,

  orderDate,

  ticketNum,

  totalPrice,

  orderSeatInfo,

  payType,

 } = req.body

 let phoneCode = util.randomCode(6)

 let sqlStr =

  'INSERT INTO t_order(user_id,schedule_id,order_phone,order_date,ticket_num,ticket_total_price,order_seat_info,pay_type,phone_code) VALUES(?,?,?,?,?,?,?,?,?); '

 conn.query(

  sqlStr,

  [

   userId,

   scheduleId,

   orderPhone,

   orderDate,

   ticketNum,

   totalPrice,

   orderSeatInfo,

   payType,

   phoneCode,

  ],

  (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    res.json({ success_code: 200, data: { phone_code: phoneCode } })

   }

  },

 )

})

//è·å–ä¸ªäººè®¢å•ä¿¡æ¯

router.get('/api/getOrderByUserId', function (req, res) {

 let userId = req.query.userId

 let sqlStr =

  'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE user_id = ?;'

 conn.query(sqlStr, [userId], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   res.json({ success_code: 200, data: result })

  }

 })

})

//è·å–ä¸ªäººæƒ³çœ‹ç”µå½±

router.get('/api/getWishMovieByUserId', function (req, res) {

 let userId = req.query.userId

 let sqlStr =

  'SELECT * FROM t_wishmovie INNER JOIN t_movie ON t_wishmovie.movie_id = t_movie.movie_id WHERE user_id = ?;'

 conn.query(sqlStr, [userId], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   res.json({ success_code: 200, data: result })

  }

 })

})

//è·å–ä¸ªäººçœ‹è¿‡çš„ç”µå½±

router.get('/api/getIsWatchedMovieByUserId', function (req, res) {

 let userId = req.query.userId

 let sqlStr =

  'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id WHERE user_id = ? AND is_pass = 1;'

 conn.query(sqlStr, [userId], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   res.json({ success_code: 200, data: result })

  }

 })

})

//ç®¡ç†å‘˜API

//è·å–å½“å‰é¡µç”¨æˆ·

//å¯†ç ç™»å½•

router.post('/api/admin/login', function (req, res) {

 let name = req.body.name

 let password = req.body.password

 let sqlStr = 'SELECT * FROM t_admin WHERE name = ? LIMIT 1 ;'

 conn.query(sqlStr, [name, password], (error, result, field) => {

  if (error) {

   res.json({ error_code: 1, message: 'æŸ¥è¯¢ç”¨æˆ·å¤±è´¥' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

â€‹    if (result[0].password === password) {

â€‹     //ä¿å­˜ç”¨æˆ·id

â€‹     req.session.adminId = result[0].admin_id

â€‹     res.cookie('admin_id', result[0].admin_id)

â€‹     res.json({ success_code: 200 })

â€‹    } else {

â€‹     res.json({ error_code: 1, message: 'å¯†ç é”™è¯¯' })

â€‹    }

   } else {

â€‹    res.json({ error: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })

   }

  }

 })

})

//è·å–ç”¨æˆ·ä¿¡æ¯

router.get('/api/admin/getAdminInfo', function (req, res) {

 let adminId = req.query.adminId

 let sqlStr = 'SELECT * FROM t_admin WHERE admin_id = ? LIMIT 1 ;'

 conn.query(sqlStr, [adminId], (error, result, field) => {

  if (error) {

   res.json({ error_code: 1, message: 'æŸ¥è¯¢ç”¨æˆ·å¤±è´¥' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

â€‹    res.json({ success_code: 200, data: result[0] })

   } else {

â€‹    res.json({ error: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })

   }

  }

 })

})

router.get('/api/admin/getCurrentPageUser', function (req, res) {

 let { currentPage, pageSize, input } = req.query

 let start = Number((currentPage - 1) * pageSize)

 pageSize = Number(pageSize)

 let sqlStr = 'SELECT * FROM t_user WHERE user_name LIKE ? ORDER BY user_id;'

 let total

 conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   total = result.length

  }

 })

 sqlStr =

  'SELECT * FROM t_user WHERE user_name LIKE ? ORDER BY user_id LIMIT ?,?;'

 conn.query(

  sqlStr,

  ['%' + input + '%', start, pageSize],

  (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    result = JSON.parse(JSON.stringify(result))

â€‹    res.json({ success_code: 200, data: result, total: total })

   }

  },

 )

})

var datatime = './public/images/avatar/'

//å°†å›¾ç‰‡æ”¾åˆ°æœåŠ¡å™¨

var storage = multer.diskStorage({

 // å¦‚æœä½ æä¾›çš„ destination æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½ éœ€è¦è´Ÿè´£åˆ›å»ºæ–‡ä»¶å¤¹

 destination: datatime,

 // //ç»™ä¸Šä¼ æ–‡ä»¶é‡å‘½åï¼Œè·å–æ·»åŠ åç¼€å

 filename: function (req, file, cb) {

  cb(null, new Date().getTime() + '.jpg')

 },

})

var upload = multer({

 storage: storage,

})

// let upload = multer({dest:'./public/images/avatar'}).any();

router.post('/api/admin/upLoadImg', upload.any(), function (req, res) {

 res.json({ success_code: 200, data: req.files })

 console.log(req.files)

})

//æ›´æ–°ç”¨æˆ·ä¿¡æ¯

router.post('/api/admin/updateUserInfo', function (req, res) {

 let { userId, userName, avatar, password, sex, phone, sign, birthday } =

  req.body

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

â€‹    res.json({ error_code: 1, message: 'ç”¨æˆ·ä¸å­˜åœ¨' })

   } else {

â€‹    let sqlStr =

â€‹     'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1;'

â€‹    conn.query(sqlStr, [userName, userId], (error, result, field) => {

â€‹     if (error) {

â€‹      console.log(error)

â€‹     } else {

â€‹      result = JSON.parse(JSON.stringify(result))

â€‹      if (result[0]) {

â€‹       res.json({ error_code: 1, message: 'ç”¨æˆ·åå·²å­˜åœ¨ï¼' })

â€‹      } else {

â€‹       sqlStr =

â€‹        'SELECT * FROM t_user WHERE phone = ? AND user_id <> ? LIMIT 1;'

â€‹       conn.query(sqlStr, [phone, userId], (error, result, field) => {

â€‹        if (error) {

â€‹         console.log(error)

â€‹        } else {

â€‹         result = JSON.parse(JSON.stringify(result))

â€‹         if (result[0]) {

â€‹          res.json({ error_code: 1, message: 'æ‰‹æœºå·ç å·²æ³¨å†Œï¼' })

â€‹         } else {

â€‹          //æ›´æ–°æ•°æ®åº“

â€‹          let sqlStr =

â€‹           'UPDATE t_user SET user_name = ?,avatar = ?,password = ?,sex = ? ,phone = ?,birthday = ?,sign = ? WHERE user_id = ?;'

â€‹          conn.query(

â€‹           sqlStr,

â€‹           [

â€‹            userName,

â€‹            avatar,

â€‹            password,

â€‹            sex,

â€‹            phone,

â€‹            birthday,

â€‹            sign,

â€‹            userId,

â€‹           ],

â€‹           (error, result, field) => {

â€‹            if (error) {

â€‹             res.json({

â€‹              error_code: 1,

â€‹              message: 'æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥',

â€‹             })

â€‹             console.log(error)

â€‹            } else {

â€‹             res.json({ success_code: 200 })

â€‹            }

â€‹           },

â€‹          )

â€‹         }

â€‹        }

â€‹       })

â€‹      }

â€‹     }

â€‹    })

   }

  })

 }

})

//åˆ é™¤ç”¨æˆ·ä¿¡æ¯

router.post('/api/admin/deleteUserInfo', function (req, res) {

 let { userId } = req.body

 if (userId) {

  let sqlStr =

   'SELECT t_schedule.schedule_id, t_schedule.seat_info,order_seat_info FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id WHERE user_id = ?'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    result = JSON.parse(JSON.stringify(result))

â€‹    console.log(result)

â€‹    if (result) {

â€‹     result.forEach((value) => {

â€‹      let tempArr = []

â€‹      value.seat_info = JSON.parse(value.seat_info)

â€‹      value.order_seat_info = JSON.parse(value.order_seat_info)

â€‹      value.seat_info.forEach((v) => {

â€‹       if (value.order_seat_info.indexOf(v) === -1) {

â€‹        tempArr.push(v)

â€‹       }

â€‹      })

â€‹      tempArr = JSON.stringify(tempArr)

â€‹      sqlStr =

â€‹       'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ?;'

â€‹      conn.query(

â€‹       sqlStr,

â€‹       [tempArr, value.schedule_id],

â€‹       (error, result, field) => {

â€‹        if (error) {

â€‹         console.log(error)

â€‹        }

â€‹       },

â€‹      )

â€‹     })

â€‹    }

â€‹    sqlStr = 'DELETE FROM t_user WHERE user_id =?'

â€‹    conn.query(sqlStr, [userId], (error, result, field) => {

â€‹     if (error) {

â€‹      console.log(error)

â€‹     } else {

â€‹      res.json({ success_code: 200 })

â€‹     }

â€‹    })

   }

  })

 }

})

//æ·»åŠ ç”¨æˆ·ä¿¡æ¯

router.post('/api/admin/addUserInfo', function (req, res) {

 let { userName, avatar, phone, password, sex, sign, birthday } = req.body

 if (!avatar) {

  avatar = '/images/avatar/monkey.png'

 }

 let sqlStr = 'SELECT * FROM t_user WHERE user_name = ? LIMIT 1;'

 conn.query(sqlStr, [userName], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

â€‹    res.json({ error_code: 1, message: 'ç”¨æˆ·åå·²å­˜åœ¨ï¼' })

   } else {

â€‹    sqlStr = 'SELECT * FROM t_user WHERE phone = ? LIMIT 1'

â€‹    conn.query(sqlStr, [phone], (error, result, field) => {

â€‹     if (error) {

â€‹      console.log(error)

â€‹     } else {

â€‹      result = JSON.parse(JSON.stringify(result))

â€‹      if (result[0]) {

â€‹       res.json({ error_code: 1, message: 'æ‰‹æœºå·ç å·²æ³¨å†Œï¼' })

â€‹      } else {

â€‹       sqlStr =

â€‹        'INSERT INTO t_user(user_name,avatar,phone,password,sex,sign,birthday) VALUES(?,?,?,?,?,?,?);'

â€‹       conn.query(

â€‹        sqlStr,

â€‹        [userName, avatar, phone, password, sex, sign, birthday],

â€‹        (error, result, field) => {

â€‹         if (error) {

â€‹          console.log(error)

â€‹         } else {

â€‹          res.json({ success_code: 200 })

â€‹         }

â€‹        },

â€‹       )

â€‹      }

â€‹     }

â€‹    })

   }

  }

 })

})

//è·å–å½“å‰é¡µç”µå½±

router.get('/api/admin/getCurrentPageMovie', function (req, res) {

 let { currentPage, pageSize, input } = req.query

 let start = Number((currentPage - 1) * pageSize)

 pageSize = Number(pageSize)

 let sqlStr = 'SELECT * FROM t_movie WHERE name LIKE ? ORDER BY movie_id'

 let total

 conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   total = result.length

  }

 })

 sqlStr =

  'SELECT * FROM t_movie WHERE name LIKE ? ORDER BY movie_id LIMIT ?,?;'

 conn.query(

  sqlStr,

  ['%' + input + '%', start, pageSize],

  (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    result = JSON.parse(JSON.stringify(result))

â€‹    res.json({ success_code: 200, data: result, total: total })

   }

  },

 )

})

//æ›´æ–°ç”µå½±ä¿¡æ¯

router.post('/api/admin/updateMovieInfo', function (req, res) {

 let {

  movieId,

  movieName,

  poster,

  director,

  actor,

  long,

  type,

  language,

  publicDate,

  intro,

 } = req.body

 let sqlStr = 'SELECT * FROM t_movie WHERE name = ? AND movie_id <> ? LIMIT 1;'

 conn.query(sqlStr, [movieName, movieId], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

â€‹    res.json({ error_code: 1, message: 'ç”µå½±åå·²å­˜åœ¨ï¼' })

   } else {

â€‹    //æ›´æ–°æ•°æ®åº“

â€‹    let sqlStr =

â€‹     'UPDATE t_movie SET name = ?,poster = ?,director = ?,actor = ? ,movie_long = ?,type = ?,language = ?,public_date = ?,intro = ? WHERE movie_id = ?;'

â€‹    conn.query(

â€‹     sqlStr,

â€‹     [

â€‹      movieName,

â€‹      poster,

â€‹      director,

â€‹      actor,

â€‹      long,

â€‹      type,

â€‹      language,

â€‹      publicDate,

â€‹      intro,

â€‹      movieId,

â€‹     ],

â€‹     (error, result, field) => {

â€‹      if (error) {

â€‹       console.log(error)

â€‹      } else {

â€‹       res.json({ success_code: 200 })

â€‹      }

â€‹     },

â€‹    )

   }

  }

 })

})

//æ·»åŠ ç”µå½±ä¿¡æ¯

router.post('/api/admin/addMovieInfo', function (req, res) {

 let {

  movieName,

  poster,

  director,

  actor,

  long,

  type,

  language,

  publicDate,

  intro,

 } = req.body

 let sqlStr = 'SELECT * FROM t_movie WHERE name = ? LIMIT 1;'

 conn.query(sqlStr, [movieName], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

â€‹    res.json({ error_code: 1, message: 'ç”µå½±åå·²å­˜åœ¨ï¼' })

   } else {

â€‹    let sqlStr =

â€‹     'INSERT INTO t_movie(name,poster,director,actor,movie_long,type,language,public_date,intro) VALUES(?,?,?,?,?,?,?,?,?);'

â€‹    conn.query(

â€‹     sqlStr,

â€‹     [

â€‹      movieName,

â€‹      poster,

â€‹      director,

â€‹      actor,

â€‹      long,

â€‹      type,

â€‹      language,

â€‹      publicDate,

â€‹      intro,

â€‹     ],

â€‹     (error, result, field) => {

â€‹      if (error) {

â€‹       console.log(error)

â€‹      } else {

â€‹       res.json({ success_code: 200 })

â€‹      }

â€‹     },

â€‹    )

   }

  }

 })

})

datatime = './public/images/movie/'

//å°†å›¾ç‰‡æ”¾åˆ°æœåŠ¡å™¨

storage = multer.diskStorage({

 // å¦‚æœä½ æä¾›çš„ destination æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½ éœ€è¦è´Ÿè´£åˆ›å»ºæ–‡ä»¶å¤¹

 destination: datatime,

 // //ç»™ä¸Šä¼ æ–‡ä»¶é‡å‘½åï¼Œè·å–æ·»åŠ åç¼€å

 filename: function (req, file, cb) {

  cb(null, new Date().getTime() + '.jpg')

 },

})

upload = multer({

 storage: storage,

})

router.post('/api/admin/upLoadMovieImg', upload.any(), function (req, res) {

 res.json({ success_code: 200, data: req.files })

 console.log(req.files)

})

//åˆ é™¤ç”µå½±ä¿¡æ¯

router.post('/api/admin/deleteMovieInfo', function (req, res) {

 let { movieId } = req.body

 let sqlStr = 'DELETE FROM t_movie WHERE movie_id =?'

 conn.query(sqlStr, [movieId], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   res.json({ success_code: 200 })

  }

 })

})

//è·å–å½“å‰é¡µå½±é™¢

router.get('/api/admin/getCurrentPageCinema', function (req, res) {

 let { currentPage, pageSize, input } = req.query

 let start = Number((currentPage - 1) * pageSize)

 pageSize = Number(pageSize)

 let sqlStr =

  'SELECT * FROM t_cinema WHERE cinema_name LIKE ? ORDER BY cinema_id ;'

 let total

 conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   total = result.length

  }

 })

 sqlStr =

  'SELECT * FROM t_cinema WHERE cinema_name LIKE ? ORDER BY cinema_id LIMIT ?,?;'

 conn.query(

  sqlStr,

  ['%' + input + '%', start, pageSize],

  (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    result = JSON.parse(JSON.stringify(result))

â€‹    res.json({ success_code: 200, data: result, total: total })

   }

  },

 )

})

//æ›´æ–°å½±é™¢ä¿¡æ¯

router.post('/api/admin/updateCinemaInfo', function (req, res) {

 let { cinemaId, cinemaName, cinemaPhone, address } = req.body

 if (cinemaId) {

  let sqlStr = 'SELECT * from t_cinema WHERE cinema_id = ? LIMIT 1;'

  conn.query(sqlStr, [cinemaId], (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    sqlStr =

â€‹     'SELECT * FROM t_cinema WHERE cinema_name = ? AND cinema_id <> ? LIMIT 1 ;'

â€‹    conn.query(sqlStr, [cinemaName, cinemaId], (error, result, field) => {

â€‹     if (error) {

â€‹      console.log(error)

â€‹     } else {

â€‹      result = JSON.parse(JSON.stringify(result))

â€‹      if (result[0]) {

â€‹       res.json({ error_code: 1, message: 'å½±é™¢åå·²å­˜åœ¨ï¼' })

â€‹      } else {

â€‹       //æ›´æ–°æ•°æ®åº“

â€‹       let sqlStr =

â€‹        'UPDATE t_cinema SET cinema_name = ?,cinema_phone = ?,specified_address = ? WHERE cinema_id = ?;'

â€‹       conn.query(

â€‹        sqlStr,

â€‹        [cinemaName, cinemaPhone, address, cinemaId],

â€‹        (error, result, field) => {

â€‹         if (error) {

â€‹          res.json({ error_code: 1, message: 'æ›´æ–°å½±é™¢ä¿¡æ¯å¤±è´¥' })

â€‹          console.log(error)

â€‹         } else {

â€‹          res.json({ success_code: 200 })

â€‹         }

â€‹        },

â€‹       )

â€‹      }

â€‹     }

â€‹    })

   }

  })

 }

})

//åˆ é™¤å½±é™¢ä¿¡æ¯

router.post('/api/admin/deleteCinemaInfo', function (req, res) {

 let { cinemaId } = req.body

 if (cinemaId) {

  let sqlStr = 'DELETE FROM t_cinema WHERE cinema_id =?'

  conn.query(sqlStr, [cinemaId], (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    res.json({ success_code: 200 })

   }

  })

 }

})

//æ·»åŠ å½±é™¢ä¿¡æ¯

router.post('/api/admin/addCinemaInfo', function (req, res) {

 let { cinemaName, cinemaPhone, address } = req.body

 sqlStr = 'SELECT * FROM t_cinema WHERE cinema_name = ? LIMIT 1 ;'

 conn.query(sqlStr, [cinemaName], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

â€‹    res.json({ error_code: 1, message: 'å½±é™¢åå·²å­˜åœ¨ï¼' })

   } else {

â€‹    let sqlStr =

â€‹     'INSERT INTO t_cinema(cinema_name,cinema_phone,specified_address) VALUES(?,?,?);'

â€‹    conn.query(

â€‹     sqlStr,

â€‹     [cinemaName, cinemaPhone, address],

â€‹     (error, result, field) => {

â€‹      if (error) {

â€‹       console.log(error)

â€‹      } else {

â€‹       res.json({ success_code: 200 })

â€‹      }

â€‹     },

â€‹    )

   }

  }

 })

})

//è·å–å½“å‰é¡µè¯„è®º

router.get('/api/admin/getCurrentPageComment', function (req, res) {

 let { currentPage, pageSize, input } = req.query

 let start = Number((currentPage - 1) * pageSize)

 pageSize = Number(pageSize)

 let sqlStr =

  'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id INNER JOIN t_user ON t_user.user_id=t_comment.user_id WHERE t_movie.name LIKE ? ORDER BY comment_id;'

 let total

 conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   total = result.length

  }

 })

 sqlStr =

  'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id INNER JOIN t_user ON t_user.user_id=t_comment.user_id WHERE t_movie.name LIKE ? ORDER BY comment_id LIMIT ?,?;'

 conn.query(

  sqlStr,

  ['%' + input + '%', start, pageSize],

  (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    result = JSON.parse(JSON.stringify(result))

â€‹    res.json({ success_code: 200, data: result, total: total })

   }

  },

 )

})

//é€šè¿‡å½“å‰è¯„è®º

router.post('/api/admin/passCurrentComment', function (req, res) {

 let commentId = req.body.commentId

 let movieId = req.body.movieId

 if (commentId) {

  let sqlStr = 'UPDATE t_comment SET is_pass = 1 WHERE comment_id = ?;'

  conn.query(sqlStr, [commentId], (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    sqlStr =

â€‹     'SELECT user_score FROM t_comment WHERE movie_id = ? AND is_pass = ?;'

â€‹    conn.query(sqlStr, [movieId, 1], (error, result, field) => {

â€‹     if (error) {

â€‹      console.log(error)

â€‹     } else {

â€‹      result = JSON.parse(JSON.stringify(result))

â€‹      let avgScore = 0

â€‹      if (result.length) {

â€‹       result.forEach((val) => {

â€‹        avgScore += Number(val.user_score)

â€‹       })

â€‹       avgScore = (avgScore / Number(result.length)).toFixed(1)

â€‹      }

â€‹      sqlStr = 'UPDATE t_movie SET score = ? WHERE movie_id = ?;'

â€‹      conn.query(sqlStr, [avgScore, movieId], (error, result, field) => {

â€‹       if (error) {

â€‹        console.log(error)

â€‹       } else {

â€‹        res.json({ success_code: 200 })

â€‹       }

â€‹      })

â€‹     }

â€‹    })

   }

  })

 }

})

//åˆ é™¤å½“å‰è¯„è®º

router.post('/api/admin/deleteCurrentComment', function (req, res) {

 let commentId = req.body.commentId

 let movieId = req.body.movieId

 if (commentId) {

  let sqlStr = 'DELETE FROM t_comment WHERE comment_id = ?;'

  conn.query(sqlStr, [commentId], (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    sqlStr =

â€‹     'SELECT user_score FROM t_comment WHERE movie_id = ? AND is_pass = ?;'

â€‹    conn.query(sqlStr, [movieId, 1], (error, result, field) => {

â€‹     if (error) {

â€‹      console.log(error)

â€‹     } else {

â€‹      result = JSON.parse(JSON.stringify(result))

â€‹      let avgScore = 0

â€‹      if (result.length) {

â€‹       result.forEach((val) => {

â€‹        avgScore += Number(val.user_score)

â€‹       })

â€‹       avgScore = (avgScore / Number(result.length)).toFixed(1)

â€‹      }

â€‹      sqlStr = 'UPDATE t_movie SET score = ? WHERE movie_id = ?;'

â€‹      conn.query(sqlStr, [avgScore, movieId], (error, result, field) => {

â€‹       if (error) {

â€‹        console.log(error)

â€‹       } else {

â€‹        res.json({ success_code: 200 })

â€‹       }

â€‹      })

â€‹     }

â€‹    })

   }

  })

 }

})

//è·å–å½“å‰é¡µè®¢å•

router.get('/api/admin/getCurrentPageOrder', function (req, res) {

 let { currentPage, pageSize, input } = req.query

 let start = Number((currentPage - 1) * pageSize)

 pageSize = Number(pageSize)

 let sqlStr =

  'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id INNER JOIN t_user ON t_order.user_id = t_user.user_id WHERE t_movie.name LIKE ? ORDER BY order_id;'

 let total

 conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   total = result.length

  }

 })

 sqlStr =

  'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id INNER JOIN t_user ON t_order.user_id = t_user.user_id WHERE t_movie.name LIKE ? ORDER BY order_id LIMIT ?,?;'

 conn.query(

  sqlStr,

  ['%' + input + '%', start, pageSize],

  (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    result = JSON.parse(JSON.stringify(result))

â€‹    res.json({ success_code: 200, data: result, total: total })

   }

  },

 )

})

//åˆ é™¤è®¢å•

router.post('/api/admin/deleteOrder', function (req, res) {

 let { orderId, scheduleId, orderSeatInfo } = req.body

 if (orderId) {

  let sqlStr = 'SELECT seat_info FROM t_schedule WHERE schedule_id = ?'

  conn.query(sqlStr, [scheduleId], (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    result = result[0].seat_info

â€‹    result = JSON.parse(result)

â€‹    orderSeatInfo = JSON.parse(orderSeatInfo)

â€‹    console.log(typeof result)

â€‹    console.log(typeof orderSeatInfo)

â€‹    let tempArr = []

â€‹    result.forEach((value) => {

â€‹     if (orderSeatInfo.indexOf(value) === -1) {

â€‹      tempArr.push(value)

â€‹     }

â€‹    })

â€‹    console.log(tempArr)

â€‹    result = JSON.stringify(tempArr)

â€‹    sqlStr = 'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ?;'

â€‹    conn.query(sqlStr, [result, scheduleId], (error, result, field) => {

â€‹     if (error) {

â€‹      console.log(error)

â€‹     } else {

â€‹      sqlStr = 'DELETE FROM t_order WHERE order_id =?'

â€‹      conn.query(sqlStr, [orderId], (error, result, field) => {

â€‹       if (error) {

â€‹        console.log(error)

â€‹       } else {

â€‹        res.json({ success_code: 200 })

â€‹       }

â€‹      })

â€‹     }

â€‹    })

   }

  })

 }

})

//è·å–å½“å‰é¡µå½±å…

router.get('/api/admin/getCurrentPageHall', function (req, res) {

 let { currentPage, pageSize, input } = req.query

 let start = Number((currentPage - 1) * pageSize)

 pageSize = Number(pageSize)

 let sqlStr =

  'SELECT * FROM t_hall INNER JOIN t_cinema ON t_cinema.cinema_id = t_hall.cinema_id WHERE t_cinema.cinema_name LIKE ? ORDER BY hall_id;'

 let total

 conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   total = result.length

  }

 })

 sqlStr =

  'SELECT * FROM t_hall INNER JOIN t_cinema ON t_cinema.cinema_id = t_hall.cinema_id WHERE t_cinema.cinema_name LIKE ? ORDER BY hall_id LIMIT ?,?;'

 conn.query(

  sqlStr,

  ['%' + input + '%', start, pageSize],

  (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    result = JSON.parse(JSON.stringify(result))

â€‹    res.json({ success_code: 200, data: result, total: total })

   }

  },

 )

})

//åˆ é™¤å½±å…

router.post('/api/admin/deleteHall', function (req, res) {

 let { cinemaId, hallName } = req.body

 if (cinemaId) {

  let sqlStr =

   'SELECT schedule_id FROM t_schedule WHERE cinema_id = ? AND hall_name = ?;'

  conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    result = JSON.parse(JSON.stringify(result))

â€‹    console.log(result)

â€‹    if (result.length) {

â€‹     result.forEach((value) => {

â€‹      sqlStr = 'DELETE FROM t_schedule WHERE schedule_id = ?;'

â€‹      conn.query(sqlStr, [value.schedule_id], (error, result, field) => {

â€‹       if (error) {

â€‹        console.log(error)

â€‹       }

â€‹      })

â€‹     })

â€‹    }

â€‹    sqlStr = 'DELETE FROM t_hall WHERE cinema_id = ? AND name = ?'

â€‹    conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {

â€‹     if (error) {

â€‹      console.log(error)

â€‹     } else {

â€‹      res.json({ success_code: 200 })

â€‹     }

â€‹    })

   }

  })

 }

})

//æ›´æ–°å½±å…ä¿¡æ¯

router.post('/api/admin/updateHallInfo', function (req, res) {

 let { hallId, cinemaId, hallOldName, hallNewName } = req.body

 if (cinemaId) {

  let sqlStr =

   'SELECT * FROM t_hall WHERE name = ? AND cinema_id = ? AND hall_id <> ? LIMIT 1;'

  conn.query(

   sqlStr,

   [hallNewName, cinemaId, hallId],

   (error, result, field) => {

â€‹    if (error) {

â€‹     console.log(error)

â€‹    } else {

â€‹     result = JSON.parse(JSON.stringify(result))

â€‹     if (result[0]) {

â€‹      res.json({ error_code: 1, message: 'è¯¥å½±é™¢çš„å½±å…å·²å­˜åœ¨ï¼' })

â€‹     } else {

â€‹      sqlStr =

â€‹       'UPDATE t_schedule SET hall_name = ? WHERE cinema_id = ? AND hall_name = ?'

â€‹      conn.query(

â€‹       sqlStr,

â€‹       [hallNewName, cinemaId, hallOldName],

â€‹       (error, result, field) => {

â€‹        if (error) {

â€‹         console.log(error)

â€‹        } else {

â€‹         //æ›´æ–°æ•°æ®åº“

â€‹         let sqlStr =

â€‹          'UPDATE t_hall SET name = ? WHERE cinema_id = ? AND name = ?;'

â€‹         conn.query(

â€‹          sqlStr,

â€‹          [hallNewName, cinemaId, hallOldName],

â€‹          (error, result, field) => {

â€‹           if (error) {

â€‹            res.json({

â€‹             error_code: 1,

â€‹             message: 'æ›´æ–°å½±å½±å…ä¿¡æ¯å¤±è´¥',

â€‹            })

â€‹            console.log(error)

â€‹           } else {

â€‹            res.json({ success_code: 200 })

â€‹           }

â€‹          },

â€‹         )

â€‹        }

â€‹       },

â€‹      )

â€‹     }

â€‹    }

   },

  )

 }

})

//è·å–æ‰€æœ‰å½±é™¢

router.get('/api/admin/getAllCinema', function (req, res) {

 let sqlStr = 'SELECT cinema_id,cinema_name FROM t_cinema;'

 conn.query(sqlStr, (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   res.json({ success_code: 200, data: result })

  }

 })

})

//æ·»åŠ å½±å…ä¿¡æ¯

router.post('/api/admin/addHallInfo', function (req, res) {

 let { cinemaId, hallName } = req.body

 let sqlStr = 'SELECT * FROM t_hall WHERE name = ? AND cinema_id = ? LIMIT 1;'

 conn.query(sqlStr, [hallName, cinemaId], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

â€‹    res.json({ error_code: 1, message: 'è¯¥å½±é™¢çš„å½±å…å·²å­˜åœ¨ï¼' })

   } else {

â€‹    let sqlStr = 'INSERT INTO t_hall(cinema_id,name) VALUES(?,?);'

â€‹    conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {

â€‹     if (error) {

â€‹      console.log(error)

â€‹     } else {

â€‹      res.json({ success_code: 200 })

â€‹     }

â€‹    })

   }

  }

 })

})

//è·å–å½“å‰é¡µç”µå½±

router.get('/api/admin/getCurrentPageMovieSchedule', function (req, res) {

 let { currentPage, pageSize, input } = req.query

 let start = Number((currentPage - 1) * pageSize)

 pageSize = Number(pageSize)

 let sqlStr =

  'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE t_movie.name LIKE ? ORDER BY schedule_id '

 let total

 conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   total = result.length

  }

 })

 sqlStr =

  'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE t_movie.name LIKE ? ORDER BY schedule_id LIMIT ?,?;'

 conn.query(

  sqlStr,

  ['%' + input + '%', start, pageSize],

  (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    result = JSON.parse(JSON.stringify(result))

â€‹    res.json({ success_code: 200, data: result, total: total })

   }

  },

 )

})

//è·å–æ‰€æœ‰ç”µå½±

router.get('/api/admin/getAllMovie', function (req, res) {

 let sqlStr = 'SELECT * FROM t_movie;'

 conn.query(sqlStr, (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   res.json({ success_code: 200, data: result })

  }

 })

})

//è·å–å½±é™¢çš„å½±å…

router.get('/api/admin/getHallByCinemaId', function (req, res) {

 let cinemaId = req.query.cinemaId

 console.log(cinemaId)

 let sqlStr = 'SELECT hall_id,name FROM t_hall WHERE cinema_id = ?;'

 conn.query(sqlStr, [cinemaId], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   console.log(result)

   res.json({ success_code: 200, data: result })

  }

 })

})

//è·å–æ’ç‰‡çš„æŸå¤©çš„æ—¶é—´æ®µå®‰æ’

router.get('/api/admin/getHasScheduleDateTime', function (req, res) {

 let { cinemaId, hallName, showDate } = req.query

 let sqlStr =

  'SELECT show_time FROM t_schedule WHERE cinema_id = ? AND hall_name = ? AND show_date = ?;'

 conn.query(sqlStr, [cinemaId, hallName, showDate], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   res.json({ success_code: 200, data: result })

  }

 })

})

//æ·»åŠ å½±é™¢ä¿¡æ¯

router.post('/api/admin/addScheduleInfo', function (req, res) {

 let { movieId, cinemaId, hallName, showDate, showTime, price } = req.body

 let sqlStr =

  'INSERT INTO t_schedule(movie_id,cinema_id,hall_name,show_date,show_time,price) VALUES(?,?,?,?,?,?);'

 conn.query(

  sqlStr,

  [movieId, cinemaId, hallName, showDate, showTime, price],

  (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    res.json({ success_code: 200 })

   }

  },

 )

})

//åˆ é™¤å½±å…

router.post('/api/admin/deleteMovieSchedule', function (req, res) {

 let { scheduleId } = req.body

 if (scheduleId) {

  let sqlStr = 'DELETE FROM t_schedule WHERE schedule_id = ?'

  conn.query(sqlStr, [scheduleId], (error, result, field) => {

   if (error) {

â€‹    console.log(error)

   } else {

â€‹    res.json({ success_code: 200 })

   }

  })

 }

})

module.exports = router