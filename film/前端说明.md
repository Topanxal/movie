

### 1. 项目结构概览
首先，我们来看一下项目的整体结构：

```
|-- .gitignore
|-- index.html
|-- package.json
|-- README.md
|-- build
|-- config
|-- src
|   |-- App.vue
|   |-- main.js
|   |-- api
|   |   |-- ajax.js
|   |   |-- index.js
|   |-- common
|   |   |-- css
|   |   |   |-- style.css
|   |   |   |-- fonts
|   |   |-- util
|   |       |-- util.js
|   |-- components
|   |   |-- CinemaDetail
|   |   |-- DatePicker
|   |   |-- Login
|   |   |-- MovieDetail
|   |   |   |-- MovieDetail.vue
|   |   |   |-- children
|   |   |   |   |-- CommentPanel.vue
|   |   |-- MovieItem
|   |   |-- Pay
|   |   |-- SelectCinema
|   |   |-- SelectSeat
|   |   |-- SubmitOrder
|   |   |-- TabBar
|   |-- pages
|   |   |-- Cinema
|   |   |   |-- Cinema.vue
|   |   |   |-- children
|   |   |       |-- SearchCinema.vue
|   |   |-- Home
|   |   |   |-- Home.vue
|   |   |   |-- children
|   |   |   |   |-- SearchAll.vue
|   |   |-- Movie
|   |   |   |-- Movie.vue
|   |   |   |-- children
|   |   |   |   |-- SearchMovie.vue
|   |   |-- My
|   |       |-- My.vue
|   |       |-- children
|   |       |   |-- ModifyUserName.vue
|   |       |   |-- ModifyUserSign.vue
|   |       |   |-- MyInfo.vue
|   |       |   |-- MyMovie.vue
|   |       |   |-- MyOrder.vue
|   |-- router
|   |   |-- index.js
|   |-- store
|-- static
    |-- css
        |-- adapter.css
        |-- reset.css
```

### 2. 项目入口文件
#### 2.1 `index.html`
这是项目的根HTML文件，所有的Vue组件最终都会被渲染到这个文件中。它通常包含一个`<div id="app"></div>`，Vue实例会挂载到这个DOM元素上。

#### 2.2 `main.js`
这是Vue应用的入口文件。它负责初始化Vue实例，并引入全局的插件、路由、状态管理等。

```javascript
import Vue from 'vue'
import App from './App.vue'
import router from './router'
import store from './store'

new Vue({
  el: '#app',
  router,
  store,
  render: h => h(App)
})
```

- `router`：负责路由管理，控制页面的跳转。
- `store`：负责全局状态管理，使用Vuex来管理应用的状态。

#### 2.3 `App.vue`
这是整个应用的根组件，所有的页面和组件都会在这个组件中被渲染。它通常包含一个`<router-view>`，用于显示当前路由对应的组件。

```vue
<template>
  <div id="app">
    <router-view></router-view>
  </div>
</template>

<script>
export default {
  name: 'App'
}
</script>
```

### 3. 路由配置
#### 3.1 `src/router/index.js`
这个文件定义了应用的路由配置。每个路由对应一个页面组件，用户访问不同的URL时，Vue Router会根据配置渲染对应的组件。

```javascript
import Vue from 'vue'
import Router from 'vue-router'
import Home from '../pages/Home/Home.vue'
import Movie from '../pages/Movie/Movie.vue'
import Cinema from '../pages/Cinema/Cinema.vue'
import My from '../pages/My/My.vue'

Vue.use(Router)

export default new Router({
  routes: [
    {
      path: '/',
      name: 'Home',
      component: Home
    },
    {
      path: '/movie',
      name: 'Movie',
      component: Movie
    },
    {
      path: '/cinema',
      name: 'Cinema',
      component: Cinema
    },
    {
      path: '/my',
      name: 'My',
      component: My
    }
  ]
})
```

### 4. 页面组件
页面组件位于`src/pages`目录下，每个页面通常对应一个路由。页面组件可以包含子组件，用于构建复杂的页面结构。

#### 4.1 `Home.vue`
这是应用的主页，通常包含一些推荐电影、热门影院等信息。

```vue
<template>
  <div class="home">
    <h1>欢迎来到电影订票系统</h1>
    <MovieItem v-for="movie in movies" :key="movie.id" :movie="movie" />
  </div>
</template>

<script>
import MovieItem from '@/components/MovieItem/MovieItem.vue'

export default {
  name: 'Home',
  components: {
    MovieItem
  },
  data() {
    return {
      movies: []
    }
  },
  created() {
    // 获取电影数据
    this.fetchMovies()
  },
  methods: {
    fetchMovies() {
      // 调用API获取电影数据
    }
  }
}
</script>
```

#### 4.2 `Movie.vue`
这是电影页面，通常展示电影列表、电影详情等信息。

```vue
<template>
  <div class="movie">
    <h1>电影列表</h1>
    <MovieItem v-for="movie in movies" :key="movie.id" :movie="movie" />
  </div>
</template>

<script>
import MovieItem from '@/components/MovieItem/MovieItem.vue'

export default {
  name: 'Movie',
  components: {
    MovieItem
  },
  data() {
    return {
      movies: []
    }
  },
  created() {
    // 获取电影数据
    this.fetchMovies()
  },
  methods: {
    fetchMovies() {
      // 调用API获取电影数据
    }
  }
}
</script>
```

### 5. 组件
组件位于`src/components`目录下，每个组件都是一个独立的Vue文件，可以被多个页面复用。

#### 5.1 `MovieItem.vue`
这是一个展示单个电影信息的组件，通常用于电影列表中的每一项。

```vue
<template>
  <div class="movie-item">
    <img :src="movie.poster" alt="movie poster">
    <h3>{{ movie.title }}</h3>
    <p>{{ movie.description }}</p>
  </div>
</template>

<script>
export default {
  name: 'MovieItem',
  props: {
    movie: {
      type: Object,
      required: true
    }
  }
}
</script>
```

#### 5.2 `TabBar.vue`
这是一个底部导航栏组件，通常用于切换不同的页面。

```vue
<template>
  <div class="tab-bar">
    <router-link to="/">首页</router-link>
    <router-link to="/movie">电影</router-link>
    <router-link to="/cinema">影院</router-link>
    <router-link to="/my">我的</router-link>
  </div>
</template>

<script>
export default {
  name: 'TabBar'
}
</script>
```

### 6. API 请求
#### 6.1 `src/api/ajax.js`
这个文件通常封装了`axios`，用于发送HTTP请求。

```javascript
import axios from 'axios'

const instance = axios.create({
  baseURL: 'https://api.example.com',
  timeout: 10000
})

export default instance
```

#### 6.2 `src/api/index.js`
这个文件定义了具体的API请求方法。

```javascript
import ajax from './ajax'

export const getMovies = () => ajax.get('/movies')
export const getMovieDetail = (id) => ajax.get(`/movies/${id}`)
```

### 7. 状态管理
#### 7.1 `src/store/index.js`
这个文件使用Vuex来管理全局状态。Vuex的核心概念包括`state`、`mutations`、`actions`和`getters`。

```javascript
import Vue from 'vue'
import Vuex from 'vuex'

Vue.use(Vuex)

export default new Vuex.Store({
  state: {
    user: null,
    movies: []
  },
  mutations: {
    setUser(state, user) {
      state.user = user
    },
    setMovies(state, movies) {
      state.movies = movies
    }
  },
  actions: {
    fetchMovies({ commit }) {
      // 调用API获取电影数据
      const movies = []
      commit('setMovies', movies)
    }
  },
  getters: {
    getUser(state) {
      return state.user
    },
    getMovies(state) {
      return state.movies
    }
  }
})
```

### 8. 公共资源
#### 8.1 `src/common/css/style.css`
这个文件通常包含一些全局的CSS样式，比如字体图标、颜色、布局等。

```css
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
}
```

#### 8.2 `src/common/util/util.js`
这个文件包含一些公共的工具方法，比如日期格式化、字符串处理等。

```javascript
export function formatDate(date) {
  return new Date(date).toLocaleDateString()
}
```

### 9. 静态资源
#### 9.1 `static/css/reset.css`
这个文件通常用于重置浏览器的默认样式，确保不同浏览器下的一致性。

```css
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
```

#### 9.2 `static/css/adapter.css`
这个文件通常用于处理不同屏幕尺寸的自适应样式。

```css
@media screen and (max-width: 768px) {
  body {
    font-size: 14px;
  }
}
```

### 10. 项目构建与配置
#### 10.1 `build` 和 `config` 目录
这两个目录包含了Webpack的配置文件和Vue CLI的配置文件，用于项目的开发和打包。通常你不需要修改这些文件，除非你有特殊的构建需求。

### 11. 修改项目
现在你已经对项目的结构有了基本的了解，接下来你可以根据需求对项目进行修改。比如：

- **添加新页面**：在`src/pages`目录下创建一个新的Vue文件，并在`src/router/index.js`中添加对应的路由配置。
- **修改样式**：在`src/common/css/style.css`或`static/css/adapter.css`中修改全局样式，或者在组件内部使用`<style>`标签添加局部样式。
- **添加新功能**：在`src/components`目录下创建新的组件，并在页面中引入和使用这些组件。

### 12. 运行项目
在项目根目录下运行以下命令来启动开发服务器：

```bash
npm install
npm run dev
```

这将启动一个本地开发服务器，你可以在浏览器中访问`http://localhost:8080`来查看项目。

### 13. 打包项目
当你完成开发后，可以使用以下命令将项目打包：

```bash
npm run build
```

打包后的文件会生成在`dist`目录下，你可以将这些文件部署到服务器上。

### 总结
通过以上步骤，你应该已经对这个基于Vue的电影订票系统项目有了全面的了解。接下来，你可以根据需求对项目进行修改和扩展。如果你有任何问题或需要进一步的帮助，请随时告诉我！







# 修改方案

在你的 Vue 项目结构中，`components` 和 `pages` 目录的主要区别在于 **用途** 和 **粒度**，它们的逻辑关系如下：

------

## **1. `components` 目录（组件）**

- **作用**：存放 **可复用的小型 UI 组件**，这些组件一般是 **无状态（stateless）** 或 **少状态（stateful）** 的，只关注 UI 和交互，不负责页面逻辑。
- 特点：
  - 组件是 **可复用的**，多个页面可能都会用到相同的组件。
  - 组件通常是 **功能模块**，例如按钮、导航栏、卡片、弹窗等。
  - 组件本身 **不会成为一个单独的路由**，而是被 `pages` 里的页面引用。
  - 组件一般通过 **props 接收数据**，或者在内部管理小范围的状态。

### **组件分类**

| 组件名         | 作用                                         |
| -------------- | -------------------------------------------- |
| `TabBar`       | 底部导航栏                                   |
| `MovieItem`    | 单个电影条目                                 |
| `MovieDetail`  | 电影详情组件（包含 `CommentPanel` 影评组件） |
| `CinemaDetail` | 影院详情组件                                 |
| `SelectCinema` | 影院选择组件                                 |
| `SelectSeat`   | 选座组件                                     |
| `SubmitOrder`  | 订单提交组件                                 |
| `Pay`          | 支付组件                                     |
| `DatePicker`   | 日期选择器                                   |
| `Login`        | 登录组件                                     |

✅ **示例**

```vue
<!-- MovieItem.vue -->
<template>
  <div class="movie-item">
    <img :src="movie.poster" alt="movie poster" />
    <h3>{{ movie.title }}</h3>
    <p>{{ movie.genre }}</p>
  </div>
</template>

<script>
export default {
  props: {
    movie: Object, // 接收电影数据
  }
}
</script>
```

> 这个组件**只关注电影的展示**，可以被 `Movie.vue` 或 `Home.vue` 复用。

------

## **2. `pages` 目录（页面）**

- **作用**：存放 **页面级组件**，这些组件通常**对应一个路由**，例如 `/home`、`/movie`、`/cinema`。
- 特点 ：
  - `pages` 下的组件是 **路由组件**，意味着它们在 `router/index.js` 里被定义为一个页面路径。
  - 页面组件通常会 **引用多个 `components` 里的组件**，组合成完整的页面结构。
  - 页面组件通常是 **有状态的（stateful）**，它们可能从 `Vuex` 或 **API** 获取数据，并且管理自身的 UI 逻辑。

### **页面分类**

| 页面名               | 作用           |
| -------------------- | -------------- |
| `Home.vue`           | 主页           |
| `Movie.vue`          | 电影页         |
| `Cinema.vue`         | 影院页         |
| `My.vue`             | 个人中心页     |
| `SearchAll.vue`      | 全局搜索页     |
| `SearchMovie.vue`    | 电影搜索页     |
| `SearchCinema.vue`   | 影院搜索页     |
| `MyInfo.vue`         | 个人信息页     |
| `MyMovie.vue`        | 收藏电影页     |
| `MyOrder.vue`        | 订单管理页     |
| `ModifyUserName.vue` | 修改用户名页   |
| `ModifyUserSign.vue` | 修改用户签名页 |

✅ **示例**

```vue
<!-- Home.vue -->
<template>
  <div class="home">
    <TabBar /> <!-- 复用组件 -->
    <MovieItem v-for="movie in movies" :key="movie.id" :movie="movie" />
  </div>
</template>

<script>
import TabBar from '@/components/TabBar/TabBar';
import MovieItem from '@/components/MovieItem/MovieItem';

export default {
  components: { TabBar, MovieItem },
  data() {
    return {
      movies: [] // 页面状态
    };
  },
  created() {
    // 这里可以调用 API 获取电影数据
  }
};
</script>
```

> 这个 `Home.vue` 页面使用了 `TabBar` 和 `MovieItem` 组件，并且会管理 `movies` 的数据状态。

------

## **3. `components` 和 `pages` 的逻辑关系**

- `pages` 负责页面逻辑，它们**可以引用多个 `components` 组件**。
- `components` 仅仅是**UI 组件**，一般不会自己管理全局数据，而是**由 `pages` 传入数据**。
- `pages` **通常和 `router/index.js` 相关联**，而 `components` **不会出现在 `router/index.js` 里**，因为它们只是页面的子组件。

### **关系示意图**

```
Home.vue (页面)
 ├── TabBar.vue (组件)
 ├── MovieItem.vue (组件)
 ├── 其他小组件...
```

------

## **4. 什么时候应该放到 `components` 而不是 `pages`？**

✅ **应该放到 `components` 的情况**

1. **多个页面都会用到的 UI 组件**（例如 `TabBar`）。
2. **封装好的可复用组件**（例如 `MovieItem`、`DatePicker`）。
3. **页面的某一部分功能**（例如 `CommentPanel` 属于 `MovieDetail.vue`）。

✅ **应该放到 `pages` 的情况**

1. **该组件对应一个独立的路由**（例如 `/movie` 对应 `Movie.vue`）。
2. **页面级别的逻辑和数据**（例如 `Home.vue` 需要从 API 获取数据）。
3. **包含多个 `components` 组件的完整页面**（例如 `Cinema.vue` 可能包含 `CinemaDetail`）。

------

## **总结**

| 对比项         | `components` 目录             | `pages` 目录                  |
| -------------- | ----------------------------- | ----------------------------- |
| **作用**       | 存放可复用组件                | 存放路由页面                  |
| **是否有路由** | ❌ 不是路由组件                | ✅ 是路由组件                  |
| **是否可复用** | ✅ 可在多个页面使用            | ❌ 仅在对应的路由使用          |
| **数据管理**   | ❌ 依赖 `props` 传值           | ✅ 可以管理页面状态和 API 请求 |
| **示例**       | `MovieItem.vue`，`TabBar.vue` | `Movie.vue`，`Home.vue`       |

------

## **5. 扩展：如果想添加全局搜索的语义搜索功能，该放在哪？**

- **搜索框组件** → `components/SearchBar.vue`
- **搜索结果组件** → `components/SearchResult.vue`
- **搜索页面** → `pages/Home/children/SearchAll.vue`
- **搜索逻辑（BERT 语义搜索）** → `api/search.js`（如果是前端搜索），或者后端 **API**

你可以在 `SearchAll.vue` 里调用 `tensorflow.js` 进行搜索，然后用 `SearchResult.vue` 组件展示结果：

```vue
<!-- SearchAll.vue -->
<template>
  <div>
    <SearchBar @search="handleSearch" />
    <SearchResult :movies="searchResults" />
  </div>
</template>

<script>
import SearchBar from '@/components/SearchBar.vue';
import SearchResult from '@/components/SearchResult.vue';

export default {
  components: { SearchBar, SearchResult },
  data() {
    return {
      searchResults: []
    };
  },
  methods: {
    handleSearch(query) {
      // 这里调用 tensorflow.js 进行语义搜索
    }
  }
};
</script>
```

> 这样 `SearchAll.vue` 作为页面，负责调用搜索逻辑，而 `SearchBar.vue` 和 `SearchResult.vue` 作为组件，负责 UI 展示。

------

## **最终结论**

- **`components` 是可复用的 UI 组件，`pages` 是完整的页面组件**。
- **`components` 负责展示，`pages` 负责管理数据和逻辑**。
- **语义搜索功能的 UI 放在 `components`，搜索逻辑放在 `pages` 或 `api`。**

这样可以让你的项目结构更加清晰，方便维护和扩展！🚀





# 后端index.js源代码

```javascript
const express = require('express')
const router = express.Router()
const conn = require('../db/db')
const svgCaptcha = require('svg-captcha')
const util = require('../util/util')
const multer = require('multer')

// 用户API
let user = {}
/* GET home page. */
router.get('/', function (req, res, next) {
  res.render('index', { title: 'Express' })
})
//获取手机验证码
router.get('/api/getPhoneCode', function (req, res) {
  let phone = req.query.phone
  let phoneCode = util.randomCode(4)
  if (!phoneCode) {
    res.json({ error_code: 1, message: '获取验证码失败' })
  } else {
    user[phone] = phoneCode
    res.json({ success_code: 200, data: phoneCode })
  }
})
//获取图形验证码
router.get('/api/captcha', function (req, res) {
  let captcha = svgCaptcha.create({
    size: 4, // size of random string
    ignoreChars: '0o1i', // filter out some characters like 0o1i
    noise: 3, // number of noise lines
    color: true, //, characters will have distinct colors instead of grey, true if background option is set
    background: '#fff', // background color of the svg image
  })
  //保存图形验证码文本
  req.session.captcha = captcha.text.toLowerCase()
  //返回验证码数据
  res.type('svg')
  res.status(200).send(captcha.data)
})
//手机登录
router.post('/api/phoneLogin', function (req, res) {
  let phone = req.body.phone
  let phoneCode = req.body.phoneCode
  //判断手机验证码是否正确
  if (user[phone] === phoneCode) {
    let sqlStr = 'SELECT * from t_user WHERE phone = ? LIMIT 1 ;'
    conn.query(sqlStr, [phone], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '请求数据失败' })
      } else {
        result = JSON.parse(JSON.stringify(result))
        //用户存在
        if (result[0]) {
          req.session.userId = result[0].user_id
          res.cookie('user_id', result[0].user_id)
          res.json({ success_code: 200 })
        } else {
          //用户不存在
          let sqlStr =
            'INSERT INTO t_user(user_name,phone,avatar,password) VALUES(?,?,?,?)'
          let avatarSrc = '/images/avatar/monkey.png'
          conn.query(
            sqlStr,
            [phone, phone, avatarSrc, 123456],
            (error, result, field) => {
              if (error) {
                console.log(error)
                res.json({ error_code: 1, message: '创建用户失败' })
              } else {
                res.cookie('user_id', result.insertId)
                res.json({ success_code: 200 })
              }
            },
          )
        }
      }
    })
  } else {
    res.json({ error_code: 1, message: '验证码不正确' })
  }
})
//密码登录
router.post('/api/pwdLogin', function (req, res) {
  let name = req.body.userName
  let pwd = req.body.password
  let captcha = req.body.captcha
  //判断验证码是否正确
  if (captcha.toLowerCase() !== req.session.captcha) {
    res.json({ error_code: 1, message: '验证码不正确' })
  } else {
    delete req.session.captcha
    let sqlStr = 'SELECT * from t_user WHERE user_name =? LIMIT 1 ;'
    conn.query(sqlStr, [name], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '查询用户失败' })
      } else {
        result = JSON.parse(JSON.stringify(result))
        if (result[0]) {
          if (result[0].password === pwd) {
            //保存用户id
            req.session.userId = result[0].user_id
            res.cookie('user_id', result[0].user_id)
            res.json({ success_code: 200 })
          } else {
            res.json({ error_code: 1, message: '密码错误' })
          }
        } else {
          res.json({ error: 1, message: '用户不存在' })
        }
      }
    })
  }
})
//获取用户信息
router.get('/api/getUserInfo', function (req, res) {
  let userId = req.query.userId
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '获取用户信息失败' })
      } else {
        result = JSON.parse(JSON.stringify(result))
        if (result[0]) {
          res.json({ success_code: 200, data: result[0] })
        } else {
          res.json({ error_code: 1, message: '用户信息不存在' })
        }
      }
    })
  }
})
//更新用户头像
router.post('/api/updateUserAvatar', function (req, res) {
  let { userId, avatar } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '用户不存在' })
      } else {
        //更新数据库
        let sqlStr = 'UPDATE t_user SET avatar = ? WHERE user_id = ?;'
        conn.query(sqlStr, [avatar, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: '更新用户头像失败' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//更新用户名
router.post('/api/updateUserName', function (req, res) {
  let { userId, userName } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '用户不存在' })
      } else {
        sqlStr =
          'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1 ;'
        conn.query(sqlStr, [userName, userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: '用户名已存在！' })
            } else {
              //更新数据库
              let sqlStr = 'UPDATE t_user SET user_name = ? WHERE user_id = ?;'
              conn.query(sqlStr, [userName, userId], (error, result, field) => {
                if (error) {
                  res.json({ error_code: 1, message: '更新用户名失败' })
                } else {
                  res.json({ success_code: 200 })
                }
              })
            }
          }
        })
      }
    })
  }
})
//更新用户性别
router.post('/api/updateUserSex', function (req, res) {
  let { userId, sex } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '用户不存在' })
      } else {
        //更新数据库
        let sqlStr = 'UPDATE t_user SET sex = ? WHERE user_id = ?;'
        conn.query(sqlStr, [sex, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: '更新用户性别失败' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//更新用户生日
router.post('/api/updateUserBirthday', function (req, res) {
  let { userId, birthday } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '用户不存在' })
      } else {
        //更新数据库
        let sqlStr = 'UPDATE t_user SET birthday = ? WHERE user_id = ?;'
        conn.query(sqlStr, [birthday, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: '更新用户生日失败' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//更新用户签名
router.post('/api/updateUserSign', function (req, res) {
  let { userId, sign } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '用户不存在' })
      } else {
        //更新数据库
        let sqlStr = 'UPDATE t_user SET sign = ? WHERE user_id = ?;'
        conn.query(sqlStr, [sign, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: '更新用户签名失败' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//更新用户信息
router.post('/api/updateUserInfo', function (req, res) {
  let { userId, userName, avatar, password, sex, sign, birthday } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '用户不存在' })
      } else {
        sqlStr =
          'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1 ;'
        conn.query(sqlStr, [userName, userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: '用户名已存在！' })
            } else {
              //更新数据库
              let sqlStr =
                'UPDATE t_user SET user_name = ?,avatar = ?,password = ?,sex = ? ,birthday = ?,sign = ?WHERE user_id = ?;'
              conn.query(
                sqlStr,
                [userName, avatar, password, sex, birthday, sign, userId],
                (error, result, field) => {
                  if (error) {
                    res.json({ error_code: 1, message: '更新用户信息失败' })
                  } else {
                    res.json({ success_code: 200 })
                  }
                },
              )
            }
          }
        })
      }
    })
  }
})
//加载电影列表
router.get('/api/getMovieList', function (req, res) {
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '获取电影列表失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        // result = result.filter((value)=>{
        //   return new Date(value.show_date+','+value.show_time)-new Date()>0;
        // });
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['movie_id'] === result[j]['movie_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
        res.json({ success_code: 200, data: result })
      } else {
        res.json({ error_code: 1, message: '电影列表为空' })
      }
    }
  })
})
//加载电影详细信息
router.get('/api/getMovieDetail', function (req, res) {
  let movieId = req.query.movieId
  let sqlStr = 'SELECT * FROM t_movie WHERE movie_id = ? LIMIT 1;'
  conn.query(sqlStr, [movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: '获取电影信息失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result })
      } else {
        res.json({ error_code: 1, message: '该电影不存在' })
      }
    }
  })
})
//是否想看电影
router.post('/api/isWishMovie', function (req, res) {
  let { userId, movieId } = req.body
  let sqlStr =
    'SELECT * FROM t_wishmovie WHERE user_id = ? AND movie_id = ? LIMIT 1;'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '操作失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200 })
      } else {
        res.json({ error_code: 1, message: '不想看' })
      }
    }
  })
})
//想看电影
router.post('/api/wishMovie', function (req, res) {
  let { userId, movieId } = req.body
  let sqlStr = 'INSERT INTO t_wishmovie(user_id,movie_id) VALUES(?,?)'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: '操作失败' })
    } else {
      let sqlStr = 'SELECT wish_num from t_movie WHERE movie_id = ? LIMIT 1;'
      conn.query(sqlStr, [movieId], (error, result, field) => {
        if (error) {
          res.json({ error_code: 1, message: '操作失败' })
        } else {
          result = JSON.parse(JSON.stringify(result))
          if (result[0]) {
            //更新数据库
            let sqlStr = 'UPDATE t_movie SET wish_num = ? WHERE movie_id = ?;'
            conn.query(
              sqlStr,
              [result[0].wish_num + 1, movieId],
              (error, result, field) => {
                if (error) {
                  res.json({ error_code: 1, message: '更新信息失败' })
                } else {
                  res.json({ success_code: 200 })
                }
              },
            )
          }
        }
      })
    }
  })
})
//取消想看电影
router.post('/api/cancelWishMovie', function (req, res) {
  let { userId, movieId } = req.body
  let sqlStr = 'DELETE FROM t_wishmovie WHERE user_id = ? AND movie_id =? ;'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: '操作失败' })
    } else {
      let sqlStr = 'SELECT wish_num from t_movie WHERE movie_id = ? LIMIT 1;'
      conn.query(sqlStr, [movieId], (error, result, field) => {
        if (error) {
          res.json({ error_code: 1, message: '操作失败' })
        } else {
          result = JSON.parse(JSON.stringify(result))
          if (result[0]) {
            //更新数据库
            let sqlStr = 'UPDATE t_movie SET wish_num = ? WHERE movie_id = ?;'
            conn.query(
              sqlStr,
              [result[0].wish_num - 1, movieId],
              (error, result, field) => {
                if (error) {
                  res.json({ error_code: 1, message: '更新信息失败' })
                } else {
                  res.json({ success_code: 200 })
                }
              },
            )
          }
        }
      })
    }
  })
})
//获取当前用户评论
router.get('/api/getUserComment', function (req, res) {
  let { userId, movieId } = req.query
  let sqlStr =
    'SELECT * FROM t_comment WHERE user_id = ? AND movie_id= ? LIMIT 1;'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '操作失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: '用户未评论' })
      }
    }
  })
})
//获取所有用户通过审核的评论
router.get('/api/getAllUserPassComment', function (req, res) {
  let { movieId } = req.query
  let sqlStr =
    'SELECT * FROM t_user user INNER JOIN t_comment comment ON user.user_id = comment.user_id WHERE comment.movie_id = ? AND comment.is_pass = ? ;'
  conn.query(sqlStr, [movieId, 1], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '操作失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result) {
        res.json({ success_code: 200, data: result })
      } else {
        res.json({ error_code: 1, message: '未评论' })
      }
    }
  })
})
//更新用户评论
router.post('/api/updateUserComment', function (req, res) {
  let { userId, movieId, score, commentContent, commentDate } = req.body
  let sqlStr =
    'SELECT comment_id from t_comment WHERE user_id = ? AND movie_id = ? LIMIT 1'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: '操作失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        //评论存在
        //更新
        let sqlStr =
          'UPDATE t_comment SET user_score = ?, comment_content = ?, comment_date = ?,support_num = ?,is_pass = ?,support_user = ? WHERE comment_id = ? ;'
        conn.query(
          sqlStr,
          [
            score,
            commentContent,
            commentDate,
            0,
            0,
            undefined,
            result[0].comment_id,
          ],
          (error, result, field) => {
            if (error) {
              res.json({ error_code: 1, message: '更新评论失败' })
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      } else {
        //评论不存在
        let sqlStr =
          'INSERT INTO t_comment(user_id,movie_id,user_score,comment_content,comment_date,support_num,is_pass) VALUES(?,?,?,?,?,?,?)'
        conn.query(
          sqlStr,
          [userId, movieId, score, commentContent, commentDate, 0, 0],
          (error, result, field) => {
            if (error) {
              console.log(error)
              res.json({ error_code: 1, message: '操作失败' })
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      }
    }
  })
})
//获取当前评论
router.get('/api/getCommentByID', function (req, res) {
  let { commentId } = req.query
  let sqlStr = 'SELECT * FROM t_comment WHERE comment_id = ? LIMIT 1;'
  conn.query(sqlStr, [commentId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '操作失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: '用户未评论' })
      }
    }
  })
})
//更新当前评论的用户点赞
router.post('/api/updateUserSupport', function (req, res) {
  let { commentId, supportNum, supportUser } = req.body
  let sqlStr =
    'UPDATE t_comment SET support_num = ? , support_user = ? WHERE comment_id = ?;'
  conn.query(
    sqlStr,
    [supportNum, supportUser, commentId],
    (error, result, field) => {
      if (error) {
        console.log(error)
        res.json({ error_code: 1, message: '操作失败' })
      } else {
        res.json({ success_code: 200 })
      }
    },
  )
})
//加载影院列表
router.get('/api/getCinemaList', function (req, res) {
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_cinema ON t_schedule.cinema_id = t_cinema.cinema_id INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: '获取影院列表失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        // result = result.filter((value)=>{
        //   return new Date(value.show_date+','+value.show_time)-new Date()>0;
        // });
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['cinema_id'] === result[j]['cinema_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
      }
      res.json({ success_code: 200, data: result })
    }
  })
})
//加载当前影院详细信息
router.get('/api/getCurrentCinemaDetail', function (req, res) {
  let cinemaId = req.query.cinemaId
  let sqlStr = 'SELECT * FROM t_cinema WHERE cinema_id = ? LIMIT 1;'
  conn.query(sqlStr, [cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '获取当前影院信息失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: '影院不存在' })
      }
    }
  })
})
//加载当前影院排片
router.get('/api/getCurrentCinemaMovieSchedule', function (req, res) {
  let cinemaId = req.query.cinemaId
  console.log(cinemaId)
  let sqlStr = 'SELECT * FROM t_schedule WHERE cinema_id = ?;'
  conn.query(sqlStr, [cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '获取当前影院排片信息失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result) {
        let tempMovieArr = []
        result.forEach((value) => {
          if (
            new Date() - new Date(value.show_date + ',' + value.show_time) <=
            0
          ) {
            tempMovieArr.push(value.movie_id)
          }
        })
        tempMovieArr = Array.from(new Set(tempMovieArr))
        let movieArray = []
        let movieScheduleArray = []
        tempMovieArr.forEach((value) => {
          sqlStr = 'SELECT * FROM t_movie WHERE movie_id = ? LIMIT 1;'
          conn.query(sqlStr, [value], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result[0]) {
                movieArray.push(result[0])
              }
            }
          })
          sqlStr =
            'SELECT * FROM t_schedule schedule INNER JOIN t_movie movie ON schedule.movie_id = movie.movie_id WHERE schedule.movie_id = ? AND schedule.cinema_id = ?;'
          conn.query(sqlStr, [value, cinemaId], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result) {
                movieScheduleArray.push(result)
              }
            }
          })
        })
        setTimeout(() => {
          res.json({
            success_code: 200,
            data: {
              hasMovieInfo: movieArray,
              movieScheduleInfo: movieScheduleArray,
            },
          })
        }, 500)
      } else {
        res.json({ error_code: 1, message: '当前影院排片信息为空' })
      }
    }
  })
})
//加载当前影院详细信息
router.get('/api/getScheduleById', function (req, res) {
  let scheduleId = req.query.scheduleId
  let sqlStr = 'SELECT * FROM t_schedule WHERE schedule_id = ? LIMIT 1;'
  conn.query(sqlStr, [scheduleId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '获取当前排片信息失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: '排片信息不存在' })
      }
    }
  })
})
//加载当前影院详细信息
router.post('/api/updateScheduleSeat', function (req, res) {
  let { scheduleId, seatInfo } = req.body
  let sqlStr =
    'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ? LIMIT 1;'
  conn.query(sqlStr, [seatInfo, scheduleId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '更新排片座位信息失败' })
    } else {
      res.json({ success_code: 200, data: result[0] })
    }
  })
})
//加载当前电影排片
router.get('/api/getCurrentMovieSchedule', function (req, res) {
  let movieId = req.query.movieId
  let sqlStr = 'SELECT * FROM t_schedule WHERE movie_id = ?;'
  conn.query(sqlStr, [movieId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '获取当前影院排片信息失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result) {
        let tempDateArr = []
        result.forEach((value) => {
          if (
            new Date() - new Date(value.show_date + ',' + value.show_time) <=
            0
          ) {
            tempDateArr.push(value.show_date)
          }
        })
        tempDateArr = Array.from(new Set(tempDateArr))
        tempDateArr.sort((a, b) => {
          return new Date(a) - new Date(b)
        })
        let cinemaArray = []
        let cinemaScheduleArray = []
        tempDateArr.forEach((value) => {
          sqlStr = 'SELECT * FROM t_schedule WHERE show_date = ?'
          conn.query(sqlStr, [value], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result) {
                cinemaArray.push(result)
              }
            }
          })
          sqlStr =
            'SELECT * FROM t_schedule schedule INNER JOIN t_cinema cinema ON schedule.cinema_id = cinema.cinema_id WHERE schedule.movie_id = ? AND schedule.show_date = ?;'
          conn.query(sqlStr, [movieId, value], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result) {
                cinemaScheduleArray.push(result)
              }
            }
          })
        })
        setTimeout(() => {
          res.json({
            success_code: 200,
            data: {
              hasCinemaInfo: cinemaArray,
              cinemaScheduleInfo: cinemaScheduleArray,
            },
          })
        }, 500)
      } else {
        res.json({ error_code: 1, message: '当前电影排片信息为空' })
      }
    }
  })
})
//根据名字匹配电影
router.get('/api/matchMovieByName', function (req, res) {
  console.log('开始进行精准搜索！！！！！！！！')
  let movieName = req.query.movieName
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id WHERE name LIKE ?;'
  conn.query(sqlStr, ['%' + movieName + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        // result = result.filter((value)=>{
        //   return new Date(value.show_date+','+value.show_time)-new Date()>0;
        // });
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['movie_id'] === result[j]['movie_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
      }
      res.json({ success_code: 200, data: result })
    }
  })
})

const { BertTokenizer } = require('bert-tokenizer')
const _ = require('lodash') // 用于处理数组和对象的工具库

// 加载词汇表
const vocabUrl = 'node_modules/bert-tokenizer/assets/vocab.json'
const bertTokenizer = new BertTokenizer(vocabUrl, true)

// 计算余弦相似度
function cosineSimilarity(vecA, vecB) {
  const dotProduct = _.sum(_.zipWith(vecA, vecB, (a, b) => a * b))
  const normA = Math.sqrt(_.sum(_.map(vecA, (a) => a * a)))
  const normB = Math.sqrt(_.sum(_.map(vecB, (b) => b * b)))
  if (normA === 0 || normB === 0) {
    return 0
  }
  return dotProduct / (normA * normB)
}

// 语义搜索电影
// router.get('/api/semanticSearchMovie', async function (req, res) {
//   try {
//     const searchQuery = req.query.searchQuery // 用户搜索词

//     // 对搜索词进行分词
//     const searchTokens = bertTokenizer.tokenize(searchQuery)

//     // 构建搜索词的词频向量
//     const searchVector = []
//     const searchTokenCount = _.countBy(searchTokens)
//     for (let i = 0; i < bertTokenizer.vocab.length; i++) {
//       searchVector[i] = searchTokenCount[bertTokenizer.vocab[i]] || 0
//     }

//     // 获取所有电影的描述信息
//     let sqlStr = 'SELECT movie_id, name, intro FROM t_movie;'
//     conn.query(sqlStr, async (error, movies) => {
//       if (error) {
//         console.error(error)
//         return res.json({ error_code: 1, message: '查询失败' })
//       }

//       const results = []
//       for (const movie of movies) {
//         const movieIntro = movie.intro
//         // 对电影描述进行分词
//         const movieTokens = bertTokenizer.tokenize(movieIntro)

//         // 构建电影描述的词频向量
//         const movieVector = []
//         const movieTokenCount = _.countBy(movieTokens)
//         for (let i = 0; i < bertTokenizer.vocab.length; i++) {
//           movieVector[i] = movieTokenCount[bertTokenizer.vocab[i]] || 0
//         }

//         // 计算搜索词和电影描述的余弦相似度
//         const similarityScore = cosineSimilarity(searchVector, movieVector)

//         results.push({
//           movie_id: movie.movie_id,
//           name: movie.name,
//           intro: movie.intro,
//           score: similarityScore,
//         })
//       }

//       // 按相似度排序
//       results.sort((a, b) => b.score - a.score)

//       // 过滤出相似度大于 0 的结果
//       const filteredResults = results.filter((result) => result.score > 0)

//       res.json({
//         success_code: 200,
//         data: filteredResults,
//       })
//     })
//   } catch (error) {
//     console.error('语义搜索错误:', error)
//     res.json({
//       error_code: 1,
//       message: '搜索处理失败',
//     })
//   }
// })
// 语义搜索电影
router.get('/api/semanticSearchMovie', async function (req, res) {
  console.log('开始进行语义搜索！！！！！！！！')
  try {
    const searchQuery = req.query.searchQuery // 用户搜索词
    console.log('用户搜索词:', searchQuery)

    // 对搜索词进行向量化
    const searchVector =
      bertTokenizer.convertSingleExample(searchQuery).inputIds
    console.log('搜索词向量:', searchVector)

    // 获取所有电影的描述信息
    const sqlStr =
      'SELECT movie_id, name, intro, movieName_vector, movieIntro_vector, movieLabel_vector FROM t_movie;'
    console.log('执行 SQL 查询:', sqlStr)

    const movies = await new Promise((resolve, reject) => {
      conn.query(sqlStr, (error, results) => {
        if (error) {
          reject(error)
        } else {
          resolve(results)
        }
      })
    })
    // console.log('获取电影数据成功，共', movies.length, '条记录')

    const results = []
    for (const movie of movies) {
      console.log('处理电影:', movie.name)

      // 对电影的三个向量（movieName_vector, movieIntro_vector, movieLabel_vector）分别计算相似度
      const movieNameVector = JSON.parse(movie.movieName_vector || '[]')
      const movieIntroVector = JSON.parse(movie.movieIntro_vector || '[]')
      const movieLabelVector = JSON.parse(movie.movieLabel_vector || '[]')

      // console.log('电影名称向量:', movieNameVector)
      // console.log('电影简介向量:', movieIntroVector)
      // console.log('电影标签向量:', movieLabelVector)

      // 计算余弦相似度
      const nameSimilarity = cosineSimilarity(searchVector, movieNameVector)
      const introSimilarity = cosineSimilarity(searchVector, movieIntroVector)
      const labelSimilarity = cosineSimilarity(searchVector, movieLabelVector)

      // console.log('名称相似度:', nameSimilarity)
      // console.log('简介相似度:', introSimilarity)
      // console.log('标签相似度:', labelSimilarity)

      // 综合相似度（取最大值或平均值）
      // const similarityScore = Math.max(
      //   nameSimilarity,
      //   introSimilarity,
      //   labelSimilarity,
      // )
      const similarityScore =
        0.0 * nameSimilarity + 0.3 * introSimilarity + 0.0 * labelSimilarity
      // console.log('综合相似度:', similarityScore)

      results.push({
        movie_id: movie.movie_id,
        name: movie.name,
        intro: movie.intro,
        score: similarityScore,
      })
    }

    // 按相似度排序
    results.sort((a, b) => b.score - a.score)
    console.log('排序后的结果:', results)

    // 获取 top10 结果
    const top10Results = results.slice(0, 10)
    // console.log('Top10 结果:', top10Results)

    // 去重（根据 movie_id）
    const uniqueResults = _.uniqBy(top10Results, 'movie_id')
    // console.log('去重后的结果:', uniqueResults)

    // 获取 top10 电影 ID
    const movieIds = uniqueResults.map((movie) => movie.movie_id)
    console.log('Top10 电影 ID:', movieIds)

    // 根据电影 ID 查询完整行数据
    const finalSqlStr = `
  SELECT * FROM t_schedule
  INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id
  WHERE t_schedule.movie_id IN (?);
`
    // console.log('执行最终 SQL 查询:', finalSqlStr)

    const finalResults = await new Promise((resolve, reject) => {
      conn.query(finalSqlStr, [movieIds], (error, results) => {
        if (error) {
          reject(error)
        } else {
          resolve(results)
        }
      })
    })
    console.log('获取完整行数据成功，共', finalResults.length, '条记录')

    const finalSortedResults = _.sortBy(finalResults, (movie) =>
      movieIds.indexOf(movie.movie_id),
    )
    res.json({ success_code: 200, data: finalSortedResults })
  } catch (error) {
    console.error('语义搜索错误:', error)
    res.json({ error_code: 1, message: '搜索处理失败' })
  }
})

router.get('/api/matchCinemaByName', function (req, res) {
  let cinemaName = req.query.cinemaName
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_cinema ON t_schedule.cinema_id = t_cinema.cinema_id INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id WHERE cinema_name LIKE ?;'
  conn.query(sqlStr, ['%' + cinemaName + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        // result = result.filter((value)=>{
        //   return new Date(value.show_date+','+value.show_time)-new Date()>0;
        // });
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['cinema_id'] === result[j]['cinema_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
      }
      res.json({ success_code: 200, data: result })
    }
  })
})
//用户下单
router.post('/api/order', function (req, res) {
  let {
    userId,
    scheduleId,
    orderPhone,
    orderDate,
    ticketNum,
    totalPrice,
    orderSeatInfo,
    payType,
  } = req.body
  let phoneCode = util.randomCode(6)
  let sqlStr =
    'INSERT INTO t_order(user_id,schedule_id,order_phone,order_date,ticket_num,ticket_total_price,order_seat_info,pay_type,phone_code) VALUES(?,?,?,?,?,?,?,?,?); '
  conn.query(
    sqlStr,
    [
      userId,
      scheduleId,
      orderPhone,
      orderDate,
      ticketNum,
      totalPrice,
      orderSeatInfo,
      payType,
      phoneCode,
    ],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200, data: { phone_code: phoneCode } })
      }
    },
  )
})
//获取个人订单信息
router.get('/api/getOrderByUserId', function (req, res) {
  let userId = req.query.userId
  let sqlStr =
    'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE user_id = ?;'
  conn.query(sqlStr, [userId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//获取个人想看电影
router.get('/api/getWishMovieByUserId', function (req, res) {
  let userId = req.query.userId
  let sqlStr =
    'SELECT * FROM t_wishmovie INNER JOIN t_movie ON t_wishmovie.movie_id = t_movie.movie_id WHERE user_id = ?;'
  conn.query(sqlStr, [userId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//获取个人看过的电影
router.get('/api/getIsWatchedMovieByUserId', function (req, res) {
  let userId = req.query.userId
  let sqlStr =
    'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id WHERE user_id = ? AND is_pass = 1;'
  conn.query(sqlStr, [userId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})

//管理员API
//获取当前页用户

//密码登录
router.post('/api/admin/login', function (req, res) {
  let name = req.body.name
  let password = req.body.password
  let sqlStr = 'SELECT * FROM t_admin WHERE name = ? LIMIT 1 ;'
  conn.query(sqlStr, [name, password], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: '查询用户失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        if (result[0].password === password) {
          //保存用户id
          req.session.adminId = result[0].admin_id
          res.cookie('admin_id', result[0].admin_id)
          res.json({ success_code: 200 })
        } else {
          res.json({ error_code: 1, message: '密码错误' })
        }
      } else {
        res.json({ error: 1, message: '用户不存在' })
      }
    }
  })
})
//获取用户信息
router.get('/api/admin/getAdminInfo', function (req, res) {
  let adminId = req.query.adminId
  let sqlStr = 'SELECT * FROM t_admin WHERE admin_id = ? LIMIT 1 ;'
  conn.query(sqlStr, [adminId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: '查询用户失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error: 1, message: '用户不存在' })
      }
    }
  })
})
router.get('/api/admin/getCurrentPageUser', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr = 'SELECT * FROM t_user WHERE user_name LIKE ? ORDER BY user_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_user WHERE user_name LIKE ? ORDER BY user_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})

var datatime = './public/images/avatar/'
//将图片放到服务器
var storage = multer.diskStorage({
  // 如果你提供的 destination 是一个函数，你需要负责创建文件夹
  destination: datatime,
  // //给上传文件重命名，获取添加后缀名
  filename: function (req, file, cb) {
    cb(null, new Date().getTime() + '.jpg')
  },
})
var upload = multer({
  storage: storage,
})
// let upload = multer({dest:'./public/images/avatar'}).any();
router.post('/api/admin/upLoadImg', upload.any(), function (req, res) {
  res.json({ success_code: 200, data: req.files })
  console.log(req.files)
})

//更新用户信息
router.post('/api/admin/updateUserInfo', function (req, res) {
  let { userId, userName, avatar, password, sex, phone, sign, birthday } =
    req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '用户不存在' })
      } else {
        let sqlStr =
          'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1;'
        conn.query(sqlStr, [userName, userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: '用户名已存在！' })
            } else {
              sqlStr =
                'SELECT * FROM t_user WHERE phone = ? AND user_id <> ? LIMIT 1;'
              conn.query(sqlStr, [phone, userId], (error, result, field) => {
                if (error) {
                  console.log(error)
                } else {
                  result = JSON.parse(JSON.stringify(result))
                  if (result[0]) {
                    res.json({ error_code: 1, message: '手机号码已注册！' })
                  } else {
                    //更新数据库
                    let sqlStr =
                      'UPDATE t_user SET user_name = ?,avatar = ?,password = ?,sex = ? ,phone = ?,birthday = ?,sign = ? WHERE user_id = ?;'
                    conn.query(
                      sqlStr,
                      [
                        userName,
                        avatar,
                        password,
                        sex,
                        phone,
                        birthday,
                        sign,
                        userId,
                      ],
                      (error, result, field) => {
                        if (error) {
                          res.json({
                            error_code: 1,
                            message: '更新用户信息失败',
                          })
                          console.log(error)
                        } else {
                          res.json({ success_code: 200 })
                        }
                      },
                    )
                  }
                }
              })
            }
          }
        })
      }
    })
  }
})
//删除用户信息
router.post('/api/admin/deleteUserInfo', function (req, res) {
  let { userId } = req.body
  if (userId) {
    let sqlStr =
      'SELECT t_schedule.schedule_id, t_schedule.seat_info,order_seat_info FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id WHERE user_id = ?'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        console.log(result)
        if (result) {
          result.forEach((value) => {
            let tempArr = []
            value.seat_info = JSON.parse(value.seat_info)
            value.order_seat_info = JSON.parse(value.order_seat_info)
            value.seat_info.forEach((v) => {
              if (value.order_seat_info.indexOf(v) === -1) {
                tempArr.push(v)
              }
            })
            tempArr = JSON.stringify(tempArr)
            sqlStr =
              'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ?;'
            conn.query(
              sqlStr,
              [tempArr, value.schedule_id],
              (error, result, field) => {
                if (error) {
                  console.log(error)
                }
              },
            )
          })
        }
        sqlStr = 'DELETE FROM t_user WHERE user_id =?'
        conn.query(sqlStr, [userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//添加用户信息
router.post('/api/admin/addUserInfo', function (req, res) {
  let { userName, avatar, phone, password, sex, sign, birthday } = req.body
  if (!avatar) {
    avatar = '/images/avatar/monkey.png'
  }
  let sqlStr = 'SELECT * FROM t_user WHERE user_name = ? LIMIT 1;'
  conn.query(sqlStr, [userName], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: '用户名已存在！' })
      } else {
        sqlStr = 'SELECT * FROM t_user WHERE phone = ? LIMIT 1'
        conn.query(sqlStr, [phone], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: '手机号码已注册！' })
            } else {
              sqlStr =
                'INSERT INTO t_user(user_name,avatar,phone,password,sex,sign,birthday) VALUES(?,?,?,?,?,?,?);'
              conn.query(
                sqlStr,
                [userName, avatar, phone, password, sex, sign, birthday],
                (error, result, field) => {
                  if (error) {
                    console.log(error)
                  } else {
                    res.json({ success_code: 200 })
                  }
                },
              )
            }
          }
        })
      }
    }
  })
})
//获取当前页电影
router.get('/api/admin/getCurrentPageMovie', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr = 'SELECT * FROM t_movie WHERE name LIKE ? ORDER BY movie_id'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_movie WHERE name LIKE ? ORDER BY movie_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})

// 异步函数：更新电影的向量
async function updateMovieVectors(movieId, movieName, intro, type) {
  try {
    console.log(`开始更新电影 ID ${movieId} 的向量...`)

    // 生成向量
    console.log('生成 movieName_vector...')
    const movieNameVector = generateTextVector(movieName)
    console.log('生成 movieIntro_vector...')
    const movieIntroVector = generateTextVector(intro)
    console.log('生成 movieLabel_vector...')
    const movieLabelVector = generateTextVector(type)

    // 更新数据库
    console.log('将向量更新到数据库...')
    const updateSqlStr =
      'UPDATE t_movie SET movieName_vector = ?, movieIntro_vector = ?, movieLabel_vector = ? WHERE movie_id = ?;'
    await new Promise((resolve, reject) => {
      conn.query(
        updateSqlStr,
        [
          JSON.stringify(movieNameVector),
          JSON.stringify(movieIntroVector),
          JSON.stringify(movieLabelVector),
          movieId,
        ],
        (error, result) => {
          if (error) {
            reject(error)
          } else {
            resolve(result)
          }
        },
      )
    })

    console.log(`电影 ID ${movieId} 的向量更新成功`)
  } catch (error) {
    console.error(`电影 ID ${movieId} 的向量更新失败:`, error)
    throw error // 抛出错误以便调用方处理
  }
}

//更新电影信息
// 更新电影信息
router.post('/api/admin/updateMovieInfo', async function (req, res) {
  const {
    movieId,
    movieName,
    poster,
    director,
    actor,
    long,
    type,
    language,
    publicDate,
    intro,
  } = req.body

  try {
    console.log(`开始更新电影 ID ${movieId} 的信息...`)

    // 检查电影名是否已存在
    console.log('检查电影名是否已存在...')
    const checkSqlStr =
      'SELECT * FROM t_movie WHERE name = ? AND movie_id <> ? LIMIT 1;'
    const checkResult = await new Promise((resolve, reject) => {
      conn.query(checkSqlStr, [movieName, movieId], (error, result) => {
        if (error) {
          reject(error)
        } else {
          resolve(JSON.parse(JSON.stringify(result)))
        }
      })
    })

    if (checkResult.length > 0) {
      console.log('电影名已存在，更新失败')
      return res.json({ error_code: 1, message: '电影名已存在！' })
    }

    // 更新电影基本信息
    console.log('更新电影基本信息...')
    const updateSqlStr =
      'UPDATE t_movie SET name = ?, poster = ?, director = ?, actor = ?, movie_long = ?, type = ?, language = ?, public_date = ?, intro = ? WHERE movie_id = ?;'
    await new Promise((resolve, reject) => {
      conn.query(
        updateSqlStr,
        [
          movieName,
          poster,
          director,
          actor,
          long,
          type,
          language,
          publicDate,
          intro,
          movieId,
        ],
        (error, result) => {
          if (error) {
            reject(error)
          } else {
            resolve(result)
          }
        },
      )
    })

    // 异步更新电影向量
    console.log('开始异步更新电影向量...')
    updateMovieVectors(movieId, movieName, intro, type)
      .then(() => {
        console.log(`电影 ID ${movieId} 的向量更新完成`)
      })
      .catch((error) => {
        console.error(`电影 ID ${movieId} 的向量更新失败:`, error)
      })

    console.log('电影信息更新成功')
    res.json({ success_code: 200, message: '电影信息更新成功' })
  } catch (error) {
    console.error('更新电影信息错误:', error)
    res.status(500).json({ error_code: 500, message: '服务器内部错误' })
  }
})
// //添加电影信息
// 添加电影信息
router.post('/api/admin/addMovieInfo', async function (req, res) {
  const {
    movieName,
    poster,
    director,
    actor,
    long,
    type,
    language,
    publicDate,
    intro,
  } = req.body

  try {
    console.log('开始新增电影...')

    // 检查电影名是否已存在
    console.log('检查电影名是否已存在...')
    const checkSqlStr = 'SELECT * FROM t_movie WHERE name = ? LIMIT 1;'
    const checkResult = await new Promise((resolve, reject) => {
      conn.query(checkSqlStr, [movieName], (error, result) => {
        if (error) {
          reject(error)
        } else {
          resolve(JSON.parse(JSON.stringify(result)))
        }
      })
    })

    if (checkResult.length > 0) {
      console.log('电影名已存在，新增失败')
      return res.json({ error_code: 1, message: '电影名已存在！' })
    }

    // 插入电影基本信息
    console.log('插入电影基本信息...')
    const insertSqlStr =
      'INSERT INTO t_movie(name, poster, director, actor, movie_long, type, language, public_date, intro) VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?);'
    const insertResult = await new Promise((resolve, reject) => {
      conn.query(
        insertSqlStr,
        [
          movieName,
          poster,
          director,
          actor,
          long,
          type,
          language,
          publicDate,
          intro,
        ],
        (error, result) => {
          if (error) {
            reject(error)
          } else {
            resolve(result)
          }
        },
      )
    })

    const movieId = insertResult.insertId // 获取新插入的电影 ID
    console.log(`新增电影成功，电影 ID: ${movieId}`)

    // 异步更新电影向量
    console.log('开始异步更新电影向量...')
    updateMovieVectors(movieId, movieName, intro, type)
      .then(() => {
        console.log(`新增电影 ID ${movieId} 的向量更新完成`)
      })
      .catch((error) => {
        console.error(`新增电影 ID ${movieId} 的向量更新失败:`, error)
      })

    res.json({ success_code: 200, message: '电影新增成功', movieId })
  } catch (error) {
    console.error('新增电影错误:', error)
    res.status(500).json({ error_code: 500, message: '服务器内部错误' })
  }
})
// 生成文本的词频向量
function generateTextVector(text) {
  if (!text || typeof text !== 'string') {
    throw new Error('Invalid text input')
  }

  // 使用 BERT 分词器处理文本
  console.log('开始使用 BERT 分词器处理文本')
  const tokenizedResult = bertTokenizer.convertSingleExample(text)

  // 检查分词结果
  if (!tokenizedResult || !tokenizedResult.inputIds) {
    throw new Error('Failed to tokenize text')
  }

  // 使用 inputIds 作为向量
  const vector = tokenizedResult.inputIds

  // 返回向量
  return vector
}

// 异步函数：更新电影的向量
async function updateMovieVectors(movieId, movieName, intro, type) {
  try {
    // 生成向量
    const movieNameVector = generateTextVector(movieName)
    const movieIntroVector = generateTextVector(intro)
    const movieLabelVector = generateTextVector(type)

    // 更新数据库
    const updateSqlStr =
      'UPDATE t_movie SET movieName_vector = ?, movieIntro_vector = ?, movieLabel_vector = ? WHERE movie_id = ?;'
    await new Promise((resolve, reject) => {
      conn.query(
        updateSqlStr,
        [
          JSON.stringify(movieNameVector),
          JSON.stringify(movieIntroVector),
          JSON.stringify(movieLabelVector),
          movieId,
        ],
        (error, result) => {
          if (error) {
            reject(error)
          } else {
            resolve(result)
          }
        },
      )
    })

    console.log(`电影 ID ${movieId} 的向量更新成功`)
  } catch (error) {
    console.error(`电影 ID ${movieId} 的向量更新失败:`, error)
    throw error // 抛出错误以便调用方处理
  }
}

datatime = './public/images/movie/'
//将图片放到服务器
storage = multer.diskStorage({
  // 如果你提供的 destination 是一个函数，你需要负责创建文件夹
  destination: datatime,
  // //给上传文件重命名，获取添加后缀名
  filename: function (req, file, cb) {
    cb(null, new Date().getTime() + '.jpg')
  },
})
upload = multer({
  storage: storage,
})
router.post('/api/admin/upLoadMovieImg', upload.any(), function (req, res) {
  res.json({ success_code: 200, data: req.files })
  console.log(req.files)
})
//删除电影信息
router.post('/api/admin/deleteMovieInfo', function (req, res) {
  let { movieId } = req.body
  let sqlStr = 'DELETE FROM t_movie WHERE movie_id =?'
  conn.query(sqlStr, [movieId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      res.json({ success_code: 200 })
    }
  })
})
//获取当前页影院
router.get('/api/admin/getCurrentPageCinema', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_cinema WHERE cinema_name LIKE ? ORDER BY cinema_id ;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_cinema WHERE cinema_name LIKE ? ORDER BY cinema_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//更新影院信息
router.post('/api/admin/updateCinemaInfo', function (req, res) {
  let { cinemaId, cinemaName, cinemaPhone, address } = req.body
  if (cinemaId) {
    let sqlStr = 'SELECT * from t_cinema WHERE cinema_id = ? LIMIT 1;'
    conn.query(sqlStr, [cinemaId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        sqlStr =
          'SELECT * FROM t_cinema WHERE cinema_name = ? AND cinema_id <> ? LIMIT 1 ;'
        conn.query(sqlStr, [cinemaName, cinemaId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: '影院名已存在！' })
            } else {
              //更新数据库
              let sqlStr =
                'UPDATE t_cinema SET cinema_name = ?,cinema_phone = ?,specified_address = ? WHERE cinema_id = ?;'
              conn.query(
                sqlStr,
                [cinemaName, cinemaPhone, address, cinemaId],
                (error, result, field) => {
                  if (error) {
                    res.json({ error_code: 1, message: '更新影院信息失败' })
                    console.log(error)
                  } else {
                    res.json({ success_code: 200 })
                  }
                },
              )
            }
          }
        })
      }
    })
  }
})
//删除影院信息
router.post('/api/admin/deleteCinemaInfo', function (req, res) {
  let { cinemaId } = req.body
  if (cinemaId) {
    let sqlStr = 'DELETE FROM t_cinema WHERE cinema_id =?'
    conn.query(sqlStr, [cinemaId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200 })
      }
    })
  }
})
//添加影院信息
router.post('/api/admin/addCinemaInfo', function (req, res) {
  let { cinemaName, cinemaPhone, address } = req.body
  sqlStr = 'SELECT * FROM t_cinema WHERE cinema_name = ? LIMIT 1 ;'
  conn.query(sqlStr, [cinemaName], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: '影院名已存在！' })
      } else {
        let sqlStr =
          'INSERT INTO t_cinema(cinema_name,cinema_phone,specified_address) VALUES(?,?,?);'
        conn.query(
          sqlStr,
          [cinemaName, cinemaPhone, address],
          (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      }
    }
  })
})
//获取当前页评论
router.get('/api/admin/getCurrentPageComment', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id INNER JOIN t_user ON t_user.user_id=t_comment.user_id WHERE t_movie.name LIKE ? ORDER BY comment_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id INNER JOIN t_user ON t_user.user_id=t_comment.user_id WHERE t_movie.name LIKE ? ORDER BY comment_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//通过当前评论
router.post('/api/admin/passCurrentComment', function (req, res) {
  let commentId = req.body.commentId
  let movieId = req.body.movieId
  if (commentId) {
    let sqlStr = 'UPDATE t_comment SET is_pass = 1 WHERE comment_id = ?;'
    conn.query(sqlStr, [commentId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        sqlStr =
          'SELECT user_score FROM t_comment WHERE movie_id = ? AND is_pass = ?;'
        conn.query(sqlStr, [movieId, 1], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            let avgScore = 0
            if (result.length) {
              result.forEach((val) => {
                avgScore += Number(val.user_score)
              })
              avgScore = (avgScore / Number(result.length)).toFixed(1)
            }
            sqlStr = 'UPDATE t_movie SET score = ? WHERE movie_id = ?;'
            conn.query(sqlStr, [avgScore, movieId], (error, result, field) => {
              if (error) {
                console.log(error)
              } else {
                res.json({ success_code: 200 })
              }
            })
          }
        })
      }
    })
  }
})
//删除当前评论
router.post('/api/admin/deleteCurrentComment', function (req, res) {
  let commentId = req.body.commentId
  let movieId = req.body.movieId
  if (commentId) {
    let sqlStr = 'DELETE FROM t_comment WHERE comment_id = ?;'
    conn.query(sqlStr, [commentId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        sqlStr =
          'SELECT user_score FROM t_comment WHERE movie_id = ? AND is_pass = ?;'
        conn.query(sqlStr, [movieId, 1], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            let avgScore = 0
            if (result.length) {
              result.forEach((val) => {
                avgScore += Number(val.user_score)
              })
              avgScore = (avgScore / Number(result.length)).toFixed(1)
            }
            sqlStr = 'UPDATE t_movie SET score = ? WHERE movie_id = ?;'
            conn.query(sqlStr, [avgScore, movieId], (error, result, field) => {
              if (error) {
                console.log(error)
              } else {
                res.json({ success_code: 200 })
              }
            })
          }
        })
      }
    })
  }
})
//获取当前页订单
router.get('/api/admin/getCurrentPageOrder', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id INNER JOIN t_user ON t_order.user_id = t_user.user_id WHERE t_movie.name LIKE ? ORDER BY order_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id INNER JOIN t_user ON t_order.user_id = t_user.user_id WHERE t_movie.name LIKE ? ORDER BY order_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//删除订单
router.post('/api/admin/deleteOrder', function (req, res) {
  let { orderId, scheduleId, orderSeatInfo } = req.body
  if (orderId) {
    let sqlStr = 'SELECT seat_info FROM t_schedule WHERE schedule_id = ?'
    conn.query(sqlStr, [scheduleId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = result[0].seat_info
        result = JSON.parse(result)
        orderSeatInfo = JSON.parse(orderSeatInfo)
        console.log(typeof result)
        console.log(typeof orderSeatInfo)
        let tempArr = []
        result.forEach((value) => {
          if (orderSeatInfo.indexOf(value) === -1) {
            tempArr.push(value)
          }
        })
        console.log(tempArr)
        result = JSON.stringify(tempArr)
        sqlStr = 'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ?;'
        conn.query(sqlStr, [result, scheduleId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            sqlStr = 'DELETE FROM t_order WHERE order_id =?'
            conn.query(sqlStr, [orderId], (error, result, field) => {
              if (error) {
                console.log(error)
              } else {
                res.json({ success_code: 200 })
              }
            })
          }
        })
      }
    })
  }
})
//获取当前页影厅
router.get('/api/admin/getCurrentPageHall', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_hall INNER JOIN t_cinema ON t_cinema.cinema_id = t_hall.cinema_id WHERE t_cinema.cinema_name LIKE ? ORDER BY hall_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_hall INNER JOIN t_cinema ON t_cinema.cinema_id = t_hall.cinema_id WHERE t_cinema.cinema_name LIKE ? ORDER BY hall_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//删除影厅
router.post('/api/admin/deleteHall', function (req, res) {
  let { cinemaId, hallName } = req.body
  if (cinemaId) {
    let sqlStr =
      'SELECT schedule_id FROM t_schedule WHERE cinema_id = ? AND hall_name = ?;'
    conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        console.log(result)
        if (result.length) {
          result.forEach((value) => {
            sqlStr = 'DELETE FROM t_schedule WHERE schedule_id = ?;'
            conn.query(sqlStr, [value.schedule_id], (error, result, field) => {
              if (error) {
                console.log(error)
              }
            })
          })
        }
        sqlStr = 'DELETE FROM t_hall WHERE cinema_id = ? AND name = ?'
        conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//更新影厅信息
router.post('/api/admin/updateHallInfo', function (req, res) {
  let { hallId, cinemaId, hallOldName, hallNewName } = req.body
  if (cinemaId) {
    let sqlStr =
      'SELECT * FROM t_hall WHERE name = ? AND cinema_id = ? AND hall_id <> ? LIMIT 1;'
    conn.query(
      sqlStr,
      [hallNewName, cinemaId, hallId],
      (error, result, field) => {
        if (error) {
          console.log(error)
        } else {
          result = JSON.parse(JSON.stringify(result))
          if (result[0]) {
            res.json({ error_code: 1, message: '该影院的影厅已存在！' })
          } else {
            sqlStr =
              'UPDATE t_schedule SET hall_name = ? WHERE cinema_id = ? AND hall_name = ?'
            conn.query(
              sqlStr,
              [hallNewName, cinemaId, hallOldName],
              (error, result, field) => {
                if (error) {
                  console.log(error)
                } else {
                  //更新数据库
                  let sqlStr =
                    'UPDATE t_hall SET name = ? WHERE cinema_id = ? AND name = ?;'
                  conn.query(
                    sqlStr,
                    [hallNewName, cinemaId, hallOldName],
                    (error, result, field) => {
                      if (error) {
                        res.json({
                          error_code: 1,
                          message: '更新影影厅信息失败',
                        })
                        console.log(error)
                      } else {
                        res.json({ success_code: 200 })
                      }
                    },
                  )
                }
              },
            )
          }
        }
      },
    )
  }
})
//获取所有影院
router.get('/api/admin/getAllCinema', function (req, res) {
  let sqlStr = 'SELECT cinema_id,cinema_name FROM t_cinema;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//添加影厅信息
router.post('/api/admin/addHallInfo', function (req, res) {
  let { cinemaId, hallName } = req.body
  let sqlStr = 'SELECT * FROM t_hall WHERE name = ? AND cinema_id = ? LIMIT 1;'
  conn.query(sqlStr, [hallName, cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: '该影院的影厅已存在！' })
      } else {
        let sqlStr = 'INSERT INTO t_hall(cinema_id,name) VALUES(?,?);'
        conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    }
  })
})
//获取当前页电影
router.get('/api/admin/getCurrentPageMovieSchedule', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE t_movie.name LIKE ? ORDER BY schedule_id '
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE t_movie.name LIKE ? ORDER BY schedule_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//获取所有电影
router.get('/api/admin/getAllMovie', function (req, res) {
  let sqlStr = 'SELECT * FROM t_movie;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//获取影院的影厅
router.get('/api/admin/getHallByCinemaId', function (req, res) {
  let cinemaId = req.query.cinemaId
  console.log(cinemaId)
  let sqlStr = 'SELECT hall_id,name FROM t_hall WHERE cinema_id = ?;'
  conn.query(sqlStr, [cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      console.log(result)
      res.json({ success_code: 200, data: result })
    }
  })
})
//获取排片的某天的时间段安排
router.get('/api/admin/getHasScheduleDateTime', function (req, res) {
  let { cinemaId, hallName, showDate } = req.query
  let sqlStr =
    'SELECT show_time FROM t_schedule WHERE cinema_id = ? AND hall_name = ? AND show_date = ?;'
  conn.query(sqlStr, [cinemaId, hallName, showDate], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//添加影院信息
router.post('/api/admin/addScheduleInfo', function (req, res) {
  let { movieId, cinemaId, hallName, showDate, showTime, price } = req.body
  let sqlStr =
    'INSERT INTO t_schedule(movie_id,cinema_id,hall_name,show_date,show_time,price) VALUES(?,?,?,?,?,?);'
  conn.query(
    sqlStr,
    [movieId, cinemaId, hallName, showDate, showTime, price],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200 })
      }
    },
  )
})
//删除影厅
router.post('/api/admin/deleteMovieSchedule', function (req, res) {
  let { scheduleId } = req.body
  if (scheduleId) {
    let sqlStr = 'DELETE FROM t_schedule WHERE schedule_id = ?'
    conn.query(sqlStr, [scheduleId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200 })
      }
    })
  }
})
module.exports = router

```



# 用户端前端代码

```vue
<template>
  <div class="search-all">
    <div class="header">
      <div class="search">
        <span
          class="icon-dropdown-arrow"
          :class="{ 'arrow-open': isDropdownOpen }"
          @click="toggleDropdown"
          >&#9660;</span
        >
        <span class="icon-search"></span>
        <!-- 绑定 placeholder 到计算属性 -->
        <input type="text" :placeholder="getPlaceholder" v-model.trim="name" />
      </div>
      <div class="dropdown-menu" v-if="isDropdownOpen">
        <div class="dropdown-item">
          <input
            type="checkbox"
            id="search-movie"
            v-model="searchOptions.movie"
          />
          <label for="search-movie">搜电影</label>
        </div>
        <div class="dropdown-item">
          <input
            type="checkbox"
            id="search-cinema"
            v-model="searchOptions.cinema"
          />
          <label for="search-cinema">搜影院</label>
        </div>
        <div class="dropdown-item">
          <input
            type="checkbox"
            id="fuzzy-search"
            v-model="searchOptions.fuzzy"
          />
          <label for="fuzzy-search">模糊搜索</label>
        </div>
      </div>
      <span class="cancel-btn" @click="$router.go(-1)">取消</span>
    </div>
    <div class="content">
      <!-- 原有内容 -->
      <div class="movie-container" v-if="movieInfo.length">
        <div class="title">影片</div>
        <movie-item :movie-list="movieInfo" :search-name="name"></movie-item>
      </div>
      <div class="cinema-container" v-if="cinemaInfo.length">
        <div class="title">影院</div>
        <div
          class="item"
          v-for="(item, index) in cinemaInfo"
          :key="index"
          @click="
            $router.push({
              path: '/cinema_detail',
              query: { cinema_id: item.cinema_id }
            })
          "
        >
          <div class="left">
            <div
              class="name ellipsis"
              v-html="ruleName(item.cinema_name)"
            ></div>
            <div class="address ellipsis">{{ item.specified_address }}</div>
            <div class="label-block">
              <span>小吃</span><span>4D厅</span><span>杜比全景声厅</span
              ><span>巨幕厅</span>
            </div>
          </div>
        </div>
      </div>
      <div class="tips" v-if="name && !movieInfo.length && !cinemaInfo.length">
        <span class="icon icon-empty-content"></span>
        <span class="text">暂时木有内容呀</span>
      </div>
    </div>
  </div>
</template>

<script>
import {
  matchCinemaByName,
  matchMovieByName,
  semanticSearchMovie,
} from "../../../api/index";
import MovieItem from "../../../components/MovieItem/MovieItem";

export default {
  name: "SearchAll",
  components: {
    MovieItem,
  },
  data() {
    return {
      name: "",
      movieInfo: [],
      cinemaInfo: [],
      server: "http://localhost:3000",
      timer: "",
      isDropdownOpen: false, // 控制下拉菜单是否显示
      searchOptions: {
        movie: true, // 搜电影初始勾选
        cinema: true, // 搜影院初始勾选
        fuzzy: false, // 模糊搜索初始不勾选
      },
    };
  },
  methods: {
    toggleDropdown() {
      this.isDropdownOpen = !this.isDropdownOpen;
      if (this.isDropdownOpen) {
        clearTimeout(this.timer); // 下拉菜单展开时停止搜索
      }
    },
    closeDropdown() {
      this.isDropdownOpen = false;
    },
    handleClickOutside(event) {
      const dropdown = this.$el.querySelector(".dropdown-menu");
      const arrow = this.$el.querySelector(".icon-dropdown-arrow");
      if (
        dropdown &&
        !dropdown.contains(event.target) &&
        !arrow.contains(event.target)
      ) {
        this.closeDropdown();
      }
    },
    // 合并精准搜索和模糊搜索的结果
    async filterData() {
      if (this.isDropdownOpen) return; // 下拉菜单展开时不进行搜索
      const keyword = this.name;
      this.movieInfo = [];
      this.cinemaInfo = [];

      // 精准搜索
      if (this.searchOptions.movie) {
        let exactMovieResults = await matchMovieByName(keyword);
        if (exactMovieResults.success_code === 200) {
          this.movieInfo = exactMovieResults.data;
        }
      }

      // 模糊搜索
      if (this.searchOptions.fuzzy && this.searchOptions.movie) {
        let fuzzyMovieResults = await semanticSearchMovie(keyword);
        if (fuzzyMovieResults.success_code === 200) {
          // 合并结果，去重，优先保留精准搜索的结果
          const exactMovieIds = new Set(this.movieInfo.map((movie) => movie.movie_id));
          fuzzyMovieResults.data.forEach((movie) => {
            if (!exactMovieIds.has(movie.movie_id)) {
              this.movieInfo.push(movie);
            }
          });
        }
      }

      // 搜影院逻辑（保持不变）
      if (this.searchOptions.cinema) {
        let json = await matchCinemaByName(keyword);
        if (json.success_code === 200) {
          this.cinemaInfo = json.data;
        }
      }
    },
  },
  watch: {
    async name(newVal, oldVal) {
      clearTimeout(this.timer);
      if (newVal) {
        this.timer = setTimeout(async () => {
          await this.filterData();
        }, 500);
      }
    },
    searchOptions: {
      deep: true,
      handler() {
        this.filterData();
      },
    },
  },
  computed: {
    ruleName() {
      return (nameString) => {
        let replaceReg = new RegExp(this.name, "g");
        let replaceString = `<span style="color: #dd2727">${this.name}</span>`;
        return nameString.replace(replaceReg, replaceString);
      };
    },
    // 新增计算属性 getPlaceholder
    getPlaceholder() {
      let searchType = this.searchOptions.fuzzy ? "【模糊】" : "【精确】";
      let searchTarget = "1";
      if (this.searchOptions.movie && this.searchOptions.cinema) {
        searchTarget = "影片、影院";
      } else if (this.searchOptions.movie) {
        searchTarget = "影片";
      } else if (this.searchOptions.cinema) {
        searchTarget = "影院";
      }
      return `${searchType}搜${searchTarget}`;
    },
  },
  mounted() {
    document.addEventListener("click", this.handleClickOutside);
  },
  beforeDestroy() {
    document.removeEventListener("click", this.handleClickOutside);
  },
};
</script>

<style scoped lang="stylus" ref="stylesheet/stylus">
.search-all
  width 100%
  background-color #f5f5f5
  .header
    width 100%
    height 1rem
    display flex
    justify-content center
    align-items center
    background-color #fff
    box-shadow 0 0 .002rem #888
    .search
      flex 4
      display flex
      align-items center
      border-radius .5rem
      margin-left .25rem
      padding .125rem .25rem
      background-color #f5f5f5
      .icon-dropdown-arrow
        font-size .375rem
        margin-right .1rem
        color blue // 初始蓝色
        cursor pointer
      .arrow-open
        color black // 下拉后黑色
      .icon-search
        font-size .375rem
      input
        width 100%
        border none
        outline none
        background-color #f5f5f5
        caret-color #dd2727
        text-indent .125rem
        font-size .3rem !important
    .dropdown-menu
      position absolute
      top 1rem
      left .25rem
      background-color white
      border 1px solid #ccc
      border-radius .1rem
      padding .1rem
      box-shadow 0 2px 4px rgba(0, 0, 0, 0.1)
      .dropdown-item
        display flex
        align-items center
        margin-bottom .05rem
        input[type="checkbox"]
          width: .3rem  // 增大勾选框大小
          height: .3rem
        label
          font-size: .25rem  // 减小字体大小
          margin-left: .15rem  // 增加文字与勾选框的间距
    .cancel-btn
      flex 1
      font-size .3rem
      color #dd2727
      text-align center
  .content
    width 100%
    background #fff
    .movie-container
      width 100%
      font-size .3125rem
      padding .3rem
      box-sizing border-box
      border-top .04rem solid #f1f1f1
      .title
        font-size .3rem
        padding-bottom .25rem
        border-bottom .03rem solid #f1f1f1
      .item
        display flex
        justify-content space-around
        align-items center
        padding .25rem
        border-bottom .03rem solid #f1f1f1
        img
          display inline-block
          width 20%
          border-radius .1rem
        .info
          width 68%
          display flex
          flex-flow column
          padding .25rem
          font-size .25rem
          color #9d9d9d
          .name
            font-weight bolder
            padding-bottom .2rem
            color #333
          .type
            padding-bottom .2rem
          .people
            padding-bottom .2rem
            .number
              color #ffb400
          .score
            padding-bottom .2rem
            .number
              color #ffb400
        .buy
          width 12%
          padding .16rem .12rem
          text-align center
          background-color #dd2727
          border-radius 24%
          font-size .25rem
          color #fff
        .presell
          background-color #2d98f3
          width 12%
          padding .16rem .12rem
          text-align center
          border-radius 20%
          font-size .25rem
          color #fff
    .cinema-container
      width 100%
      font-size .3125rem
      padding .3rem
      box-sizing border-box
      border-top .04rem solid #f1f1f1
      .title
        font-size .3rem
        padding-bottom .25rem
        border-bottom .03rem solid #f1f1f1
      .item
        display flex
        justify-content center
        align-items center
        box-sizing border-box
        padding .25rem
        width 100%
        border-bottom .03rem solid #f1f1f1
        margin-bottom .25rem
        .left
          width 100%
          .name
            font-size .345rem
            line-height .36rem
            margin-bottom .25rem
            font-weight 700
          .address
            font-size .28rem
            line-height .3rem
            color #666
            margin-bottom .25rem
          .label-block
            display flex
            span
              padding .06rem
              font-size .2rem
              border .01rem solid #f90
              margin-right .1rem
              border-radius .04rem
              color #f90
        .right
          width 20%
          text-align center
          .price-block
            color #dd2727
            .price
              font-size .38rem
    .tips
      display flex
      justify-content center
      align-items center
      flex-flow column
      font-size .28rem
      padding-top 4rem
      border-top .04rem solid #f1f1f1
      .icon
        font-size 1.6rem
        margin-bottom .25rem
      .text
        color #ccc
</style>
```





```javascript
//根据名字匹配电影---精准搜索
router.get('/api/matchMovieByName', function (req, res) {
  console.log('开始精准搜索！！！！')
  let movieName = req.query.movieName
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id WHERE name LIKE ?;'
  conn.query(sqlStr, ['%' + movieName + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        result = result.filter((value) => {
          return (
            new Date(value.show_date + ',' + value.show_time) - new Date() > 0
          )
        })
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['movie_id'] === result[j]['movie_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
      }
      res.json({ success_code: 200, data: result })
    }
  })
})

const _ = require('lodash')
// const { createRequire } = require('module')
// const requireES6 = createRequire(import.meta.url)

// 导入 jieba 相关模块
const { Jieba } = require('@node-rs/jieba')
const { dict } = require('@node-rs/jieba/dict')

// 初始化 jieba 实例
const jieba = Jieba.withDict(dict)

// BM25 类
class BM25 {
  constructor(docs, k1 = 1.2, b = 0.75) {
    this.docs = docs
    this.k1 = k1
    this.b = b
    this.avgDocLen = this.calculateAvgDocLen()
    this.idf = this.calculateIDF()
  }

  calculateAvgDocLen() {
    let totalLen = 0
    for (const doc of this.docs) {
      totalLen += doc.length
    }
    return totalLen / this.docs.length
  }

  calculateIDF() {
    const docCount = this.docs.length
    const idf = {}
    const termDocCount = {}

    for (const doc of this.docs) {
      const uniqueTerms = _.uniq(doc)
      for (const term of uniqueTerms) {
        termDocCount[term] = (termDocCount[term] || 0) + 1
      }
    }

    for (const term in termDocCount) {
      const freq = termDocCount[term]
      idf[term] = Math.log((docCount - freq + 0.5) / (freq + 0.5) + 1)
    }

    return idf
  }

  score(query, doc) {
    const docLen = doc.length
    const termFreq = _.countBy(doc)
    let score = 0

    for (const term of query) {
      if (this.idf[term]) {
        const freq = termFreq[term] || 0
        const numerator = this.idf[term] * freq * (this.k1 + 1)
        const denominator =
          freq + this.k1 * (1 - this.b + this.b * (docLen / this.avgDocLen))
        score += numerator / denominator
      }
    }

    return score
  }
}

router.get('/api/semanticSearchMovie', function (req, res) {
  console.log('开始进行语义搜索！！！！！！！！')

  let searchQuery = req.query.searchQuery
  console.log('用户搜索词:', searchQuery)

  if (!searchQuery) {
    return res.json({ error_code: 1, message: '搜索词不能为空' })
  }

  let sqlStr = 'SELECT movie_id, name, intro FROM t_movie;'

  conn.query(sqlStr, (error, result) => {
    if (error) {
      console.error('数据库查询错误:', error)
      return res.json({ error_code: 1, message: '数据库查询失败' })
    }

    result = JSON.parse(JSON.stringify(result)) // 规范化数据格式
    console.log('数据库查询返回:', result.length, '条记录')

    if (result.length === 0) {
      return res.json({ success_code: 200, data: [] })
    }

    // **✅ 进行分词处理**
    const searchTokens = jieba.cut(searchQuery)
    const docs = result.map((movie) => jieba.cut(movie.intro))

    // **✅ 计算 BM25 相关性**
    const bm25 = new BM25(docs)
    const results = result.map((movie, i) => ({
      movie_id: movie.movie_id,
      name: movie.name,
      intro: movie.intro,
      score: bm25.score(searchTokens, docs[i]),
    }))

    // **✅ 排序 & 去重**
    const topResults = _.uniqBy(
      results.sort((a, b) => b.score - a.score).slice(0, 10),
      'movie_id',
    )

    const movieIds = topResults.map((m) => m.movie_id)
    console.log('Top 10 电影 ID:', movieIds)

    if (movieIds.length === 0) {
      return res.json({ success_code: 200, data: [] })
    }

    // **✅ 查询完整电影信息**
    let finalSqlStr = `
      SELECT t_schedule.*, t_movie.*
      FROM t_schedule
      INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id
      WHERE t_schedule.movie_id IN (${movieIds.map(() => '?').join(',')})
    `

    conn.query(finalSqlStr, movieIds, (err, finalResults) => {
      if (err) {
        console.error('获取完整电影信息错误:', err)
        return res.json({ error_code: 1, message: '获取电影详情失败' })
      }

      console.log('完整电影数据:', finalResults.length, '条记录')
      res.json({ success_code: 200, data: finalResults })
    })
  })
})
```





bm25 但是没有精准了？？

```js
const express = require('express')
const router = express.Router()
const conn = require('../db/db')
const svgCaptcha = require('svg-captcha')
const util = require('../util/util')
const multer = require('multer')

// 用户API
let user = {}
/* GET home page. */
router.get('/', function (req, res, next) {
  res.render('index', { title: 'Express' })
})
//获取手机验证码
router.get('/api/getPhoneCode', function (req, res) {
  let phone = req.query.phone
  let phoneCode = util.randomCode(4)
  if (!phoneCode) {
    res.json({ error_code: 1, message: '获取验证码失败' })
  } else {
    user[phone] = phoneCode
    res.json({ success_code: 200, data: phoneCode })
  }
})
//获取图形验证码
router.get('/api/captcha', function (req, res) {
  let captcha = svgCaptcha.create({
    size: 4, // size of random string
    ignoreChars: '0o1i', // filter out some characters like 0o1i
    noise: 3, // number of noise lines
    color: true, //, characters will have distinct colors instead of grey, true if background option is set
    background: '#fff', // background color of the svg image
  })
  //保存图形验证码文本
  req.session.captcha = captcha.text.toLowerCase()
  //返回验证码数据
  res.type('svg')
  res.status(200).send(captcha.data)
})
//手机登录
router.post('/api/phoneLogin', function (req, res) {
  let phone = req.body.phone
  let phoneCode = req.body.phoneCode
  //判断手机验证码是否正确
  if (user[phone] === phoneCode) {
    let sqlStr = 'SELECT * from t_user WHERE phone = ? LIMIT 1 ;'
    conn.query(sqlStr, [phone], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '请求数据失败' })
      } else {
        result = JSON.parse(JSON.stringify(result))
        //用户存在
        if (result[0]) {
          req.session.userId = result[0].user_id
          res.cookie('user_id', result[0].user_id)
          res.json({ success_code: 200 })
        } else {
          //用户不存在
          let sqlStr =
            'INSERT INTO t_user(user_name,phone,avatar,password) VALUES(?,?,?,?)'
          let avatarSrc = '/images/avatar/monkey.png'
          conn.query(
            sqlStr,
            [phone, phone, avatarSrc, 123456],
            (error, result, field) => {
              if (error) {
                console.log(error)
                res.json({ error_code: 1, message: '创建用户失败' })
              } else {
                res.cookie('user_id', result.insertId)
                res.json({ success_code: 200 })
              }
            },
          )
        }
      }
    })
  } else {
    res.json({ error_code: 1, message: '验证码不正确' })
  }
})
//密码登录
router.post('/api/pwdLogin', function (req, res) {
  let name = req.body.userName
  let pwd = req.body.password
  let captcha = req.body.captcha
  //判断验证码是否正确
  if (captcha.toLowerCase() !== req.session.captcha) {
    res.json({ error_code: 1, message: '验证码不正确' })
  } else {
    delete req.session.captcha
    let sqlStr = 'SELECT * from t_user WHERE user_name =? LIMIT 1 ;'
    conn.query(sqlStr, [name], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '查询用户失败' })
      } else {
        result = JSON.parse(JSON.stringify(result))
        if (result[0]) {
          if (result[0].password === pwd) {
            //保存用户id
            req.session.userId = result[0].user_id
            res.cookie('user_id', result[0].user_id)
            res.json({ success_code: 200 })
          } else {
            res.json({ error_code: 1, message: '密码错误' })
          }
        } else {
          res.json({ error: 1, message: '用户不存在' })
        }
      }
    })
  }
})
//获取用户信息
router.get('/api/getUserInfo', function (req, res) {
  let userId = req.query.userId
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '获取用户信息失败' })
      } else {
        result = JSON.parse(JSON.stringify(result))
        if (result[0]) {
          res.json({ success_code: 200, data: result[0] })
        } else {
          res.json({ error_code: 1, message: '用户信息不存在' })
        }
      }
    })
  }
})
//更新用户头像
router.post('/api/updateUserAvatar', function (req, res) {
  let { userId, avatar } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '用户不存在' })
      } else {
        //更新数据库
        let sqlStr = 'UPDATE t_user SET avatar = ? WHERE user_id = ?;'
        conn.query(sqlStr, [avatar, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: '更新用户头像失败' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//更新用户名
router.post('/api/updateUserName', function (req, res) {
  let { userId, userName } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '用户不存在' })
      } else {
        sqlStr =
          'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1 ;'
        conn.query(sqlStr, [userName, userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: '用户名已存在！' })
            } else {
              //更新数据库
              let sqlStr = 'UPDATE t_user SET user_name = ? WHERE user_id = ?;'
              conn.query(sqlStr, [userName, userId], (error, result, field) => {
                if (error) {
                  res.json({ error_code: 1, message: '更新用户名失败' })
                } else {
                  res.json({ success_code: 200 })
                }
              })
            }
          }
        })
      }
    })
  }
})
//更新用户性别
router.post('/api/updateUserSex', function (req, res) {
  let { userId, sex } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '用户不存在' })
      } else {
        //更新数据库
        let sqlStr = 'UPDATE t_user SET sex = ? WHERE user_id = ?;'
        conn.query(sqlStr, [sex, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: '更新用户性别失败' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//更新用户生日
router.post('/api/updateUserBirthday', function (req, res) {
  let { userId, birthday } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '用户不存在' })
      } else {
        //更新数据库
        let sqlStr = 'UPDATE t_user SET birthday = ? WHERE user_id = ?;'
        conn.query(sqlStr, [birthday, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: '更新用户生日失败' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//更新用户签名
router.post('/api/updateUserSign', function (req, res) {
  let { userId, sign } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '用户不存在' })
      } else {
        //更新数据库
        let sqlStr = 'UPDATE t_user SET sign = ? WHERE user_id = ?;'
        conn.query(sqlStr, [sign, userId], (error, result, field) => {
          if (error) {
            res.json({ error_code: 1, message: '更新用户签名失败' })
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//更新用户信息
router.post('/api/updateUserInfo', function (req, res) {
  let { userId, userName, avatar, password, sex, sign, birthday } = req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '用户不存在' })
      } else {
        sqlStr =
          'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1 ;'
        conn.query(sqlStr, [userName, userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: '用户名已存在！' })
            } else {
              //更新数据库
              let sqlStr =
                'UPDATE t_user SET user_name = ?,avatar = ?,password = ?,sex = ? ,birthday = ?,sign = ?WHERE user_id = ?;'
              conn.query(
                sqlStr,
                [userName, avatar, password, sex, birthday, sign, userId],
                (error, result, field) => {
                  if (error) {
                    res.json({ error_code: 1, message: '更新用户信息失败' })
                  } else {
                    res.json({ success_code: 200 })
                  }
                },
              )
            }
          }
        })
      }
    })
  }
})
//加载电影列表
router.get('/api/getMovieList', function (req, res) {
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '获取电影列表失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        result = result.filter((value) => {
          return (
            new Date(value.show_date + ',' + value.show_time) - new Date() > 0
          )
        })
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['movie_id'] === result[j]['movie_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
        res.json({ success_code: 200, data: result })
      } else {
        res.json({ error_code: 1, message: '电影列表为空' })
      }
    }
  })
})
//加载电影详细信息
router.get('/api/getMovieDetail', function (req, res) {
  let movieId = req.query.movieId
  let sqlStr = 'SELECT * FROM t_movie WHERE movie_id = ? LIMIT 1;'
  conn.query(sqlStr, [movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: '获取电影信息失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result })
      } else {
        res.json({ error_code: 1, message: '该电影不存在' })
      }
    }
  })
})
//是否想看电影
router.post('/api/isWishMovie', function (req, res) {
  let { userId, movieId } = req.body
  let sqlStr =
    'SELECT * FROM t_wishmovie WHERE user_id = ? AND movie_id = ? LIMIT 1;'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '操作失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200 })
      } else {
        res.json({ error_code: 1, message: '不想看' })
      }
    }
  })
})
//想看电影
router.post('/api/wishMovie', function (req, res) {
  let { userId, movieId } = req.body
  let sqlStr = 'INSERT INTO t_wishmovie(user_id,movie_id) VALUES(?,?)'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: '操作失败' })
    } else {
      let sqlStr = 'SELECT wish_num from t_movie WHERE movie_id = ? LIMIT 1;'
      conn.query(sqlStr, [movieId], (error, result, field) => {
        if (error) {
          res.json({ error_code: 1, message: '操作失败' })
        } else {
          result = JSON.parse(JSON.stringify(result))
          if (result[0]) {
            //更新数据库
            let sqlStr = 'UPDATE t_movie SET wish_num = ? WHERE movie_id = ?;'
            conn.query(
              sqlStr,
              [result[0].wish_num + 1, movieId],
              (error, result, field) => {
                if (error) {
                  res.json({ error_code: 1, message: '更新信息失败' })
                } else {
                  res.json({ success_code: 200 })
                }
              },
            )
          }
        }
      })
    }
  })
})
//取消想看电影
router.post('/api/cancelWishMovie', function (req, res) {
  let { userId, movieId } = req.body
  let sqlStr = 'DELETE FROM t_wishmovie WHERE user_id = ? AND movie_id =? ;'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: '操作失败' })
    } else {
      let sqlStr = 'SELECT wish_num from t_movie WHERE movie_id = ? LIMIT 1;'
      conn.query(sqlStr, [movieId], (error, result, field) => {
        if (error) {
          res.json({ error_code: 1, message: '操作失败' })
        } else {
          result = JSON.parse(JSON.stringify(result))
          if (result[0]) {
            //更新数据库
            let sqlStr = 'UPDATE t_movie SET wish_num = ? WHERE movie_id = ?;'
            conn.query(
              sqlStr,
              [result[0].wish_num - 1, movieId],
              (error, result, field) => {
                if (error) {
                  res.json({ error_code: 1, message: '更新信息失败' })
                } else {
                  res.json({ success_code: 200 })
                }
              },
            )
          }
        }
      })
    }
  })
})
//获取当前用户评论
router.get('/api/getUserComment', function (req, res) {
  let { userId, movieId } = req.query
  let sqlStr =
    'SELECT * FROM t_comment WHERE user_id = ? AND movie_id= ? LIMIT 1;'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '操作失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: '用户未评论' })
      }
    }
  })
})
//获取所有用户通过审核的评论
router.get('/api/getAllUserPassComment', function (req, res) {
  let { movieId } = req.query
  let sqlStr =
    'SELECT * FROM t_user user INNER JOIN t_comment comment ON user.user_id = comment.user_id WHERE comment.movie_id = ? AND comment.is_pass = ? ;'
  conn.query(sqlStr, [movieId, 1], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '操作失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result) {
        res.json({ success_code: 200, data: result })
      } else {
        res.json({ error_code: 1, message: '未评论' })
      }
    }
  })
})
//更新用户评论
router.post('/api/updateUserComment', function (req, res) {
  let { userId, movieId, score, commentContent, commentDate } = req.body
  let sqlStr =
    'SELECT comment_id from t_comment WHERE user_id = ? AND movie_id = ? LIMIT 1'
  conn.query(sqlStr, [userId, movieId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: '操作失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        //评论存在
        //更新
        let sqlStr =
          'UPDATE t_comment SET user_score = ?, comment_content = ?, comment_date = ?,support_num = ?,is_pass = ?,support_user = ? WHERE comment_id = ? ;'
        conn.query(
          sqlStr,
          [
            score,
            commentContent,
            commentDate,
            0,
            0,
            undefined,
            result[0].comment_id,
          ],
          (error, result, field) => {
            if (error) {
              res.json({ error_code: 1, message: '更新评论失败' })
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      } else {
        //评论不存在
        let sqlStr =
          'INSERT INTO t_comment(user_id,movie_id,user_score,comment_content,comment_date,support_num,is_pass) VALUES(?,?,?,?,?,?,?)'
        conn.query(
          sqlStr,
          [userId, movieId, score, commentContent, commentDate, 0, 0],
          (error, result, field) => {
            if (error) {
              console.log(error)
              res.json({ error_code: 1, message: '操作失败' })
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      }
    }
  })
})
//获取当前评论
router.get('/api/getCommentByID', function (req, res) {
  let { commentId } = req.query
  let sqlStr = 'SELECT * FROM t_comment WHERE comment_id = ? LIMIT 1;'
  conn.query(sqlStr, [commentId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '操作失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: '用户未评论' })
      }
    }
  })
})
//更新当前评论的用户点赞
router.post('/api/updateUserSupport', function (req, res) {
  let { commentId, supportNum, supportUser } = req.body
  let sqlStr =
    'UPDATE t_comment SET support_num = ? , support_user = ? WHERE comment_id = ?;'
  conn.query(
    sqlStr,
    [supportNum, supportUser, commentId],
    (error, result, field) => {
      if (error) {
        console.log(error)
        res.json({ error_code: 1, message: '操作失败' })
      } else {
        res.json({ success_code: 200 })
      }
    },
  )
})
//加载影院列表
router.get('/api/getCinemaList', function (req, res) {
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_cinema ON t_schedule.cinema_id = t_cinema.cinema_id INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: '获取影院列表失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        result = result.filter((value) => {
          return (
            new Date(value.show_date + ',' + value.show_time) - new Date() > 0
          )
        })
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['cinema_id'] === result[j]['cinema_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
      }
      res.json({ success_code: 200, data: result })
    }
  })
})
//加载当前影院详细信息
router.get('/api/getCurrentCinemaDetail', function (req, res) {
  let cinemaId = req.query.cinemaId
  let sqlStr = 'SELECT * FROM t_cinema WHERE cinema_id = ? LIMIT 1;'
  conn.query(sqlStr, [cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '获取当前影院信息失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: '影院不存在' })
      }
    }
  })
})
//加载当前影院排片
router.get('/api/getCurrentCinemaMovieSchedule', function (req, res) {
  let cinemaId = req.query.cinemaId
  console.log(cinemaId)
  let sqlStr = 'SELECT * FROM t_schedule WHERE cinema_id = ?;'
  conn.query(sqlStr, [cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '获取当前影院排片信息失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result) {
        let tempMovieArr = []
        result.forEach((value) => {
          if (
            new Date() - new Date(value.show_date + ',' + value.show_time) <=
            0
          ) {
            tempMovieArr.push(value.movie_id)
          }
        })
        tempMovieArr = Array.from(new Set(tempMovieArr))
        let movieArray = []
        let movieScheduleArray = []
        tempMovieArr.forEach((value) => {
          sqlStr = 'SELECT * FROM t_movie WHERE movie_id = ? LIMIT 1;'
          conn.query(sqlStr, [value], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result[0]) {
                movieArray.push(result[0])
              }
            }
          })
          sqlStr =
            'SELECT * FROM t_schedule schedule INNER JOIN t_movie movie ON schedule.movie_id = movie.movie_id WHERE schedule.movie_id = ? AND schedule.cinema_id = ?;'
          conn.query(sqlStr, [value, cinemaId], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result) {
                movieScheduleArray.push(result)
              }
            }
          })
        })
        setTimeout(() => {
          res.json({
            success_code: 200,
            data: {
              hasMovieInfo: movieArray,
              movieScheduleInfo: movieScheduleArray,
            },
          })
        }, 500)
      } else {
        res.json({ error_code: 1, message: '当前影院排片信息为空' })
      }
    }
  })
})
//加载当前影院详细信息
router.get('/api/getScheduleById', function (req, res) {
  let scheduleId = req.query.scheduleId
  let sqlStr = 'SELECT * FROM t_schedule WHERE schedule_id = ? LIMIT 1;'
  conn.query(sqlStr, [scheduleId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '获取当前排片信息失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error_code: 1, message: '排片信息不存在' })
      }
    }
  })
})
//加载当前影院详细信息
router.post('/api/updateScheduleSeat', function (req, res) {
  let { scheduleId, seatInfo } = req.body
  let sqlStr =
    'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ? LIMIT 1;'
  conn.query(sqlStr, [seatInfo, scheduleId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '更新排片座位信息失败' })
    } else {
      res.json({ success_code: 200, data: result[0] })
    }
  })
})
//加载当前电影排片
router.get('/api/getCurrentMovieSchedule', function (req, res) {
  let movieId = req.query.movieId
  let sqlStr = 'SELECT * FROM t_schedule WHERE movie_id = ?;'
  conn.query(sqlStr, [movieId], (error, result, field) => {
    if (error) {
      console.log(error)
      res.json({ error_code: 1, message: '获取当前影院排片信息失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result) {
        let tempDateArr = []
        result.forEach((value) => {
          if (
            new Date() - new Date(value.show_date + ',' + value.show_time) <=
            0
          ) {
            tempDateArr.push(value.show_date)
          }
        })
        tempDateArr = Array.from(new Set(tempDateArr))
        tempDateArr.sort((a, b) => {
          return new Date(a) - new Date(b)
        })
        let cinemaArray = []
        let cinemaScheduleArray = []
        tempDateArr.forEach((value) => {
          sqlStr = 'SELECT * FROM t_schedule WHERE show_date = ?'
          conn.query(sqlStr, [value], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result) {
                cinemaArray.push(result)
              }
            }
          })
          sqlStr =
            'SELECT * FROM t_schedule schedule INNER JOIN t_cinema cinema ON schedule.cinema_id = cinema.cinema_id WHERE schedule.movie_id = ? AND schedule.show_date = ?;'
          conn.query(sqlStr, [movieId, value], (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              result = JSON.parse(JSON.stringify(result))
              if (result) {
                cinemaScheduleArray.push(result)
              }
            }
          })
        })
        setTimeout(() => {
          res.json({
            success_code: 200,
            data: {
              hasCinemaInfo: cinemaArray,
              cinemaScheduleInfo: cinemaScheduleArray,
            },
          })
        }, 500)
      } else {
        res.json({ error_code: 1, message: '当前电影排片信息为空' })
      }
    }
  })
})

//根据名字匹配电影---精准搜索
router.get('/api/matchMovieByName', function (req, res) {
  console.log('开始精准搜索！！！！')
  let movieName = req.query.movieName
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id WHERE name LIKE ?;'
  conn.query(sqlStr, ['%' + movieName + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        result = result.filter((value) => {
          return (
            new Date(value.show_date + ',' + value.show_time) - new Date() > 0
          )
        })
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['movie_id'] === result[j]['movie_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
      }
      res.json({ success_code: 200, data: result })
    }
  })
})

const _ = require('lodash')
// const { createRequire } = require('module')
// const requireES6 = createRequire(import.meta.url)

// 导入 jieba 相关模块
const { Jieba } = require('@node-rs/jieba')
const { dict } = require('@node-rs/jieba/dict')

// 初始化 jieba 实例
const jieba = Jieba.withDict(dict)

// BM25 类
class BM25 {
  constructor(docs, k1 = 1.2, b = 0.75) {
    this.docs = docs
    this.k1 = k1
    this.b = b
    this.avgDocLen = this.calculateAvgDocLen()
    this.idf = this.calculateIDF()
  }

  calculateAvgDocLen() {
    let totalLen = 0
    for (const doc of this.docs) {
      totalLen += doc.length
    }
    return totalLen / this.docs.length
  }

  calculateIDF() {
    const docCount = this.docs.length
    const idf = {}
    const termDocCount = {}

    for (const doc of this.docs) {
      const uniqueTerms = _.uniq(doc)
      for (const term of uniqueTerms) {
        termDocCount[term] = (termDocCount[term] || 0) + 1
      }
    }

    for (const term in termDocCount) {
      const freq = termDocCount[term]
      idf[term] = Math.log((docCount - freq + 0.5) / (freq + 0.5) + 1)
    }

    return idf
  }

  score(query, doc) {
    const docLen = doc.length
    const termFreq = _.countBy(doc)
    let score = 0

    for (const term of query) {
      if (this.idf[term]) {
        const freq = termFreq[term] || 0
        const numerator = this.idf[term] * freq * (this.k1 + 1)
        const denominator =
          freq + this.k1 * (1 - this.b + this.b * (docLen / this.avgDocLen))
        score += numerator / denominator
      }
    }

    return score
  }
}

router.get('/api/semanticSearchMovie', function (req, res) {
  console.log('开始进行语义搜索！！！！！！！！')

  let searchQuery = req.query.searchQuery
  console.log('用户搜索词:', searchQuery)

  if (!searchQuery) {
    return res.json({ error_code: 1, message: '搜索词不能为空' })
  }

  let sqlStr = 'SELECT movie_id, name, intro FROM t_movie;'

  conn.query(sqlStr, (error, result) => {
    if (error) {
      console.error('数据库查询错误:', error)
      return res.json({ error_code: 1, message: '数据库查询失败' })
    }

    result = JSON.parse(JSON.stringify(result)) // 规范化数据格式
    console.log('数据库查询返回:', result.length, '条记录')

    if (result.length === 0) {
      return res.json({ success_code: 200, data: [] })
    }

    // **✅ 进行分词处理**
    const searchTokens = jieba.cut(searchQuery)
    const docs = result.map((movie) => jieba.cut(movie.intro))

    // **✅ 计算 BM25 相关性**
    const bm25 = new BM25(docs)
    const results = result.map((movie, i) => ({
      movie_id: movie.movie_id,
      name: movie.name,
      intro: movie.intro,
      score: bm25.score(searchTokens, docs[i]),
    }))

    // **✅ 排序 & 去重**
    const topResults = _.uniqBy(
      results.sort((a, b) => b.score - a.score).slice(0, 10),
      'movie_id',
    )

    const movieIds = topResults.map((m) => m.movie_id)
    console.log('Top 10 电影 ID:', movieIds)

    if (movieIds.length === 0) {
      return res.json({ success_code: 200, data: [] })
    }

    // **✅ 查询完整电影信息**
    let finalSqlStr = `
      SELECT t_schedule.*, t_movie.*
      FROM t_schedule
      INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id
      WHERE t_schedule.movie_id IN (${movieIds.map(() => '?').join(',')})
    `

    conn.query(finalSqlStr, movieIds, (err, finalResults) => {
      if (err) {
        console.error('获取完整电影信息错误:', err)
        return res.json({ error_code: 1, message: '获取电影详情失败' })
      }

      console.log('完整电影数据:', finalResults.length, '条记录')
      res.json({ success_code: 200, data: finalResults })
    })
  })
})

//根据名字匹配影院
router.get('/api/matchCinemaByName', function (req, res) {
  let cinemaName = req.query.cinemaName
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_cinema ON t_schedule.cinema_id = t_cinema.cinema_id INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id WHERE cinema_name LIKE ?;'
  conn.query(sqlStr, ['%' + cinemaName + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result.length) {
        result = result.filter((value) => {
          return (
            new Date(value.show_date + ',' + value.show_time) - new Date() > 0
          )
        })
        for (let i = 0; i < result.length; i++) {
          for (let j = i + 1; j < result.length; j++) {
            if (result[i]['cinema_id'] === result[j]['cinema_id']) {
              result.splice(j, 1)
              j = j - 1
            }
          }
        }
      }
      res.json({ success_code: 200, data: result })
    }
  })
})
//用户下单
router.post('/api/order', function (req, res) {
  let {
    userId,
    scheduleId,
    orderPhone,
    orderDate,
    ticketNum,
    totalPrice,
    orderSeatInfo,
    payType,
  } = req.body
  let phoneCode = util.randomCode(6)
  let sqlStr =
    'INSERT INTO t_order(user_id,schedule_id,order_phone,order_date,ticket_num,ticket_total_price,order_seat_info,pay_type,phone_code) VALUES(?,?,?,?,?,?,?,?,?); '
  conn.query(
    sqlStr,
    [
      userId,
      scheduleId,
      orderPhone,
      orderDate,
      ticketNum,
      totalPrice,
      orderSeatInfo,
      payType,
      phoneCode,
    ],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200, data: { phone_code: phoneCode } })
      }
    },
  )
})
//获取个人订单信息
router.get('/api/getOrderByUserId', function (req, res) {
  let userId = req.query.userId
  let sqlStr =
    'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE user_id = ?;'
  conn.query(sqlStr, [userId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//获取个人想看电影
router.get('/api/getWishMovieByUserId', function (req, res) {
  let userId = req.query.userId
  let sqlStr =
    'SELECT * FROM t_wishmovie INNER JOIN t_movie ON t_wishmovie.movie_id = t_movie.movie_id WHERE user_id = ?;'
  conn.query(sqlStr, [userId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//获取个人看过的电影
router.get('/api/getIsWatchedMovieByUserId', function (req, res) {
  let userId = req.query.userId
  let sqlStr =
    'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id WHERE user_id = ? AND is_pass = 1;'
  conn.query(sqlStr, [userId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})

//管理员API
//获取当前页用户

//密码登录
router.post('/api/admin/login', function (req, res) {
  let name = req.body.name
  let password = req.body.password
  let sqlStr = 'SELECT * FROM t_admin WHERE name = ? LIMIT 1 ;'
  conn.query(sqlStr, [name, password], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: '查询用户失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        if (result[0].password === password) {
          //保存用户id
          req.session.adminId = result[0].admin_id
          res.cookie('admin_id', result[0].admin_id)
          res.json({ success_code: 200 })
        } else {
          res.json({ error_code: 1, message: '密码错误' })
        }
      } else {
        res.json({ error: 1, message: '用户不存在' })
      }
    }
  })
})
//获取用户信息
router.get('/api/admin/getAdminInfo', function (req, res) {
  let adminId = req.query.adminId
  let sqlStr = 'SELECT * FROM t_admin WHERE admin_id = ? LIMIT 1 ;'
  conn.query(sqlStr, [adminId], (error, result, field) => {
    if (error) {
      res.json({ error_code: 1, message: '查询用户失败' })
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ success_code: 200, data: result[0] })
      } else {
        res.json({ error: 1, message: '用户不存在' })
      }
    }
  })
})
router.get('/api/admin/getCurrentPageUser', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr = 'SELECT * FROM t_user WHERE user_name LIKE ? ORDER BY user_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_user WHERE user_name LIKE ? ORDER BY user_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})

var datatime = './public/images/avatar/'
//将图片放到服务器
var storage = multer.diskStorage({
  // 如果你提供的 destination 是一个函数，你需要负责创建文件夹
  destination: datatime,
  // //给上传文件重命名，获取添加后缀名
  filename: function (req, file, cb) {
    cb(null, new Date().getTime() + '.jpg')
  },
})
var upload = multer({
  storage: storage,
})
// let upload = multer({dest:'./public/images/avatar'}).any();
router.post('/api/admin/upLoadImg', upload.any(), function (req, res) {
  res.json({ success_code: 200, data: req.files })
  console.log(req.files)
})

//更新用户信息
router.post('/api/admin/updateUserInfo', function (req, res) {
  let { userId, userName, avatar, password, sex, phone, sign, birthday } =
    req.body
  if (userId) {
    let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        res.json({ error_code: 1, message: '用户不存在' })
      } else {
        let sqlStr =
          'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1;'
        conn.query(sqlStr, [userName, userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: '用户名已存在！' })
            } else {
              sqlStr =
                'SELECT * FROM t_user WHERE phone = ? AND user_id <> ? LIMIT 1;'
              conn.query(sqlStr, [phone, userId], (error, result, field) => {
                if (error) {
                  console.log(error)
                } else {
                  result = JSON.parse(JSON.stringify(result))
                  if (result[0]) {
                    res.json({ error_code: 1, message: '手机号码已注册！' })
                  } else {
                    //更新数据库
                    let sqlStr =
                      'UPDATE t_user SET user_name = ?,avatar = ?,password = ?,sex = ? ,phone = ?,birthday = ?,sign = ? WHERE user_id = ?;'
                    conn.query(
                      sqlStr,
                      [
                        userName,
                        avatar,
                        password,
                        sex,
                        phone,
                        birthday,
                        sign,
                        userId,
                      ],
                      (error, result, field) => {
                        if (error) {
                          res.json({
                            error_code: 1,
                            message: '更新用户信息失败',
                          })
                          console.log(error)
                        } else {
                          res.json({ success_code: 200 })
                        }
                      },
                    )
                  }
                }
              })
            }
          }
        })
      }
    })
  }
})
//删除用户信息
router.post('/api/admin/deleteUserInfo', function (req, res) {
  let { userId } = req.body
  if (userId) {
    let sqlStr =
      'SELECT t_schedule.schedule_id, t_schedule.seat_info,order_seat_info FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id WHERE user_id = ?'
    conn.query(sqlStr, [userId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        console.log(result)
        if (result) {
          result.forEach((value) => {
            let tempArr = []
            value.seat_info = JSON.parse(value.seat_info)
            value.order_seat_info = JSON.parse(value.order_seat_info)
            value.seat_info.forEach((v) => {
              if (value.order_seat_info.indexOf(v) === -1) {
                tempArr.push(v)
              }
            })
            tempArr = JSON.stringify(tempArr)
            sqlStr =
              'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ?;'
            conn.query(
              sqlStr,
              [tempArr, value.schedule_id],
              (error, result, field) => {
                if (error) {
                  console.log(error)
                }
              },
            )
          })
        }
        sqlStr = 'DELETE FROM t_user WHERE user_id =?'
        conn.query(sqlStr, [userId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//添加用户信息
router.post('/api/admin/addUserInfo', function (req, res) {
  let { userName, avatar, phone, password, sex, sign, birthday } = req.body
  if (!avatar) {
    avatar = '/images/avatar/monkey.png'
  }
  let sqlStr = 'SELECT * FROM t_user WHERE user_name = ? LIMIT 1;'
  conn.query(sqlStr, [userName], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: '用户名已存在！' })
      } else {
        sqlStr = 'SELECT * FROM t_user WHERE phone = ? LIMIT 1'
        conn.query(sqlStr, [phone], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: '手机号码已注册！' })
            } else {
              sqlStr =
                'INSERT INTO t_user(user_name,avatar,phone,password,sex,sign,birthday) VALUES(?,?,?,?,?,?,?);'
              conn.query(
                sqlStr,
                [userName, avatar, phone, password, sex, sign, birthday],
                (error, result, field) => {
                  if (error) {
                    console.log(error)
                  } else {
                    res.json({ success_code: 200 })
                  }
                },
              )
            }
          }
        })
      }
    }
  })
})
//获取当前页电影
router.get('/api/admin/getCurrentPageMovie', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr = 'SELECT * FROM t_movie WHERE name LIKE ? ORDER BY movie_id'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_movie WHERE name LIKE ? ORDER BY movie_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//更新电影信息
router.post('/api/admin/updateMovieInfo', function (req, res) {
  let {
    movieId,
    movieName,
    poster,
    director,
    actor,
    long,
    type,
    language,
    publicDate,
    intro,
  } = req.body
  let sqlStr = 'SELECT * FROM t_movie WHERE name = ? AND movie_id <> ? LIMIT 1;'
  conn.query(sqlStr, [movieName, movieId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: '电影名已存在！' })
      } else {
        //更新数据库
        let sqlStr =
          'UPDATE t_movie SET name = ?,poster = ?,director = ?,actor = ? ,movie_long = ?,type = ?,language = ?,public_date = ?,intro = ? WHERE movie_id = ?;'
        conn.query(
          sqlStr,
          [
            movieName,
            poster,
            director,
            actor,
            long,
            type,
            language,
            publicDate,
            intro,
            movieId,
          ],
          (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      }
    }
  })
})
//添加电影信息
router.post('/api/admin/addMovieInfo', function (req, res) {
  let {
    movieName,
    poster,
    director,
    actor,
    long,
    type,
    language,
    publicDate,
    intro,
  } = req.body
  let sqlStr = 'SELECT * FROM t_movie WHERE name = ? LIMIT 1;'
  conn.query(sqlStr, [movieName], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: '电影名已存在！' })
      } else {
        let sqlStr =
          'INSERT INTO t_movie(name,poster,director,actor,movie_long,type,language,public_date,intro) VALUES(?,?,?,?,?,?,?,?,?);'
        conn.query(
          sqlStr,
          [
            movieName,
            poster,
            director,
            actor,
            long,
            type,
            language,
            publicDate,
            intro,
          ],
          (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      }
    }
  })
})

datatime = './public/images/movie/'
//将图片放到服务器
storage = multer.diskStorage({
  // 如果你提供的 destination 是一个函数，你需要负责创建文件夹
  destination: datatime,
  // //给上传文件重命名，获取添加后缀名
  filename: function (req, file, cb) {
    cb(null, new Date().getTime() + '.jpg')
  },
})
upload = multer({
  storage: storage,
})
router.post('/api/admin/upLoadMovieImg', upload.any(), function (req, res) {
  res.json({ success_code: 200, data: req.files })
  console.log(req.files)
})
//删除电影信息
router.post('/api/admin/deleteMovieInfo', function (req, res) {
  let { movieId } = req.body
  let sqlStr = 'DELETE FROM t_movie WHERE movie_id =?'
  conn.query(sqlStr, [movieId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      res.json({ success_code: 200 })
    }
  })
})
//获取当前页影院
router.get('/api/admin/getCurrentPageCinema', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_cinema WHERE cinema_name LIKE ? ORDER BY cinema_id ;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_cinema WHERE cinema_name LIKE ? ORDER BY cinema_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//更新影院信息
router.post('/api/admin/updateCinemaInfo', function (req, res) {
  let { cinemaId, cinemaName, cinemaPhone, address } = req.body
  if (cinemaId) {
    let sqlStr = 'SELECT * from t_cinema WHERE cinema_id = ? LIMIT 1;'
    conn.query(sqlStr, [cinemaId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        sqlStr =
          'SELECT * FROM t_cinema WHERE cinema_name = ? AND cinema_id <> ? LIMIT 1 ;'
        conn.query(sqlStr, [cinemaName, cinemaId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            if (result[0]) {
              res.json({ error_code: 1, message: '影院名已存在！' })
            } else {
              //更新数据库
              let sqlStr =
                'UPDATE t_cinema SET cinema_name = ?,cinema_phone = ?,specified_address = ? WHERE cinema_id = ?;'
              conn.query(
                sqlStr,
                [cinemaName, cinemaPhone, address, cinemaId],
                (error, result, field) => {
                  if (error) {
                    res.json({ error_code: 1, message: '更新影院信息失败' })
                    console.log(error)
                  } else {
                    res.json({ success_code: 200 })
                  }
                },
              )
            }
          }
        })
      }
    })
  }
})
//删除影院信息
router.post('/api/admin/deleteCinemaInfo', function (req, res) {
  let { cinemaId } = req.body
  if (cinemaId) {
    let sqlStr = 'DELETE FROM t_cinema WHERE cinema_id =?'
    conn.query(sqlStr, [cinemaId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200 })
      }
    })
  }
})
//添加影院信息
router.post('/api/admin/addCinemaInfo', function (req, res) {
  let { cinemaName, cinemaPhone, address } = req.body
  sqlStr = 'SELECT * FROM t_cinema WHERE cinema_name = ? LIMIT 1 ;'
  conn.query(sqlStr, [cinemaName], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: '影院名已存在！' })
      } else {
        let sqlStr =
          'INSERT INTO t_cinema(cinema_name,cinema_phone,specified_address) VALUES(?,?,?);'
        conn.query(
          sqlStr,
          [cinemaName, cinemaPhone, address],
          (error, result, field) => {
            if (error) {
              console.log(error)
            } else {
              res.json({ success_code: 200 })
            }
          },
        )
      }
    }
  })
})
//获取当前页评论
router.get('/api/admin/getCurrentPageComment', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id INNER JOIN t_user ON t_user.user_id=t_comment.user_id WHERE t_movie.name LIKE ? ORDER BY comment_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id INNER JOIN t_user ON t_user.user_id=t_comment.user_id WHERE t_movie.name LIKE ? ORDER BY comment_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//通过当前评论
router.post('/api/admin/passCurrentComment', function (req, res) {
  let commentId = req.body.commentId
  let movieId = req.body.movieId
  if (commentId) {
    let sqlStr = 'UPDATE t_comment SET is_pass = 1 WHERE comment_id = ?;'
    conn.query(sqlStr, [commentId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        sqlStr =
          'SELECT user_score FROM t_comment WHERE movie_id = ? AND is_pass = ?;'
        conn.query(sqlStr, [movieId, 1], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            let avgScore = 0
            if (result.length) {
              result.forEach((val) => {
                avgScore += Number(val.user_score)
              })
              avgScore = (avgScore / Number(result.length)).toFixed(1)
            }
            sqlStr = 'UPDATE t_movie SET score = ? WHERE movie_id = ?;'
            conn.query(sqlStr, [avgScore, movieId], (error, result, field) => {
              if (error) {
                console.log(error)
              } else {
                res.json({ success_code: 200 })
              }
            })
          }
        })
      }
    })
  }
})
//删除当前评论
router.post('/api/admin/deleteCurrentComment', function (req, res) {
  let commentId = req.body.commentId
  let movieId = req.body.movieId
  if (commentId) {
    let sqlStr = 'DELETE FROM t_comment WHERE comment_id = ?;'
    conn.query(sqlStr, [commentId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        sqlStr =
          'SELECT user_score FROM t_comment WHERE movie_id = ? AND is_pass = ?;'
        conn.query(sqlStr, [movieId, 1], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            result = JSON.parse(JSON.stringify(result))
            let avgScore = 0
            if (result.length) {
              result.forEach((val) => {
                avgScore += Number(val.user_score)
              })
              avgScore = (avgScore / Number(result.length)).toFixed(1)
            }
            sqlStr = 'UPDATE t_movie SET score = ? WHERE movie_id = ?;'
            conn.query(sqlStr, [avgScore, movieId], (error, result, field) => {
              if (error) {
                console.log(error)
              } else {
                res.json({ success_code: 200 })
              }
            })
          }
        })
      }
    })
  }
})
//获取当前页订单
router.get('/api/admin/getCurrentPageOrder', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id INNER JOIN t_user ON t_order.user_id = t_user.user_id WHERE t_movie.name LIKE ? ORDER BY order_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id INNER JOIN t_user ON t_order.user_id = t_user.user_id WHERE t_movie.name LIKE ? ORDER BY order_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//删除订单
router.post('/api/admin/deleteOrder', function (req, res) {
  let { orderId, scheduleId, orderSeatInfo } = req.body
  if (orderId) {
    let sqlStr = 'SELECT seat_info FROM t_schedule WHERE schedule_id = ?'
    conn.query(sqlStr, [scheduleId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = result[0].seat_info
        result = JSON.parse(result)
        orderSeatInfo = JSON.parse(orderSeatInfo)
        console.log(typeof result)
        console.log(typeof orderSeatInfo)
        let tempArr = []
        result.forEach((value) => {
          if (orderSeatInfo.indexOf(value) === -1) {
            tempArr.push(value)
          }
        })
        console.log(tempArr)
        result = JSON.stringify(tempArr)
        sqlStr = 'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ?;'
        conn.query(sqlStr, [result, scheduleId], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            sqlStr = 'DELETE FROM t_order WHERE order_id =?'
            conn.query(sqlStr, [orderId], (error, result, field) => {
              if (error) {
                console.log(error)
              } else {
                res.json({ success_code: 200 })
              }
            })
          }
        })
      }
    })
  }
})
//获取当前页影厅
router.get('/api/admin/getCurrentPageHall', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_hall INNER JOIN t_cinema ON t_cinema.cinema_id = t_hall.cinema_id WHERE t_cinema.cinema_name LIKE ? ORDER BY hall_id;'
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_hall INNER JOIN t_cinema ON t_cinema.cinema_id = t_hall.cinema_id WHERE t_cinema.cinema_name LIKE ? ORDER BY hall_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//删除影厅
router.post('/api/admin/deleteHall', function (req, res) {
  let { cinemaId, hallName } = req.body
  if (cinemaId) {
    let sqlStr =
      'SELECT schedule_id FROM t_schedule WHERE cinema_id = ? AND hall_name = ?;'
    conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        console.log(result)
        if (result.length) {
          result.forEach((value) => {
            sqlStr = 'DELETE FROM t_schedule WHERE schedule_id = ?;'
            conn.query(sqlStr, [value.schedule_id], (error, result, field) => {
              if (error) {
                console.log(error)
              }
            })
          })
        }
        sqlStr = 'DELETE FROM t_hall WHERE cinema_id = ? AND name = ?'
        conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    })
  }
})
//更新影厅信息
router.post('/api/admin/updateHallInfo', function (req, res) {
  let { hallId, cinemaId, hallOldName, hallNewName } = req.body
  if (cinemaId) {
    let sqlStr =
      'SELECT * FROM t_hall WHERE name = ? AND cinema_id = ? AND hall_id <> ? LIMIT 1;'
    conn.query(
      sqlStr,
      [hallNewName, cinemaId, hallId],
      (error, result, field) => {
        if (error) {
          console.log(error)
        } else {
          result = JSON.parse(JSON.stringify(result))
          if (result[0]) {
            res.json({ error_code: 1, message: '该影院的影厅已存在！' })
          } else {
            sqlStr =
              'UPDATE t_schedule SET hall_name = ? WHERE cinema_id = ? AND hall_name = ?'
            conn.query(
              sqlStr,
              [hallNewName, cinemaId, hallOldName],
              (error, result, field) => {
                if (error) {
                  console.log(error)
                } else {
                  //更新数据库
                  let sqlStr =
                    'UPDATE t_hall SET name = ? WHERE cinema_id = ? AND name = ?;'
                  conn.query(
                    sqlStr,
                    [hallNewName, cinemaId, hallOldName],
                    (error, result, field) => {
                      if (error) {
                        res.json({
                          error_code: 1,
                          message: '更新影影厅信息失败',
                        })
                        console.log(error)
                      } else {
                        res.json({ success_code: 200 })
                      }
                    },
                  )
                }
              },
            )
          }
        }
      },
    )
  }
})
//获取所有影院
router.get('/api/admin/getAllCinema', function (req, res) {
  let sqlStr = 'SELECT cinema_id,cinema_name FROM t_cinema;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//添加影厅信息
router.post('/api/admin/addHallInfo', function (req, res) {
  let { cinemaId, hallName } = req.body
  let sqlStr = 'SELECT * FROM t_hall WHERE name = ? AND cinema_id = ? LIMIT 1;'
  conn.query(sqlStr, [hallName, cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      if (result[0]) {
        res.json({ error_code: 1, message: '该影院的影厅已存在！' })
      } else {
        let sqlStr = 'INSERT INTO t_hall(cinema_id,name) VALUES(?,?);'
        conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {
          if (error) {
            console.log(error)
          } else {
            res.json({ success_code: 200 })
          }
        })
      }
    }
  })
})
//获取当前页电影
router.get('/api/admin/getCurrentPageMovieSchedule', function (req, res) {
  let { currentPage, pageSize, input } = req.query
  let start = Number((currentPage - 1) * pageSize)
  pageSize = Number(pageSize)
  let sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE t_movie.name LIKE ? ORDER BY schedule_id '
  let total
  conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      total = result.length
    }
  })
  sqlStr =
    'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE t_movie.name LIKE ? ORDER BY schedule_id LIMIT ?,?;'
  conn.query(
    sqlStr,
    ['%' + input + '%', start, pageSize],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        result = JSON.parse(JSON.stringify(result))
        res.json({ success_code: 200, data: result, total: total })
      }
    },
  )
})
//获取所有电影
router.get('/api/admin/getAllMovie', function (req, res) {
  let sqlStr = 'SELECT * FROM t_movie;'
  conn.query(sqlStr, (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//获取影院的影厅
router.get('/api/admin/getHallByCinemaId', function (req, res) {
  let cinemaId = req.query.cinemaId
  console.log(cinemaId)
  let sqlStr = 'SELECT hall_id,name FROM t_hall WHERE cinema_id = ?;'
  conn.query(sqlStr, [cinemaId], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      console.log(result)
      res.json({ success_code: 200, data: result })
    }
  })
})
//获取排片的某天的时间段安排
router.get('/api/admin/getHasScheduleDateTime', function (req, res) {
  let { cinemaId, hallName, showDate } = req.query
  let sqlStr =
    'SELECT show_time FROM t_schedule WHERE cinema_id = ? AND hall_name = ? AND show_date = ?;'
  conn.query(sqlStr, [cinemaId, hallName, showDate], (error, result, field) => {
    if (error) {
      console.log(error)
    } else {
      result = JSON.parse(JSON.stringify(result))
      res.json({ success_code: 200, data: result })
    }
  })
})
//添加影院信息
router.post('/api/admin/addScheduleInfo', function (req, res) {
  let { movieId, cinemaId, hallName, showDate, showTime, price } = req.body
  let sqlStr =
    'INSERT INTO t_schedule(movie_id,cinema_id,hall_name,show_date,show_time,price) VALUES(?,?,?,?,?,?);'
  conn.query(
    sqlStr,
    [movieId, cinemaId, hallName, showDate, showTime, price],
    (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200 })
      }
    },
  )
})
//删除影厅
router.post('/api/admin/deleteMovieSchedule', function (req, res) {
  let { scheduleId } = req.body
  if (scheduleId) {
    let sqlStr = 'DELETE FROM t_schedule WHERE schedule_id = ?'
    conn.query(sqlStr, [scheduleId], (error, result, field) => {
      if (error) {
        console.log(error)
      } else {
        res.json({ success_code: 200 })
      }
    })
  }
})
module.exports = router

```

const express = require('express')

const router = express.Router()

const conn = require('../db/db')

const svgCaptcha = require('svg-captcha')

const util = require('../util/util')

const multer = require('multer')

// 用户API

let user = {}

/* GET home page. */

router.get('/', function (req, res, next) {

 res.render('index', { title: 'Express' })

})

//获取手机验证码

router.get('/api/getPhoneCode', function (req, res) {

 let phone = req.query.phone

 let phoneCode = util.randomCode(4)

 if (!phoneCode) {

  res.json({ error_code: 1, message: '获取验证码失败' })

 } else {

  user[phone] = phoneCode

  res.json({ success_code: 200, data: phoneCode })

 }

})

//获取图形验证码

router.get('/api/captcha', function (req, res) {

 let captcha = svgCaptcha.create({

  size: 4, // size of random string

  ignoreChars: '0o1i', // filter out some characters like 0o1i

  noise: 3, // number of noise lines

  color: true, //, characters will have distinct colors instead of grey, true if background option is set

  background: '#fff', // background color of the svg image

 })

 //保存图形验证码文本

 req.session.captcha = captcha.text.toLowerCase()

 //返回验证码数据

 res.type('svg')

 res.status(200).send(captcha.data)

})

//手机登录

router.post('/api/phoneLogin', function (req, res) {

 let phone = req.body.phone

 let phoneCode = req.body.phoneCode

 //判断手机验证码是否正确

 if (user[phone] === phoneCode) {

  let sqlStr = 'SELECT * from t_user WHERE phone = ? LIMIT 1 ;'

  conn.query(sqlStr, [phone], (error, result, field) => {

   if (error) {

​    res.json({ error_code: 1, message: '请求数据失败' })

   } else {

​    result = JSON.parse(JSON.stringify(result))

​    //用户存在

​    if (result[0]) {

​     req.session.userId = result[0].user_id

​     res.cookie('user_id', result[0].user_id)

​     res.json({ success_code: 200 })

​    } else {

​     //用户不存在

​     let sqlStr =

​      'INSERT INTO t_user(user_name,phone,avatar,password) VALUES(?,?,?,?)'

​     let avatarSrc = '/images/avatar/monkey.png'

​     conn.query(

​      sqlStr,

​      [phone, phone, avatarSrc, 123456],

​      (error, result, field) => {

​       if (error) {

​        console.log(error)

​        res.json({ error_code: 1, message: '创建用户失败' })

​       } else {

​        res.cookie('user_id', result.insertId)

​        res.json({ success_code: 200 })

​       }

​      },

​     )

​    }

   }

  })

 } else {

  res.json({ error_code: 1, message: '验证码不正确' })

 }

})

//密码登录

router.post('/api/pwdLogin', function (req, res) {

 let name = req.body.userName

 let pwd = req.body.password

 let captcha = req.body.captcha

 //判断验证码是否正确

 if (captcha.toLowerCase() !== req.session.captcha) {

  res.json({ error_code: 1, message: '验证码不正确' })

 } else {

  delete req.session.captcha

  let sqlStr = 'SELECT * from t_user WHERE user_name =? LIMIT 1 ;'

  conn.query(sqlStr, [name], (error, result, field) => {

   if (error) {

​    res.json({ error_code: 1, message: '查询用户失败' })

   } else {

​    result = JSON.parse(JSON.stringify(result))

​    if (result[0]) {

​     if (result[0].password === pwd) {

​      //保存用户id

​      req.session.userId = result[0].user_id

​      res.cookie('user_id', result[0].user_id)

​      res.json({ success_code: 200 })

​     } else {

​      res.json({ error_code: 1, message: '密码错误' })

​     }

​    } else {

​     res.json({ error: 1, message: '用户不存在' })

​    }

   }

  })

 }

})

//获取用户信息

router.get('/api/getUserInfo', function (req, res) {

 let userId = req.query.userId

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

​    res.json({ error_code: 1, message: '获取用户信息失败' })

   } else {

​    result = JSON.parse(JSON.stringify(result))

​    if (result[0]) {

​     res.json({ success_code: 200, data: result[0] })

​    } else {

​     res.json({ error_code: 1, message: '用户信息不存在' })

​    }

   }

  })

 }

})

//更新用户头像

router.post('/api/updateUserAvatar', function (req, res) {

 let { userId, avatar } = req.body

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

​    res.json({ error_code: 1, message: '用户不存在' })

   } else {

​    //更新数据库

​    let sqlStr = 'UPDATE t_user SET avatar = ? WHERE user_id = ?;'

​    conn.query(sqlStr, [avatar, userId], (error, result, field) => {

​     if (error) {

​      res.json({ error_code: 1, message: '更新用户头像失败' })

​     } else {

​      res.json({ success_code: 200 })

​     }

​    })

   }

  })

 }

})

//更新用户名

router.post('/api/updateUserName', function (req, res) {

 let { userId, userName } = req.body

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

​    res.json({ error_code: 1, message: '用户不存在' })

   } else {

​    sqlStr =

​     'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1 ;'

​    conn.query(sqlStr, [userName, userId], (error, result, field) => {

​     if (error) {

​      console.log(error)

​     } else {

​      result = JSON.parse(JSON.stringify(result))

​      if (result[0]) {

​       res.json({ error_code: 1, message: '用户名已存在！' })

​      } else {

​       //更新数据库

​       let sqlStr = 'UPDATE t_user SET user_name = ? WHERE user_id = ?;'

​       conn.query(sqlStr, [userName, userId], (error, result, field) => {

​        if (error) {

​         res.json({ error_code: 1, message: '更新用户名失败' })

​        } else {

​         res.json({ success_code: 200 })

​        }

​       })

​      }

​     }

​    })

   }

  })

 }

})

//更新用户性别

router.post('/api/updateUserSex', function (req, res) {

 let { userId, sex } = req.body

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

​    res.json({ error_code: 1, message: '用户不存在' })

   } else {

​    //更新数据库

​    let sqlStr = 'UPDATE t_user SET sex = ? WHERE user_id = ?;'

​    conn.query(sqlStr, [sex, userId], (error, result, field) => {

​     if (error) {

​      res.json({ error_code: 1, message: '更新用户性别失败' })

​     } else {

​      res.json({ success_code: 200 })

​     }

​    })

   }

  })

 }

})

//更新用户生日

router.post('/api/updateUserBirthday', function (req, res) {

 let { userId, birthday } = req.body

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

​    res.json({ error_code: 1, message: '用户不存在' })

   } else {

​    //更新数据库

​    let sqlStr = 'UPDATE t_user SET birthday = ? WHERE user_id = ?;'

​    conn.query(sqlStr, [birthday, userId], (error, result, field) => {

​     if (error) {

​      res.json({ error_code: 1, message: '更新用户生日失败' })

​     } else {

​      res.json({ success_code: 200 })

​     }

​    })

   }

  })

 }

})

//更新用户签名

router.post('/api/updateUserSign', function (req, res) {

 let { userId, sign } = req.body

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

​    res.json({ error_code: 1, message: '用户不存在' })

   } else {

​    //更新数据库

​    let sqlStr = 'UPDATE t_user SET sign = ? WHERE user_id = ?;'

​    conn.query(sqlStr, [sign, userId], (error, result, field) => {

​     if (error) {

​      res.json({ error_code: 1, message: '更新用户签名失败' })

​     } else {

​      res.json({ success_code: 200 })

​     }

​    })

   }

  })

 }

})

//更新用户信息

router.post('/api/updateUserInfo', function (req, res) {

 let { userId, userName, avatar, password, sex, sign, birthday } = req.body

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

​    res.json({ error_code: 1, message: '用户不存在' })

   } else {

​    sqlStr =

​     'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1 ;'

​    conn.query(sqlStr, [userName, userId], (error, result, field) => {

​     if (error) {

​      console.log(error)

​     } else {

​      result = JSON.parse(JSON.stringify(result))

​      if (result[0]) {

​       res.json({ error_code: 1, message: '用户名已存在！' })

​      } else {

​       //更新数据库

​       let sqlStr =

​        'UPDATE t_user SET user_name = ?,avatar = ?,password = ?,sex = ? ,birthday = ?,sign = ?WHERE user_id = ?;'

​       conn.query(

​        sqlStr,

​        [userName, avatar, password, sex, birthday, sign, userId],

​        (error, result, field) => {

​         if (error) {

​          res.json({ error_code: 1, message: '更新用户信息失败' })

​         } else {

​          res.json({ success_code: 200 })

​         }

​        },

​       )

​      }

​     }

​    })

   }

  })

 }

})

//加载电影列表

router.get('/api/getMovieList', function (req, res) {

 let sqlStr =

  'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id;'

 conn.query(sqlStr, (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: '获取电影列表失败' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result.length) {

​    result = result.filter((value) => {

​     return (

​      new Date(value.show_date + ',' + value.show_time) - new Date() > 0

​     )

​    })

​    for (let i = 0; i < result.length; i++) {

​     for (let j = i + 1; j < result.length; j++) {

​      if (result[i]['movie_id'] === result[j]['movie_id']) {

​       result.splice(j, 1)

​       j = j - 1

​      }

​     }

​    }

​    res.json({ success_code: 200, data: result })

   } else {

​    res.json({ error_code: 1, message: '电影列表为空' })

   }

  }

 })

})

//加载电影详细信息

router.get('/api/getMovieDetail', function (req, res) {

 let movieId = req.query.movieId

 let sqlStr = 'SELECT * FROM t_movie WHERE movie_id = ? LIMIT 1;'

 conn.query(sqlStr, [movieId], (error, result, field) => {

  if (error) {

   res.json({ error_code: 1, message: '获取电影信息失败' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

​    res.json({ success_code: 200, data: result })

   } else {

​    res.json({ error_code: 1, message: '该电影不存在' })

   }

  }

 })

})

//是否想看电影

router.post('/api/isWishMovie', function (req, res) {

 let { userId, movieId } = req.body

 let sqlStr =

  'SELECT * FROM t_wishmovie WHERE user_id = ? AND movie_id = ? LIMIT 1;'

 conn.query(sqlStr, [userId, movieId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: '操作失败' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

​    res.json({ success_code: 200 })

   } else {

​    res.json({ error_code: 1, message: '不想看' })

   }

  }

 })

})

//想看电影

router.post('/api/wishMovie', function (req, res) {

 let { userId, movieId } = req.body

 let sqlStr = 'INSERT INTO t_wishmovie(user_id,movie_id) VALUES(?,?)'

 conn.query(sqlStr, [userId, movieId], (error, result, field) => {

  if (error) {

   res.json({ error_code: 1, message: '操作失败' })

  } else {

   let sqlStr = 'SELECT wish_num from t_movie WHERE movie_id = ? LIMIT 1;'

   conn.query(sqlStr, [movieId], (error, result, field) => {

​    if (error) {

​     res.json({ error_code: 1, message: '操作失败' })

​    } else {

​     result = JSON.parse(JSON.stringify(result))

​     if (result[0]) {

​      //更新数据库

​      let sqlStr = 'UPDATE t_movie SET wish_num = ? WHERE movie_id = ?;'

​      conn.query(

​       sqlStr,

​       [result[0].wish_num + 1, movieId],

​       (error, result, field) => {

​        if (error) {

​         res.json({ error_code: 1, message: '更新信息失败' })

​        } else {

​         res.json({ success_code: 200 })

​        }

​       },

​      )

​     }

​    }

   })

  }

 })

})

//取消想看电影

router.post('/api/cancelWishMovie', function (req, res) {

 let { userId, movieId } = req.body

 let sqlStr = 'DELETE FROM t_wishmovie WHERE user_id = ? AND movie_id =? ;'

 conn.query(sqlStr, [userId, movieId], (error, result, field) => {

  if (error) {

   res.json({ error_code: 1, message: '操作失败' })

  } else {

   let sqlStr = 'SELECT wish_num from t_movie WHERE movie_id = ? LIMIT 1;'

   conn.query(sqlStr, [movieId], (error, result, field) => {

​    if (error) {

​     res.json({ error_code: 1, message: '操作失败' })

​    } else {

​     result = JSON.parse(JSON.stringify(result))

​     if (result[0]) {

​      //更新数据库

​      let sqlStr = 'UPDATE t_movie SET wish_num = ? WHERE movie_id = ?;'

​      conn.query(

​       sqlStr,

​       [result[0].wish_num - 1, movieId],

​       (error, result, field) => {

​        if (error) {

​         res.json({ error_code: 1, message: '更新信息失败' })

​        } else {

​         res.json({ success_code: 200 })

​        }

​       },

​      )

​     }

​    }

   })

  }

 })

})

//获取当前用户评论

router.get('/api/getUserComment', function (req, res) {

 let { userId, movieId } = req.query

 let sqlStr =

  'SELECT * FROM t_comment WHERE user_id = ? AND movie_id= ? LIMIT 1;'

 conn.query(sqlStr, [userId, movieId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: '操作失败' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

​    res.json({ success_code: 200, data: result[0] })

   } else {

​    res.json({ error_code: 1, message: '用户未评论' })

   }

  }

 })

})

//获取所有用户通过审核的评论

router.get('/api/getAllUserPassComment', function (req, res) {

 let { movieId } = req.query

 let sqlStr =

  'SELECT * FROM t_user user INNER JOIN t_comment comment ON user.user_id = comment.user_id WHERE comment.movie_id = ? AND comment.is_pass = ? ;'

 conn.query(sqlStr, [movieId, 1], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: '操作失败' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result) {

​    res.json({ success_code: 200, data: result })

   } else {

​    res.json({ error_code: 1, message: '未评论' })

   }

  }

 })

})

//更新用户评论

router.post('/api/updateUserComment', function (req, res) {

 let { userId, movieId, score, commentContent, commentDate } = req.body

 let sqlStr =

  'SELECT comment_id from t_comment WHERE user_id = ? AND movie_id = ? LIMIT 1'

 conn.query(sqlStr, [userId, movieId], (error, result, field) => {

  if (error) {

   res.json({ error_code: 1, message: '操作失败' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

​    //评论存在

​    //更新

​    let sqlStr =

​     'UPDATE t_comment SET user_score = ?, comment_content = ?, comment_date = ?,support_num = ?,is_pass = ?,support_user = ? WHERE comment_id = ? ;'

​    conn.query(

​     sqlStr,

​     [

​      score,

​      commentContent,

​      commentDate,

​      0,

​      0,

​      undefined,

​      result[0].comment_id,

​     ],

​     (error, result, field) => {

​      if (error) {

​       res.json({ error_code: 1, message: '更新评论失败' })

​      } else {

​       res.json({ success_code: 200 })

​      }

​     },

​    )

   } else {

​    //评论不存在

​    let sqlStr =

​     'INSERT INTO t_comment(user_id,movie_id,user_score,comment_content,comment_date,support_num,is_pass) VALUES(?,?,?,?,?,?,?)'

​    conn.query(

​     sqlStr,

​     [userId, movieId, score, commentContent, commentDate, 0, 0],

​     (error, result, field) => {

​      if (error) {

​       console.log(error)

​       res.json({ error_code: 1, message: '操作失败' })

​      } else {

​       res.json({ success_code: 200 })

​      }

​     },

​    )

   }

  }

 })

})

//获取当前评论

router.get('/api/getCommentByID', function (req, res) {

 let { commentId } = req.query

 let sqlStr = 'SELECT * FROM t_comment WHERE comment_id = ? LIMIT 1;'

 conn.query(sqlStr, [commentId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: '操作失败' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

​    res.json({ success_code: 200, data: result[0] })

   } else {

​    res.json({ error_code: 1, message: '用户未评论' })

   }

  }

 })

})

//更新当前评论的用户点赞

router.post('/api/updateUserSupport', function (req, res) {

 let { commentId, supportNum, supportUser } = req.body

 let sqlStr =

  'UPDATE t_comment SET support_num = ? , support_user = ? WHERE comment_id = ?;'

 conn.query(

  sqlStr,

  [supportNum, supportUser, commentId],

  (error, result, field) => {

   if (error) {

​    console.log(error)

​    res.json({ error_code: 1, message: '操作失败' })

   } else {

​    res.json({ success_code: 200 })

   }

  },

 )

})

//加载影院列表

router.get('/api/getCinemaList', function (req, res) {

 let sqlStr =

  'SELECT * FROM t_schedule INNER JOIN t_cinema ON t_schedule.cinema_id = t_cinema.cinema_id INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id;'

 conn.query(sqlStr, (error, result, field) => {

  if (error) {

   res.json({ error_code: 1, message: '获取影院列表失败' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result.length) {

​    result = result.filter((value) => {

​     return (

​      new Date(value.show_date + ',' + value.show_time) - new Date() > 0

​     )

​    })

​    for (let i = 0; i < result.length; i++) {

​     for (let j = i + 1; j < result.length; j++) {

​      if (result[i]['cinema_id'] === result[j]['cinema_id']) {

​       result.splice(j, 1)

​       j = j - 1

​      }

​     }

​    }

   }

   res.json({ success_code: 200, data: result })

  }

 })

})

//加载当前影院详细信息

router.get('/api/getCurrentCinemaDetail', function (req, res) {

 let cinemaId = req.query.cinemaId

 let sqlStr = 'SELECT * FROM t_cinema WHERE cinema_id = ? LIMIT 1;'

 conn.query(sqlStr, [cinemaId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: '获取当前影院信息失败' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

​    res.json({ success_code: 200, data: result[0] })

   } else {

​    res.json({ error_code: 1, message: '影院不存在' })

   }

  }

 })

})

//加载当前影院排片

router.get('/api/getCurrentCinemaMovieSchedule', function (req, res) {

 let cinemaId = req.query.cinemaId

 console.log(cinemaId)

 let sqlStr = 'SELECT * FROM t_schedule WHERE cinema_id = ?;'

 conn.query(sqlStr, [cinemaId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: '获取当前影院排片信息失败' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result) {

​    let tempMovieArr = []

​    result.forEach((value) => {

​     if (

​      new Date() - new Date(value.show_date + ',' + value.show_time) <=

​      0

​     ) {

​      tempMovieArr.push(value.movie_id)

​     }

​    })

​    tempMovieArr = Array.from(new Set(tempMovieArr))

​    let movieArray = []

​    let movieScheduleArray = []

​    tempMovieArr.forEach((value) => {

​     sqlStr = 'SELECT * FROM t_movie WHERE movie_id = ? LIMIT 1;'

​     conn.query(sqlStr, [value], (error, result, field) => {

​      if (error) {

​       console.log(error)

​      } else {

​       result = JSON.parse(JSON.stringify(result))

​       if (result[0]) {

​        movieArray.push(result[0])

​       }

​      }

​     })

​     sqlStr =

​      'SELECT * FROM t_schedule schedule INNER JOIN t_movie movie ON schedule.movie_id = movie.movie_id WHERE schedule.movie_id = ? AND schedule.cinema_id = ?;'

​     conn.query(sqlStr, [value, cinemaId], (error, result, field) => {

​      if (error) {

​       console.log(error)

​      } else {

​       result = JSON.parse(JSON.stringify(result))

​       if (result) {

​        movieScheduleArray.push(result)

​       }

​      }

​     })

​    })

​    setTimeout(() => {

​     res.json({

​      success_code: 200,

​      data: {

​       hasMovieInfo: movieArray,

​       movieScheduleInfo: movieScheduleArray,

​      },

​     })

​    }, 500)

   } else {

​    res.json({ error_code: 1, message: '当前影院排片信息为空' })

   }

  }

 })

})

//加载当前影院详细信息

router.get('/api/getScheduleById', function (req, res) {

 let scheduleId = req.query.scheduleId

 let sqlStr = 'SELECT * FROM t_schedule WHERE schedule_id = ? LIMIT 1;'

 conn.query(sqlStr, [scheduleId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: '获取当前排片信息失败' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

​    res.json({ success_code: 200, data: result[0] })

   } else {

​    res.json({ error_code: 1, message: '排片信息不存在' })

   }

  }

 })

})

//加载当前影院详细信息

router.post('/api/updateScheduleSeat', function (req, res) {

 let { scheduleId, seatInfo } = req.body

 let sqlStr =

  'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ? LIMIT 1;'

 conn.query(sqlStr, [seatInfo, scheduleId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: '更新排片座位信息失败' })

  } else {

   res.json({ success_code: 200, data: result[0] })

  }

 })

})

//加载当前电影排片

router.get('/api/getCurrentMovieSchedule', function (req, res) {

 let movieId = req.query.movieId

 let sqlStr = 'SELECT * FROM t_schedule WHERE movie_id = ?;'

 conn.query(sqlStr, [movieId], (error, result, field) => {

  if (error) {

   console.log(error)

   res.json({ error_code: 1, message: '获取当前影院排片信息失败' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result) {

​    let tempDateArr = []

​    result.forEach((value) => {

​     if (

​      new Date() - new Date(value.show_date + ',' + value.show_time) <=

​      0

​     ) {

​      tempDateArr.push(value.show_date)

​     }

​    })

​    tempDateArr = Array.from(new Set(tempDateArr))

​    tempDateArr.sort((a, b) => {

​     return new Date(a) - new Date(b)

​    })

​    let cinemaArray = []

​    let cinemaScheduleArray = []

​    tempDateArr.forEach((value) => {

​     sqlStr = 'SELECT * FROM t_schedule WHERE show_date = ?'

​     conn.query(sqlStr, [value], (error, result, field) => {

​      if (error) {

​       console.log(error)

​      } else {

​       result = JSON.parse(JSON.stringify(result))

​       if (result) {

​        cinemaArray.push(result)

​       }

​      }

​     })

​     sqlStr =

​      'SELECT * FROM t_schedule schedule INNER JOIN t_cinema cinema ON schedule.cinema_id = cinema.cinema_id WHERE schedule.movie_id = ? AND schedule.show_date = ?;'

​     conn.query(sqlStr, [movieId, value], (error, result, field) => {

​      if (error) {

​       console.log(error)

​      } else {

​       result = JSON.parse(JSON.stringify(result))

​       if (result) {

​        cinemaScheduleArray.push(result)

​       }

​      }

​     })

​    })

​    setTimeout(() => {

​     res.json({

​      success_code: 200,

​      data: {

​       hasCinemaInfo: cinemaArray,

​       cinemaScheduleInfo: cinemaScheduleArray,

​      },

​     })

​    }, 500)

   } else {

​    res.json({ error_code: 1, message: '当前电影排片信息为空' })

   }

  }

 })

})

//根据名字匹配电影---精准搜索

router.get('/api/matchMovieByName', function (req, res) {

 console.log('开始精准搜索！！！！')

 let movieName = req.query.movieName

 let sqlStr =

  'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id WHERE name LIKE ?;'

 conn.query(sqlStr, ['%' + movieName + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result.length) {

​    result = result.filter((value) => {

​     return (

​      new Date(value.show_date + ',' + value.show_time) - new Date() > 0

​     )

​    })

​    for (let i = 0; i < result.length; i++) {

​     for (let j = i + 1; j < result.length; j++) {

​      if (result[i]['movie_id'] === result[j]['movie_id']) {

​       result.splice(j, 1)

​       j = j - 1

​      }

​     }

​    }

   }

   res.json({ success_code: 200, data: result })

  }

 })

})

const _ = require('lodash')

// const { createRequire } = require('module')

// const requireES6 = createRequire(import.meta.url)

// 导入 jieba 相关模块

const { Jieba } = require('@node-rs/jieba')

const { dict } = require('@node-rs/jieba/dict')

// 初始化 jieba 实例

const jieba = Jieba.withDict(dict)

// BM25 类

class BM25 {

 constructor(docs, k1 = 1.2, b = 0.75) {

  this.docs = docs

  this.k1 = k1

  this.b = b

  this.avgDocLen = this.calculateAvgDocLen()

  this.idf = this.calculateIDF()

 }

 calculateAvgDocLen() {

  let totalLen = 0

  for (const doc of this.docs) {

   totalLen += doc.length

  }

  return totalLen / this.docs.length

 }

 calculateIDF() {

  const docCount = this.docs.length

  const idf = {}

  const termDocCount = {}

  for (const doc of this.docs) {

   const uniqueTerms = _.uniq(doc)

   for (const term of uniqueTerms) {

​    termDocCount[term] = (termDocCount[term] || 0) + 1

   }

  }

  for (const term in termDocCount) {

   const freq = termDocCount[term]

   idf[term] = Math.log((docCount - freq + 0.5) / (freq + 0.5) + 1)

  }

  return idf

 }

 score(query, doc) {

  const docLen = doc.length

  const termFreq = _.countBy(doc)

  let score = 0

  for (const term of query) {

   if (this.idf[term]) {

​    const freq = termFreq[term] || 0

​    const numerator = this.idf[term] * freq * (this.k1 + 1)

​    const denominator =

​     freq + this.k1 * (1 - this.b + this.b * (docLen / this.avgDocLen))

​    score += numerator / denominator

   }

  }

  return score

 }

}

router.get('/api/semanticSearchMovie', function (req, res) {

 console.log('开始进行语义搜索！！！！！！！！')

 let searchQuery = req.query.searchQuery

 console.log('用户搜索词:', searchQuery)

 if (!searchQuery) {

  return res.json({ error_code: 1, message: '搜索词不能为空' })

 }

 let sqlStr = 'SELECT movie_id, name, intro FROM t_movie;'

 conn.query(sqlStr, (error, result) => {

  if (error) {

   console.error('数据库查询错误:', error)

   return res.json({ error_code: 1, message: '数据库查询失败' })

  }

  result = JSON.parse(JSON.stringify(result)) // 规范化数据格式

  console.log('数据库查询返回:', result.length, '条记录')

  if (result.length === 0) {

   return res.json({ success_code: 200, data: [] })

  }

  // **✅ 进行分词处理**

  const searchTokens = jieba.cut(searchQuery)

  const docs = result.map((movie) => jieba.cut(movie.intro))

  // **✅ 计算 BM25 相关性**

  const bm25 = new BM25(docs)

  const results = result.map((movie, i) => ({

   movie_id: movie.movie_id,

   name: movie.name,

   intro: movie.intro,

   score: bm25.score(searchTokens, docs[i]),

  }))

  // **✅ 排序 & 去重**

  const topResults = _.uniqBy(

   results.sort((a, b) => b.score - a.score).slice(0, 10),

   'movie_id',

  )

  const movieIds = topResults.map((m) => m.movie_id)

  console.log('Top 10 电影 ID:', movieIds)

  if (movieIds.length === 0) {

   return res.json({ success_code: 200, data: [] })

  }

  // **✅ 查询完整电影信息**

  let finalSqlStr = `

   SELECT t_schedule.*, t_movie.*

   FROM t_schedule

   INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id

   WHERE t_schedule.movie_id IN (${movieIds.map(() => '?').join(',')})

  `

  conn.query(finalSqlStr, movieIds, (err, finalResults) => {

   if (err) {

​    console.error('获取完整电影信息错误:', err)

​    return res.json({ error_code: 1, message: '获取电影详情失败' })

   }

   console.log('完整电影数据:', finalResults.length, '条记录')

   res.json({ success_code: 200, data: finalResults })

  })

 })

})

//根据名字匹配影院

router.get('/api/matchCinemaByName', function (req, res) {

 let cinemaName = req.query.cinemaName

 let sqlStr =

  'SELECT * FROM t_schedule INNER JOIN t_cinema ON t_schedule.cinema_id = t_cinema.cinema_id INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id WHERE cinema_name LIKE ?;'

 conn.query(sqlStr, ['%' + cinemaName + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result.length) {

​    result = result.filter((value) => {

​     return (

​      new Date(value.show_date + ',' + value.show_time) - new Date() > 0

​     )

​    })

​    for (let i = 0; i < result.length; i++) {

​     for (let j = i + 1; j < result.length; j++) {

​      if (result[i]['cinema_id'] === result[j]['cinema_id']) {

​       result.splice(j, 1)

​       j = j - 1

​      }

​     }

​    }

   }

   res.json({ success_code: 200, data: result })

  }

 })

})

//用户下单

router.post('/api/order', function (req, res) {

 let {

  userId,

  scheduleId,

  orderPhone,

  orderDate,

  ticketNum,

  totalPrice,

  orderSeatInfo,

  payType,

 } = req.body

 let phoneCode = util.randomCode(6)

 let sqlStr =

  'INSERT INTO t_order(user_id,schedule_id,order_phone,order_date,ticket_num,ticket_total_price,order_seat_info,pay_type,phone_code) VALUES(?,?,?,?,?,?,?,?,?); '

 conn.query(

  sqlStr,

  [

   userId,

   scheduleId,

   orderPhone,

   orderDate,

   ticketNum,

   totalPrice,

   orderSeatInfo,

   payType,

   phoneCode,

  ],

  (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    res.json({ success_code: 200, data: { phone_code: phoneCode } })

   }

  },

 )

})

//获取个人订单信息

router.get('/api/getOrderByUserId', function (req, res) {

 let userId = req.query.userId

 let sqlStr =

  'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE user_id = ?;'

 conn.query(sqlStr, [userId], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   res.json({ success_code: 200, data: result })

  }

 })

})

//获取个人想看电影

router.get('/api/getWishMovieByUserId', function (req, res) {

 let userId = req.query.userId

 let sqlStr =

  'SELECT * FROM t_wishmovie INNER JOIN t_movie ON t_wishmovie.movie_id = t_movie.movie_id WHERE user_id = ?;'

 conn.query(sqlStr, [userId], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   res.json({ success_code: 200, data: result })

  }

 })

})

//获取个人看过的电影

router.get('/api/getIsWatchedMovieByUserId', function (req, res) {

 let userId = req.query.userId

 let sqlStr =

  'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id WHERE user_id = ? AND is_pass = 1;'

 conn.query(sqlStr, [userId], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   res.json({ success_code: 200, data: result })

  }

 })

})

//管理员API

//获取当前页用户

//密码登录

router.post('/api/admin/login', function (req, res) {

 let name = req.body.name

 let password = req.body.password

 let sqlStr = 'SELECT * FROM t_admin WHERE name = ? LIMIT 1 ;'

 conn.query(sqlStr, [name, password], (error, result, field) => {

  if (error) {

   res.json({ error_code: 1, message: '查询用户失败' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

​    if (result[0].password === password) {

​     //保存用户id

​     req.session.adminId = result[0].admin_id

​     res.cookie('admin_id', result[0].admin_id)

​     res.json({ success_code: 200 })

​    } else {

​     res.json({ error_code: 1, message: '密码错误' })

​    }

   } else {

​    res.json({ error: 1, message: '用户不存在' })

   }

  }

 })

})

//获取用户信息

router.get('/api/admin/getAdminInfo', function (req, res) {

 let adminId = req.query.adminId

 let sqlStr = 'SELECT * FROM t_admin WHERE admin_id = ? LIMIT 1 ;'

 conn.query(sqlStr, [adminId], (error, result, field) => {

  if (error) {

   res.json({ error_code: 1, message: '查询用户失败' })

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

​    res.json({ success_code: 200, data: result[0] })

   } else {

​    res.json({ error: 1, message: '用户不存在' })

   }

  }

 })

})

router.get('/api/admin/getCurrentPageUser', function (req, res) {

 let { currentPage, pageSize, input } = req.query

 let start = Number((currentPage - 1) * pageSize)

 pageSize = Number(pageSize)

 let sqlStr = 'SELECT * FROM t_user WHERE user_name LIKE ? ORDER BY user_id;'

 let total

 conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   total = result.length

  }

 })

 sqlStr =

  'SELECT * FROM t_user WHERE user_name LIKE ? ORDER BY user_id LIMIT ?,?;'

 conn.query(

  sqlStr,

  ['%' + input + '%', start, pageSize],

  (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    result = JSON.parse(JSON.stringify(result))

​    res.json({ success_code: 200, data: result, total: total })

   }

  },

 )

})

var datatime = './public/images/avatar/'

//将图片放到服务器

var storage = multer.diskStorage({

 // 如果你提供的 destination 是一个函数，你需要负责创建文件夹

 destination: datatime,

 // //给上传文件重命名，获取添加后缀名

 filename: function (req, file, cb) {

  cb(null, new Date().getTime() + '.jpg')

 },

})

var upload = multer({

 storage: storage,

})

// let upload = multer({dest:'./public/images/avatar'}).any();

router.post('/api/admin/upLoadImg', upload.any(), function (req, res) {

 res.json({ success_code: 200, data: req.files })

 console.log(req.files)

})

//更新用户信息

router.post('/api/admin/updateUserInfo', function (req, res) {

 let { userId, userName, avatar, password, sex, phone, sign, birthday } =

  req.body

 if (userId) {

  let sqlStr = 'SELECT * from t_user WHERE user_id = ? LIMIT 1;'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

​    res.json({ error_code: 1, message: '用户不存在' })

   } else {

​    let sqlStr =

​     'SELECT * FROM t_user WHERE user_name = ? AND user_id <> ? LIMIT 1;'

​    conn.query(sqlStr, [userName, userId], (error, result, field) => {

​     if (error) {

​      console.log(error)

​     } else {

​      result = JSON.parse(JSON.stringify(result))

​      if (result[0]) {

​       res.json({ error_code: 1, message: '用户名已存在！' })

​      } else {

​       sqlStr =

​        'SELECT * FROM t_user WHERE phone = ? AND user_id <> ? LIMIT 1;'

​       conn.query(sqlStr, [phone, userId], (error, result, field) => {

​        if (error) {

​         console.log(error)

​        } else {

​         result = JSON.parse(JSON.stringify(result))

​         if (result[0]) {

​          res.json({ error_code: 1, message: '手机号码已注册！' })

​         } else {

​          //更新数据库

​          let sqlStr =

​           'UPDATE t_user SET user_name = ?,avatar = ?,password = ?,sex = ? ,phone = ?,birthday = ?,sign = ? WHERE user_id = ?;'

​          conn.query(

​           sqlStr,

​           [

​            userName,

​            avatar,

​            password,

​            sex,

​            phone,

​            birthday,

​            sign,

​            userId,

​           ],

​           (error, result, field) => {

​            if (error) {

​             res.json({

​              error_code: 1,

​              message: '更新用户信息失败',

​             })

​             console.log(error)

​            } else {

​             res.json({ success_code: 200 })

​            }

​           },

​          )

​         }

​        }

​       })

​      }

​     }

​    })

   }

  })

 }

})

//删除用户信息

router.post('/api/admin/deleteUserInfo', function (req, res) {

 let { userId } = req.body

 if (userId) {

  let sqlStr =

   'SELECT t_schedule.schedule_id, t_schedule.seat_info,order_seat_info FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id WHERE user_id = ?'

  conn.query(sqlStr, [userId], (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    result = JSON.parse(JSON.stringify(result))

​    console.log(result)

​    if (result) {

​     result.forEach((value) => {

​      let tempArr = []

​      value.seat_info = JSON.parse(value.seat_info)

​      value.order_seat_info = JSON.parse(value.order_seat_info)

​      value.seat_info.forEach((v) => {

​       if (value.order_seat_info.indexOf(v) === -1) {

​        tempArr.push(v)

​       }

​      })

​      tempArr = JSON.stringify(tempArr)

​      sqlStr =

​       'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ?;'

​      conn.query(

​       sqlStr,

​       [tempArr, value.schedule_id],

​       (error, result, field) => {

​        if (error) {

​         console.log(error)

​        }

​       },

​      )

​     })

​    }

​    sqlStr = 'DELETE FROM t_user WHERE user_id =?'

​    conn.query(sqlStr, [userId], (error, result, field) => {

​     if (error) {

​      console.log(error)

​     } else {

​      res.json({ success_code: 200 })

​     }

​    })

   }

  })

 }

})

//添加用户信息

router.post('/api/admin/addUserInfo', function (req, res) {

 let { userName, avatar, phone, password, sex, sign, birthday } = req.body

 if (!avatar) {

  avatar = '/images/avatar/monkey.png'

 }

 let sqlStr = 'SELECT * FROM t_user WHERE user_name = ? LIMIT 1;'

 conn.query(sqlStr, [userName], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

​    res.json({ error_code: 1, message: '用户名已存在！' })

   } else {

​    sqlStr = 'SELECT * FROM t_user WHERE phone = ? LIMIT 1'

​    conn.query(sqlStr, [phone], (error, result, field) => {

​     if (error) {

​      console.log(error)

​     } else {

​      result = JSON.parse(JSON.stringify(result))

​      if (result[0]) {

​       res.json({ error_code: 1, message: '手机号码已注册！' })

​      } else {

​       sqlStr =

​        'INSERT INTO t_user(user_name,avatar,phone,password,sex,sign,birthday) VALUES(?,?,?,?,?,?,?);'

​       conn.query(

​        sqlStr,

​        [userName, avatar, phone, password, sex, sign, birthday],

​        (error, result, field) => {

​         if (error) {

​          console.log(error)

​         } else {

​          res.json({ success_code: 200 })

​         }

​        },

​       )

​      }

​     }

​    })

   }

  }

 })

})

//获取当前页电影

router.get('/api/admin/getCurrentPageMovie', function (req, res) {

 let { currentPage, pageSize, input } = req.query

 let start = Number((currentPage - 1) * pageSize)

 pageSize = Number(pageSize)

 let sqlStr = 'SELECT * FROM t_movie WHERE name LIKE ? ORDER BY movie_id'

 let total

 conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   total = result.length

  }

 })

 sqlStr =

  'SELECT * FROM t_movie WHERE name LIKE ? ORDER BY movie_id LIMIT ?,?;'

 conn.query(

  sqlStr,

  ['%' + input + '%', start, pageSize],

  (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    result = JSON.parse(JSON.stringify(result))

​    res.json({ success_code: 200, data: result, total: total })

   }

  },

 )

})

//更新电影信息

router.post('/api/admin/updateMovieInfo', function (req, res) {

 let {

  movieId,

  movieName,

  poster,

  director,

  actor,

  long,

  type,

  language,

  publicDate,

  intro,

 } = req.body

 let sqlStr = 'SELECT * FROM t_movie WHERE name = ? AND movie_id <> ? LIMIT 1;'

 conn.query(sqlStr, [movieName, movieId], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

​    res.json({ error_code: 1, message: '电影名已存在！' })

   } else {

​    //更新数据库

​    let sqlStr =

​     'UPDATE t_movie SET name = ?,poster = ?,director = ?,actor = ? ,movie_long = ?,type = ?,language = ?,public_date = ?,intro = ? WHERE movie_id = ?;'

​    conn.query(

​     sqlStr,

​     [

​      movieName,

​      poster,

​      director,

​      actor,

​      long,

​      type,

​      language,

​      publicDate,

​      intro,

​      movieId,

​     ],

​     (error, result, field) => {

​      if (error) {

​       console.log(error)

​      } else {

​       res.json({ success_code: 200 })

​      }

​     },

​    )

   }

  }

 })

})

//添加电影信息

router.post('/api/admin/addMovieInfo', function (req, res) {

 let {

  movieName,

  poster,

  director,

  actor,

  long,

  type,

  language,

  publicDate,

  intro,

 } = req.body

 let sqlStr = 'SELECT * FROM t_movie WHERE name = ? LIMIT 1;'

 conn.query(sqlStr, [movieName], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

​    res.json({ error_code: 1, message: '电影名已存在！' })

   } else {

​    let sqlStr =

​     'INSERT INTO t_movie(name,poster,director,actor,movie_long,type,language,public_date,intro) VALUES(?,?,?,?,?,?,?,?,?);'

​    conn.query(

​     sqlStr,

​     [

​      movieName,

​      poster,

​      director,

​      actor,

​      long,

​      type,

​      language,

​      publicDate,

​      intro,

​     ],

​     (error, result, field) => {

​      if (error) {

​       console.log(error)

​      } else {

​       res.json({ success_code: 200 })

​      }

​     },

​    )

   }

  }

 })

})

datatime = './public/images/movie/'

//将图片放到服务器

storage = multer.diskStorage({

 // 如果你提供的 destination 是一个函数，你需要负责创建文件夹

 destination: datatime,

 // //给上传文件重命名，获取添加后缀名

 filename: function (req, file, cb) {

  cb(null, new Date().getTime() + '.jpg')

 },

})

upload = multer({

 storage: storage,

})

router.post('/api/admin/upLoadMovieImg', upload.any(), function (req, res) {

 res.json({ success_code: 200, data: req.files })

 console.log(req.files)

})

//删除电影信息

router.post('/api/admin/deleteMovieInfo', function (req, res) {

 let { movieId } = req.body

 let sqlStr = 'DELETE FROM t_movie WHERE movie_id =?'

 conn.query(sqlStr, [movieId], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   res.json({ success_code: 200 })

  }

 })

})

//获取当前页影院

router.get('/api/admin/getCurrentPageCinema', function (req, res) {

 let { currentPage, pageSize, input } = req.query

 let start = Number((currentPage - 1) * pageSize)

 pageSize = Number(pageSize)

 let sqlStr =

  'SELECT * FROM t_cinema WHERE cinema_name LIKE ? ORDER BY cinema_id ;'

 let total

 conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   total = result.length

  }

 })

 sqlStr =

  'SELECT * FROM t_cinema WHERE cinema_name LIKE ? ORDER BY cinema_id LIMIT ?,?;'

 conn.query(

  sqlStr,

  ['%' + input + '%', start, pageSize],

  (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    result = JSON.parse(JSON.stringify(result))

​    res.json({ success_code: 200, data: result, total: total })

   }

  },

 )

})

//更新影院信息

router.post('/api/admin/updateCinemaInfo', function (req, res) {

 let { cinemaId, cinemaName, cinemaPhone, address } = req.body

 if (cinemaId) {

  let sqlStr = 'SELECT * from t_cinema WHERE cinema_id = ? LIMIT 1;'

  conn.query(sqlStr, [cinemaId], (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    sqlStr =

​     'SELECT * FROM t_cinema WHERE cinema_name = ? AND cinema_id <> ? LIMIT 1 ;'

​    conn.query(sqlStr, [cinemaName, cinemaId], (error, result, field) => {

​     if (error) {

​      console.log(error)

​     } else {

​      result = JSON.parse(JSON.stringify(result))

​      if (result[0]) {

​       res.json({ error_code: 1, message: '影院名已存在！' })

​      } else {

​       //更新数据库

​       let sqlStr =

​        'UPDATE t_cinema SET cinema_name = ?,cinema_phone = ?,specified_address = ? WHERE cinema_id = ?;'

​       conn.query(

​        sqlStr,

​        [cinemaName, cinemaPhone, address, cinemaId],

​        (error, result, field) => {

​         if (error) {

​          res.json({ error_code: 1, message: '更新影院信息失败' })

​          console.log(error)

​         } else {

​          res.json({ success_code: 200 })

​         }

​        },

​       )

​      }

​     }

​    })

   }

  })

 }

})

//删除影院信息

router.post('/api/admin/deleteCinemaInfo', function (req, res) {

 let { cinemaId } = req.body

 if (cinemaId) {

  let sqlStr = 'DELETE FROM t_cinema WHERE cinema_id =?'

  conn.query(sqlStr, [cinemaId], (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    res.json({ success_code: 200 })

   }

  })

 }

})

//添加影院信息

router.post('/api/admin/addCinemaInfo', function (req, res) {

 let { cinemaName, cinemaPhone, address } = req.body

 sqlStr = 'SELECT * FROM t_cinema WHERE cinema_name = ? LIMIT 1 ;'

 conn.query(sqlStr, [cinemaName], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

​    res.json({ error_code: 1, message: '影院名已存在！' })

   } else {

​    let sqlStr =

​     'INSERT INTO t_cinema(cinema_name,cinema_phone,specified_address) VALUES(?,?,?);'

​    conn.query(

​     sqlStr,

​     [cinemaName, cinemaPhone, address],

​     (error, result, field) => {

​      if (error) {

​       console.log(error)

​      } else {

​       res.json({ success_code: 200 })

​      }

​     },

​    )

   }

  }

 })

})

//获取当前页评论

router.get('/api/admin/getCurrentPageComment', function (req, res) {

 let { currentPage, pageSize, input } = req.query

 let start = Number((currentPage - 1) * pageSize)

 pageSize = Number(pageSize)

 let sqlStr =

  'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id INNER JOIN t_user ON t_user.user_id=t_comment.user_id WHERE t_movie.name LIKE ? ORDER BY comment_id;'

 let total

 conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   total = result.length

  }

 })

 sqlStr =

  'SELECT * FROM t_comment INNER JOIN t_movie ON t_comment.movie_id = t_movie.movie_id INNER JOIN t_user ON t_user.user_id=t_comment.user_id WHERE t_movie.name LIKE ? ORDER BY comment_id LIMIT ?,?;'

 conn.query(

  sqlStr,

  ['%' + input + '%', start, pageSize],

  (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    result = JSON.parse(JSON.stringify(result))

​    res.json({ success_code: 200, data: result, total: total })

   }

  },

 )

})

//通过当前评论

router.post('/api/admin/passCurrentComment', function (req, res) {

 let commentId = req.body.commentId

 let movieId = req.body.movieId

 if (commentId) {

  let sqlStr = 'UPDATE t_comment SET is_pass = 1 WHERE comment_id = ?;'

  conn.query(sqlStr, [commentId], (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    sqlStr =

​     'SELECT user_score FROM t_comment WHERE movie_id = ? AND is_pass = ?;'

​    conn.query(sqlStr, [movieId, 1], (error, result, field) => {

​     if (error) {

​      console.log(error)

​     } else {

​      result = JSON.parse(JSON.stringify(result))

​      let avgScore = 0

​      if (result.length) {

​       result.forEach((val) => {

​        avgScore += Number(val.user_score)

​       })

​       avgScore = (avgScore / Number(result.length)).toFixed(1)

​      }

​      sqlStr = 'UPDATE t_movie SET score = ? WHERE movie_id = ?;'

​      conn.query(sqlStr, [avgScore, movieId], (error, result, field) => {

​       if (error) {

​        console.log(error)

​       } else {

​        res.json({ success_code: 200 })

​       }

​      })

​     }

​    })

   }

  })

 }

})

//删除当前评论

router.post('/api/admin/deleteCurrentComment', function (req, res) {

 let commentId = req.body.commentId

 let movieId = req.body.movieId

 if (commentId) {

  let sqlStr = 'DELETE FROM t_comment WHERE comment_id = ?;'

  conn.query(sqlStr, [commentId], (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    sqlStr =

​     'SELECT user_score FROM t_comment WHERE movie_id = ? AND is_pass = ?;'

​    conn.query(sqlStr, [movieId, 1], (error, result, field) => {

​     if (error) {

​      console.log(error)

​     } else {

​      result = JSON.parse(JSON.stringify(result))

​      let avgScore = 0

​      if (result.length) {

​       result.forEach((val) => {

​        avgScore += Number(val.user_score)

​       })

​       avgScore = (avgScore / Number(result.length)).toFixed(1)

​      }

​      sqlStr = 'UPDATE t_movie SET score = ? WHERE movie_id = ?;'

​      conn.query(sqlStr, [avgScore, movieId], (error, result, field) => {

​       if (error) {

​        console.log(error)

​       } else {

​        res.json({ success_code: 200 })

​       }

​      })

​     }

​    })

   }

  })

 }

})

//获取当前页订单

router.get('/api/admin/getCurrentPageOrder', function (req, res) {

 let { currentPage, pageSize, input } = req.query

 let start = Number((currentPage - 1) * pageSize)

 pageSize = Number(pageSize)

 let sqlStr =

  'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id INNER JOIN t_user ON t_order.user_id = t_user.user_id WHERE t_movie.name LIKE ? ORDER BY order_id;'

 let total

 conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   total = result.length

  }

 })

 sqlStr =

  'SELECT * FROM t_order INNER JOIN t_schedule ON t_order.schedule_id = t_schedule.schedule_id INNER JOIN t_movie ON t_movie.movie_id = t_schedule.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id INNER JOIN t_user ON t_order.user_id = t_user.user_id WHERE t_movie.name LIKE ? ORDER BY order_id LIMIT ?,?;'

 conn.query(

  sqlStr,

  ['%' + input + '%', start, pageSize],

  (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    result = JSON.parse(JSON.stringify(result))

​    res.json({ success_code: 200, data: result, total: total })

   }

  },

 )

})

//删除订单

router.post('/api/admin/deleteOrder', function (req, res) {

 let { orderId, scheduleId, orderSeatInfo } = req.body

 if (orderId) {

  let sqlStr = 'SELECT seat_info FROM t_schedule WHERE schedule_id = ?'

  conn.query(sqlStr, [scheduleId], (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    result = result[0].seat_info

​    result = JSON.parse(result)

​    orderSeatInfo = JSON.parse(orderSeatInfo)

​    console.log(typeof result)

​    console.log(typeof orderSeatInfo)

​    let tempArr = []

​    result.forEach((value) => {

​     if (orderSeatInfo.indexOf(value) === -1) {

​      tempArr.push(value)

​     }

​    })

​    console.log(tempArr)

​    result = JSON.stringify(tempArr)

​    sqlStr = 'UPDATE t_schedule SET seat_info = ? WHERE schedule_id = ?;'

​    conn.query(sqlStr, [result, scheduleId], (error, result, field) => {

​     if (error) {

​      console.log(error)

​     } else {

​      sqlStr = 'DELETE FROM t_order WHERE order_id =?'

​      conn.query(sqlStr, [orderId], (error, result, field) => {

​       if (error) {

​        console.log(error)

​       } else {

​        res.json({ success_code: 200 })

​       }

​      })

​     }

​    })

   }

  })

 }

})

//获取当前页影厅

router.get('/api/admin/getCurrentPageHall', function (req, res) {

 let { currentPage, pageSize, input } = req.query

 let start = Number((currentPage - 1) * pageSize)

 pageSize = Number(pageSize)

 let sqlStr =

  'SELECT * FROM t_hall INNER JOIN t_cinema ON t_cinema.cinema_id = t_hall.cinema_id WHERE t_cinema.cinema_name LIKE ? ORDER BY hall_id;'

 let total

 conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   total = result.length

  }

 })

 sqlStr =

  'SELECT * FROM t_hall INNER JOIN t_cinema ON t_cinema.cinema_id = t_hall.cinema_id WHERE t_cinema.cinema_name LIKE ? ORDER BY hall_id LIMIT ?,?;'

 conn.query(

  sqlStr,

  ['%' + input + '%', start, pageSize],

  (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    result = JSON.parse(JSON.stringify(result))

​    res.json({ success_code: 200, data: result, total: total })

   }

  },

 )

})

//删除影厅

router.post('/api/admin/deleteHall', function (req, res) {

 let { cinemaId, hallName } = req.body

 if (cinemaId) {

  let sqlStr =

   'SELECT schedule_id FROM t_schedule WHERE cinema_id = ? AND hall_name = ?;'

  conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    result = JSON.parse(JSON.stringify(result))

​    console.log(result)

​    if (result.length) {

​     result.forEach((value) => {

​      sqlStr = 'DELETE FROM t_schedule WHERE schedule_id = ?;'

​      conn.query(sqlStr, [value.schedule_id], (error, result, field) => {

​       if (error) {

​        console.log(error)

​       }

​      })

​     })

​    }

​    sqlStr = 'DELETE FROM t_hall WHERE cinema_id = ? AND name = ?'

​    conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {

​     if (error) {

​      console.log(error)

​     } else {

​      res.json({ success_code: 200 })

​     }

​    })

   }

  })

 }

})

//更新影厅信息

router.post('/api/admin/updateHallInfo', function (req, res) {

 let { hallId, cinemaId, hallOldName, hallNewName } = req.body

 if (cinemaId) {

  let sqlStr =

   'SELECT * FROM t_hall WHERE name = ? AND cinema_id = ? AND hall_id <> ? LIMIT 1;'

  conn.query(

   sqlStr,

   [hallNewName, cinemaId, hallId],

   (error, result, field) => {

​    if (error) {

​     console.log(error)

​    } else {

​     result = JSON.parse(JSON.stringify(result))

​     if (result[0]) {

​      res.json({ error_code: 1, message: '该影院的影厅已存在！' })

​     } else {

​      sqlStr =

​       'UPDATE t_schedule SET hall_name = ? WHERE cinema_id = ? AND hall_name = ?'

​      conn.query(

​       sqlStr,

​       [hallNewName, cinemaId, hallOldName],

​       (error, result, field) => {

​        if (error) {

​         console.log(error)

​        } else {

​         //更新数据库

​         let sqlStr =

​          'UPDATE t_hall SET name = ? WHERE cinema_id = ? AND name = ?;'

​         conn.query(

​          sqlStr,

​          [hallNewName, cinemaId, hallOldName],

​          (error, result, field) => {

​           if (error) {

​            res.json({

​             error_code: 1,

​             message: '更新影影厅信息失败',

​            })

​            console.log(error)

​           } else {

​            res.json({ success_code: 200 })

​           }

​          },

​         )

​        }

​       },

​      )

​     }

​    }

   },

  )

 }

})

//获取所有影院

router.get('/api/admin/getAllCinema', function (req, res) {

 let sqlStr = 'SELECT cinema_id,cinema_name FROM t_cinema;'

 conn.query(sqlStr, (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   res.json({ success_code: 200, data: result })

  }

 })

})

//添加影厅信息

router.post('/api/admin/addHallInfo', function (req, res) {

 let { cinemaId, hallName } = req.body

 let sqlStr = 'SELECT * FROM t_hall WHERE name = ? AND cinema_id = ? LIMIT 1;'

 conn.query(sqlStr, [hallName, cinemaId], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   if (result[0]) {

​    res.json({ error_code: 1, message: '该影院的影厅已存在！' })

   } else {

​    let sqlStr = 'INSERT INTO t_hall(cinema_id,name) VALUES(?,?);'

​    conn.query(sqlStr, [cinemaId, hallName], (error, result, field) => {

​     if (error) {

​      console.log(error)

​     } else {

​      res.json({ success_code: 200 })

​     }

​    })

   }

  }

 })

})

//获取当前页电影

router.get('/api/admin/getCurrentPageMovieSchedule', function (req, res) {

 let { currentPage, pageSize, input } = req.query

 let start = Number((currentPage - 1) * pageSize)

 pageSize = Number(pageSize)

 let sqlStr =

  'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE t_movie.name LIKE ? ORDER BY schedule_id '

 let total

 conn.query(sqlStr, ['%' + input + '%'], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   total = result.length

  }

 })

 sqlStr =

  'SELECT * FROM t_schedule INNER JOIN t_movie ON t_schedule.movie_id = t_movie.movie_id INNER JOIN t_cinema ON t_cinema.cinema_id = t_schedule.cinema_id WHERE t_movie.name LIKE ? ORDER BY schedule_id LIMIT ?,?;'

 conn.query(

  sqlStr,

  ['%' + input + '%', start, pageSize],

  (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    result = JSON.parse(JSON.stringify(result))

​    res.json({ success_code: 200, data: result, total: total })

   }

  },

 )

})

//获取所有电影

router.get('/api/admin/getAllMovie', function (req, res) {

 let sqlStr = 'SELECT * FROM t_movie;'

 conn.query(sqlStr, (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   res.json({ success_code: 200, data: result })

  }

 })

})

//获取影院的影厅

router.get('/api/admin/getHallByCinemaId', function (req, res) {

 let cinemaId = req.query.cinemaId

 console.log(cinemaId)

 let sqlStr = 'SELECT hall_id,name FROM t_hall WHERE cinema_id = ?;'

 conn.query(sqlStr, [cinemaId], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   console.log(result)

   res.json({ success_code: 200, data: result })

  }

 })

})

//获取排片的某天的时间段安排

router.get('/api/admin/getHasScheduleDateTime', function (req, res) {

 let { cinemaId, hallName, showDate } = req.query

 let sqlStr =

  'SELECT show_time FROM t_schedule WHERE cinema_id = ? AND hall_name = ? AND show_date = ?;'

 conn.query(sqlStr, [cinemaId, hallName, showDate], (error, result, field) => {

  if (error) {

   console.log(error)

  } else {

   result = JSON.parse(JSON.stringify(result))

   res.json({ success_code: 200, data: result })

  }

 })

})

//添加影院信息

router.post('/api/admin/addScheduleInfo', function (req, res) {

 let { movieId, cinemaId, hallName, showDate, showTime, price } = req.body

 let sqlStr =

  'INSERT INTO t_schedule(movie_id,cinema_id,hall_name,show_date,show_time,price) VALUES(?,?,?,?,?,?);'

 conn.query(

  sqlStr,

  [movieId, cinemaId, hallName, showDate, showTime, price],

  (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    res.json({ success_code: 200 })

   }

  },

 )

})

//删除影厅

router.post('/api/admin/deleteMovieSchedule', function (req, res) {

 let { scheduleId } = req.body

 if (scheduleId) {

  let sqlStr = 'DELETE FROM t_schedule WHERE schedule_id = ?'

  conn.query(sqlStr, [scheduleId], (error, result, field) => {

   if (error) {

​    console.log(error)

   } else {

​    res.json({ success_code: 200 })

   }

  })

 }

})

module.exports = router